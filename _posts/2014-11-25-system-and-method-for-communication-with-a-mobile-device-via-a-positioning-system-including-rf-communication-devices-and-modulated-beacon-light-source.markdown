---

title: System and method for communication with a mobile device via a positioning system including RF communication devices and modulated beacon light sources
abstract: A light source emits a modulated light, and a radio-frequency transceiver disposed therewith emits a radio-frequency signal. A mobile device may receive either or both signals and determine its position based thereon. The light and radio-frequency sources may be disposed in node in a network of said sources, and the nodes may communicate via the radio-frequency transceivers.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09509402&OS=09509402&RS=09509402
owner: ABL IP HOLDING LLC
number: 09509402
owner_city: Conyers
owner_country: US
publication_date: 20141125
---
This application claims priority to and the benefit of U.S. Provisional Patent Application Ser. Nos. 61 908 460 filed Nov. 25 2013 and 62 052 207 filed Sep. 18 2014 which are hereby incorporated herein by reference in their entirety.

In various embodiments the present invention relates generally to systems and methods for communicating with a mobile device via a positioning system that includes both radio frequency RF transceivers and modulated beacon light sources and among the nodes constituting such a system.

Provided herein are descriptions of methods and systems for the use and application of RF communication devices integrated with light sources for position detection of mobile devices control of a lighting system and for communication with mobile and stationary devices preferably in spaces of relatively limited extent e.g. retail store interiors convention floors libraries airport terminals roofed sports stadiums courtyards that are illuminated by lights capable of communicating information by visible light communication VLC . In various embodiments these methods and systems enable the RF communications devices to enhance and support the position determination function and other functions of a system or network of one or more VLC capable lights. Also in various embodiments these methods and systems advantageously co locate the RF communications devices with VLC lights powered by standard mains lighting power obviating the use of batteries or the installation of special wiring to power the RF communications devices.

Indoor positioning services relate to systems and methods whereby the locations of mobile devices and their users within buildings are estimated. Such services may be based on various physical modalities including light radio waves ultrasonic waves and floor vibrations. Indoor positioning is a key component of location aware computing which relates to applications that utilize the location of a mobile device to provide the device s user with content relevant to their location. Some location aware computing functions pertain to entertainment marketing and management. An example of an entertainment function supported by indoor positioning is augmented reality technology that functionally overlays a virtual space onto a physical space. Marketing functions supported by indoor positioning include advertising and content distribution through mobile devices e.g. tablets cell phones wearable computers smart tags . Herein marketing refers to content distribution even in nonprofit settings. Indoor marketing functions differ importantly from those for off site environments for example for a retail enterprise indoor marketing can include unique aspects such as alerting a customer via their mobile device of discounts on items in the store. In an example a customer not in the store sees an ad in general media for a product at a given location. They then travel to that location. Upon entry they are prompted by a radio frequency RF capability of the store s lighting network to view their mobile device. This exposes the mobile device to ambient light and enables visible light communication VLC supported position estimation for the device. The customer is then alerted to a special discount coupon available to them at that time only for a product in the store and may interact with a map displayed on their device that employs the device s VLC position estimate and directs them to the product. In general in store content and ad distribution capabilities are enabled by indoor location services that are not feasible in the prior art.

An illustrative management function for indoor positioning is inventory navigation e.g. in a warehouse the indoor positioning system can direct a person equipped with a mobile device to where a particular item is located. Inventory tracking is also possible e.g. if the person removes the item an event that may be either logged by the device user on their mobile device or automatically detected as motion of an electronic tag on the item a back end server can update inventory databases to reflect this change.

In another exemplary management function a mobile device using a light based indoor position positioning technique in conjunction with a wireless connection e.g. WiFi can enable non intrusive data collection on customers. For example data collection on how customers move through a store and where they spend time can be collected and used to improve layout and merchandise displays.

Light based indoor positioning systems have various advantages over systems employing other physical modalities. Signals from Global Positioning System GPS satellites often used for determining the location of mobile computing devices lose significant power when passing through construction materials and suffer from multi path propagation effects making GPS unsuitable for indoor navigation. Techniques based on received signal strength indication RSSI from radio transceivers e.g. WiFi and Bluetooth wireless access points have been explored for indoor positioning but positioning accuracy of RSSI based systems is limited to the multi meter range. Ultrasonic techniques which transmit inaudible acoustic waves to microphones can also be used to approximate indoor position however ultrasound tends to be more limited in range than radio and commonplace devices and networks are not configured for communicating via ultrasound.

VLC indoor positioning techniques employ optical signals either visible or infrared typically emitted by lights also performing an illumination function and can be used to accurately locate mobile devices indoors. Optical techniques are more accurate and or reliable than other approaches since light waves are highly directional and do not pass through most materials a light detecting device can be presumed proximate to a light source if the source is robustly detectable. Moreover many mobile devices are inherently equipped with cameras that may be exploited for optical indoor positioning and are simultaneously in contact via radio with one or more communications networks e.g. telephone Internet . Herein mobile devices includes all portable devices having a computational capability e.g. phones tablets wearable computers electronic tags etc. . Also light based indoor positioning systems are easy and low cost to set up e.g. to install a building operator may need only to swap out existing bulbs for VLC bulbs. No new socket hardware or power wiring is required and no scheduled battery maintenance need be instituted.

However optical indoor positioning techniques have several limitations or drawbacks. For example VLC signals cannot be sent or received directly by many computing devices or networks e.g. servers the cell phone network the Internet standardized protocols do not exist for the exchange of data commands and other information between VLC beacons and other computing devices or networks VLC signals are not detectable by devices lacking light sensors or whose light sensors are not exposed to ambient light e.g. a cell phone stowed in a user s pocket the bandwidth of VLC beacons is low relative to that of various other communications modalities and because of the tendency of light to be attenuated by even flimsy objects any intercommunicating network of VLC devices e.g. ceiling lights in a retail space would likely be unreliable and subject to isolation of portions of the network by architectural or other barriers. All of these drawbacks as well as others not named arise from the innate character of VLC signaling. Techniques are therefore desired by which the advantageous aspects of VLC indoor positioning may be combined with those of one or more other communications modalities. Also desired are methods for remote control monitoring and diagnosis of a lighting network that may feature non VLC lights and or VLC lights.

A set of RF transceivers e.g. Bluetooth modules may be stationed at known locations in a given region e.g. within a retail space and made to communicate with each other in such a way as to constitute a grid or mesh. Herein one or more devices e.g. RF transceivers VLC capable lights devices integrating RF transceivers with VLC capable lights a.k.a. VLC RF lights and similar terms herein are said to form a mesh if each transceiver in the set is capable of communicating with at least one other transceiver in the set and the topology or interconnectedness of these links is such as to enable the exchange of information between any one transceiver in the whole set and any other whether by direct transmission or by transmission through one or more intermediary transceivers. Herein a network is any set of one or more devices e.g. RF transceivers VLC RF lights capable of intercommunicating information and may or may not have a mesh type topology.

As described herein RF mesh transceivers may be advantageously combined or integrated with modulating light beacons in a positioning system. Typically in such an integrated mesh a modulated light beacon e.g. a light source such as an LED and electronic circuitry to vary an intensity or frequency of light emitted therefrom in accordance with a modulation signal and an RF module e.g. an RF transmitter and or receiver comprising electronic circuitry for sending and receiving data via an RF signal are combined in a single physical unit e.g. a ceiling light fixture . Such integration advantageously enables the RF modules to draw power from the power mains installed to power light fixtures obviating the labor intensive periodic maintenance of battery power sources in the modules and or the installation of a separate additional system of power mains to power the RF modules. Also such integration effectively co locates within a single space two arrays of modules one consisting essentially of RF transceivers and the other of modulatable lights e.g. LEDs . Both arrays may be used separately or in a complementary manner for purposes of communication with each other mobile devices non mobile devices and other networks or communication systems. For example information may be transmitted by light sources to mobile devices via VLC or one way or two way communication may occur between mobile devices sensors servers VLC modules RF modules and other devices and or networks.

Integration of an RF mesh with a system of modulated VLC beacons enables more rapid flexible and accurate orientation and position finding for mobile devices as well as the efficient communication or exchange of information other than positional information with mobile devices and with other devices. As shall be made clear herein such systems offer greatly enhanced flexibility of operation and function as compared to the state of the art of either RF only or light only positioning systems. Herein illustrative characteristics of the RF aspect of a mesh including both RF and VLC modules herein termed an integrated VLC RF system VLC RF system and similar terms are shown and described according to various embodiments of the invention.

More particularly described herein are techniques for operating a multiplicity of RF modules as a mesh for the physical and operational integration of RF modules with VLC beacons for communicating with sensors and actuators through an integrated VLC RF mesh herein termed an VLC RF system VLC RF mesh and similar terms for encryptionally preserving the security of a VLC RF against at least some forms of attempted takeover or unwanted characterization for commissioning a VLC RF system or portions thereof during startup expansion or maintenance for the robust identification by receiving devices of individual RF transceivers and VLC beacons and for other applications and operations that will be made apparent herein. Techniques for the broadcast and detection of at least locally unique identifiers for VLC beacon sources are shown and described in for example U.S. Ser. No. 13 369 144 filed on Feb. 8 2012 U.S. Ser. No. 13 369 147 filed on Feb. 8 2012 U.S. Ser. No. 13 422 591 filed on Mar. 16 2012 U.S. Ser. No. 13 435 448 filed on Mar. 30 2012 U.S. Ser. No. 13 445 019 filed on Apr. 12 2012 U.S. Ser. No. 13 446 506 filed on Apr. 13 2012 U.S. Ser. No. 13 446 520 filed on Apr. 13 2012 and U.S. Ser. No. 13 526 781 filed on Jun. 19 2012 the entire disclosure of each of which is incorporated by reference herein. Methods for the broadcast and detection of at least locally unique identifiers for RF transceivers are shown and described herein.

Herein integration integrated and the like signify that an RF mesh and a VLC beacon system do not merely coexist in a given space but may in various embodiments be installed in a shared housings draw upon shared power sources and exchange sensed data control signals and other information with each other as well as with devices in the working space of the system and beyond. For example an individual VLC RF lighting unit may also include 1 a Bluetooth Low Energy BLE module with circuitry for enabling control via the BLE module of the unit s VLC aspect or vice versa and 2 sensors whose data are transmittable through the BLE module to other BLE modules comprised by an RF mesh or directly or eventually to other destinations.

Also described herein are techniques for communicating with a mobile communications device e.g. cellular telephone wearable computer tablet computer smart tag via a VLC RF system in the vicinity of the mobile device. The RF transceivers of a VLC RF mesh may be employed simultaneously with or alternatively to the VLC beacons of the mesh in determining the position state of motion and orientation of a mobile device in the working space. The VLC beacons and RF transceivers may communicate with each other as well as potentially with other devices or networks. As a particular example commands specifying the operation of the VLC lights may be communicated by the RF transceivers of a VLC RF mesh.

Also described herein are techniques for identifying a modulatable light to facilitate position detection by nearby mobile devices via a radio frequency e.g. Bluetooth identifier of a radio frequency function that is integrated into the light. Such techniques may include combining a Bluetooth identifier with any of a set of preselected light identifiers and hashing the combination to produce a unique position identifier where the unique position identifier may be the same for all of the preselected light identifiers. Herein hashing denotes the unique mapping of a digital string to a data string of fixed size with slight differences in input data producing large differences in output data. The hashed output for a given input string constitutes an encryption of the input string. The technique may alternatively include receiving a Bluetooth identifier with a mobile device receiving modulated light with a camera of the mobile device where the modulated light communicates a portion of a light identifier and communicating the received Bluetooth identifier and portion of a light identifier to a networked server configured to generate a unique position identifier from the received data. Such a technique may alternatively include receiving a Bluetooth identifier with a mobile device receiving modulated light with a camera of the mobile device where the modulated light communicates a portion of a light identifier hashing the Bluetooth identifier and portion of a light identifier to generate a unique position identifier and communicating the unique position identifier to a networked server configured to facilitate device position detection based on the communicated unique position identifier. Facilitating device position detection may include using the unique position identifier as an index into a table that associates unique position identifiers to at least one of a logically identified area and a physically located light. In a variation of such a technique the modulated light communicated portion of the light identifier does not uniquely identify the light. In another variation the modulated light communicated portion of the light identifier is common to a plurality of lights.

Pushing a notification to a user of a mobile device to enable modulated light based position detection may be based on detecting the presence of a Bluetooth module that is integrated into the light when the mobile device is disposed within Bluetooth beaconing range of the light. Herein a user of a mobile device is any operator of a mobile device whether a customer store employee store manager emergency responder robot vehicle or other entity. The notification may be at least one of an audio and a video notification to the user to expose the mobile device s camera.

Also described herein are methods of controlling a processor to facilitate broadcasting Bluetooth compatible signals while modulating a light.

Also described herein are certain methods and systems of transmitting collected information via radio frequency signal communication between a mobile device that has detected a presence of a modulating light and a processor integrated with the light that has access to the collected information where the collected information is collected from sensors associated with the modulating light. Collected information herein also denotes more broadly information collected about customers potential customers employees mobile and stationary machines and other sources of information relevant to an enterprise e.g. business . Information collected concern customers may include responsiveness to ads in external non indoor media changes in location arrivals and departures from VLC served spaces movement patterns purchasing patterns expressed preferences and other.

Also described herein are illustrative techniques for configuring a directional RF antenna so that RF signals emitted from a modulatable light for position detection is constrained to substantially the same region as the modulated light emitted from the light.

In addition disambiguating detected modulated light identifiers from a plurality of modulatable light sources may be accomplished by comparing hashes of combinations of a Bluetooth beacon signal that is detected while the light identifiers are detected and at least a portion of the detected light modulated identifiers to a table of hash based light identifiers. Hashing as described herein may also facilitate generating a specific unique position identifier that is common for a plurality of combinations of distinct Bluetooth and light identification codes.

Broadcasting a plurality of distinct combinations of Bluetooth and light identification codes from a light may facilitate each distinct combination seeding a hash function that generates a specific unique or locally unique or effectively unique position identifier that is common for all of the distinct combinations.

Automatically configuring a light modulation function that results in the light generating a particular light modulation pattern by communicating among a plurality of proximal lights where each light is configured with a processor that facilitates radio frequency signal transmission and reception is described herein. An example includes the particular light modulation pattern being distinct from light modulation patterns of the proximal lights. Another example includes the particular light modulation pattern being based on light modulation patterns of the proximal lights.

Also described herein is a mesh radio frequency network comprising a plurality of local area radio frequency enabled position detection modulatable lights and at least one multi radio device where at least one of the radios of the multi radio device facilitates connection to a wide area network. Security for such a network may be accomplished through encryption of at least a portion of the communications over the local area radio.

The mesh network may be used by at least some of the modulatable lights that include at least one sensor selected from the list of sensors consisting of radio frequency sensor optical sensor video sensor audio sensor and image sensor for collecting sensor representative data and storing the collected data in a memory of the light.

Synchronizing modulation schemes for a plurality of modulatable lights may be accomplished by transmitting information about a desired modulation scheme among a plurality of the lights via RF facilities configured into the light.

Presenting user targeted content may be based on detection by a personal mobile device of a modulated light pattern generated by a modulatable light source. In an illustrative example a mobile device detects a modulatable light source or several such sources detects an effectively unique light source ID code or combination of light source ID codes in the modulated light reports this code or combination of codes via an RF capability of its own or of the VLC RF system to a back end a.k.a. controller server associated with the network and is informed via the RF capability of an estimate of its the mobile device s position. Moreover the user is offered through either through the mobile device or displays devices lighting and like devices proximate to the user content that pertains to the user s location in the working space as well as potentially other information about the user e.g. shopping history age gender . In various embodiments facilitating access to user targeted position dependent content may be based on an indoor position of a user that is determined from a unique position identifier that is derived from a combination of a light pattern and an RF signal generated by a RF enabled modulatable light within a VLC RF mesh.

In one aspect a mesh network includes a plurality of nodes and each node includes a light source for emitting a modulated light to be received by a mobile device a radio frequency transceiver for emitting and receiving a radio frequency signal enabling bi directional communication with at least one other node in the mesh network and a power supply for drawing power from an AC mains source and for supplying power to the light source and radio frequency transceiver.

One node in the mesh may include a mesh controller for issuing commands receiving data or communicating with a device or network outside the mesh network. Each radio frequency transceiver may broadcast bits sequentially in accordance with a physical modulation scheme the broadcast bits may include groups of fixed or variable length. The groups may include information identifying the group a transmitter of the group an intended recipient of the group commands or collected data. Each node may further include a packet ID. Each node may compare a received packet ID to its packet ID and based on a result of the comparison executes a command associated with the received packet ID or retransmits the received packet ID. The mesh network may include a communications range extender for a mobile device. A node in the mesh network may wrap a non mesh packet s content into one or more mesh packets and broadcasts the one or more mesh packets. The radio frequency transceiver may receive a signal assigning a packet ID or identifier.

In another aspect a method of communicating among a plurality of nodes in a mesh network includes emitting from a light source disposed in each node a modulated light to be received by a mobile device emitting and receiving from a radio frequency transceiver disposed in each node a radio frequency signal to thereby enable bi directional communication with at least one other node in the mesh network and drawing power from an AC mains source and supplying power to the light source and radio frequency source in each node.

The method may further include issuing commands receiving data or communicating with a device or network outside the mesh network. Each radio frequency transceiver may broadcast bits sequentially in accordance with a physical modulation scheme. The broadcast bits may include groups of fixed or variable length. The groups may include information identifying the group a transmitter of the group an intended recipient of the group commands or collected data. Each node may further include a packet ID. The method may further include comparing a received packet ID to the packet ID and based on a result of the comparison executing a command associated with the received packet ID or retransmitting the received packet ID extending a communications range of a mobile device using the mesh network and or wrapping a non mesh packet s content into one or more mesh packets and broadcasting the one or more mesh packets. The radio frequency transceiver may receive a signal assigning a packet ID or identifier.

In another aspect a system for communicating with a mobile device includes a light source for emitting a modulated light to be received by the mobile device the modulated light comprising a first plurality of identifiers a radio frequency source for emitting a radio frequency signal to be received by the mobile device the radio frequency signal comprising a second plurality of identifiers wherein hashing each of the first plurality identifiers with a corresponding one of the second plurality of identifiers yields a unique location identifier and a power supply for drawing power from an AC mains source and for supplying power to the light source and radio frequency source.

Hashing may include a unique mapping of a digital string to a data string of fixed size. A networked server may be configured to generate the unique location identifier from the first and second plurality of identifiers. The mobile device may transmit transmits the first and second plurality of identifiers to the networked sever. A networked server may be configured to receive the unique location identifier from the mobile device. The unique location identifier may be unique to one light or is common to a plurality of lights.

In another aspect a method for communicating with a mobile device includes emitting using a light source a modulated light to be received by the mobile device the modulated light comprising a first plurality of identifiers emitting using a radio frequency source a radio frequency signal to be received by the mobile device the radio frequency signal comprising a second plurality of identifiers wherein hashing each of the first plurality identifiers with a corresponding one of the second plurality of identifiers yields a unique location identifier and drawing power using a power supply from an AC mains source and supplying power to the light source and radio frequency source.

Hashing may include a unique mapping of a digital string to a data string of fixed size. The method may further include generating using a networked server the unique location identifier from the first and second plurality of identifiers transmitting the first and second plurality of identifiers from the mobile device to the networked server 

and or receiving at a networked server the unique location identifier from the mobile device. The unique location identifier may be unique to one light or is common to a plurality of lights. The method may further include disambiguating detected identifiers from the first or second plurality of identifiers by comparing the unique location identifier to a table of stored identifiers and or generating a particular identifier by communicating among a plurality of proximal light sources.

In another aspect a system for communicating with a mobile device includes a light source for emitting a modulated light to be received by the mobile device in a light detection area a radio frequency source for emitting a radio frequency signal to be received by the mobile device in a radio frequency detection area wherein at least a portion of the radio frequency detection area coincides with the light detection area and a power supply for drawing power from an AC mains source and for supplying power to the light source and radio frequency source.

A second light source may emit a second light detection area and a second radio frequency detection area wherein at least a portion of the second radio frequency detection area overlaps with the radio frequency detection area and the second light detection area does not overlap with the light detection area. A directional antenna may directionally limit the radio frequency signal such that the light detection area and radio frequency detection area substantially overlap the directional antenna may be a conformal antenna panel antenna or phased array antenna. The phased array antenna may be dynamically programmed to alter a broadcast power reception sensitivity radiation pattern or direction of the radio frequency signal. The radio frequency source may be configured for pushing a notification to a mobile device to enable light based position detection when the mobile device is disposed in the radio frequency detection area. The radio frequency source may be configured for pushing a notification to a mobile device the notification comprising content related to a location of the mobile device when the mobile device is disposed in the light detection area or radio frequency detection area.

In another aspect a method for communicating with a mobile device includes emitting using a light source a modulated light to be received by the mobile device in a light detection area emitting using a radio frequency source a radio frequency signal to be received by the mobile device in a radio frequency detection area wherein at least a portion of the radio frequency detection area coincides with the light detection area and drawing power using a power supply from an AC mains source and for supplying power to the light source and radio frequency source.

The method may further include emitting using a second light source a second light detection area and a second radio frequency detection area wherein at least a portion of the second radio frequency detection area overlaps with the radio frequency detection area and the second light detection area does not overlap with the light detection area and or directionally limiting using a directional antenna the radio frequency signal such that the light detection area and radio frequency detection area substantially overlap. The directional antenna may be a conformal antenna panel antenna or phased array antenna. The method may further include dynamically programming the phased array antenna to alter a broadcast power reception sensitivity radiation pattern or direction of the radio frequency signal pushing a notification to a mobile device to enable light based position detection when the mobile device is disposed in the radio frequency detection area and or pushing a notification to a mobile device the notification comprising content related to a location of the mobile device when the mobile device is disposed in the light detection area or radio frequency detection area.

Herein wireless RF communication is on occasion denoted by reference to Bluetooth but any wireless communication means may be similarly employed and all such are implicitly intended subject to constraints arising from variations in capability wherever Bluetooth and related terms are used. Examples of wireless RF communication means intended herein without limitation include Bluetooth Bluetooth Low Energy BLE WiFi Enhanced NFC WiMax 3G 4G and the like. Also herein lighting systems described as embodying VLC and similar capabilities may minimally possess only an illumination capability not necessarily a visible light communications capability in some or all lights.

Moreover systems employing modulated light are denoted herein by reference to visible light communications VLC but modulation of non visible light e.g. infrared light ambient audible sound e.g. music and ambient non audible sound e.g. ultrasound infrasound subaudible noise may be similarly employed additionally or alternatively to visible light and are therefore implicitly included wherever visible light communication or similar terms are employed herein subject to limitations of meaning arising from constraints on technical capability. All these modalities can be used to create an ambient wave field within a working space which field may be readily modulated by e.g. frequency shifting on off keying broadcast of multiple tones intensity modulation to convey information in a manner not sensibly apparent to human beings in the space. Moreover all these modalities may be employed in a manner that localizes the detectable of sources or broadcast points on a similar spatial scale e.g. meters or tens of meters and so lend themselves straightforwardly to employment in local area position finding and related functions described herein primarily with reference to visible light modulation and RF signaling. Thus all such modalities are contemplated and within the scope of the invention.

Also herein the term positioning system and similar terms refer inclusively to systems that perform functions additional or alternative to determining the position of a mobile device in a working space. Examples of such additional or alternative functions without limitation include determining the orientation and or state of motion of a mobile device in a served space gathering and or exchanging information about the distribution of magnetic fields RF signals illumination or other measurable quantities throughout a working space communicating operational commands sensed data queries maps identifying information marketing and sales information and other information with between or through mobile or stationary devices in the working space wirelessly supplying electrical power to stationary or mobile devices in the working space and using stationary or mobile devices as gateways through which to access other devices or networks such as an intranet or the Internet. Also herein the term indoor e.g. in indoor positioning system is understood to include all relatively local areas or volumes whether partly or wholly contained inside a building or not that may be served by a VLC RF positioning system.

These and other systems methods objects features and advantages of RF communication enabled position detection lighting described herein will be apparent to those skilled in the art from the following detailed description of the preferred embodiment and the drawings. All documents mentioned herein are hereby incorporated in their entirety by reference.

In and discussion thereof systems and methods are disclosed that disclose providing a positioning service for devices based on light received from one or more light sources. pertain to the integration of VLC and radio capabilities in a lighting system.

In some embodiments light sources are used to provide an indoor positioning service to mobile devices. Each light source is given a distinctive identification ID code and database associates each ID code with specific location data coordinates . The ID code is broadcast by modulating the visible light output of the LED light source. This modulation occurs at speeds undetectable by the human eye yet detectable by a camera equipped mobile device as modulation artifact in images acquired by the camera. Since robust detection of ID information broadcast by a point source of light is feasible only the vicinity of the source the mobile device can be presumed to be in the vicinity of a light whose ID it detects. Detected light IDs can therefore be used to estimate the mobile device s location e.g. by matching detected IDs to spatial coordinates using a database on a server. When a mobile device identifies light from more than one light source the position of the device can be geometrically estimated with even greater accuracy.

In various embodiments hashing or other encryption techniques may be used to obscure ID codes from third party observers e.g. competitors who wish to map a store and its VLC system . Herein hashing denotes the unique mapping of a digital string to a data string of fixed size with slight differences in input data producing large differences in output data. The hashed output for a given input string constitutes an encryption of the input string. For example in an illustrative embodiment hashed ID codes may be detected by a mobile device and transmitted to a server for de hashing the hash function itself is never exposed to third party examination by being entrusted to the mobile device.

In the illustrative embodiment of a mobile device receives light from three light sources . Each light source can be any lighting source used for general purpose illumination spot illumination or backlighting that is capable of transmitting information by means of visible light communication VLC . For the purposes of this disclosure we consider any form of light capable of being suitably modulated e.g. an LED light source as a VLC light source LED light sources are referred to extensively herein but such references are illustrative and technologically nonrestrictive.

LEDs can be dimmed and brightened i.e. modulated more rapidly than the human eye can detect. LED light is therefore a medium through which data can be transmitted to devices equipped with appropriate light sensing capability e.g. a digital camera. As will be clear to persons familiar with the art of communications engineering many forms of digital two state and analog continuous state modulation may be applied to an LED s light output including amplitude shift keying amplitude modulation frequency modulation and many others. For example the brightness of a light source may be modulated by one or more sinusoidal signals. All modulation techniques that can be applied to visible light are contemplated and within the scope of the invention subject only to the condition that the modulation is of a degree and or frequency not detectable by a human observer. Moreover modulation of forms of light not generally detectable by a human observer e.g. low level infrared light which not constrained by limits on flicker perception is also contemplated and within the scope of the invention and intended whenever VLC and similar terms are used.

An example of a modulation technique employed in various embodiments is Digital Pulse Recognition DPR . This technique exploits the rolling shutter mechanism of a complementary metal oxide semiconductor CMOS image sensor such as is found in many mobile device cameras. As shall be further clarified with reference to a rolling shutter CMOS camera sequentially captures portions of each image frame whether a still photograph or a video frame on a rolling time sequential basis. These portions are typically rows of sensors e.g. charge coupled devices CCDs corresponding to lines of image pixels that are exposed for successive periods of time. A CCD may be exposed under electronic control that is may accumulate light induced electrical charges for only for a fraction of the time that it is actually illuminated by a light source. Herein exposure refers to a period of charge accumulation not a period of illumination by light. Because rows of CCDs are exposed sequentially illumination may be of a different brightness during the exposure of each row. Accordingly a time varying light source may produce row wise striping in an image frame. For example a light source modulated by a periodic waveform will tend to produce stripes of even width across a CMOS image stripe width being a function of waveform period and rolling shutter exposure timing. The frequencies of one or more distinct VLC tones can be deduced from striping patterns in an image.

For example consider the three light sources of the illustrative VLC beacon light based indoor positioning system of with the output of lights and sinusoidally modulated at respectively 500 Hz 600 Hz and 700 Hz. These frequencies are well above the human flicker fusion threshold i.e. about 60 Hz rarely as high as 120 Hz therefore undetectable to the eye. Mobile device within view of lights can detect DPR tones in light correlate detected tones with light IDs by accessing a database that links IDs to light locations as shall be shown more fully in and then geometrically calculate or receive the results of such a calculation from a server not shown in an estimate of its own location based on the locations of the detected lights . Even a single light detection would suffice for an estimate of the position of device .

The illustrative device comprises an image sensor analysis module and digital memory in order to capture images and analyze the images to determine if VLC information is present therein. To detect information encoded in ambient light the mobile device can analyze one or more image frames captured by the sensor by using the module whose logic can be implemented in any combination of hardware and software. For example the module can be an application that runs on a computational capability of the device . A network adapter enables the mobile device to connect to for example cellular telephone Bluetooth and WiFi networks. The network connection can be used to access a data source containing light ID codes linked to location data and location dependent content. Linking of ID codes to location data can also be accomplished by storing location data in the mobile device memory but the network adapter allows for greater flexibility and decreases the internal device resources needed.

Estimation of position as described above and or by other means can occur with little to no user input and can be employed in a number of ways depending on the desired application. In an illustrative case of an indoor navigation application the user would see an identifying you are here marker overlaid on a map of the indoor space they are in. In the case of content delivery the user might see on their mobile device images text videos recorded audio or other information about objects they standing near.

The microcontroller contains a nonvolatile memory storage area e.g. programmable read only memory electrically erasable programmable read only memory or Flash that stores the ID code of the light . The task of the microcontroller is to send a predetermined e.g. programmed sequence of signals to the modulator which in turn interfaces with the LED driver to modulate the visible light from the LEDs . The sequence of signals sent from the microcontroller determines the form of modulation imposed on the light from the LEDs and the information conveyed by such modulation.

In various embodiments the network may comprise a hierarchy of networks. Such a hierarchy of networks may include a network of radio frequency RF devices e.g. Bluetooth low energy transceivers that are co located with the VLC lights in an indoor space that are powered from the power source of the VLC lights and that intercommunicate with each other in a mesh topology or other network topology. The VLC lights may be controlled through the nodes of the low level RF mesh e.g. the lights ID codes modulation schemes and on off behaviors may be thus controlled . Such VLC integrated RF mesh may relay data between any devices capable of suitable RF communication with the nodes of the mesh including mobile devices stationary computers sensors smart tags robots drones and other devices.

Communications from the device to the network can include data additional to or other than light ID codes including sensor data such as but not limited to GPS coordinates compass measurements and accelerometer gyroscope data. Communications from the network to the device could include data additional to or other than location data including but not limited to recorded audio videos text and images and the selection of such data may depend on criteria that include one or more of but are not limited to device location temporal criteria historical criteria and user specific criteria. Temporal criteria can include for example time of day week month or year for example seasonal marketing and content could be automatically presented to the user of device or content in the form of morning evening or nightly specials could be presented at particular times throughout a day. Historical criteria can include user location history e.g. locations visited frequently Internet browsing history retail purchases or any other information recorded about a mobile device user. User specific criteria can include age gender past buying habits and other information as well as policies or rules set up by a user to specify the type of content they wish to receive or actions the mobile device should take based on location information. In an example of content provision based on user specific criteria a 20 year old male user may receive different advertisements and promotions than a 60 year old female user.

Illustratively the capability of the server may be physically and or logically divided into portions or areas each of which performs functions pertaining to a distinct service location. Distinct service locations are physical zones either within a single structure or at diverse locations that are served by distinct VLC systems. Each location specific server area contains databases and web service resources devoted to the location. Databases consist essentially of information pertaining to a specific service installation e.g. light IDs maps content analytics . The installation specific web service resources enable services which allow users customers administrators and developers access to ID codes indoor locations and other information.

In an illustrative VLC indoor location service the server handles incoming ID codes to appropriately return indoor location data to the network for transmission to the mobile device . Handling of ID codes can include receiving incoming ID codes searching service location specific databases to enable code to light matches calculating position coordinates based on ID codes and communicating indoor location data .

In a typical VLC enabled installation tens to hundreds of LED light sources broadcast distinctive ID codes. The purpose of the Light IDs database is to record where the ID codes are physically assigned at the installation. These records can take the form of but are not limited to GPS coordinates mapped into an indoor space. Maps in a location specific Maps database can take various physical and digital forms being obtained either directly from the service location or from third party vendors or other outside sources. A location specific Content database may contain for example ads and inventory information and a location specific Analytics database may contain for example records of user shopping behavior. Databases may in general contain static user based and or dynamic content. Static content is unchanging information associated with the specific area e.g. audio recordings streaming or stored video files texts images or links to local or remote websites. User based content is dependent on user criteria e.g. user age sex preference habits etc. Dynamic content changes with varying frequency e.g. daily weekly monthly etc.

At a typical VLC service location there is a small possibility of having duplicate ID codes since there are in practice a finite number of available codes. To deal with duplicate ID codes additional distinguishing information can be contained in the individual log records of the Light IDs data base e.g. records of ID codes of lights in physical proximity to each other. The probability of a pattern of ID code proximities being inadvertently duplicated at a single location or at more than one location can be made vanishingly small by appropriate ID generation and assignment procedures. Distinguishing information may also include sensor data including but not limited to accelerometer or gyroscope data WiFi triangulation or fingerprinting data GSM signature data infrared or Bluetooth data and ultrasonic audio data.

In various embodiments calibration of a light based positioning system herein refers minimally to the population of the Light IDs database with light IDs installed at a given service location and physical location information for those lights. In an example calibration of a light based positioning system either upon first installation or after the addition or replacement of VLC lights is performed by having a user of a mobile device equipped with an application having a calibration capacity walk around the indoor service space of the positioning system. The mobile calibration application contains map information for the indoor space with the positions of the LED light sources overlaid on the map. As the user changes position they will receive ID codes from various lights. When the user receives an ID code they will use the map on the mobile app to select which LED light source that they are standing under. Specific lights may be made to blink e.g. by commands sent through an integrated Bluetooth mesh in order to facilitate identification of lights by the user. After the user confirms the identity of a light the mobile application sends a request to the server to match the ID code detected with the light location contained in the lighting plan. In various embodiments the calibration may be automated by using robots or flying drones to quarter the indoor space associating light IDs with physical locations and potentially undertaking other calibration related functions as well e.g. performing automated laser based indoor surveying operations in order to produce highly accurate position measurements for association with light ID detections. Manual or automated calibration procedures may also be employed to acquire finely space measurements of light fields radio fields e.g. radiated by a mesh of Bluetooth transceivers or other variables throughout the volume of a served space a process herein termed fingerprinting. Thus calibration minimally includes the association of light IDs with light locations but may also include the gathering of other data including fingerprinting.

Calibration of LED light locations can also be achieved via crowd sourcing. In this method as mobile devices carried by users move around an indoor space receiving ID codes they send requests to the server containing the light ID code received. The server knows the device s current approximate position based on other positioning techniques such as WiFi GPS GSM inertial sensors etc. Given enough users machine learning algorithms running on the server can be used to accurately infer the position of each LED light source. The accuracy of this calibration method depends upon several variables including number of mobile application users. Various computational techniques including Bayesian techniques can be used to combine spatial information from a variety of sources to produce light location estimates that are improved or updated at intervals for example light location estimates from a manual or automated commissioning process can be made more accurate and complete over time by incorporating crowd source information in an iterative Bayesian process. For example a light based positioning system that was manually commissioned at first startup may be subsequently updated by crowd sourcing as lights are replaced or added.

Block Light positioning enabled denotes a conditional action to move forward if the mobile device is estimated to be within a VLC enabled area or to repeat the Estimate position function if not. Block Initiate Background Service is activated if the mobile device is estimated to have entered a VLC enabled enabled area. Service is tasked with performing the functions that obtain location information from modulated light. Block Sample ambient light sensor denotes a function to order the ambient light sensor to begin acquiring images at its inherent frame rate. Block Detect change is a conditional action that moves forward if the Service determines that the sequential image frame data show a change in observed light. The purpose of this conditional is to determine when the sensor has gone from dark to light e.g. when the user has taken the device out of a pocket . Alternatively or additionally to measuring changes in image content Service can also look for absolute brightness values in image content obviating the need to compare images and can test for mobile device accelerometer measurements above a fixed threshold e.g. to determine when the user has taken the device out of their pocket . If Detect change produces an affirmative the method moves to block Sample the image sensor after which block Continue denotes continuation of the method of from block .

In typical operation of the system mobile devices in locations detect ID codes from lights and send the codes through the network to the Database Service Application through User app . A mobile device thus obtains read only access to Maps and conditional on various criteria administered by the Database Service Application Content . The Database Service Application has built in write access to Analytics in order to record the behaviors of the accessing mobile device.

In another mode of operation of system the client connects to the Database Service Application via an appropriate access app or enabled via a password authorized login screen. Clients with administrator permissions have read write access to Light IDs read access to maps read write access to Content and read access to Analytics . Clients with developer permissions have read access to Light IDs read access to Maps read write access to Content and read access to Analytics . A client with root permissions has read write access to all databases. In various embodiments a user may access the client device at any permissions level through a device communicating with the network e.g. a mobile device or a computer at a remote location.

VLC light sources may produce patterns of stripes in rolling shutter CMOS camera images. Image processing can be used to extract transmitted signal from striping. For example consider a room containing five VLC light sources that are sinusoidally brightness modulated at 500 Hz 600 Hz 700 Hz 800 Hz and 900 Hz respectively. Each sinusoid also known as a DPR tone can be used to identify its distinctive source and thus proximity to the source and thus the approximate location of the camera . Herein we presume that the exposure parameters of the CMOS camera exposed to light from the five VLC light sources are such as to enable the appearance of unaliased detectable striping artifact in the resulting images e.g. the CMOS camera exposure time is not so short as to undersample any of the sinusoidal light signals .

Described herein are two illustrative methods for extracting DPR tone information from a rolling shutter CMOS images. One possibility when a single tone is present is to use line detection algorithms to identify the pixel width of the stripes which directly corresponds to the transmitted DPR tone frequency. This stripe width is then used to access a lookup table that associates width and transmitted frequency and determines the transmitted tones.

To recover DPR frequency content independently of the scene a background subtraction algorithm may be employed to essentially remove the scene leaving ideally only DPR striping artifact. In an example an implementation of a background subtraction method uses a video sequence of images. For any DPR tone frequency that is not an exact multiple of the video frame rate the DPR bands will shift position from one frame to another. Therefore if a sufficient number of video frames are averaged the banding effect due to periodic modulated modulation will be reduced to a constant value added to all pixels of the averaged image. If the video is of a motionless scene the averaged image will reveal only the underlying scene. This underlying scene i.e. the background may be subtracted from any individual frame to leave only the banding from illumination modulation. The effects of background scenes may also be mitigated alternatively or additionally by deliberate defocusing of the mobile device camera a form of low pass image filtering .

For video of a scene in motion simple averaging of video frames will not accurately yield the underlying scene background. In such a case motion compensation is necessary. By using standard feature recognition techniques e.g. phase correlation that will be familiar to persons versed in the art of image processing scene motion between video frames for example shifting or rotation of the whole scene due to camera movement may be detected after which each video frame may be shifted or transformed to cause it to approximately overlie the previous frame as much as possible. After performing these compensatory transforms on each frame in a series the resulting frames may be averaged to produce a scene background image that may be subtracted from one or more of the frames to reveal DPR striping. In block Perform Motion Compensation and Background Subtraction denotes these operations.

After background subtraction analysis of an FFT can be used to recover DPR tone or tones from any one frame or from an averaged frame. As will be clear to persons familiar with the science of signal processing given a series of amplitude measurements of a signal containing one or more periodic components the FFT of the series will feature peaks at the frequencies of the periodic components. Automated peak finding techniques may be applied to such an FFT to identify the frequencies of any periodic components. Block Perform Frequency Analysis to Determine Tone s denotes the performance of such analysis. In the block Return ID s denotes the matching of one or more detected DPR tones to specific VLC light ID numbers which can in turn be associated with physical light locations.

Imperfect background subtraction and or nonuniform illumination may lead to non identical pixel values across DPR stripes this effect is visible in image as nonuniform brightness along each stripe. Taking FFTs of row values along different columns of such an image may produce different results leading to ambiguity. One compensatory method is to assign the average pixel value for any given row to every pixel in that row. displays the image that results from applying row averaging to the background subtracted image of . DPR stripes e.g. stripe are highly visible and consistent. All columns of image contain the same information i.e. are simply repetitions of a single averaged column so only the averaged column need be retained for FFT.

Modulating light source may include a processor such as a microcontroller that may be configured to execute programs and process data that facilitate modulation of light from one or more LED lights . The processor may be connected to a radio frequency RF transmit receive antenna that may facilitate communication over wireless RF signals to other similarly equipped proximal devices such as other modulating light sources personal mobile devices computing devices generally RF equipped items such as appliances tools entertainment devices RF tags RF enabled network access points multi radio devices and the like.

The modulating light source of may further include one or more sensors for detecting aspects of the environment including electromagnetic emissions from nearby computing devices. The sensors may be connected to the processor to facilitate collection analysis and communication of sensor data and or data derived from the sensor data. Sensors may include ultrasonic sensors video sensors audio sensors image sensors optical sensors temperature sensors humidity sensors air quality sensors motion detection sensors chemical sensors radio frequency sensors and the like. While the aforementioned sensor examples are contemplated so are any other types of sensor that may detect an aspect of an environment into which the modulating light source may be deployed.

An RF enabled modulating light source such as the one depicted in may facilitate simultaneous Bluetooth transmission and light modulation. Position detection is one particular example of an application for such an RF enabled modulating light source . In an example RF communication between the RF capability of the light and nearby mobile devices may facilitate enhanced position detection as will be described herein. Communication among RF enabled modulating lights as well as communication between an RF enabled modulating light and a mobile device that is adapted for communication with an RF enabled modulating light may enable capabilities in position detection that may not possible or at least not as efficient with modulation of light alone. One exemplary capability is bi directional communication. While position detection via modulating light enables mobile devices to determine and thereby report their position over a network e.g. WiFi or cellular to web servers bi directional RF communication allows the detection of particular mobile devices by the light . When combined with a potential mesh type network of RF enabled modulating lights it is envisioned that a wide variety of data content inquiries promotions and the like may be effectively distributed among mobile devices that have been identified as connected to at least one RF enabled light .

More generally a network including or consisting essentially of RF enabled modulating light sources may enable the control and sensing of numerous aspects of the VLC and non VLC aspects of the lighting function of such a network any form of control and sensing that would be possible through direct hard wired connections to the nodes of such a network will in general be feasible through the RF aspect of a network of RF enabled modulating light sources.

RF communication capabilities typically comply with some network like standard such as Bluetooth. As an example a Bluetooth network standard includes unique identifiers for each Bluetooth device that is connected to a network. In a similar way each RF enabled modulating light may be configured with a unique RF identifier. This RF identifier may be used when determining a position of a properly equipped personal mobile device e.g. a personal mobile device with an RF capability a camera capability and a mobile device application for interacting with at least these two capabilities . While a capability to receive and process such an RF identifier may facilitate coarse device location it is quite common for two or more RF identifiers to be detectable in any of several positions due to the natural overlap of RF signals from nearby lights. Therefore RF identifiers alone may not be sufficient for fine position resolution. However by combining RF identifier detection with modulating light detection techniques improved accuracy and performance may be achieved.

One such way that improved performance may be achieved is through light namespace sharing. Because detection of a light identifier from a modulated light might require repeatedly receiving the modulated light to detect the specific identifier when an RF identifier is used in combination with a modulated light identifier determination of the modulated light identifier may be accelerated. This may be based on a known relationship between RF identifiers and modulated light identifiers such as through a lookup function that accesses a dataset of identifiers that associates RF identifiers with modulated light identifiers. Even if two or more RF identifiers are simultaneously detected due to RF signal overlap determination of the corresponding modulated light identifier may be much faster because the possible number of modulated light identifiers can be limited to those found in the lookup function for the simultaneously detected RF identifiers.

A network capability as depicted in may include access through a mobile device or other RF enabled device to external non mesh networks. In the example of a mobile device that may have Bluetooth and WiFi and or cellular communication capabilities may act as a gateway for communicating data to from RF enabled modulatable beacon lights. If the lights are configured into a network it may be possible for an Internet resource such as a position determination server to communicate to a networked light or by passing data through the Internet and a network access point such as a cellular tower or a WiFi router that may be in communication with a mobile device . If and or when the mobile device is in Bluetooth radio signal proximity to one of the networked lights an indirect connection may be made between the server and a light . This may allow communication of information collected from mobile devices via the RF capability e.g. identities of devices users that pass through the area by one of the lights to a remote server such as server . Although a mobile device is described as the primary gateway from the light mesh network to a wider area network any other suitable network network gateway may be used. A network network gateway may be configured in close proximity to one of the networked lights that may enable communication from at least one of the lights through networks such as Ethernet PoE Zigbee and the like. In various embodiments software installed on a mobile device that is in contact with a non mesh communications network e.g. an app voluntarily installed on a smart phone that is connected to the Internet via WiFi and or to a cell phone network facilitates the mobile device to act as a network to network gateway. In an illustrative embodiment BLE packets sent by a VLC RF mesh node to a phone are retransmitted undecrypted as payload via the telephone capability of the phone to a server controller associated with the mesh. The packets may contain any data which the mesh is capable of circulating. In another illustrative example a mobile device e.g. tablet computer contains both a a Zigbee transceiver capable of communicating with MESH of Zigbee low power nodes b an RF transceiver capable of communication with the RF capability of nodes in a VLC RF mesh c an app enabling the translation between the Zigbee informational format and the informational format of the VLC RF mesh. In effect items in communication with the VLC RF mesh would be enabled to appear as Zigbee items to the Zigbee network and vice versa. In these and various other embodiments that comprise a bridging capability whether through mobile devices or dedicated stationary multi radio devices a VLC RF mesh may be compatibly combined with a wide range of extant or traditional wireless control systems that may coexist with the VLC RF mesh in a working space or that may be non collocated with the VLC RF mesh.

Use of mobile devices as gateways between a VLC RF system and another network e.g. wireless mesh may be opportunistic e.g. mobile devices of customers who have installed an app related to the VLC RF mesh may be opportunistically enlisted as gateways as the devices move in and out of the mesh s working space. Such a gateway function may be used for example to effectively increase the bandwidth of data reporting by mesh nodes to a server controller since under various conditions packets can be communicated more quickly through a gateway than through a series of mesh node retransmissions as per the illustrative protocol discussed herein with reference to . Gateway transmission may be used alternatively or additionally to transmission through a mesh controller node connected to a non mesh network e.g. upon failure of an external connection node or device a mesh may still be enabled to communicate with a server controller by means of a gateway function carrying on its various functions while calling for diagnosis and repair of the failure. The bridging and gateway functions of various embodiments are exemplified in .

In various embodiments the position determination server is a general purpose mesh server and controller back end that performs functions other than or additional to position determination issuing commands to the RF and or lighting capabilities of one or many network nodes polling network nodes for information garnered from sensors and so on. A general purpose back end may be enabled to understand the locations movements and other aspects of mobile devices and other assets within the service area of the VLC RF network mesh. Illustrative capabilities include inventorying assisted navigation and reality augmentation RF asset tag location tracking robot and drone tracking time of day based control real time user tailored control of active assets e.g. video displays security management routine customer assistance emergency assistance ambience adjustment e.g. music lighting and other environmental adjustments in response to sensed user behaviors and more. In another example routine scan advertising packet broadcasts from Bluetooth capable mobile devices are detected by the RF capability of nodes enabling a mode of position estimation of the mobile device based on received signal strength indication RSSI and or node detection pattern. Such estimates may be combined with estimates based on detection of VLC beacons by a light sensing capability of the mobile device e.g. after the device user is prompted to expose their device to light based on detection of their presence by the RF mode.

Reference is now made to . Communication from light to light and of the light network with a server as described above with reference to may allow automatic configuration of identification data for each light so that when a new or replacement light is added to an existing ad hoc network of lights the processor in the light may communicate via the RF capability with other lights to determine which light identifiers are already in use and so ensure that the new light adopts a distinctive identifier ID . Automatic configuration of a light may facilitate determination by a newly added light that it is new to the network and may also facilitate determining which light was most recently added by communicating initialization and or configuration data over the mesh like network with the other lights. This may also facilitate determining a positioning of the light if the lights are installed in a known order such as starting at one end of an aisle and proceeding down the aisle. Similarly RF IDs may be changed dynamically yet remain unique within a configuration via light to light RF ID communication via such a network. schematically depicts steps of an illustrative method according to some embodiments of self commissioning of a light i.e. New Light just added to an existing network of one or more lights already commissioned. Upon first power up New Light possesses a factory default ID e.g. a string of zeroes possessed by all new lights and a firmware pointer causing New Light to undertake Action One Advertise a query to all nodes in network asking them to reply with own ID with packets addressed to New Light ID. New Light then performs Action Two For a time interval T e.g. one minute long enough to give all nodes in a mesh of maximal size time to reply listen for responses from mesh nodes with IDs and during that interval collect a list of all IDs delivered. After interval T New Light undertakes Action Three self assign a random ID other than its factory default and all IDs if any received alert the server of its new ID and proceed to Action . In Action New Light commences routine node operation per mesh protocols and or continues a commissioning process whereby the physical location of New Light is determined and stored in the server . Various embodiments may employ other steps in a self commissioning process of a new light e.g. steps that enable a automatic determination of new to this mesh status by a previously used but newly installed light i.e. a light not possessing factory settings b automatic determination of First Node in New Mesh status and c automatic positional determination of a new light e.g. I am in fixture Aisle based on measurements of radio signal strength from other nodes in the network as described elsewhere herein.

The number of light and RF IDs and hashes producible by a finite number of bits is finite by definition. Therefore given the manufacture of sufficiently large numbers of VLC RF nodes the repetition of possible identifiers both pre and post hash is inevitable. It follows that with some probability non unique identifiers may absent potentially burdensome tracking techniques be deployed within a single working space or in multiple working spaces. A mobile device that seeks for example to identify what store it is in by detecting a single node identifier may be caused to err by ID repetition. The likelihood of such errors can be reduced to an insignificant level by using combinations of two or more light and or RF IDs as position identifiers presumed to be unique. If IDs are randomly assigned and located in an independent manner and that the probability of the probability of any single combination of a number P IDs being identical to any other single combination of P IDs is approximately proportional to p where pis the probability of an ID repetition occurring in a given working space. Thus for example if p 1 10 then the probability of repeating a group of P 4 IDs is p 1 10 1 10 a number sufficiently small to ignore in real world applications.

It is generally advantageous to piggyback the powering of the RF capability of a VLC RF light onto the arrangements for powering the light as depicted in since in typical working spaces e.g. retail stores mains power is architecturally supplied for a lighting system regardless of intent to install a VLC or VLC RF system. In various other embodiments the RF transceiver may be entirely battery powered or powered by harvesting acoustic RF and or optical energy from its environment e.g. an RF transceiver capability of a light may be powered by a photovoltaic cell illuminated by the light itself and or adjacent lights and or daylighting enabling the RF transceiver to be installed simply by attaching it to the ceiling near a light . Without limitation all such powering arrangements wired battery powered ambient energy powered or any combination thereof are contemplated and within the scope of the invention.

In the illustrative embodiment the RF transceiver capability of the nodes in is of the digital packet type that is each RF transceiver broadcasts bits sequentially according to some physical modulation scheme and the transmitted bits constitute groups or packets of fixed or in some realizations variable length. The bits of each packet as shall be clarified in for one illustrative embodiment in are divided schematically into a string of contiguous fields or sub groups. The packet fields may include information identifying the packet itself the transmitter of the packet e.g. Node a and the intended recipient of the packet e.g. all nodes Node c all nodes in Group Two commands e.g. turn off your light data collected by sensors e.g. temperature and other information. The broadcast of some packets may be required by an RF interoperability standard such as the Bluetooth standard other packets while conforming to the standard may be transmitted optionally and may enwrap information in a manner that constitutes a communications channel. In broadcasting required packets e.g. Bluetooth advertisement packets will preferably be given broadcast priority and optional packets will be broadcast opportunistically.

The mesh of operates in a waterfall or non routed fashion that is each node transmits packets to all nodes within physical range and receives packets from all nodes within range and rebroadcasts and or acts upon the packet subject to certain rules to all nodes within range. Some of the rules governing responses to received packets are as follows 

It will be clear to persons versed in the science of network communications that the above rules are necessary and sufficient to assure that packets first broadcast by any node of the mesh will be communicated to every other node in the mesh and will cease to be rebroadcast by nodes in the mesh after a number of broadcast events not greater than the number of nodes in the mesh and potentially much smaller. It will also be clear that these rules are exemplary and that in various other embodiments rule sets differing in various particulars from the example given and likely more extensive would also enable the practical operation of a packet type unrouted VLC RF mesh e.g. a BLE mesh . All such variations are contemplated and within the scope of the invention as is the use of network topologies e.g. bus ring star tree other than the illustrative mesh topology of .

In the illustrative mesh each node s RF capability includes or consists essentially of a single antenna that may only transmit or receive at any given time a node therefore listens for packets except when it is transmitting a packet. While transmitting a mesh may miss be deaf to a packet broadcast by one or more other nodes. Although this potentially allows packets to disappear prematurely from the mesh in various embodiments the VLC RF mesh may incorporate at least two features that adequately mitigate the problem of packet dropping 1 for a given packet to be dropped by a mesh comprising asynchronous nodes all nodes within receiving range of all other nodes broadcasting that packet must attempt transmission of that packet or some other simultaneously and this is highly unlikely in an asynchronous mesh and 2 as described further hereinbelow a packet definition standard may permit the inclusion of a response command that requires a receiving node to transmit a confirmation packet back through the mesh. Failure by a mesh controller node to receive a response packet may trigger presumption of a packet drop loss either of the original packet or of the confirmation packet and thus rebroadcast of the original packet. This process may be repeated until a timeout is reached and a network failure flag is raised or until packet receipt is confirmed.

In the progress of a single packet through an illustrative VLC RF mesh is schematically illustrated. The packet not shown is either delivered to Node a from a device or network outside the mesh or is constructed within Node a by appropriate devices comprised by the node or a packet may originate within any other node in the mesh . In the case illustrated Node a broadcasts advertises the packet. In receipt of a packet broadcast by a node is indicated by an arrow drawn between the broadcasting node and the receiving node e.g. in the broadcast from Node a is received by Node b Node c and Node d . No other nodes in the mesh are within physical receiving range of Node a . At the head of each arrow denoting successful transmission a mark within the receiving node denotes the fate of packet 1 A check mark indicates that the node simply rebroadcasts the packet 2 a bull s eye indicates that the node consumes the packet which may or may not entail rebroadcasting and c an X indicates that the node kills the packet.

In Node e Node f and Node g constitute a group Group One within the mesh e.g. lights in a particular section of a retail space . The packet protocol of mesh enables commands be broadcast through the mesh that are executed by all nodes in Group One and by no others nodes in a Group may also be individually addressed and controlled. In the state of mesh operation depicted in the light capability of Node e Node f and Node g is On as indicated by open cones attached to the nodes of Group One e.g. cone . The illustrative packet transmitted by Node a is addressed to the nodes of Group One and contains a command to turn off the lights.

In the broadcast from Node a has been received by Node b Node c and Node d . None of these nodes find the packet ID in memory nor find that they are addressed by the packet. They therefore rebroadcast the packet as indicated by the checkmarks in the node symbols.

Since Node e is in Group One to which the packet is addressed upon examining the packet Node e finds a command addressed to itself and its fellow group members. Node e therefore consumes the packet i.e. turns off its light and puts the packet on its broadcast queue. In the turning off of the light capability of Node e is represented by blackening in of the cone .

Typically one node in the mesh is denoted a mesh controller which has unique authority within a given mesh to issue commands receive data and communicate with a device mesh or network outside the mesh. The mesh controller node may be a VLC RF node or another Bluetooth capable device e.g. phone laptop server joint Bluetooth WiFi device . In various embodiments as is clarified further hereinbelow with reference to a packet may contain a command response field that set to an active state instructs addressee nodes to transmit packets acknowledging receipt and execution of the command packet or returning data to the mesh controller. For example if Node a of were designated a mesh controller and the packet transmitted in the illustrative packet history included an active command response flag the state of operation of would be followed by transmission of response packets by the three nodes of Group One which response packets would contain information confirming the dousing of the Group s lights and which would cease to propagate through the mesh only after having been consumed by Node a . In general a mesh controller may poll other nodes in a mesh for a range of information including the operational state of its various capabilities sensor data ID data LED operational history e.g. current voltage ambient temperature and the like. Also a mesh controller may issue commands changing both RF and VLC identity codes and other operational parameters of nodes or changing the operational states of lights and RF transceivers and may demand confirmation of the receipt and execution of such commands and may communicate with devices meshes servers networks and the like outside the mesh.

Commands propagated throughout the mesh from a mesh controller may enable a number of functions all of which are intended and within the scope of the invention. Without limitation these include a light brightness control on off dimming flashing VLC message programming etc. directional control of lights equipped with mechanical activators retrieval of data from sensors and retrieval of data collected by the RF capability of the mesh from mobile devices tags other nodes and the like.

In various embodiments provision is made for automatic specification of a mesh controller node either upon system startup or in the event of failure of the designated mesh controller node alternatively or additionally the mesh may be configured to operate autonomously in one or more pre determined default modes in the event that a mesh controller ceases to operate. For example in the absence of commands from a mesh controller the mesh nodes may be programmed to broadcast VLC beacon ID information and keep the lights on until further notice and record sensor data in RAM in a wraparound fashion that records a moving window of most recent readings.

Each VLC RF packet may be 31 bytes long where a byte is defined as 8 bits an octet . Each packet may be an Advertising packet i.e. a packet containing identification or command information or a Scan Response packet i.e. a packet containing data solicited by a controller including information about receipt of Advertising packets execution of commands therein etc. Advertising and Command Response packets differ in function and content but not in format. Each packet comprises a Significant Part and a Nonsignificant Part the Significant Part may occupy the whole of the packet. Within the Significant Part or packet payload may be broken down into a collection of Advertisement Data AD Structures each as indicated in composed of a single byte specifying the length of the AD Structure a single byte specifying the AD Structure type and some number of bytes of AD Data. Type identifiers for AD Structures are typically assigned numbers by the Bluetooth Special Interest Group.

In a preferred embodiment the VLC RF packet contains a single AD Structure that may occupy up to the whole 31 bytes of the packet this maximizes the non overhead payload content of the packet. Thus of the 31 packet bytes 1 is occupied by the AD Length specification byte 1 is occupied by the AD Type specification byte and up to 29 bytes are occupied by a Mesh Message. The AD Type specification byte is set to 0xFF the Bluetooth code for Manufacturer Specific Data. To distinguish a Mesh packet from other Manufacturer Specific Advertising Data packets that may be sent e.g. to mobile devices in the working space of the VLC RF system each Mesh Message will begin with a fixed Mesh Specific Sequence MSS of 2 bytes fixed at some arbitrary value e.g. 0xB1BC .

The remainder of the Mesh Message up to 27 bytes consists of encrypted packet contents. Encryption prevents unauthorized users from taking control of the VLC RF mesh and its functions e.g. turning lights on and off or harvesting information from the mesh. Nodes will decrypt a packet if they determine that it is not on their Seen list and examine its contents to see if they are an addressee of the packet. Encryption may be by a variety of cryptographic techniques in one embodiment a reversible cryptographic hash is employed. A portion of the encrypted packet contents e.g. 2 bytes possibly up to and including the entire encrypted packet contents is employed as a quasi unique packet identifier quasi unique because although the number of possible M bit strings is large for nontrivial M it cannot be infinite hence the need for ID re use as discussed hereinabove with reference to . This packet identifier may be the string employed by nodes for identifying packets as seen or not seen as discussed hereinabove with reference to the illustrative mesh of .

The pre encrypted or decrypted portion of the packet payload consists of a an octet of 8 1 bit flags b the 3 byte ID code of the VLC RF node originating the packet c the 3 byte ID code of the addressee which may be either a single node or a group of nodes and d a Mesh Payload of up to 18 bytes length containing Commands and Parameters.

The AD structure of the VLC RF packet is as follows where N 31 is the number of bytes in the AD Structure 

The functions of the Flags Byte bits are further explained as follows 1 Bit the Group bit is 0 if the destination address field is an individual node address or 1 if the destination addressee field denotes a group number where Group Address 0 denotes indiscriminate broadcast . 2 Bit . the Response bit is 0 if the receiving node should not generate a response packet and 1 if the receiving node should generate a response packet. 3 Bits the three bit Channel ID field enable the specification of 8 2 channels. Each channel may be reserved for the use of a particular mesh. Thus if the physical broadcast and reception spaces of nearby meshes e.g. on adjacent floors of a building overlap traffic may still be segregated between the meshes by use of the Channel ID field. Each node in each mesh is programmed during system commissioning with its own Channel ID and if a received packet contains another Channel ID the node kills the packet.

The Command field and Parameters within the Mesh Payload field may be designated as follows 1 A single byte may be devoted to specifying a Command this allows the definition of 256 2 distinct Commands which is ample for the operation of a VLC RF mesh in various embodiments. Examples of Command field values include Set Mesh Controller Node ID Response Packet signifying that this packet is a response packet Set Light Brightness Level Blink Light Set VLC Beacon ID Device Data Channel signifying that the packet payload consists of data being transmitted on a virtual channel above the packet layer and others. 2 Parameters may contain data of any kind including RF node IDs VLC node IDs light brightness level specifiers portions of multi packet commands data for transmission to mobile devices in the service space and a variety of other control commissioning and communications data. The Parameters field enables the VLC RF packet protocol to act as is common for packet protocols as the basis for a structure of one or more virtual data channels that convey messages broken into fragments for transmission in packets. The bit rate of such virtual channels must always be less than the physical bit rate of the packet layer but there are few constraints on the informational character of such virtual channels which may include field definitions error correction encryption packet structure and any other features capable of embodiment in a digital data stream.

Packet life cycle has already been partly described with reference to . In various embodiments two numerical parameters are defined for the whole RF capability of the mesh e.g. programmed into the nonvolatile memory of all RF nodes during commissioning of the mesh namely 1 ADV PER PKT and 2 ADV SEEN TIME LIMIT. ADV PER PKT is the number of times a mesh packet will be advertised by each mesh node e.g. once if the packet is to be advertised. ADV SEEN TIME LIMIT is the number of seconds after receipt e.g. two that a packet ID expires i.e. is deleted from the packet ID stack in node memory . ADV PER PKT constrains the amount of traffic across the mesh that will be entailed by the transmission of each packet ADV SEEN TIME LIMIT tends to constrain the lifetime of a packet in the mesh although transmission through node rings and other cases for sufficiently large meshes could enable packets to ring through the mesh even after ADV SEEN TIME LIMIT has expired . Decreasing either or both parameters tends to decrease the probability that a packet will be dropped increasing either or both parameters tends to increase the lifetime of each packet in the mesh and so limit the effective bandwidth of the mesh as a whole.

It will be clear to a person familiar with the science of network communications that the foregoing packet and mesh specifications may in various embodiments be varied in many particulars without substantively altering the capabilities and applications of a VLC RF described herein.

In various embodiments powering of RF tags and other devices in the working space of the VLC RF system may be achieved by harvesting of RF energy from RF transmissions of the system from illumination provided by the system or from acoustic energy provided by the working area environment and or by an acoustic e.g. ultrasonic capability of the VLC RF system. Recent technological developments have increasingly enabled the harvesting of very small quantities of electromagnetic or mechanical energy from environments. For example all receiving antennae intrinsically collect broadcast electromagnetic energy which may be utilized for its information content its energy content or both. Also piezoelectric and electromechanical devices e.g. piezoelectric films and microelectromechanical devices can convert acoustic energy to electrical energy which likewise may provide information energy or both. Photoelectric devices can harvest energy from light for either sensing or power. One or more of these energy harvesting modalities may be employed in devices. In various embodiments a VLC RF system powers one or more energy harvesting devices EHDs in its working area by broadcasting one or more of a ordinary Bluetooth signals in a nondirectional manner b Bluetooth signals in a directional manner e.g. as described hereinabove with reference to c non communicative RF signals matched to the receiving capabilities of EHDs d ultrasonic signals matched to the matched to the receiving capabilities of EHDs e VLC illumination and or noncommunicative illumination and f infrared VLC and or noncommunicative illumination in a manner matched to the receiving capabilities of EHDs. RF powering of EHDs is preferred because RF waves unlike light and ultrasound readily pass through most objects and materials commonly found in the intended working spaces of such a system moreover RF direction of energy e.g. by phased array beam steering or mechanical beam steering as described hereinabove with reference to may allow more energetically higher efficiency powering of EHDs whose locations are known. EHDs may be stationary or mobile and without limitation may include RF product tags sensors and LEDs.

Reference is now made to which schematically depicts an illustrative system in which a lighting mesh features a capability for communication with radio powered EHDs e.g. a tag . Radio broadcasts from or more nodes of the mesh may be received by one or more tags . Each tag in this illustrative embodiment includes or consists essentially of an antenna an energy storing capability e.g. a capacitor and an information processing capability . The tag antenna is capable of both receiving radio waves whether from nodes of the network or from other sources and of transmitting radio waves as symbolized by the two sets of ripple lines associated with the antenna . When the antenna receives radio waves some of which may be transmitted by one or more nodes in the mesh some of the energy in those waves is stored in the energy storing capability . When a sufficient amount of energy has been stored by the storage capability the information processing capability may be powered for some interval. Its functions may include recording data received through the antenna and transmitting information e.g. an ID code of the tag through the antenna . Transmissions by tags may be received by nodes in the network enabling location detection of tags and or by other tags. In various embodiments tags may in general perform all the functions of continuously powered nodes in the main network as well as tag specific functions enabling the tags to function as a passively powered secondary network or extension of the continuously powered network . EHDs of various capabilities not shown may be present within the system . In various other embodiments EHDs may harvest forms of energy additional to or other than radio waves radio waves may be spatially directed toward EHDs by nodes of the network and other capabilities may be included or omitted.

A technique for estimating the positions of tags nodes and other components in communication with a lighting mesh and that may be enabled by RF capable modulating beacon lights is RF signal based triangulation to determine an approximate position of a mobile device. This approximate position may be further narrowed through the use of the modulated beacon light data from lights in proximity to the approximate position. In various embodiments RF position determination may employ received signal strength indicator RSSI a measurement of the power present in a received radio signal to determine the location of an RF capable mobile device. Since RF energy per unit area received from an omnidirectional transmitter such as most mobile devices employ drops by the inverse square of distance RF transceivers closer to the cell phone will measure stronger RSSI for the advertising packets. Alternatively or additionally a mobile device may make RSSI measurements of broadcasts from one or more RF capable modulating beacon lights which measurements may then be used to estimate the device s position by triangulation possibly taking into account non omnidirectionality of RF transceiver broadcasts. Either the raw RSSI measurements or a position estimate calculated by the mobile device itself from those measurements may be reported by the device to a server back end or controller through the RF capability of the VLC RF mesh or via another channel with which the mobile device is in contact e.g. a cell phone network . In another illustrative embodiment BLE advertising packets broadcast by a cell phone are detected by one or more RF transceivers of a VLC RF mesh. The RF transceivers are preferably located in a common plane e.g. the ceiling of a store however RSSI may be used for mobile device position estimation even if RF transceiver locations are non coplanar if their three dimensional locations are accurately known. These measurements may be reported through the mesh or via the mobile device employed as a gateway or via one or more other mobile devices or nodes employed as gateways to a mesh controller node or computer that contains software capable of algebraically estimating transmitter location from the RSSI measurements. RSSI measurements at a single moment or over a short interval may be used by the VLC RF mesh and associated computing devices for position estimation of broadcasting device. Repeated position estimates by such means enable the estimation of transmitter dynamics velocity acceleration and movement history. Doppler measurements at a single moment or over a short interval may alternatively or additionally be used in estimating device dynamics.

RSSI measurements similarly reported to and analyzed by a computer within the mesh or in communication with it may also be used by RF transceivers of a VLC RF mesh to estimate their own relative positions. In a preferred embodiment the RF transceivers are located in a common plane e.g. the ceiling of a store increasing the likelihood of a unique solution for the location of a multiplicity of RF transceivers given their mutual observations of RSSI. In various embodiments RF transceivers may transmit packet or non packet signals during a commissioning process or other process of net geometry determination based on mutual RSSI measurements the broadcast of such signals e.g. packets pings sinusoids ramped sinusoids may be controlled on a node by node basis through the VLC RF mesh in a manner that increases the informational content of a set of RSSI measurements. The results of an RF net geometry determination may be combined computationally with the results of a visible light net geometry determination based on e.g. results of fingerprinting measurements of light beacon intensity RSSI or other measurable features of wave fields within the working space. The results of an RF and or VLC net geometry determination may also be used in a directed type network to set up routing tables for network nodes.

Several geometrical constraints are now noted. Two spheres whose centers are separated by a distance greater than the difference of their radii and not greater than the sum of their radii intersect along a circle. Two RSSI i.e. radii measurements therefore do not suffice to disambiguate the location of a mobile device the mobile device might be anywhere on a circle determined by the two measured distances and the locations of the nodes measuring them. Moreover three or more spheres having collinear centers can always be positioned so that all intersect on a circle. Thus even when three or more radii are measured collinear RSSI measuring nodes can produce ambiguous location estimates for a mobile device. Finally all arrangements of intersecting spheres having coplanar centers intersect at points or along circles that are symmetrical above and below the plane. There is thus always ambiguity in location estimates derived from a coplanar set of RF nodes about whether the detected transmitter is above or below the plane. All such ambiguities may be avoided in various embodiments by providing that a system using RSSI measurements for location estimation comprises at least four RF nodes one of which is non coplanar with the others. For example in a system comprising a three or more coplanar nodes in a ceiling one or more out of plane Disambiguation Nodes can also be installed. Each such node will always be more proximate to or distant from a mobile device that is below or above the ceiling plane thus eliminating ambiguity.

RF position estimation of passive EHD tags and or sensors linked to assets e.g. merchandise robots furniture clothing within a working space maybe be used by the VLC RF mesh for asset position mapping inventorying theft detection and related purposes. Alternatively or additionally battery powered sensors or asset linked tags may communicate with the mesh. In an illustrative embodiment the VLC RF system is used as a backbone network for network tracking as follows EHD or battery powered modules comprising an RF capability regularly broadcast BLE packets that a contain encrypted data based on sensors variously comprised by modules such as temperature humidity CO or COor other gas levels occupancy RF spectrum monitoring audio recording brightness sensing floor vibration and other and that b when received by one or more VLC RF nodes enable the location of module through RSSI triangulation on the module. In this example a generic base module having an RF capability allows for the physical plug in of multiple sensor modules for customization. The sensing network i.e. modules plus VLC RF mesh is managed via a cloud based system accessed through the web via a representational state transfer REST application programming interface API . Asset tracking by a back end may be enabled by communication between the mesh and the tag modules. Firmware updating and other control of tag modules may also be managed through the mesh. Such a system may enable simultaneous asset spatial tracking inventorying space usage characterization environmental characterization theft detection and other data driven functions

A single microcontroller in a VLC RF node may be programmed to perform all light modulation and RF communication capabilities using timed routines or functions. The microcontroller may be configured to constantly broadcast and receive an RF signal while also ensuring that the modulation of the light e.g. on off state is properly operated so as to provide the right modulation light function while avoiding human visible flicker in the light output.

An alternate configuration may include a separate in line RF communication module that may be disposed in line with a modulating beacon light. This combination may allow each physical combination of RF capability and modulating light capability to achieve capabilities that are similar to the integrated embodiment described such as in above.

Various embodiments of the present invention incorporate RF devices e.g. the Broadcom BCM4358 802.11ac WiFi 2 2 Multiple Input Multiple Output chip and similar devices capable of BLE transceiving that intrinsically determine Angle of Arrival AOA information for received RF signals. Such information may be used independently of VLC and RSSI information to estimate the position of a mobile device. In an illustrative case such estimation is performed as follows 

1 Upon reception of a signal from the user s mobile device the RF capability of a VLC RF node measures AOA of the signal and sends that information along with the node s own distinctive ID information back to the mobile device via the standard BLE protocol.

2 The mobile device accumulates and time correlates based on reception time these Angle of Arrival ID data sets from one two or more nodes in the lighting system.

3 The mobile device computes a location estimate from at least two Angle of Arrival ID data sets transmitted to the mobile device by mesh nodes. For example the device may group the three closest in time AOA measurements from distinct nodes and use these angles along with the known locations of the nodes as determined from their IDs to form a two or three dimensional position estimate of the mobile device. In an illustrative two dimensional planar case if two nodes have measured an AOA of a broadcast from a mobile device one may draw a line passing through each node at the measured angle whereupon the intersection of the two lines estimates the location of the mobile device. A similar approach can be used for three dimensional position estimates using AOA measurements and known node locations from three or more nodes.

4 A position estimate based on AOA information may be augmented by positional estimation using RSSI measurements VLC beaconing and other sources of positional information e.g. inertial measurements . For example it will be clear to persons familiar with the science of probability and statistics that Bayes s Theorem may be used to make an optimal position estimate based on multiple sources of positional information. In a Bayesian approach the position estimate is a 2D or 3D random variable having some prior distribution distribution of uncertainty prior to the receipt of first data or additional data with new AOA RSSI and VLC positional information constituting evidence that is used to update the prior. The posterior distribution updated prior of mobile device position may then be used as a prior distribution for a new iterative round of estimation as additional evidence becomes available. Such an approach may maximize the likely accuracy of position estimates in a position estimation system gathering positional information from multiple modalities. In various other embodiments non Bayesian methods of combining positional information from two or more sources or from a time series of measurements are employed.

In another illustrative embodiment which may be implemented alternatively or additionally to the case just described a mobile device measures AOA of packets broadcast by two or more RF nodes in a VLC RF mesh and receives distinctive ID information from those nodes. Physical node locations derived from the ID information combined with the AOA measurements enable the mobile device to mathematically estimate its own location. In another illustrative embodiment a mobile device measures AOA and IDs for node broadcasts while nodes simultaneously measure AOA and ID for the mobile device and all these data are combined algorithmically whether by a computational capability of the nodes a node controller the mobile device or another device into a single position estimate for the mobile device. Such an estimate may be combined with positional estimate information from other modalities. Moreover as discussed hereinabove for RSSI measurements nodes in a mesh may use mutual AOA measurements in order to produce or augment information about mesh node geometry. Such information may be used to assist or automate commissioning or updating of a mesh map routing tables etc.

Coordination of light function may be accomplished via RF enabled modulatable lights. This may allow for certain lights to temporarily produce a particular modulation signal emit a particular color and the like. In a retail environment such a temporary use may be used to indicate a special offer or otherwise bring a shopper s attention to a particular position in the retail space. Likewise information offers content and the like could be transmitted from RF enabled lights to nearby mobile devices thereby effectively providing in store notification of certain specials and the like without requiring a formal site wide customer accessible WiFi network or relying on external private wide area network use e.g. cellular networks .

A network of RF enabled position determining lights may enable light to light coordination. Functions such as synchronized modulation phase locked modulation duplicated modulation signal broadcasting to strengthen a particular modulation ID signal simultaneous modulation to reduce destructive interference and the like may be implemented. Control of any one light or a group of lights may help with trouble conditions such as directing emergency personnel to a position in a large warehouse type store to assist a person in need of medical help.

An application such as a smart phone application may be used to facilitate configuring and optionally controlling a lighting setup for a location. To prevent random programmers from taking control of the lighting setup security measures such as encryption and multi factor authentication may be used. Such an application may depict a visual map of a lighting setup so that accessing e.g. via a touch screen any of the lights in the map may allow the user to control the selected light e.g. cause it to visibly blink turn off turn on stop broadcasting a modulation signal run a diagnostic or setup function and the like .

Modulated light position determination may be combined with RF position determination in an integrated LED based light and user specific profile data to inform a content server of a position of a nearby mobile device user. In an illustrative embodiment the content server may then deliver user targeted content to a nearby screen e.g. advertising screen that is proximal to the determined position of the mobile device user. Alternatively or additionally the content server may deliver user targeted content to other media e.g. speakers proximal to the determined position of the mobile device user or to one or more mobile devices of the user. Position determination may be used to direct personnel to the assistance of a user in the working space e.g. personnel may be equipped with mobile devices that inform them of a real time mesh enabled position estimate of a mobile device user who has requested personal attention and so be enabled to rendezvous with the user even if the user s position changes after the personnel are dispatched.

Bluetooth networking capabilities that facilitate rapid delivery across a network of a high priority information packet may be exploited in a network of RF enabled modulating beacon lights to ensure rapid delivery of content e.g. advertisements from a server through the light based RF network to a user s mobile device that is connected to the light based RF network.

Commissioning of a newly installed or revised lighting network may be facilitated by capabilities of a VLC RF mesh. For example in a commissioning process where a commissioner carrying a mobile device assigns location information to specific ceiling lights and has just assigned a location to a light the commissioner may wish to identify a next light for commissioning. However a plethora of lights may be candidates. Via the RF capability of a VLC RF mesh the commissioner may request that candidate lights in their vicinity and proximate to the light just commissioned be made to blink. By means of RSSI measurements reported through the mesh to a back end proximity of candidate lights to the light just commissioned can be determined narrowing the field of candidates and speeding the commissioning process. is a schematic depiction of aspects of a commissioning process of a lighting mesh . The locations of some or all of the nodes of the mesh are not initially known. A commissioner carries a mobile device and wishes to associate a physical location with a next light in the mesh e.g. the light . Having previously commissioned a nearby node the commissioner sends a command through e.g. an RF capability of their mobile device to flash lights in the vicinity of the nearby node . By means of RSSI measurements of node and possibly other nodes the back end of the mesh knows that light is near the node and causes the light to flash indicated by striped trapezoid under light . The commissioner then knows which light is the next to commission and determines a physical location for the light e.g. using indoor survey equipment . The physical location of light is then associated by the back end of the mesh with that light and the commissioner may proceed to associate physical location data with other lights in the mesh. In various operating scenarios and various embodiments other procedures may be followed for light commissioning assisted by an RSSI capability and other RF capabilities of lights.

In various RF communications systems such as some standards proposed for cell phones IDs broadcast by mobile devices are changed randomly to prevent unwanted location monitoring surveillance of mobile device users. However such random periodic ID shifting may defeat location tracking desired by a user e.g. a user who has installed an enterprise specific app enabling their device to communicate with an in store location detection system. The RF capability of a VLC RF mesh may enable location tracking of a user despite random ID shifting. For example a BLE capable mobile device with random periodic ID shifting will advertise a given ID a number of times before changing its ID. Pairing one or more spatially correlated location and movement estimates VLC RF or both with a series of RF ID receptions may enable the probabilistic e.g. Bayesian assignment of a consistent device identity to a transmitter despite random periodic ID shifting. Such position tracking will tend to be made more accurate by VLC based higher resolution position estimates of the mobile device typically dependent on software voluntarily installed on the user s device and therefore mitigative of privacy concerns. Location based services and information may therefore continue to be delivered to a customer participating in a location tracking system.

Having described one embodiment of the invention it will be apparent to those of ordinary skill in the art that other embodiments incorporating the concepts disclosed herein may be used without departing from the spirit and scope of the invention. The described embodiments are to be considered in all respects as only illustrative and not restrictive.

