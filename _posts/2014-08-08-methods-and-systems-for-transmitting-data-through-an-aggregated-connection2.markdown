---

title: Methods and systems for transmitting data through an aggregated connection
abstract: The present invention discloses methods and systems for processing data packets received at a first network node and for processing encapsulating packets received at a second network node. The first network node receives data packets from its network interface. It then selects a first tunnel and selects none or at least one second tunnel according to a selection policy. Original encapsulating packets (OEPs) are transmitted to a second network node through the first tunnel and at least one duplicate encapsulating packet (DEP) is transmitted through the at least one second tunnel. The second network node receives an encapsulating packet with a global sequence number (GSN) through an aggregated connection. The second network node determines whether one or more data packets corresponding to the encapsulating packet have been received earlier. The second network node may then determine whether or not to forward the one or more data packets.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09584443&OS=09584443&RS=09584443
owner: PISMO LABS TECHNOLOGY LIMITED
number: 09584443
owner_city: Hong Kong
owner_country: HK
publication_date: 20140808
---
The present application is a Non provisional Continuation in part Application which claims the benefits of and is based on Non provisional application Ser. No. 12 646 774 titled Throughput Optimization for Bonded Variable Bandwidth Connections filed on 23 Dec. 2009.

The present invention relates in general to the field of computer networks. More particularly the present invention relates to methods and systems for processing data packets encapsulating packets and duplicate encapsulating packets transmitted through an aggregated connection with a plurality of tunnels.

A multi Wide Area Network WAN Site to Site VPN router is a router that supports aggregating the bandwidth of multiple interconnections e.g. WAN connections for accessing one or more remote private networks. In some implementations each TCP IP session is routed to only one WAN. In this configuration a single TCP file transfer session can only utilize the bandwidth of one WAN connection on each end. For example in a session based site to site virtual private network VPN connection VPN traffic is routed to multiple WAN connections between two sites e.g. sites A and B .

In one implementation M N tunnels are initially formed between the WAN connections where M and N are the number of WAN network connections of site A and site B respectively. Application TCP IP sessions are then routed over the different tunnels. It is notable however that while a session based site to site VPN is able to utilize different tunnels for different sessions a single download session in this type of connection is only able to utilize one tunnel.

In wireless communications quality of packet transmission may be unpredictable and packet drop rate may change frequently. This may reduce the quality of the overall packet transmission. Even if the bandwidth limit of each tunnel is high the packet drop rate may not improve. A solution is required for utilizing multiple tunnels for increasing the probability of successfully transmitting data which may be achieved by using duplicate packets.

The present invention discloses methods and systems for processing data packets received at a first network node. When the first network node receives data packets from a network interface of the first network node the first network node selects a first tunnel according to a selection policy and also selects none or at least one second tunnel according to the selection policy. The first network node then transmits original encapsulating packets OEPs through the first tunnel. The OEPs encapsulate the data packets and each of the OEPs has an original encapsulating packet global sequence number OEP GSN . The OEP GSN is stored in a field of the each of the OEPs. The first network node also transmits at least one duplicate encapsulating packet DEP through the at least one second tunnel when at least one second tunnel is selected. The at least one DEP encapsulates at least one of the data packets. Each of the at least one DEP has a duplicate encapsulating packet global sequence number DEP GSN which is stored in a field of each of the at least one DEP.

The first tunnel and the at least one second tunnel may be comprised in an aggregated connection. The selection policy is based on one or more of the following criteria user selection performance of a plurality of tunnels service provider usage limit location time usage price security user identity Internet Protocol address range communication protocol communication technology application and device. According to one of the embodiments the performance of the first tunnel is determined to be better than the performance of the second tunnel and the performance is substantially based on latency and bandwidth of the tunnels.

According to one of the embodiments the OEP GSN of an OEP is the same as the DEP GSN of the at least one DEP.

According to one of the embodiments the at least one DEP comprises a list of OEP GSN. The list of OEP GSN contains at least one OEP GSN.

According to one of the embodiments when a plurality of DEPs are transmitted for each OEP each of the plurality of DEPs is transmitted through a different tunnel of the aggregated connection.

The present invention further discloses methods and systems for processing encapsulating packets received through an aggregated connection from the first network node at a second network node. The second network node receives an encapsulating packet through one of tunnels of the aggregated connection. The encapsulating packet can be an OEP or a DEP. When the encapsulating packet is an OEP it encapsulates data packet s . Alternatively when the encapsulating packet is a DEP it encapsulates data packet information which is substantially based on the data packet s . The data packet s may be originated from the first network node or received by the first network node. The second network node determines whether the data packet s have been received earlier through the aggregated connection. The determination is substantially based on a record of missing global sequence numbers GSNs . When the second network node determines to forward the data packet s the second network node decapsulates the data packet s from the encapsulating packet if the encapsulating packet is an OEP. If the encapsulating packet is a DEP the second network node recreates the data packet s substantially based on the data packet information. The second network node then forwards the data packet s to its destination. The destination is indicated in the header of the data packet s . The second network node may then update the record of missing GSNs.

According to one of the embodiments the encapsulating packet comprises a list of OEP GSN when the encapsulating packet is a DEP and the data packet information holds a plurality of encapsulated packets or error correction information.

According to one of the embodiments the second network node determines whether the GSN s corresponding to the data packet s is are in the record of missing GSNs. If the GSN s is are not in the record of missing GSNs the second network node determines not to forward the data packet s . Alternatively if the GSN s is are in the record of missing GSNs the second network node determines to forward the data packet s .

According to one of the embodiments the second network node may further update an expected global sequence number after determining whether or not the data packet s are to be forwarded.

Site and router may comprise M connections and site and router may comprise N connections . Connections and are data connections for communicating information within network between sites and . In the illustrated embodiment M is equal to 3 and N is equal to 2 however these values may vary according to desired routers and configurations. Connections and may have similar or differing bandwidth capabilities. Further connections and may comprise different types of WAN connections such as a WiFi cable DSL TI 3G 4G satellite connections and the like. It is also noted that site and site may be thought of as both a sender or receiver and discussions regarding the functionality of either site may be implemented on the other site. In other words system may be implemented as a symmetrical network.

Communications routers and may have a plurality of network interfaces according to one of the embodiments. Communications router establishes tunnels A B and C via one or more of its plurality of network interfaces with one or more network interfaces of communications router .

A plurality of established tunnels may be aggregated combined or bonded together to form one aggregated connection. Those skilled in the arts would appreciate that there are myriad ways to aggregate combine or bond a plurality of established tunnels to form one aggregate tunnel. An aggregated connection is perceived as one tunnel by sessions or applications that are using it. An aggregated connection may be an end to end connection a virtual private network connection or connectionless oriented connection. For example an aggregated connection may be a TCP connection or UDP connection. In another example aggregated connection is an aggregation of a plurality of tunnels and each tunnel is linked between communications router and communications router . In another example an aggregated connection may be a VPN tunnel comprising a plurality of established tunnels and each established tunnel is linked between communications router and communications router .

At block of the illustrated embodiment when establishing a bonded connection between routers and such as by implementing a bonded site to site VPN connection M N virtual tunnels may be created as illustrated in . Virtual tunnels correspond to a unique permutation of the network connections of site and the network connections of site .

At block of the illustrated embodiment default weights for the tunnels are determined and or assigned. To determine default weights embodiments exchange uplink and downlink bandwidth data of connections and between sites and . Using this bandwidth data a default weight may be calculated according to the following suppose site s downlink bandwidths of connections to m are d d . . . dm and site s uplink bandwidths of connections to n are ur U . . . Un the default weight for the tunnel between site s connection X and site s connection Y may be defined as DW x y where DW x y dx dy. Using the above method to calculate default weight if connections through are WAN connections of a multi WAN router with respective uplink downlink bandwidths of 10M 6M 8M 4M and 6M 6M and connections through are WAN connections of a multi WAN router with respective uplink downlink bandwidths of 7M 5M and 9M 3M the respective default weights for each tunnel will be as follows 

It is noted that other ways to calculate default weight are contemplated and the above is simply an example of the implementation of an embodiment of the present invention. It is noted that many different weighting schema may be used to define the initial bandwidth of a tunnel. For example one may desire to only weight a tunnel in one direction using the downlink capacity of a receiving site and the uplink capacity of the sending site. Any weighting scheme used to characterize capacity of the tunnels at the establishment of the bonded connection may be used for the purposes of the present invention.

When packets are being routed from site to site according to embodiments the packets will be distributed to the tunnels in a ratio according to an effective weight EW x y . Initially the effective weight of embodiments is set to be equal to the default weight EW x y DW x y and if the bandwidth of tunnels remains unchanged from the initial setting the effective weight is optimal for packet distribution. However if a user is downloading a file over a bonded network connection in a TCP session with one or more tunnels having packet drops the overall throughput of the session will drop dramatically. This is in part because the packet drops will keep causing TCP retransmissions and TCP s flow control will maintain a lower throughput even though tunnels without packet drops are not fully occupied.

One effective way to increase throughput would be to avoid such packet drops. To do so embodiments of the present invention discern when tunnels are experiencing an increase or decrease in packet drop rates at block of the illustrated embodiment. Embodiments further function to modify the effective weight of tunnels which are experiencing or have experienced changes in packet drop rates at block . The packet drop rate information may be monitored continuously or be monitored based on specific time periods. Once it is determined that a tunnel is experiencing an unacceptable rate of packet drops block the illustrated embodiment decreases the effective weight of the tunnel at block . In some embodiments unacceptable may mean that the packet drop rate is a non zero quantity while other embodiments may determine that an unacceptable rate is any rate beyond a predefined threshold. Embodiments implement these decreases in stepwise fashion in a continuous manner in a reduction at one time in proportion to the increase in the packet drop rate etc. When reductions are done in a gradual manner embodiments may continue to monitor the tunnel in order to optimize the amount of reduction which is implemented.

Tunnels may be established or monitored by sending heartbeat packets through each tunnel from either router or router . In some embodiments when the receive end fails to receive heartbeat packets from a tunnel for a period of time it will treat that tunnel as down and the tunnel will not be used for routing traffic. If heartbeat packets again start being received the tunnel may be re established and be weighted along with the other tunnels. As such in the event that all packets are being dropped in a tunnel and the effective weight of that tunnel is reduced to zero embodiments may utilize heartbeat packets to monitor and reestablish a connection.

Moreover when tunnels recover all or part of their respective bandwidths e.g. it is determined that the packet drop rate decreases block the illustrated embodiment functions to increase the effective weight of such tunnels block in order to fully or more fully utilize the bandwidth. Some embodiments increase the effective weight for a tunnel using predetermined step sizes until an accurate effective weight is regained. Other embodiments increase the effective weight proportionate to a newly measured bandwidth which may correspond to a newly measured packet drop rate. Moreover embodiments may increase the effective weight for a tunnel based on a predetermined linear or exponential scale.

After the effective weight of the tunnels are adjusted or it is determined that no adjustment is needed the weighting scheme of the system is updated at block of the illustrated embodiment. This update may comprise storing any processed information using such information in further processing causing the system to take no action etc. For example processing performed with respect to block may operate to average weighting schemes over a period of time such as to mitigate error associated with highly transient anomalies. Further the updated information may be used on system to modify the packet distribution of the data transfer session as discussed with respect to . System may continue to implement steps continuously or periodically throughout a data transfer session.

To monitor the bandwidth of the various tunnels some embodiments of the present invention encapsulate each transmitted IP packet with various information. illustrates an example embodiment showing the type of information which may be encapsulated in a transmitted IP packet. The transmitted IP packet may be referred to as an encapsulating packet namely an original encapsulating packet or a duplicate encapsulating packet. Details of original and duplicate encapsulating packets are illustrated in and C. Version field may contain information about the protocol version being utilized and protocol type field may contain the protocol type of the payload packet. In general the value of this field will correspond to the Ethernet protocol type for the packet. However additional values may be defined in other documents. Tunnel ID field may be a 32 bit field and may contain an identifier to identify the current tunnel of the IP packet. Advanced Encryption Standard AES initialization vector field may be a 32 bit field and may contain an initialization vector for AES encryption. Global sequence number field may be a 32 bit field and may contain a sequence number which is utilized to re sequence each of the packets for various sessions into the proper order when they have emerged from their respective tunnels. Per tunnel sequence number field may be a 32 bit field which may represent a sequence number that is assigned to each packet routed to a particular tunnel. AES encrypted payload field may be utilized to convey the payload of the IP packet. AES encryption may be applied for higher security of the payload in order to prevent attacks from third parties.

The per tunnel sequence number discussed above may be used to monitor dropped packets in a tunnel. In one embodiment the router on the receiving end calculates the packet drop rate of each tunnel DR x y every f seconds by monitoring the per tunnel sequence number of the received packets. DR x y may be characterized as the sequence numbers missed divided by a sequence number increase for a period f. The length of period f may vary and in one embodiment f is equal to 5 seconds.

Other methods may also be used to monitor dropped packets e.g. the sender may periodically inform the receive end how many packets it has sent the sender sends a heartbeat packet to the receive end every constant period of time and the receive end can estimate the overall drop rate by monitoring the heartbeat packets drop rate by acquiring drop rate figures from physical interface device layer etc.

The receive end may feedback a particular tunnel s drop rate effective weight or other bandwidth indicators to the sending router. When the sender receives information regarding packet drops some embodiments lower the effective weight EW x y of a tunnel by EW x y DR x y . Other metrics may be used to modify the effective weight of a tunnel. In some embodiments the sender may receive feedback and the effective weight may be reduced by number that is greater than or less than the packet drop rate. Such variances may be configured according to the particular needs of a communication system. The above example represents a metric that attempts to lower the effective weight of the tunnel to a weight which prevents further packet drops while maximizing the amount of usable bandwidth of the tunnel. Any metric which finds this balance may be preferred.

The information which is encapsulated in transmitted IP packets such as shown in and may also be used for packet buffering and re sequencing. Because each tunnel s latency can be different when two consecutive packets of the same TCP session are sent to a VPN peer over a bonded VPN tunnel they may not arrive in sequence because they are routed via two different tunnels. If the TCP session receives the out of sequence packets from the VPN the TCP session will slow down due to TCP retransmissions. Accordingly the receive end should buffer the packets that come too early until either the slower packets arrive or until an expiration time has passed. With such buffering late packets that come prior to an expiration time will be forwarded to the destination device in sequence. This buffering assists in the optimization of end to end throughput.

It is noted that embodiments described herein are at times discussed in the context of a VPN connection. These discussions are presented in order to show an example embodiment of a bonded connection. The inventive concepts described in claimed herein are not limited to such connections. In fact any connection where sufficient data may be obtained and exchanged in order to dynamically monitor the bandwidth of a plurality of communication paths which are being used in a data transfer session may be implemented with the embodiments of the present invention.

As discussed above each packet may be assigned two different sequence numbers a global sequence number GSN and a per tunnel sequence number PTSN . These numbers may be used to assist in packet buffering and re sequencing operations. After a packet is passed to an upper layer the receive end may update a next expected per tunnel sequence number NE PTSN and a next expected global sequence number NE GSN .

The following will describe one method of how a packet may be buffered or forwarded to destination device after it is received and decrypted.

2. Check if the packet s PTSN equals to the NE PTSN. If not dequeue forward to destination device in sequence all packets that have a smaller GSN than the packet s. Keep the packet unprocessed.

5. If the packets GSN is equal to the NE GSN update the NE GSN i.e. set NEGSN to GSN 1 and forward to destination device. Repeat updating the NE GSN and dequeuing the buffer head from the buffer if the head s GSN equals to the new NE GSN.

7. If a packet has been in the queue longer than a fixed amount of time set the NEGSN to the packet s GSN 1 and dequeue in sequence the packet and all packets that have a smaller GSN than the packet s.

Therefore the encapsulated packet information discussed in and may include information that optimizes overall throughput of the data transmission system such as 100 both by assisting in the optimization of tunnel bandwidth in response to monitoring packet drop rates and by assisting in the efficient re sequencing of received packets in a data transfer session.

System also includes random access memory RAM which may be SRAM DRAM SDRAM or the like. RAM may be a secondary storage which stores program instructions executable by CPU . System includes read only memory ROM which may be PROM EPROM EEPROM or the like. RAM and ROM hold user and system data and programs as are well known in the art.

System also includes input output I O adapter communications adapter user interface adapter and display adapter . I O adapter user interface adapter and or communications adapter may in certain embodiments enable a user to interact with system in order to input information.

I O adapter connects storage device s such as one or more of hard drive compact disc CD drive floppy disk drive tape drive etc. to system . The storage devices are utilized in addition to RAM for the memory requirements associated performing the operations discussed in the above embodiments. Communications adapter is adapted to couple system to network which may enable information to be input to and or output

from system via such network e.g. the Internet or other wide area network a local area network a public or private switched telephony network a wireless network any combination of the foregoing . Communications adapter may be regarded as a network interface and system may comprise a plurality of communications adapters . User interface adapter couples user input devices such as keyboard pointing device and microphone and or output devices such as speaker s to system . Display adapter is driven by CPU to control the display on display device . Display adapter transmits instructions for transforming or manipulating the state of the various numbers of pixels used by display device to visually present the desired information to a user. Such instructions include instructions for changing state from on to off setting a particular color intensity duration or the like. Each such instruction makes up the rendering instructions that control how and what is displayed on display device .

In one variant the process of may be performed periodically. The process may preferably be performed every few seconds. Alternatively the process of is performed upon receiving a trigger. For example a trigger is received when CPU determines that acknowledgements are not being received or are being received late through the first tunnel and or the second tunnel. This may indicate that the latency of the first tunnel and or the second tunnel has become very high. CPU then performs the steps of again in order to select a first and second tunnel again. In another example the trigger may be received when a user or administrator manually initiates the process of .

The first tunnel and the second tunnel may be selected according to a selection policy. In one variant the selection policy may be based on one or more of the following criteria performance of the tunnels service provider usage limit location time usage price security user identity Internet Protocol address range communication protocol communication technology application and device. When the selection policy is based on performance of the tunnels the selection may be performed according to performance metrics such as throughput error rates packet latency packet jitter symbol jitter quality of service bandwidth bit error rate packet error rate frame error rate dropped packet rate queuing delay round trip time capacity signal level interference level bandwidth delay product handoff delay time signal to interface ratio and signal to noise ratio.

A user or administrator may configure the selection policy. For example the user may configure the selection policy to be based on only the bandwidth of each of the plurality of tunnels. A tunnel with the best bandwidth is hence selected as the first tunnel through which OEPs are transmitted. Another tunnel with the second best bandwidth is selected as the second tunnel through which DEPs are transmitted. In another example the user may configure the selection policy to be based on only the latency of each of the plurality of tunnels. A tunnel with the best latency is hence selected as the first tunnel through which OEPs are transmitted. Another tunnel with the second best latency is selected as the second tunnel through which DEPs are transmitted.

In another example the user may configure the selection policy to be based on the usage limit and packet drop rate. A tunnel with the highest usage limit and or lowest packet drop rate is selected as the first tunnel. Another tunnel with second highest usage limit and or second lowest packet drop rate is selected as the second tunnel.

In another variant the selection policy is based on user selection. A user or administrator may configure communications router to use a certain tunnel as the first tunnel and another certain tunnel as the second tunnel.

The user or administrator may configure the selection policy of the communications router by sending configurations locally or remotely through a web interface an application programming interface API a command line interface or a console.

It would be known to those skilled in the art that in wireless communications quality of packet transmission may be unpredictable and latency may be high at some instances. Packet drop rate may be high too. Transmitting DEPs increases the chances of the data being received by communications router as the OEP may be dropped. However the bandwidth usage may be significantly increased by transmission of DEPs. DEPs may also be used for forward error correction FEC which will be explained in greater detail below.

With reference to type of information contained in OEP and DEPs and may be similar to that illustrated in .

Encapsulating packets encapsulate data packets. Hence the data packets become encapsulated packets when they are encapsulated by encapsulating packets. The data packets may be received by communications router through one or more of its network interfaces from a host or node in site which is accessible through communications router . The host or node may be in a LAN of communications router . Source and destination of the data packets may be indicated in headers of the data packets.

Each encapsulating packet may be assigned with two sequence numbers namely a global sequence number and a per tunnel sequence number. The global sequence number may be used to assist in packet buffering and re sequencing operations. When encapsulating packets are assigned with a global sequence number the designated host or node arranges the encapsulating packets arriving at the designated host or node according to their corresponding global sequence numbers. The per tunnel sequence number indicates which tunnel among the plurality of tunnels the encapsulating packet was transmitted through.

OEP GSN and DEP GSN may be identical. Encapsulated packets and may be identical such that OEP and DEP encapsulate the same data packet which becomes encapsulated packet and respectively. When communications router generates DEPs for transmission the payload i.e. the encapsulated packet is the same as that of the OEP . Since OEP and DEP have the same contents their global sequence numbers are also the same.

DEP may be transmitted periodically. In one variant the time period between transmitting each DEP may be predefined. When the number of OEPs transmitted in that time period is n DEP may comprise m encapsulated packets corresponding to the n OEPs where m is less than or equal to n and the value of m is at least one. The m encapsulated packets are same as encapsulated packets in m of the n OEPs. The m encapsulated packets such as encapsulated packets to may be comprised in AES encrypted payload field of DEP . List of m OEP GSN comprises OEP GSNs of OEPs that the m encapsulated packets correspond to. For example ten OEPs are transmitted in a predefined time period. A first DEP may comprise six encapsulated packets corresponding to six of the ten OEPs and a second DEP may comprise four encapsulated packets corresponding to remaining four OEPs. After the predefined time period the first and second DEPs are transmitted. The first and second DEPs may be transmitted through the same tunnel or different tunnels. Alternatively the first DEP may comprise ten encapsulated packets corresponding to the ten OEPs respectively. After the predefined time period the first DEP is transmitted. DEP may not comprise more than ten encapsulated packets as each encapsulated packet must correspond to each OEP.

In another variant the number of OEPs after which one DEP is transmitted is predefined. Therefore the number n is predefined. DEP may comprise m encapsulated packets corresponding to the n OEPs where m is less than or equal to n. The m encapsulated packets may be same as encapsulated packets in m of the n OEPs. The m encapsulated packets such as encapsulated packets to may be comprised in AES encrypted payload field of DEP . For example when n is defined to be five after every five OEPs are transmitted a DEP is transmitted and the DEP comprises five encapsulated packets corresponding to the five OEPs. The time period between transmitting DEPs may not be predefined. List of m OEP GSN comprises OEP GSN of the five OEPs that the encapsulated packets correspond to. Alternatively when n is defined to be five after every five OEPs are transmitted a first DEP and a second DEP is transmitted. The first DEP may comprise encapsulated packets corresponding to two of the five OEPs and the second DEP may comprise encapsulated packets corresponding to the remaining three of the five OEPs.

DEP may be used to correct any errors that may have occurred while transmitting the n number of OEPs since encapsulated packets contain information from data packets encapsulated in the OEPs. In one variant DEP GSN per tunnel sequence number list of m OEP GSN and other information are comprised within an options field of IP header and encapsulated packets is comprised within AES encrypted payload field . Alternatively DEP GSN per tunnel sequence number list of m OEP GSN other information and encapsulated packet are all comprised within AES encrypted payload field . It may be possible that one or more of the OEPs transmitted through the aggregated connection had been dropped lost or late. Even when the OEPs are received there may be errors within the OEPs. DEP may be used for recreating encapsulated packets in the OEPs and also for checking for any errors. Details regarding transmission of DEP and recreation of encapsulated packets are illustrated in .

OEP is transmitted through a tunnel that is different from a tunnel used for transmitting DEP or DEP . Therefore per tunnel sequence number may not be the same as per tunnel sequence number or per tunnel sequence number . If OEP and DEPs are transmitted through the same tunnel and the tunnel s performance deteriorates neither OEP nor DEPs may be received successfully by communications router . Therefore in order to increase the chances of at least one of the OEP or the DEPs being received OEP is transmitted through a tunnel that is different from a tunnel used for transmitting DEP or DEP .

Source addresses indicated in IP headers and may be the IP address of one of the network interfaces of communications router . Destination addresses indicated in IP headers and may be the IP address of one of the network interfaces of communications router . Source addresses of encapsulated packets and may be the IP address of a host or node in site accessible through communications router . Destination addresses of encapsulated packets and may be the IP address of a host or node in site accessible through communications router .

OEP GSN DEP GSN and DEP GSN may correspond to global sequence number field . Per tunnel sequence numbers and may correspond to per tunnel sequence number field .

One of the purposes for encapsulating data packets inside encapsulating packets is to reorder the data packets when the encapsulating packets are received at the other end of the aggregated connection as the encapsulating packets may arrive out of order. The data packets may also be of varying protocols and may be encapsulated inside encapsulating packets in order to fulfill protocol requirements of the aggregated connection.

According to one of the embodiments of the present invention communications router may transmit multiple DEPs for one OEP. Each of the multiple DEPs is transmitted through different tunnels. The number of DEPs to be transmitted may be defined by a user or administrator of communications router . However the number of DEPs transmitted may not be higher than the number of tunnels available for transmission of DEPs. This is because transmitting more than one DEP through a tunnel for each OEP may not be beneficial. When the tunnel s performance deteriorates most of the more than one DEPs may not be received successfully. This may unnecessarily consume more bandwidth without increasing the chances of at least one of the DEPs to be received successfully. When a user or administrator defines the number of DEPs to be higher than the number of available tunnels for transmitting DEPs communications router does not transmit the number of DEPs defined by the user or administrator. Instead communications router transmits DEPs equal to the number of available tunnels i.e. one DEP per tunnel. At least one tunnel may be reserved for transmitting OEPs and the rest of the tunnels may be used for transmitting DEPs. For illustration purposes a user defines the number of DEPs to be transmitted as five. Communications router has only four tunnels established with communications router namely first second third and fourth tunnels. The OEPs are transmitted through the first tunnel. One DEP corresponding to each OEP is transmitted through each of the second third and fourth tunnels respectively. Therefore only three DEPs are transmitted for each OEP instead of five.

In one example if a user or administrator defines the number of DEPs to be lower than the number of available tunnels DEPs may be transmitted according to the performance of the tunnels. For illustration purposes a user defines the number of DEPs to be transmitted as two. Communications router has four tunnels established with communications router namely first second third and fourth tunnels. The OEP is transmitted through the first tunnel with the best performance. If the second and third tunnels have better performance compared to the fourth tunnel one DEP is transmitted through the second tunnel and another DEP is transmitted through the third tunnel.

In another example when there are more than two tunnels available OEPs are transmitted through the first tunnel with the best performance. The DEPs are transmitted through the rest of the tunnel using load balancing technology. Alternatively the DEPs may also be transmitted through the rest of the tunnels in round robin fashion especially when the number of DEPs to be transmitted is lower than the number of the rest of the tunnels.

Communications router may receive plurality of encapsulated packets that are encapsulated in OEPs and or DEPs. It is possible that OEPs may arrive earlier than DEPs and vice versa. Therefore there is a need to know whether or not an encapsulated packet has been received earlier regardless of whether it is encapsulated in an OEP or a DEP.

In step an encapsulating packet is received by communications router from communications router . CPU of communications router determines in step whether an encapsulated packet encapsulated in the encapsulating packet has been received earlier. The encapsulated packet is determined to have been received earlier if global sequence number of the encapsulating packet is the same as another global sequence number of another encapsulating packet that has been received earlier. If the encapsulated packet has been received earlier communications router does not forward the encapsulated packet inside the encapsulating packet to the destination in step and discards the encapsulating packet. If the encapsulated packet has not been received earlier the encapsulated packet is forwarded to the destination in step . The process ends in step . When it is determined that the encapsulated packet has been received earlier it may be assumed that the encapsulated packet has already been forwarded. For this reason communications router does not forward the encapsulated packet in the encapsulating packet again and discards the encapsulating packet.

The encapsulating packet may be an OEP or a DEP . With reference to step there may be various ways of determining whether the encapsulated packet has been received. One way of determining is by checking GSN of the encapsulating packet as described above. If any other encapsulating packet with the same global sequence number has been received earlier through the same aggregated connection communications router determines that the encapsulated packet has been received already. Then there is no need to forward the same encapsulated packet.

Another way of determining whether the encapsulated packet has been received is by checking a hash code. When encapsulating packets arrive at communications router CPU of communications router may apply a hash function on the payload i.e. encapsulated packets after decapsulating the encapsulating packets. The hash code generated by applying the hash function may be stored in a storage medium. The storage medium may be a local storage medium such as RAM or a remote storage medium such as a remote server. The hash code would be the same when applied to the same encapsulated packet received earlier. CPU of communications router may then determine whether the hash code generated is unique or whether it has been stored before. If the hash code is unique it is determined that the encapsulated packet has not been received before. If the hash code has been stored before it is determined that the encapsulated packet has been received. Although the hash function or the seed may be changed it is more likely that it remains the same for a few minutes. Therefore uniqueness of the hash code may be used to determine whether the encapsulated packet has been received in the past few minutes.

Communications router receives an encapsulating packet assigned with a first global sequence number GSN in step . In step CPU of communications router determines an expected global sequence number E GSN . GSN is then compared against the E GSN in step . The E GSN may be used to estimate what the GSN of the next encapsulating packet should be.

If the E GSN is determined to be higher than GSN in step the encapsulating packet is considered to have arrived late. CPU of communications router determines whether GSN is identified in a record of missing GSNs in step . If GSN is identified in the record of missing GSNs the record of missing GSNs is updated in step to remove GSN from the record of missing GSNs. Communications router then decapsulates the encapsulating packet to retrieve an encapsulated packet and forwards the encapsulated packet to its destination in step . The destination may be a host or node in site and may be accessible through communications router . Alternatively if GSN is not identified in the record of missing GSNs the encapsulating packet is discarded in step and not forwarded to the destination. The encapsulating packet is discarded because it is considered to contain an encapsulated packet that has already been received earlier. Since GSN is not found in the record of missing GSNs this is an indication that another encapsulating packet with same GSN has been received earlier and may have already been forwarded to the destination.

If the E GSN is not determined to be higher than GSN in step CPU of communications router determines whether the E GSN is equal to GSN in step . If the E GSN is equal to GSN E GSN may be incremented if necessary in step . The encapsulating packet is decapsulated to retrieve the encapsulated packet which is then forwarded to the destination in step . If E GSN is not equal to GSN i.e. E GSN is lower than GSN the encapsulating packet is considered to have arrived early. Therefore the encapsulating packet is stored in a buffer for a predefined time period in step . The encapsulating packet may be removed from the buffer when the predefined time period has expired and decapsulated to retrieve the encapsulated packet. The encapsulated packet is then forwarded to the destination in step . Alternatively the encapsulating packet may be removed from the buffer and decapsulated when the E GSN has become equal to GSN . The encapsulated packet is then forwarded to the destination in step . E GSN may become equal to GSN because E GSN is incremented by CPU of communications router based on the GSNs of received encapsulating packets. In one variant the encapsulating packet may first be decapsulated to retrieve the encapsulated packet and then the encapsulated packet is stored in the buffer in step . The encapsulated packet may be removed from the buffer and forwarded to the destination when the predefined time period has expired or when E GSN becomes equal to GSN . The process ends in step .

The benefit of storing the encapsulating packet in the buffer is that the encapsulating packet need not be decapsulated before storing and thus computing resources used for decapsulating may be saved. However the encapsulating packet may consume higher space in the buffer compared to the encapsulated packet which may not be desirable. When encapsulated packets are stored in the buffer a table indicating corresponding GSNs are also stored with the encapsulated packets.

E GSN may be incremented even when a few encapsulating packets with lower global sequence number may be missing i.e. being late being dropped or being lost. E GSN is continued to be incremented because the buffer space for storing encapsulating packets is limited and encapsulating packets should be removed from the buffer as soon as their GSN becomes equal to the E GSN.

Detailed processes corresponding to steps and and a method for calculating E GSN are disclosed in International Publication Number WO2013 049960 A1 published on 11 Apr. 2013 entitled METHOD AND SYSTEM FOR REDUCTION OF TIME VARIANCE OF PACKETS RECEIVED FROM BONDED COMMUNICATION LINKS . In one variant step may be performed according to the process of .

Communications router stores the GSN of encapsulating packet received through the aggregated connection. The GSNs that are missing can be recording in the record of missing GSNs. For example communications router has received five encapsulating packets with GSNs and within a time period. It is determined that a packet with GSN is missing. Therefore GSN is recorded in the record of missing GSNs.

In one variant communications router stores the GSNs of each encapsulating packet whose corresponding encapsulated packet has been forwarded to the destination host or node. The GSNs may be recorded in a record of forwarded GSNs. The encapsulating packets may be OEP or DEP . When determining whether or not to forward an encapsulated packet corresponding to an encapsulating packet communications router checks the record of forwarded GSNs. If the GSN of the encapsulating packet is found in the record of forwarded GSNs the encapsulated packet is not forwarded to the destination host or node as it has already been forwarded before.

In step communications router receives the encapsulating packet. CPU of communications router determines whether the encapsulating packet comprises a list of OEP GSN in step . If the encapsulating packet comprises a list of OEP GSN it may be a DEP and if the encapsulating packet does not comprise a list of OEP GSN it may be an OEP .

When the encapsulating packet is determined to be an OEP in step CPU of communications router determines whether the GSN of the encapsulating packet i.e. OEP GSN is recorded in the record of missing GSNs. If the GSN is recorded in the record of missing GSNs an encapsulated packet such as encapsulated packet which is encapsulated in the encapsulating packet is forwarded to the destination host or node in step . If the GSN is not recorded in the record of missing GSNs it is determined that the encapsulated packet has been received earlier and the encapsulated packet had already been forwarded and hence the encapsulated packet is not forwarded to the destination again in step .

When the encapsulating packet is determined to be a DEP in step CPU of communications router determines whether at least one OEP GSN in the list of m OEP GSN is recorded in the record of missing GSNs. If not none of the encapsulated packets are forwarded to the destination host or node in step . If at least one OEP GSN is found in the record of missing GSNs in step communications router forwards encapsulated packets corresponding to the at least one OEP GSN in the list of m OEP GSN that were recorded in the record of missing GSNs. For example if OEP GSN corresponding to only encapsulated packet and were found in the record of missing GSNs then only encapsulated packets and are forwarded to the destination in step and the rest of the encapsulated packets are not forwarded to the destination. The process ends in step .

According to one of the embodiments when communications router receives an encapsulating packet it may determine whether the encapsulating packet is an OEP or a DEP by checking the tunnel ID. Communications router may inform communications router that the first tunnel is selected for transmitting OEP and the second tunnel is selected for transmitting DEP. Therefore communications router may determine that any packets received through the first tunnel are OEPs and any packets received through the second tunnel are DEPs. However in some scenarios the second tunnel may also be used for transmitting other packets such as management packets health check packets etc. In such scenarios encapsulating packets may have an additional field which indicates whether an encapsulating packet is an OEP or a DEP. Alternatively the information indicating whether an encapsulating packet is an OEP or a DEP may be included in the other information field of the encapsulating packet. Checking the tunnel ID or checking the additional field may be performed instead of performing step in order to determine whether the encapsulating packet is an OEP or DEP.

Communications router first receives data packet data packet data packet and data packet from a host or node in site . The data packets are encapsulated in OEPs. Data packet becomes encapsulated packet which is encapsulated in OEP . Data packet becomes encapsulated packet which is encapsulated in OEP . Data packet becomes encapsulated packet which is encapsulated in OEP . Data packet becomes encapsulated packet which is encapsulated in OEP . The fields OEP GSN and contain OEP GSN OEP GSN OEP GSN and OEP GSN respectively. Communications router transmits OEPs and to communications router through a first tunnel of the aggregated connection. OEPs and are the n number of OEPs transmitted and their GSNs are OEP GSN OEP GSN OEP GSN and OEP GSN respectively. Communications router then transmits DEP to communications router through a second tunnel for the four OEPs and . List of m OEP GSN comprises OEP GSN OEP GSN OEP GSN and OEP GSN . Information data packet information is based on encapsulated packets of the OEP GSNs as illustrated in . One of the purposes for transmitting DEP is to recover any information that may be lost during transmission of the OEPs. If any of the four OEPs is not received by communications router or there was an error in any of the four OEPs DEP may be used to recreate any of the four OEPs because it contains information from the four OEPs. Information may or may not contain encapsulated packets . However information may be used to recreate encapsulated packets .

A delay is introduced between steps and because it may take some time for all OEPs to arrive at communications router . Hence all OEPs may not have been received immediately after one of the OEPs is received.

For illustration purpose if it is determined in step that OEP is received earlier but OEP is not received in step information may be used for recreating data packet . This is possible because both information and data packet is available and there is enough information for recreating data packet . If both OEP and are not received earlier DEP and information may not be used for recreating data packet or data packet in step as there is not enough information even if OEP and or OEP is received earlier.

In another example when information included in DEP is generated by performing XOR operation on three data packets and OEP corresponding to only one of the three data packets is received earlier it may not be possible to recreate the other two data packets.

In one variant in step instead of only storing information and the whole DEP is stored in the buffer. The benefit of storing the whole DEP is that DEP need not be decapsulated before storing. If DEP is eventually discarded computing resources used for decapsulating may be saved. However DEP may consume higher space in the buffer compared to information and which may not be desirable.

In one variant before of forwarding the data packet in step communications router stores the data packet in the buffer for a predefined time period. When the predefined time period expires the data packet is forwarded to the destination. Alternatively the data packet may be stored in the buffer until the E GSN becomes equal to an OEP GSN corresponding to the data packet and then the data packet is forwarded to the destination.

In one example communications router establishes an aggregated connection with communications router comprising three tunnels namely the first second and third tunnel. The first tunnel is selected for transmitting OEPs and the second and third tunnels are selected for transmitting DEPs. A user or administrator may configure communications router to transmit one or both types of DEP and . When communications router is configured to transmit DEP at least one DEP is transmitted for each OEP . As discussed above the number of DEP to be transmitted corresponding to each OEP may be configured.

When communications router is configured to transmit DEP one DEP may be transmitted for n number of OEP . The number n can be configured. For illustration purpose n is five and communications router is configured to transmit one DEP for every five OEPs transmitted through the first tunnel. Therefore communications router transmits one DEP through the second or third tunnel after transmitting five OEPs through the first tunnel. If a first second third fourth and fifth OEP is transmitted and DEP comprises information corresponding to encapsulated packets of the first second third fourth and fifth OEP list of m OEP GSN comprises the OEP GSNs of the first second third fourth and fifth OEP . DEP GSN is not the same as OEP GSN of any OEP . Encapsulated packets comprises encapsulated packet and corresponding to the first second third fourth and fifth OEP respectively.

When communications router is configured to transmit both DEP and it may or may not use the same tunnel for transmitting. For illustration purpose communications router is configured to transmit two DEPs for each OEP and one DEP for every five OEPs . Two DEPs corresponding to the same OEP is not transmitted through the same tunnel. A first DEP corresponding to each OEP may be transmitted through the second tunnel and a second DEP corresponding to each OEP may be transmitted through a third tunnel. DEP may be transmitted through either the second tunnel or the third tunnel. DEP may be transmitted through the second tunnel and the third tunnel in round robin fashion. Alternatively when communications router is configured not to transmit DEP and DEP through the same tunnel it may select the second tunnel for transmitting one DEP for each OEP and the third tunnel for transmitting one DEP for every five OEPs .

In some scenarios it may be preferred to not transmit DEPs as it may have an adverse effect on the transmission of OEPs. For example when the first and second tunnels are established using the same network interface of communication device and or established using the same network interface of communication device transmitting DEPs through the second tunnel may increase the latency experienced by the OEPs through the first tunnel. The throughput of the OEPs may also be decreased. A similar effect may be observed when a first tunnel and a second tunnel is established through the same WAN in site and or the same WAN in site . A similar effect may also be observed when the first and second tunnels are established using a network provided by the same carrier as the base station that the tunnels connect to may be the same. Additionally the computing resources consumed for generating and transmitting DEPs may slow down transmission of OEPs. Therefore in these scenarios it may be preferable to not transmit DEPs or to not transmit a high number of DEPs corresponding to each OEP.

The processes described above may also be applied to encapsulating packets transmitted from communications router to communications router .

It shall be appreciated that the present disclosure is not limited to the architecture of system . For example any suitable processor based device may be utilized for implementing the above teachings including without limitation routers personal computers laptop computers computer workstations multi processor servers and even mobile telephones. Moreover certain embodiments may be implemented on application specific integrated circuits ASICs or very large scale integrated VLSI circuits. In fact persons of ordinary skill in the art may utilize any number of suitable structures capable of executing logical operations according to the embodiments.

Although embodiments of the present invention and their advantages have been described in detail it should be understood that various changes substitutions and alterations can be made herein without departing from the spirit and scope of the invention as defined by the appended claims. Moreover the scope of the present application is not intended to be limited to the particular embodiments of the process machine manufacture composition of matter means methods and steps described in the specification. As one of ordinary skill in the art will readily appreciate from the disclosure of the present invention processes machines manufacture compositions of matter means methods or steps presently existing or later to be developed that perform substantially the same function or achieve substantially the same result as the corresponding embodiments described herein may be utilized according to the present invention. Accordingly the appended claims are intended to include within their scope such processes machines manufacture compositions of matter means methods or steps.

