---

title: In-field smart device updates
abstract: Methods and systems for causing a device to join a network or fabric. A joining device sends an indication that the electronic device is not connected to a network type and receives a device ID for an assisting device to assist the electronic device in joining a network of the network type. Moreover, the assisting device resides on the network. The joining device then authenticates to the assisting device from the assisting device and receives network credentials for the network. Furthermore, the joining device joins the network using the network credentials.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09130910&OS=09130910&RS=09130910
owner: Google Inc.
number: 09130910
owner_city: Mountain View
owner_country: US
publication_date: 20141216
---
This application is a Continuation Application of and claims priority to U.S. patent application Ser. No. 14 533 885 filed Nov. 5 2014 entitled In Field Smart Device Updates in the name of Jay D. Logue the entirety of which is incorporated by reference herein for all purposes.

This disclosure relates to systems devices methods and related computer program products for smart buildings including the smart home. More particularly this patent specification relates to updating smart devices in a smart home environment.

Some homes today are equipped with smart home networks to provide automated control of devices appliances and systems such as heating ventilation and air conditioning HVAC systems lighting systems alarm systems and home theater and entertainment systems. Smart home fabrics may include one or more networks of devices interconnected to automation functions within the home. For example a person may input a desired temperature and a schedule indicating when the person is away from home.

In some scenarios one or more devices may not connect to all networks within a fabric or the fabric itself due to these devices lacking information used to connect to the networks and or the fabric itself. However in some scenarios it may be undesirable to have the user manually cause these devices to update because of inconvenience to the user. Furthermore in some scenarios it may also not be desirable to update these devices with secure information from a service since the service would store all such information thereby placing security information for numerous networks and or fabrics in a single location e.g. the service . It may be desirable to update the secure information to the devices without providing such information to the service.

A summary of certain embodiments disclosed herein is set forth below. It should be understood that these aspects are presented merely to provide the reader with a brief summary of these certain embodiments and that these aspects are not intended to limit the scope of this disclosure. Indeed this disclosure may encompass a variety of aspects that may not be set forth below.

Embodiments of the present disclosure provide methods and systems for enabling devices to join devices to network and or fabrics consisting of several networks and adding the devices to the network and or fabrics. In some embodiments these devices may already be deployed in the field but may be missing some information or features that are used to join the networks and or fabrics. Thus in some embodiments the data is sent over to the devices from a service before the devices join the networks and or fabrics. However some of the network fabric credentials such as keys and network names may not be known to the service. In such embodiments devices on the network fabric may send over the credentials to the joining device as assisting devices.

One or more specific embodiments of the present disclosure will be described below. These described embodiments are only examples of the presently disclosed techniques. Additionally in an effort to provide a concise description of these embodiments all features of an actual implementation may not be described in the specification. It should be appreciated that in the development of any such actual implementation as in any engineering or design project numerous implementation specific decisions must be made to achieve the developers specific goals such as compliance with system related and business related constraints which may vary from one implementation to another. Moreover it should be appreciated that such a development effort might be complex and time consuming but may nevertheless be a routine undertaking of design fabrication and manufacture for those of ordinary skill having the benefit of this disclosure.

When introducing elements of various embodiments of the present disclosure the articles a an and the are intended to mean that there are one or more of the elements. The terms comprising including and having are intended to be inclusive and mean that there may be additional elements other than the listed elements. Additionally it should be understood that references to one embodiment or an embodiment of the present disclosure are not intended to be interpreted as excluding the existence of additional embodiments that also incorporate the recited features.

Embodiments of the present disclosure relate generally to adding devices to network and or fabrics consisting of several networks. In some embodiments these devices may already be deployed in the field but may be missing some information or features that are used to join the networks and or fabrics. Thus in some embodiments the data is sent over to the devices from a service before the devices join the networks and or fabrics. However some of the network fabric credentials such as keys and network names may not be known to the service. In such embodiments devices on the network fabric may send over the credentials to the joining device as assisting devices.

It should be appreciated that smart home environments may refer to smart environments or smart networks for any building type such as single family houses duplexes townhomes multi unit apartment buildings hotels retail stores office buildings industrial buildings and any building that may include one or more smart devices.

It is to be further appreciated that while the terms user customer installer homeowner occupant guest tenant landlord repair person user and similar terms may be used to refer to a person or persons interacting with a smart device within the network via a user interface these references are by no means to be considered as limiting the scope of the present teachings with respect to the person or persons who are performing such actions. Thus for example the terms user customer purchaser installer subscriber and homeowner may often refer to the same person in the case of a single family residential dwelling because the head of the household is often the person who makes the purchasing decision buys the unit and installs and configures the units and is also one of the users of the units. However in other scenarios such as a landlord tenant environment the customer may be the landlord with respect to purchasing the unit the installer may be a local apartment supervisor a first user may be the tenant and a second user may again be the landlord with respect to remote control functionality. While the identity of the person performing the action may be germane to a particular advantage provided by one or more of the embodiments for example the password protected network commissioning functionality described herein may be particularly advantageous where the landlord holds the sole password and can control network additions such identity should not be construed in the descriptions that follow as necessarily limiting the scope of the present teachings to those particular individuals having those particular identities.

With the foregoing in mind illustrates an example of a smart home environment also referred to as a smart network within which one or more of the devices methods systems services and or computer program products described further herein can be applicable. The depicted smart home environment includes a structure which can include e.g. a house office building garage or mobile home. In some embodiments the devices can also be integrated into a smart home environment that does not include an entire structure such as an apartment condominium or office space. Further the smart home environment can control and or be coupled to devices outside of the actual structure . Indeed several devices in the smart home environment need not physically be within the structure at all. For example a device controlling a pool heater or irrigation system can be located outside of the structure .

The depicted structure includes multiple rooms separated at least partly from each other via walls . The walls can include interior walls or exterior walls. Each room can further include a floor and a ceiling . Devices can be mounted on integrated with and or supported by a wall floor or ceiling .

In some embodiments the smart home environment of includes various devices including intelligent multi sensing network connected devices that may integrate seamlessly with each other with a central server with a cloud computing system or some combination of these to provide any of a variety of useful smart home objectives. The smart home environment may include one or more intelligent multi sensing network connected thermostats hereinafter referred to as smart thermostats one or more intelligent network connected multi sensing hazard detection units hereinafter referred to as smart hazard detectors one or more intelligent multi sensing network connected doorbell devices hereinafter referred to as smart doorbells and one or more intelligent network connected door locks hereinafter referred to as smart door locks . According to embodiments the smart thermostat detects ambient climate characteristics e.g. temperature and or humidity and controls a HVAC system accordingly. The smart hazard detector may detect the presence of a hazardous substance or a substance indicative of a hazardous substance e.g. smoke fire or carbon monoxide . The smart doorbell may detect a person s approach to or departure from a location e.g. an outer door control doorbell functionality announce a person s approach or departure via audio or visual means or control settings on a security system e.g. to activate or deactivate the security system when occupants go and come . The smart door locks may detect and toggle between a locked and unlocked condition for doors in the home detect a person s approach to or departure from a respective door detect whether a door is open or closed or other suitable controls associated with a smart door lock.

In some embodiments the smart home environment of further includes one or more intelligent multi sensing network connected wall switches hereinafter referred to as smart wall switches along with one or more intelligent multi sensing network connected wall plug interfaces hereinafter referred to as smart wall plugs . The smart wall switches may detect ambient lighting conditions detect room occupancy states and control a power and or dim state of one or more lights. In some instances smart wall switches may also control a power state or speed of a fan such as a ceiling fan. The smart wall plugs may detect occupancy of a room or enclosure and control supply of power to one or more wall plugs e.g. such that power is not supplied to the plug if nobody is at home .

Further in some embodiments the smart home environment of includes multiple intelligent multi sensing network connected appliances hereinafter referred to as smart appliances such as refrigerators stoves and or ovens televisions washers dryers lights stereos intercom systems garage door openers floor fans ceiling fans wall air conditioners pool heaters irrigation systems security systems window sensors security systems and so forth. According to embodiments the network connected appliances may be made compatible with the smart home environment by cooperating with the respective manufacturers of the appliances. For example the appliances can be space heaters window AC units motorized duct vents etc. When plugged in an appliance can announce itself to the smart home network such as by indicating what type of appliance it is and it can automatically integrate with the controls of the smart home. Such communication by the appliance to the smart home can be facilitated by any wired or wireless communication protocols known by those having ordinary skill in the art. The smart home also can include a variety of non communicating legacy appliances such as old conventional washer dryers refrigerators and the like which can be controlled albeit coarsely ON OFF by virtue of the smart wall plugs . The smart home environment can further include a variety of partially communicating legacy appliances such as infrared IR controlled wall air conditioners or other IR controlled devices which can be controlled by IR signals provided by the smart hazard detectors or the smart wall switches .

According to embodiments the smart thermostats the smart hazard detectors the smart doorbells the smart door lock the smart wall switches the smart wall plugs and other devices of the smart home environment may be modular and may be incorporated into older and new houses. For example in some embodiments the devices are designed around a modular platform consisting of two basic components a head unit and a back plate also referred to as a docking station. Multiple configurations of the docking station are provided so as to be compatible with any home such as older and newer homes. However all of the docking stations include a standard head connection arrangement such that any head unit can be removably attached to any docking station. Thus in some embodiments the docking stations are interfaces that serve as physical connections to the structure and the voltage wiring of the homes and the interchangeable head units contain all of the sensors processors user interfaces the batteries and other functional components of the devices.

Many different commercial and functional possibilities for provisioning maintenance and upgrade are possible. For example after years of using any particular head unit a user may be able to buy a new version of the head unit and simply plug it into the old docking station. There are also many different versions for the head units such as low cost versions with few features and then a progression of increasingly capable versions up to and including sophisticated head units with a large number of features. Thus it should be appreciated that the various versions of the head units may be interchangeable with any of them working when placed into any docking station. This can advantageously encourage sharing and re deployment of old head units for example when an important high capability head unit such as a hazard detector is replaced by a new version of the head unit then the old head unit can be re deployed to a backroom or basement etc. According to embodiments when first plugged into a docking station the head unit can ask the user by 2D LCD display 2D 3D holographic projection voice interaction etc. a few simple questions such as Where am I and the user can indicate living room kitchen and so forth.

The smart home environment may also include communication with devices outside of the physical home but within a proximate geographical range of the home. For example the smart home environment may include a pool heater monitor that communicates a current pool temperature to other devices within the smart home environment or receives commands for controlling the pool temperature. Similarly the smart home environment may include an irrigation monitor that communicates information regarding irrigation systems within the smart home environment and or receives control information for controlling such irrigation systems. According to embodiments an algorithm is provided for considering the geographic location of the smart home environment such as based on the zip code or geographic coordinates of the home. The geographic information then may be used to obtain data helpful for determining optimal times for watering. Such data may include sun location information temperature dew point soil type of the land on which the home is located etc.

By virtue of network connectivity one or more of the smart home devices of can also enable a user to interact with the device even if the user is not proximate to the device. For example a user can communicate with a device using a computer e.g. a desktop computer laptop computer or tablet or other portable electronic device e.g. a smartphone . A webpage or app can be configured to receive communications from the user and control the device based on the communications and or to present information about the device s operation to the user. For example the user can view a current setpoint temperature for a device and adjust it using a computer. The user can be in the structure during this remote communication or outside the structure.

As discussed users can control the smart thermostat and other smart devices in the smart home environment using a network connected computer or portable electronic device . In some embodiments the device may be connected to the smart network directly or through additional networks e.g. WiFi that are connected to the smart network using one or more devices e.g. an edge router . In some examples some or all of the occupants e.g. individuals who live in the home can register their device with the smart home environment . Such registration can be made at a central server to authenticate the occupant and or the device as being associated with the home and to give permission to the occupant to use the device to control the smart devices in the home. An occupant may use their registered device to remotely control the smart devices of the home such as when the occupant is at work or on vacation. The occupant may also use their registered device to control the smart devices when the occupant is actually located inside the home such as when the occupant is sitting on a couch inside the home. It should be appreciated that instead of or in addition to registering devices the smart home environment may make inferences about which individuals live in the home and are therefore occupants and which devices are associated with those individuals. As such the smart home environment learns who is an occupant and permits the devices associated with those individuals to control the smart devices of the home.

In some instances guests desire to control the smart devices. For example the smart home environment may receive communication from an unregistered mobile device of an individual inside of the home where said individual is not recognized as an occupant of the home. For example a smart home environment may receive communication from a mobile device of an individual who is known to be or who is registered as a guest or determined to be on a common network e.g. SSID WiFi network as the smart devices.

In some embodiments in addition to containing processing and sensing capabilities each of the devices and other smart devices collectively referred to as the smart devices may be capable of data communications and information sharing with any other of the smart devices as well as to any central server or cloud computing system or any other device that is network connected anywhere in the world. The required data communications can be carried out using any of a variety of custom or standard wireless protocols Wi Fi ZigBee 6LoWPAN etc. and or any of a variety of custom or standard wired protocols CAT6 Ethernet HomePlug etc. .

According to embodiments all or some of the smart devices can serve as wireless or wired repeaters. For example a first one of the smart devices can communicate with a second one of the smart device via a wireless router . The smart devices can further communicate with each other via a connection to a network such as the Internet . Through the Internet the smart devices can communicate with a central server or a cloud computing system . The central server or cloud computing system can be associated with a manufacturer support entity or service provider associated with the device. For some embodiments a user may be able to contact customer support using a device itself rather than needing to use other communication means such as a telephone or Internet connected computer. Further software updates can be automatically sent from the central server or cloud computing system to the smart devices e.g. when available when purchased or at routine intervals .

As discussed below the smart devices may be combined to create a mesh network. In some embodiments this mesh network may include spokesman and low power nodes in the smart home environment where some of the smart devices are spokesman nodes and others are low powered nodes. Some of the smart devices in the smart home environment are battery powered while others have a regular and reliable power source such as by connecting to wiring e.g. to 120V line voltage wires behind the walls of the smart home environment. The smart devices that have a regular and reliable power source are referred to as spokesman nodes. These nodes are equipped with the capability of using any wireless protocol or manner to facilitate bidirectional communication with any of a variety of other devices in the smart home environment as well as with the central server or cloud computing system . On the other hand the devices that are battery powered are referred to as low power nodes. These nodes tend to be smaller than spokesman nodes and may communicate using wireless protocols that requires very little power such as ZigBee 6LoWPAN etc. Furthermore some low power nodes may also have a relatively low amount of memory to reduce power consumption. Thus in some embodiments these low power nodes utilize streamlined messages and data formats of data e.g. certificates . Further some but not all low power nodes are incapable of bidirectional communication. These low power nodes send messages but they are unable to listen . Thus other devices in the smart home environment such as the spokesman nodes cannot send information to these low power listening only nodes.

As described the smart devices serve as low power and spokesman nodes to create a mesh network in the smart home environment . Individual low power nodes in the smart home environment regularly send out messages regarding what they are sensing and the other low powered nodes in the smart home environment in addition to sending out their own messages repeat the messages thereby causing the messages to travel from node to node i.e. device to device throughout the smart home environment . The spokesman nodes in the smart home environment are able to drop down to low powered communication protocols to receive these messages translate the messages to other communication protocols and send the translated messages to other spokesman nodes and or the central server or cloud computing system . Thus the low powered nodes using low power communication protocols are able to send messages across the entire smart home environment as well as over the Internet to the central server or cloud computing system . According to embodiments the mesh network enables the central server or cloud computing system to regularly receive data from all of the smart devices in the home make inferences based on the data and send commands back to one of the smart devices to accomplish some of the smart home objectives described herein.

As described the spokesman nodes and some of the low powered nodes are capable of listening . Accordingly users other devices and the central server or cloud computing system can communicate controls to the low powered nodes. For example a user can use the portable electronic device e.g. a smartphone to send commands over the Internet to the central server or cloud computing system which then relays the commands to the spokesman nodes in the smart home environment . The spokesman nodes drop down to a low power protocol to communicate the commands to the low power nodes throughout the smart home environment as well as to other spokesman nodes that did not receive the commands directly from the central server or cloud computing system .

An example of a low power node is a smart nightlight . In addition to housing a light source the smart nightlight houses an occupancy sensor such as an ultrasonic or passive IR sensor and an ambient light sensor such as a photoresistor or a single pixel sensor that measures light in the room. In some embodiments the smart nightlight is configured to activate the light source when its ambient light sensor detects that the room is dark and when its occupancy sensor detects that someone is in the room. In other embodiments the smart nightlight is simply configured to activate the light source when its ambient light sensor detects that the room is dark. Further according to some embodiments the smart nightlight includes a low power wireless communication chip e.g. ZigBee chip that regularly sends out messages regarding the occupancy of the room and the amount of light in the room including instantaneous messages coincident with the occupancy sensor detecting the presence of a person in the room. As mentioned above these messages may be sent wirelessly using the mesh network from node to node i.e. smart device to smart device within the smart home environment as well as over the Internet to the central server or cloud computing system .

Other examples of low powered nodes include battery operated versions of the smart hazard detectors . These smart hazard detectors are often located in an area without access to constant and reliable power and as discussed in detail below may include any number and type of sensors such as smoke fire heat sensors carbon monoxide dioxide sensors occupancy motion sensors ambient light sensors temperature sensors humidity sensors and the like. Furthermore smart hazard detectors can send messages that correspond to each of the respective sensors to the other devices and the central server or cloud computing system such as by using the mesh network as described above.

Examples of spokesman nodes include smart doorbells smart thermostats smart wall switches and smart wall plugs . These devices and are often located near and connected to a reliable power source and therefore can include more power consuming components such as one or more communication chips capable of bidirectional communication in any variety of protocols.

In some embodiments these low powered and spokesman nodes e.g. devices and may function as tripwires for an alarm system in the smart home environment. For example in the event a perpetrator circumvents detection by alarm sensors located at windows doors and other entry points of the smart home environment the alarm could be triggered upon receiving an occupancy motion heat sound etc. message from one or more of the low powered and spokesman nodes in the mesh network. For example upon receiving a message from a smart nightlight indicating the presence of a person the central server or cloud computing system or some other device could trigger an alarm provided the alarm is armed at the time of detection. Thus the alarm system could be enhanced by various low powered and spokesman nodes located throughout the smart home environment . In this example a user could enhance the security of the smart home environment by buying and installing extra smart nightlights .

In some embodiments the mesh network can be used to automatically turn on and off lights as a person transitions from room to room. For example the low powered and spokesman nodes e.g. devices and detect the person s movement through the smart home environment and communicate corresponding messages through the mesh network. Using the messages that indicate which rooms are occupied the central server or cloud computing system or some other device activates and deactivates the smart wall switches to automatically provide light as the person moves from room to room in the smart home environment . Further users may provide pre configuration information that indicates which smart wall plugs provide power to lamps and other light sources such as the smart nightlight . Alternatively this mapping of light sources to wall plugs can be done automatically e.g. the smart wall plugs detect when a light source is plugged into it and it sends a corresponding message to the central server or cloud computing system . Using this mapping information in combination with messages that indicate which rooms are occupied the central server or cloud computing system or some other device activates and deactivates the smart wall plugs that provide power to lamps and other light sources so as to track the person s movement and provide light as the person moves from room to room.

In some embodiments the mesh network of low powered and spokesman nodes can be used to provide exit lighting in the event of an emergency or an emergency drill. In some instances to facilitate this users provide pre configuration information that indicates exit routes in the smart home environment . For example for each room in the house the user may provide a map of the best exit route depending on availability of the route. In some situations the route may be blocked by a hazard and an alternate route may be illuminated and indicated if available. It should be appreciated that instead of a user providing this information the central server or cloud computing system or some other device could automatically determine the routes using uploaded maps diagrams architectural drawings of the smart home house as well as using a map generated based on positional information obtained from the nodes of the mesh network e.g. positional information from the devices is used to construct a map of the house . In operation when an alarm is activated e.g. when one or more of the smart hazard detector detects smoke and activates an alarm the central server or cloud computing system or some other device uses occupancy information obtained from the low powered and spokesman nodes to determine which rooms are occupied and then turns on lights e.g. nightlights wall switches wall plugs that power lamps etc. along the exit routes from the occupied rooms so as to provide emergency exit lighting.

Also included and illustrated in the smart home environment of are service robots each configured to carry out in an autonomous manner any of a variety of household tasks. For some embodiments the service robots can be respectively configured to perform floor sweeping floor washing etc. in a manner similar to that of known commercially available devices such as the ROOMBA and SCOOBA products sold by iRobot Inc. of Bedford Mass. Tasks such as floor sweeping and floor washing can be considered as away or while away tasks for purposes of the instant description as it is generally more desirable for these tasks to be performed when the occupants are not present. For other embodiments one or more of the service robots are configured to perform tasks such as playing music for an occupant serving as a localized thermostat for an occupant serving as a localized air monitor purifier for an occupant serving as a localized baby monitor serving as a localized hazard detector for an occupant and so forth it being generally more desirable for such tasks to be carried out in the immediate presence of the human occupant. For purposes of the instant description such tasks can be considered as human facing or human centric tasks.

When serving as a localized thermostat for an occupant a particular one of the service robots can be considered to be facilitating what can be called a personal comfort area network for the occupant with the objective being to keep the occupant s immediate space at a comfortable temperature wherever that occupant may be located in the home. This can be contrasted with conventional wall mounted room thermostats which have the more attenuated objective of keeping a statically defined structural space at a comfortable temperature. According to one embodiment the localized thermostat service robot is configured to move itself into the immediate presence e.g. within five feet of a particular occupant who has settled into a particular location in the home e.g. in the dining room to eat their breakfast and read the news . The localized thermostat service robot includes a temperature sensor a processor and wireless communication components configured such that control communications with the HVAC system either directly or through a wall mounted wirelessly communicating thermostat coupled to the HVAC system are maintained and such that the temperature in the immediate vicinity of the occupant is maintained at their desired level. If the occupant then moves and settles into another location e.g. to the living room couch to watch television the localized thermostat service robot proceeds to move and park itself next to the couch and keep that particular immediate space at a comfortable temperature.

Technologies by which the localized thermostat service robot and or the larger smart home system of can identify and locate the occupant whose personal area space is to be kept at a comfortable temperature can include but are not limited to RFID sensing e.g. person having an RFID bracelet RFID necklace or RFID key fob synthetic vision techniques e.g. video cameras and face recognition processors audio techniques e.g. voice sound pattern vibration pattern recognition ultrasound sensing imaging techniques and infrared or near field communication NFC techniques e.g. person wearing an infrared or NFC capable smartphone along with rules based inference engines or artificial intelligence techniques that draw useful conclusions from the sensed information e.g. if there is only a single occupant present in the home then that is the person whose immediate space should be kept at a comfortable temperature and the selection of the desired comfortable temperature should correspond to that occupant s particular stored profile .

When serving as a localized air monitor purifier for an occupant a particular service robot can be considered to be facilitating what can be called a personal health area network for the occupant with the objective being to keep the air quality in the occupant s immediate space at healthy levels. Alternatively or in conjunction therewith other health related functions can be provided such as monitoring the temperature or heart rate of the occupant e.g. using finely remote sensors near field communication with on person monitors etc. . When serving as a localized hazard detector for an occupant a particular service robot can be considered to be facilitating what can be called a personal safety area network for the occupant with the objective being to ensure there is no excessive carbon monoxide smoke fire etc. in the immediate space of the occupant. Methods analogous to those described above for personal comfort area networks in terms of occupant identifying and tracking are likewise applicable for personal health area network and personal safety area network embodiments.

According to some embodiments the above referenced facilitation of personal comfort area networks personal health area networks personal safety area networks and or other such human facing functionalities of the service robots are further enhanced by logical integration with other smart sensors in the home according to rules based inferencing techniques or artificial intelligence techniques for achieving better performance of those human facing functionalities and or for achieving those goals in energy conserving or other resource conserving ways. Thus for one embodiment relating to personal health area networks the air monitor purifier service robot can be configured to detect whether a household pet is moving toward the currently settled location of the occupant e.g. using on board sensors and or by data communications with other smart home sensors along with rules based inferencing artificial intelligence techniques and if so the air purifying rate is immediately increased in preparation for the arrival of more airborne pet dander. For another embodiment relating to personal safety area networks the hazard detector service robot can be advised by other smart home sensors that the temperature and humidity levels are rising in the kitchen which is nearby to the occupant s current dining room location and responsive to this advisory the hazard detector service robot will temporarily raise a hazard detection threshold such as a smoke detection threshold under an inference that any small increases in ambient smoke levels will most likely be due to cooking activity and not due to a genuinely hazardous condition.

The above described human facing and away functionalities can be provided without limitation by multiple distinct service robots having respective dedicated ones of such functionalities by a single service robot having an integration of two or more different ones of such functionalities and or any combinations thereof including the ability for a single service robot to have both away and human facing functionalities without departing from the scope of the present teachings. Electrical power can be provided by virtue of rechargeable batteries or other rechargeable methods with illustrating an exemplary out of the way docking station to which the service robots will automatically dock and recharge its batteries if needed during periods of inactivity. Preferably each service robot includes wireless communication components that facilitate data communications with one or more of the other wirelessly communicating smart home sensors of and or with one or more other service robots e.g. using Wi Fi ZigBee Z Wave 6LoWPAN etc. and one or more of the smart home devices of can be in communication with a remote server over the Internet. Alternatively or in conjunction therewith each service robot can be configured to communicate directly with a remote server by virtue of cellular telephone communications satellite communications 3G 4G network data communications or other direct communication method.

Provided according to some embodiments are systems and methods relating to the integration of the service robot s with home security sensors and related functionalities of the smart home system. The embodiments are particularly applicable and advantageous when applied for those service robots that perform away functionalities or that otherwise are desirable to be active when the home is unoccupied hereinafter away service robots . Included in the embodiments are methods and systems for ensuring that home security systems intrusion detection systems and or occupancy sensitive environmental control systems for example occupancy sensitive automated setback thermostats that enter into a lower energy using condition when the home is unoccupied are not erroneously triggered by the away service robots.

Provided according to some embodiments is a home automation and security system e.g. as shown in that is remotely monitored by a monitoring service by virtue of automated systems e.g. cloud based servers or other central servers hereinafter central server that are in data communications with one or more network connected elements of the home automation and security system. The away service robots are configured to be in operative data communication with the central server and are configured such that they remain in a non away service state e.g. a dormant state at their docking station unless permission is granted from the central server e.g. by virtue of an away service OK message from the central server to commence their away service activities. An away state determination made by the system which can be arrived at i exclusively by local on premises smart device s based on occupancy sensor data ii exclusively by the central server based on received occupancy sensor data and or based on received proximity related information such as GPS coordinates from user smartphones or automobiles or iii any combination of i and ii can then trigger the granting of away service permission to the away service robots by the central server. During the course of the away service robot activity during which the away service robots may continuously detect and send their in home location coordinates to the central server the central server can readily filter signals from the occupancy sensing devices to distinguish between the away service robot activity versus any unexpected intrusion activity thereby avoiding a false intrusion alarm condition while also ensuring that the home is secure. Alternatively or in conjunction therewith the central server may provide filtering data such as an expected occupancy sensing profile triggered by the away service robots to the occupancy sensing nodes or associated processing nodes of the smart home such that the filtering is performed at the local level. Although somewhat less secure it would also be within the scope of the present teachings for the central server to temporarily disable the occupancy sensing equipment for the duration of the away service robot activity.

According to another embodiment functionality similar to that of the central server in the above example can be performed by an on site computing device such as a dedicated server computer a master home automation console or panel or as an adjunct function of one or more of the smart home devices of . In such an embodiment there would be no dependency on a remote service provider to provide the away service OK permission to the away service robots and the false alarm avoidance filtering service or filter information for the sensed intrusion detection signals.

According to other embodiments there are provided methods and systems for implementing away service robot functionality while avoiding false home security alarms and false occupancy sensitive environmental controls without the requirement of a single overall event orchestrator. For purposes of the simplicity in the present disclosure the home security systems and or occupancy sensitive environmental controls that would be triggered by the motion noise vibrations or other disturbances of the away service robot activity are referenced simply as activity sensing systems and when so triggered will yield a disturbance detected outcome representative of the false trigger for example an alarm message to a security service or an arrival determination for an automated setback thermostat that causes the home to be heated or cooled to a more comfortable occupied setpoint temperature . According to one embodiment the away service robots are configured to emit a standard ultrasonic sound throughout the course of their away service activity the activity sensing systems are configured to detect that standard ultrasonic sound and the activity sensing systems are further configured such that no disturbance detected outcome will occur for as long as that standard ultrasonic sound is detected. For other embodiments the away service robots are configured to emit a standard notification signal throughout the course of their away service activity the activity sensing systems are configured to detect that standard notification signal and the activity sensing systems are further configured such that no disturbance detected outcome will occur for as long as that standard notification signal is detected wherein the standard notification signal comprises one or more of an optical notifying signal an audible notifying signal an infrared notifying signal an infrasonic notifying signal a wirelessly transmitted data notification signal e.g. an IP broadcast multicast or unicast notification signal or a notification message sent in an TCP IP two way communication session .

According to some embodiments the notification signals sent by the away service robots to the activity sensing systems are authenticated and encrypted such that the notifications cannot be learned and replicated by a potential burglar. Any of a variety of known encryption authentication schemes can be used to ensure such data security including but not limited to methods involving third party data security services or certificate authorities. For some embodiments a permission request response model can be used wherein any particular away service robot requests permission from each activity sensing system in the home when it is ready to perform its away service tasks and does not initiate such activity until receiving a yes or permission granted message from each activity sensing system or from a single activity sensing system serving as a spokesman for all of the activity sensing systems . One advantage of the described embodiments that do not require a central event orchestrator is that there can optionally be more of an arms length relationship between the supplier s of the home security environmental control equipment on the one hand and the supplier s of the away service robot s on the other hand as it is only required that there is the described standard one way notification protocol or the described standard two way request permission protocol to be agreed upon by the respective suppliers.

According to still other embodiments the activity sensing systems are configured to detect sounds vibrations RF emissions or other detectable environmental signals or signatures that are intrinsically associated with the away service activity of each away service robot and are further configured such that no disturbance detected outcome will occur for as long as that particular detectable signal or environmental signature is detected. By way of example a particular kind of vacuum cleaning away service robot may emit a specific sound or RF signature. For one embodiment the away service environmental signatures for each of multiple known away service robots are stored in the memory of the activity sensing systems based on empirically collected data the environmental signatures being supplied with the activity sensing systems and periodically updated by a remote update server. For another embodiment the activity sensing systems can be placed into a training mode for the particular home in which they are installed wherein they listen and learn the particular environmental signatures of the away service robots for that home during that training session and thereafter will suppress disturbance detected outcomes for intervals in which those environmental signatures are heard.

For still another embodiment which is particularly useful when the activity sensing system is associated with occupancy sensitive environmental control equipment rather than a home security system the activity sensing system is configured to automatically learn the environmental signatures for the away service robots by virtue of automatically performing correlations over time between detected environmental signatures and detected occupancy activity. By way of example for one embodiment an intelligent automated nonoccupancy triggered setback thermostat such as the Nest Learning Thermostat can be configured to constantly monitor for audible and RF activity as well as to perform infrared based occupancy detection. In particular view of the fact that the environmental signature of the away service robot will remain relatively constant from event to event and in view of the fact that the away service events will likely either a themselves be triggered by some sort of nonoccupancy condition as measured by the away service robots themselves or b occur at regular times of day there will be patterns in the collected data by which the events themselves will become apparent and for which the environmental signatures can be readily learned. Generally speaking for this automatic learning embodiment in which the environmental signatures of the away service robots are automatically learned without requiring user interaction it is more preferable that a certain number of false triggers be tolerable over the course of the learning process. Accordingly this automatic learning embodiment is more preferable for application in occupancy sensitive environmental control equipment such as an automated setback thermostat rather than home security systems for the reason that a few false occupancy determinations may cause a few instances of unnecessary heating or cooling but will not otherwise have any serious consequences whereas false home security alarms may have more serious consequences.

According to embodiments technologies including the sensors of the smart devices located in the mesh network of the smart home environment in combination with rules based inference engines or artificial intelligence provided at the central server or cloud computing system are used to provide a personal smart alarm clock for individual occupants of the home. For example user occupants can communicate with the central server or cloud computing system via their mobile devices to access an interface for the smart alarm clock. There occupants can turn on their smart alarm clock and input a wake time for the next day and or for additional days. In some embodiments the occupant may have the option of setting a specific wake time for each day of the week as well as the option of setting some or all of the inputted wake times to repeat . Artificial intelligence will be used to consider the occupant s response to these alarms when they go off and make inferences about the user s preferred sleep patterns over time.

According to embodiments the smart device in the smart home environment that happens to be closest to the occupant when the occupant falls asleep will be the device that transmits messages regarding when the occupant stopped moving from which the central server or cloud computing system will make inferences about where and when the occupant prefers to sleep. This closest smart device will as be the device that sounds the alarm to wake the occupant. In this manner the smart alarm clock will follow the occupant throughout the house by tracking the individual occupants based on their unique signature which is determined based on data obtained from sensors located in the smart devices. For example the sensors include ultrasonic sensors passive IR sensors and the like. The unique signature is based on a combination of walking gait patterns of movement voice height size etc. It should be appreciated that facial recognition may also be used.

According to an embodiment the wake times associated with the smart alarm clock are used by the smart thermostat to control the HVAC in an efficient manner so as to pre heat or cool the house to the occupant s desired sleeping and awake temperature settings. The preferred settings can be learned over time such as by observing which temperature the occupant sets the thermostat to before going to sleep and which temperature the occupant sets the thermostat to upon waking up.

According to an embodiment a device is positioned proximate to the occupant s bed such as on an adjacent nightstand and collects data as the occupant sleeps using noise sensors motion sensors e.g. ultrasonic IR and optical etc. Data may be obtained by the other smart devices in the room as well. Such data may include the occupant s breathing patterns heart rate movement etc. Inferences are made based on this data in combination with data that indicates when the occupant actually wakes up. For example if on a regular basis the occupant s heart rate breathing and moving all increase by 5 to 10 twenty to thirty minutes before the occupant wakes up each morning then predictions can be made regarding when the occupant is going to wake. Other devices in the home can use these predictions to provide other smart home objectives such as adjusting the smart thermostat so as to pre heat or cool the home to the occupant s desired setting before the occupant wakes up. Further these predictions can be used to set the smart alarm clock for the occupant to turn on lights etc.

According to embodiments technologies including the sensors of the smart devices located throughout the smart home environment in combination with rules based inference engines or artificial intelligence provided at the central server or cloud computing system are used to detect or monitor the progress of Alzheimer s disease. For example the unique signatures of the occupants are used to track the individual occupants movement throughout the smart home environment . This data can be aggregated and analyzed to identify patterns indicative of Alzheimer s. Oftentimes individuals with Alzheimer s have distinctive patterns of migration in their homes. For example a person will walk to the kitchen and stand there for a while then to the living room and stand there for a while and then back to the kitchen. This pattern will take about thirty minutes and then the person will repeat the pattern. According to embodiments the remote servers or cloud computing architectures analyze the person s migration data collected by the mesh network of the smart home environment to identify such patterns.

Although in some examples provided herein the devices and services platform communicates with and collects data from the smart devices of smart home environment of it should be appreciated that the devices and services platform may communicate with and collect data from multiple smart home environments across the world. For example the central server or cloud computing system can collect home data from the devices of one or more smart home environments where the devices can routinely transmit home data or can transmit home data in specific instances e.g. when a device queries the home data . Thus the devices and services platform may routinely collect data from homes across the world. As described the collected home data includes for example power consumption data occupancy data HVAC settings and usage data carbon monoxide levels data carbon dioxide levels data volatile organic compounds levels data sleeping schedule data cooking schedule data inside and outside temperature humidity data television viewership data inside and outside noise level data etc.

The central server or cloud computing architecture can further provide one or more services . The services can include e.g. software updates customer support sensor data collection logging weather information account information remote access remote or distributed control or use suggestions e.g. based on collected home data to improve performance reduce utility cost etc. . Data associated with the services can be stored at the central server or cloud computing system and the central server or the cloud computing system can retrieve and transmit the data at an appropriate time e.g. at regular intervals upon receiving a request from a user etc. .

As illustrated in an embodiment of the extensible devices and services platform includes a processing engine which can be concentrated at a single server or distributed among several different computing entities without limitation. The processing engine can include engines configured to receive data from devices of smart home environments e.g. via the Internet or a hubbed network to index the data to analyze the data and or to generate statistics based on the analysis or as part of the analysis. The analyzed data can be stored as derived home data .

Results of the analysis or statistics can thereafter be transmitted back to the device that provided home data used to derive the results to other devices to a server providing a webpage to a user of the device or to other non device entities. For example use statistics use statistics relative to use of other devices use patterns and or statistics summarizing sensor readings can be generated by the processing engine and transmitted. The results or statistics can be provided via the Internet . In this manner the processing engine can be configured and programmed to derive a variety of useful information from the home data . A single server can include one or more engines.

The derived data can be highly beneficial at a variety of different granularities for a variety of useful purposes ranging from explicit programmed control of the devices on a per home per neighborhood or per region basis for example demand response programs for electrical utilities to the generation of inferential abstractions that can assist on a per home basis for example an inference can be drawn that the homeowner has left for vacation and so security detection equipment can be put on heightened sensitivity to the generation of statistics and associated inferential abstractions that can be used for government or charitable purposes. For example processing engine can generate statistics about device usage across a population of devices and send the statistics to device users service providers or other entities e.g. that have requested or may have provided monetary compensation for the statistics .

According to some embodiments the home data the derived home data and or another data can be used to create automated neighborhood safety networks. For example in the event the central server or cloud computing architecture receives data indicating that a particular home has been broken into is experiencing a fire or some other type of emergency event an alarm is sent to other smart homes in the neighborhood. In some instances the central server or cloud computing architecture automatically identifies smart homes within a radius of the home experiencing the emergency and sends an alarm to the identified homes. In such instances the other homes in the neighborhood do not have to sign up for or register to be a part of a safety network but instead are notified of an emergency based on their proximity to the location of the emergency. This creates robust and evolving neighborhood security watch networks such that if one person s home is getting broken into an alarm can be sent to nearby homes such as by audio announcements via the smart devices located in those homes. Additionally or alternatively if a neighbor s hazard detector detect smoke neighboring houses may activate irrigation systems to reduce likelihood of a spread of fire. It should be appreciated that this safety network can be an opt in service and that in addition to or instead of the central server or cloud computing architecture selecting which homes to send alerts to individuals can subscribe to participate in such networks and individuals can specify which homes they want to receive alerts from. This can include for example the homes of family members who live in different cities such that individuals can receive alerts when their loved ones in other locations are experiencing an emergency.

According to some embodiments sound vibration and or motion sensing components of the smart devices are used to detect sound vibration and or motion created by running water. Based on the detected sound vibration and or motion the central server or cloud computing architecture makes inferences about water usage in the home and provides related services. For example the central server or cloud computing architecture can run programs algorithms that recognize what water sounds like and when it is running in the home. According to one embodiment to map the various water sources of the home upon detecting running water the central server or cloud computing architecture sends a message an occupant s mobile device asking if water is currently running or if water has been recently run in the home and if so which room and which water consumption appliance e.g. sink shower toilet etc. was the source of the water. This enables the central server or cloud computing architecture to determine the signature or fingerprint of each water source in the home. This is sometimes referred to herein as audio fingerprinting water usage. 

In one illustrative example the central server or cloud computing architecture creates a signature for the toilet in the master bathroom and whenever that toilet is flushed the central server or cloud computing architecture will know that the water usage at that time is associated with that toilet. Thus the central server or cloud computing architecture can track the water usage of that toilet as well as each water consumption application in the home. This information can be correlated to water bills or smart water meters so as to provide users with a breakdown of their water usage.

According to some embodiments sound vibration and or motion sensing components of the smart devices are used to detect sound vibration and or motion created by mice and other rodents as well as by termites cockroaches and other insects collectively referred to as pests . Based on the detected sound vibration and or motion the central server or cloud computing architecture makes inferences about pest detection in the home and provides related services. For example the central server or cloud computing architecture can run programs algorithms that recognize what certain pests sound like how they move and or the vibration they create individually and or collectively. According to one embodiment the central server or cloud computing architecture can determine the signatures of particular types of pests.

For example in the event the central server or cloud computing architecture detects sounds that may be associated with pests it notifies the occupants of such sounds and suggests hiring a pest control company. If it is confirmed that pests are indeed present the occupants input to the central server or cloud computing architecture confirms that its detection was correct along with details regarding the identified pests such as name type description location quantity etc. This enables the central server or cloud computing architecture to tune itself for better detection and create signatures or fingerprints for specific types of pests. For example the central server or cloud computing architecture can use the tuning as well as the signatures and fingerprints to detect pests in other homes such as nearby homes that may be experiencing problems with the same pests. Further for example in the event that two or more homes in a neighborhood are experiencing problems with the same or similar types of pests the central server or cloud computing architecture can make inferences that nearby homes may also have such problems or may be susceptible to having such problems and it can send warning messages to those homes to help facilitate early detection and prevention.

In some embodiments to encourage innovation and research and to increase products and services available to users the devices and services platform expose a range of application programming interfaces APIs to third parties such as charities governmental entities e.g. the Food and Drug Administration or the Environmental Protection Agency academic institutions e.g. university researchers businesses e.g. providing device warranties or service to related equipment targeting advertisements based on home data utility companies and other third parties. The APIs may be coupled to and permit third party systems to communicate with the central server or the cloud computing system including the services the processing engine the home data and the derived home data . For example APIs may allow applications executed by the third parties to initiate specific data processing tasks that are executed by the central server or the cloud computing system as well as to receive dynamic updates to the home data and the derived home data .

For example third parties can develop programs and or applications such as web or mobile apps that integrate with the central server or the cloud computing system to provide services and information to users. Such programs and application may be for example designed to help users reduce energy consumption to preemptively service faulty equipment to prepare for high service demands to track past service performance etc. or to perform any of a variety of beneficial functions or tasks now known or hereinafter developed.

According to some embodiments third party applications make inferences from the home data and the derived home data such inferences may include when are occupants home when are they sleeping when are they cooking when are they in the den watching television and when do they shower. The answers to these questions may help third parties benefit consumers by providing them with interesting information products and services as well as with providing them with targeted advertisements.

In one example a shipping company creates an application that makes inferences regarding when people are at home. The application uses the inferences to schedule deliveries for times when people will most likely be at home. The application can also build delivery routes around these scheduled times. This reduces the number of instances where the shipping company has to make multiple attempts to deliver packages and it reduces the number of times consumers have to pick up their packages from the shipping company.

For example shows processing engine as including a number of paradigms . Processing engine can include a managed services paradigm that monitors and manages primary or secondary device functions. The device functions can include ensuring proper operation of a device given user inputs estimating that e.g. and responding to an instance in which an intruder is or is attempting to be in a dwelling detecting a failure of equipment coupled to the device e.g. a light bulb having burned out implementing or otherwise responding to energy demand response events or alerting a user of a current or predicted future event or characteristic. Processing engine can further include an advertising communication paradigm that estimates characteristics e.g. demographic information desires and or products of interest of a user based on device usage. Services promotions products or upgrades can then be offered or automatically provided to the user. Processing engine can further include a social paradigm that uses information from a social network provides information to a social network for example based on device usage and or processes data associated with user and or device interactions with the social network platform. For example a user s status as reported to their trusted contacts on the social network could be updated to indicate when they are home based on light detection security system inactivation or device usage detectors. As another example a user may be able to share device usage statistics with other users. In yet another example a user may share HVAC settings that result in low power bills and other users may download the HVAC settings to their smart thermostat to reduce their power bills.

The processing engine can include a challenges rules compliance rewards paradigm that informs a user of challenges competitions rules compliance regulations and or rewards and or that uses operation data to determine whether a challenge has been met a rule or regulation has been complied with and or a reward has been earned. The challenges rules or regulations can relate to efforts to conserve energy to live safely e.g. reducing exposure to toxins or carcinogens to conserve money and or equipment life to improve health etc. For example one challenge may involve participants turning down their thermostat by one degree for one week. Those that successfully complete the challenge are rewarded such as by coupons virtual currency status etc. Regarding compliance an example involves a rental property owner making a rule that no renters are permitted to access certain owner s rooms. The devices in the room having occupancy sensors could send updates to the owner when the room is accessed.

The processing engine may integrate or otherwise utilize extrinsic information from extrinsic sources to improve the functioning of one or more processing paradigms. Extrinsic information can be used to interpret data received from a device to determine a characteristic of the environment near the device e.g. outside a structure that the device is enclosed in to determine services or products available to the user to identify a social network or social network information to determine contact information of entities e.g. public service entities such as an emergency response team the police or a hospital near the device etc. to identify statistical or environmental conditions trends or other information associated with a home or neighborhood and so forth.

An extraordinary range and variety of benefits may be brought about by and fit within the scope of the described extensible devices and services platform ranging from the ordinary to the profound. Thus in one ordinary example each bedroom of the smart home environment can be provided with a smart wall switch a smart wall plug and or smart hazard detectors all or some of which include an occupancy sensor wherein the occupancy sensor is also capable of inferring e.g. by virtue of motion detection facial recognition audible sound patterns etc. whether the occupant is asleep or awake. If a fire event is sensed the remote security monitoring service or fire department is advised of how many occupants there are in each bedroom and whether those occupants are still asleep or immobile or whether they have properly evacuated the bedroom. While this is of course a very advantageous capability accommodated by the described extensible devices and services platform there can be substantially more profound examples that can truly illustrate the potential of a larger intelligence that can be made available. By way of perhaps a more profound example the same bedroom occupancy data that is being used for fire safety can also be repurposed by the processing engine in the context of a social paradigm of neighborhood child development and education. Thus for example the same bedroom occupancy and motion data discussed in the ordinary example can be collected and made available properly anonymized for processing in which the sleep patterns of schoolchildren in a particular ZIP code can be identified and tracked. Localized variations in the sleeping patterns of the schoolchildren may be identified and correlated for example to different nutrition programs in local schools.

By way of introduction illustrates an example of a device e.g. thermostat and or hazard detector that may that may communicate with other like devices within a home environment. In one embodiment the device may include one or more sensors a user interface component a power supply e.g. including a power connection and or battery a network interface a processor and the like. Particular sensors user interface components and power supply configurations may be the same or similar within each device . However it should be noted that in some embodiments each device may include particular sensors user interface components power supply configurations and the like based on a device type or model.

The sensors in certain embodiments may detect various properties such as acceleration temperature humidity water supplied power proximity external motion device motion sound signals ultrasound signals light signals fire smoke carbon monoxide global positioning satellite GPS signals radio frequency RF other electromagnetic signals or fields or the like. As such the sensors may include temperature sensor s humidity sensor s hazard related sensor s or other environmental sensor s accelerometer s microphone s optical sensors up to and including camera s e.g. charged coupled device or video cameras active or passive radiation sensors GPS receiver s radiofrequency identification detector s and or other suitable sensors. While illustrates an embodiment with a single sensor many embodiments may include multiple sensors. In some instances the device may includes one or more primary sensors and one or more secondary sensors. Here the primary sensor s may sense data central to the core operation of the device e.g. sensing a temperature in a thermostat or sensing smoke in a smoke detector while the secondary sensor s may sense other types of data e.g. motion light or sound which can be used for energy efficiency objectives security objectives safety objectives and or smart operation objectives.

One or more user interface components in the device may receive input from the user and or present information to the user. The received input may be used to determine one or more settings. In certain embodiments the user interface components may include a mechanical or virtual component that responds to the user s motion. For example the user may mechanically move a sliding component e.g. along a vertical or horizontal track or rotate a rotatable ring e.g. along a circular track or move an object e.g. finger across onto a touchpad of the device . Such motions may correspond to a setting adjustment which can be determined based on an absolute position of a user interface component or based on a displacement of a user interface components e.g. adjusting a set point temperature by 1 degree F. for every 10 rotation of a rotatable ring component . Physically and virtually movable user interface components can allow a user to set a setting along a portion of an apparent continuum. Thus the user may not be confined to choose between two discrete options e.g. as would be the case if up and down buttons were used but can quickly and intuitively define a setting along a range of possible setting values. For example a magnitude of a movement of a user interface component may be associated with a magnitude of a setting adjustment such that a user may dramatically alter a setting with a large movement or finely tune a setting with s small movement.

The user interface components may also include one or more buttons e.g. up and down buttons a keypad a number pad a switch a microphone and or a camera e.g. to detect gestures . In some embodiments the user interface component may include a click and rotate annular ring component that may enable the user to interact with the component by rotating the ring e.g. to adjust a setting and or by clicking the ring inwards e.g. to select an adjusted setting or to select an option . In another embodiment the user interface component may include a camera that may detect gestures e.g. to indicate that a power or alarm state of a device is to be changed . In some instances the device may have one primary input component which may be used to set a plurality of types of settings. The user interface components may also be configured to present information to a user via e.g. a visual display e.g. a thin film transistor display or organic light emitting diode display and or an audio speaker.

The power supply component may include a power connection and or a local battery. For example the power connection may connect the device to a power source such as a line voltage source. In some instances an AC power source can be used to repeatedly charge a e.g. rechargeable local battery such that the battery may be used later to supply power to the device when the AC power source is not available.

The network interface may include a component that enables the device to communicate between devices. In one embodiment the network interface may communicate using an efficient network layer as part of its Open Systems Interconnection OSI model. In one embodiment the efficient network layer which will be described in more detail below with reference to may enable the device to wirelessly communicate IPv6 type data or traffic using a RIPng routing mechanism and a DTLS security scheme. As such the network interface may include a wireless card or some other transceiver connection.

The processor may support one or more of a variety of different device functionalities. As such the processor may include one or more processors configured and programmed to carry out and or cause to be carried out one or more of the functionalities described herein. In one embodiment the processor may include general purpose processors carrying out computer code stored in local memory e.g. flash memory hard drive and random access memory special purpose processors or application specific integrated circuits combinations thereof and or using other types of hardware firmware software processing platforms. Further the processor may be implemented as localized versions or counterparts of algorithms carried out or governed remotely by central servers or cloud based systems such as by virtue of running a Java virtual machine JVM that executes instructions provided from a cloud server using Asynchronous JavaScript and XML AJAX or similar protocols. By way of example the processor may detect when a location e.g. a house or room is occupied up to and including whether it is occupied by a specific person or is occupied by a specific number of people e.g. relative to one or more thresholds . In one embodiment this detection can occur e.g. by analyzing microphone signals detecting user movements e.g. in front of a device detecting openings and closings of doors or garage doors detecting wireless signals detecting an IP address of a received signal detecting operation of one or more devices within a time window or the like. Moreover the processor may include image recognition technology to identify particular occupants or objects.

In certain embodiments the processor may also include a high power processor and a low power processor. The high power processor may execute computational intensive operations such as operating the user interface component and the like. The low power processor on the other hand may manage less complex processes such as detecting a hazard or temperature from the sensor . In one embodiment the low power processor may wake or initialize the high power processor for computationally intensive processes.

In some instances the processor may predict desirable settings and or implement those settings. For example based on the presence detection the processor may adjust device settings to e.g. conserve power when nobody is home or in a particular room or to accord with user preferences e.g. general at home preferences or user specific preferences . As another example based on the detection of a particular person animal or object e.g. a child pet or lost object the processor may initiate an audio or visual indicator of where the person animal or object is or may initiate an alarm or security feature if an unrecognized person is detected under certain conditions e.g. at night or when lights are off .

In some instances devices may interact with each other such that events detected by a first device influences actions of a second device. For example a first device can detect that a user has pulled into a garage e.g. by detecting motion in the garage detecting a change in light in the garage or detecting opening of the garage door . The first device can transmit this information to a second device via the efficient network layer such that the second device can e.g. adjust a home temperature setting a light setting a music setting and or a security alarm setting. As another example a first device can detect a user approaching a front door e.g. by detecting motion or sudden light pattern changes . The first device may e.g. cause a general audio or visual signal to be presented e.g. such as sounding of a doorbell or cause a location specific audio or visual signal to be presented e.g. to announce the visitor s presence within a room that a user is occupying .

By way of example the device may include a thermostat such as a Nest Learning Thermostat. Here the thermostat may include sensors such as temperature sensors humidity sensors and the like such that the thermostat may determine present climate conditions within a building where the thermostat is disposed. The power supply component for the thermostat may be a local battery such that the thermostat may be placed anywhere in the building without regard to being placed in close proximity to a continuous power source. Since the thermostat may be powered using a local battery the thermostat may minimize its energy use such that the battery is rarely replaced.

In one embodiment the thermostat may include a circular track that may have a rotatable ring disposed thereon as the user interface component . As such a user may interact with or program the thermostat using the rotatable ring such that the thermostat controls the temperature of the building by controlling a heating ventilation and air conditioning HVAC unit or the like. In some instances the thermostat may determine when the building may be vacant based on its programming. For instance if the thermostat is programmed to keep the HVAC unit powered off for an extended period of time the thermostat may determine that the building will be vacant during this period of time. Here the thermostat may be programmed to turn off light switches or other electronic devices when it determines that the building is vacant. As such the thermostat may use the network interface to communicate with a light switch device such that it may send a signal to the light switch device when the building is determined to be vacant. In this manner the thermostat may efficiently manage the energy use of the building.

Keeping the examples of in mind illustrates an example wireless mesh network that may be employed to facilitate communication between some of the devices such as those described above. As shown in a thermostat may have a direct wireless connection to a plug interface which may be wirelessly connected to a hazard detection unit and to a light switch . In the same manner the light switch may be wirelessly coupled to a portable electronic device and an appliance . The appliance may just be coupled to a pool heater and the portable electronic device may just be coupled to an irrigation system . The irrigation system may have a wireless connection to an entryway interface device .

Generally the network may be part of an Open Systems Interconnection OSI model as depicted in . The OSI model illustrates functions of a communication system with respect to abstraction layers. That is the OSI model may specify a networking framework or how communications between devices may be implemented. In one embodiment the OSI model may include six layers a physical layer a data link layer a network layer a transport layer a platform layer and an application layer . Generally each layer in the OSI model may serve the layer above it and may be served by the layer below it.

Keeping this in mind the physical layer may provide hardware specifications for devices that may communicate with each other. As such the physical layer may establish how devices may connect to each other assist in managing how communication resources may be shared between devices and the like.

The data link layer may specify how data may be transferred between devices. Generally the data link layer may provide a way in which data packets being transmitted may be encoded and decoded into bits as part of a transmission protocol.

The network layer may specify how the data being transferred to a destination node is routed. The network layer may also interface with a security protocol in the application layer to ensure that the integrity of the data being transferred is maintained.

The transport layer may specify a transparent transfer of the data from a source node to a destination node. The transport layer may also control how the transparent transfer of the data remains reliable. As such the transport layer may be used to verify that data packets intended to transfer to the destination node indeed reached the destination node. Example protocols that may be employed in the transport layer may include Transmission Control Protocol TCP and User Datagram Protocol UDP .

The platform layer may establish connections between devices according to the protocol specified within the transport layer . The platform layer may also translate the data packets into a form that the application layer may use. The application layer may support a software application that may directly interface with the user. As such the application layer may implement protocols defined by the software application. For example the software application may provide serves such as file transfers electronic mail and the like.

The network layer may route data between the devices using a communication protocol based on Internet Protocol version 6 IPv6 . As such each device may include a 128 bit IPv6 address that may provide each device with a unique address to use to identify itself over the Internet a local network or a fabric overlaying a group of networks or the like. In some embodiments the network layer may identify a protocol e.g. RIPng that determines how data is routed between the devices. As illustrated in using one or more layers information may be exchanged between devices and .

As illustrated in when a device connects to a service e.g. the device is to be updated and or added to a network or a common fabric among a group of networks the new device may be missing one or more features or information that may be used to join the network or fabric. Thus during operation of the device the device connects to a service . In some embodiments the device may connect to the service as part of a normal operation e.g. daily update data request etc. and a header for the desired operation indicates that the device does not have provisioning information. As will be discussed below at least a portion of the communication with the service occurs through an interface for the device. For example the interface may include a server in a group of servers used to implement the cloud. The interface may redirect incoming traffic to the appropriate locations within the service or take appropriate actions in response to requests received from devices connected to the service . For example when the interface receives an entry request from the device the interface determines that the device should receive provisioning data from a provisioning database .

In some embodiments the provisioning database may be populated with information from a security station that includes lists of keys certificates and or other security information. This security information is used to generate provisioning data for devices. In certain embodiments the provisioning data is indexed in the provisioning database and stored along with other information. For example each entry in the provisioning database may include data such as that illustrated in Table 1 below.

In some embodiments the Device ID may be a MAC address used to connect the device to a network. However in some embodiments the device may not have access to this number until provisioned using the provisioning database entry. Thus in such embodiments the device may only know the device serial number. Thus in such embodiments requests from the device may be referenced by serial number. Accordingly in some embodiments the provisioning database entries may be indexed by the device serial number.

In some embodiments to ensure security this data is generated by a generation unit that is in the security station that is offline in a secure location. In other words the security station is securely separate from the service and or the provisioning database . Thus in such embodiments a request to the service for the data may not include direct access by the service to the keys .

The securely generated provisional data is provided to the provisioning database to be sent to respective devices. In certain embodiments the provisional data is stored in an encrypted format that blocks unauthorized access. For example the provisional data may be encrypted using Advanced Encryption Standard 256 in Cipher Block Chaining Mode AES256CBC or other suitable encryption techniques.

Moreover in some embodiments the service may not have access to the decryption keys for the data and the keys used to decrypt the data may be specific to the device for whom the data is intended. In some embodiments each entry of provisional data in the provisioning database may be linked to a specific device using some identifier e.g. serial number for the device. For example the encryption and integrity keys may be derived from a default secret stored in the device using a suitable encryption algorithm e.g. HMAC based Extract and Expand Key Derivation Function Hashed Message Authentication Code Secure Hash Algorithm HDKF HMAC SHA256 algorithm . Moreover the device s serial number and a fixed string may be provided to the algorithm s info input. Thus in such embodiments each provisional data entry in the provisioning database may be specific to a particular device and the key for the provisional data entry is bound to the device . In some embodiments at least some information used to couple the device to a respective fabric and or network may not be included in the provisional data because such information is not accessible by the service . Instead in such embodiments the relevant information may be acquired from devices already present in the fabric and or network to be joined.

In some embodiments using the unique identifier for the device the service sends an entry request that includes the provisioning data to enable the device to join or create a network and or a fabric using information provided in the provisioning data .

In some embodiments the device may receive the provisioning in an encrypted format e.g. AES 256 CBC using an encryption key derived from a secret known to the device as previously discussed. Using the encryption key the device decrypts the provisioning information block . In some embodiments decrypting the provisioning information comprises deriving the encryption key using the secret known to the device used to encrypt the provisioning information. In some embodiments only a portion of the received data is encrypted. For example the received message may include a device serial number a MAC address for the device and the provisioning information. In some of these embodiments only the provisioning information is encrypted while the device serial number and the MAC address are not encrypted.

Before during and or after the provisioning information is decrypted the device may verify that the received data is valid block . For example in some embodiments the device may decode a certificate in the provisioning information and verify that the ID for the certificate matches the device ID verify that a private key in the provisioning information matches a public key in the device certificate and or verify that the pairing code includes a valid check digit. Moreover in some embodiments the provisioning information may include an integrity check value generated using an integrity key also derived from the secret known to the device. For example in certain embodiments the provisioning information may include an HMAC SHA256 integrity check value. In some embodiments the verification of validity of the received data may also include verifying by the device or the service that the device does not already have provisioning information. Based on verification information the device determines whether the update to the device is valid block . For example if any of the foregoing verification steps fail the update may be deemed invalid. Furthermore in some embodiments the device may verify that provisioning information has been stored in the device. Moreover if one or more expected portions e.g. certificate pairing code and or private key are determined to be missing from the device s memory the update may be logged as invalid.

If the provisioning information update is invalid the device logs a failure to add valid provisioning information block . In some embodiments logging the failure includes removing the invalid provisioning information from memory so that no impartial updates are stored. Therefore if the device is updated with the provisioning information the device has received all relevant information. Based on the logged failure the device may flag one or more messages to indicate failure to update the device with the provisioning information block . For example the provisioning state header may be marked as last provisioning failed so that the next related message e.g. update request message sent by the device to the service may be logged by the service.

In some embodiments only if the provisioning information update is deemed valid the device stores the information in persistent memory block . Once the information is stored in memory the device updates it provisioning state block . In some embodiments this update may be sent to the service immediately but in other embodiments the device may send the updated state when the next scheduled or desired message is sent to the service. In some embodiments if the device fails to store the provisional information and is unable to do so the device may instead update the provisioning state of the next message to a last provisioning failed state for the next message. In other embodiments the default value for the provisioning state may be a failed last provisioning. Thus in such embodiments if an update fails the device may leave the last update failed intact. However in some embodiments the headers may include a type of failure. Therefore when updating the status the device may update the failure from the default failure to a relevant failure type.

If the service determines that the state of the device is not provisioned the service may request provisioning information from a database storing such information block . For example the original message received by the service may include a device identifier e.g. device serial number that may be used to lookup the particular provisioning information relevant to the device that is stored in a provisioning database. Moreover in some embodiments the device identifier may also be included in the headers also used to determine the provisioning state of the device.

The service may receive a response from the database that includes the provisioning information for the particular device and forward the information to the device block . In some embodiments the service may determine whether a device ID in the request header matches a device ID in the provisioning information. If the device IDs do not match in some embodiments the service will log the error and take no further action. In other embodiments the service will log the error and forward the error to an appropriate place. However if the device IDs do match the service has completed the appropriate actions until a next message from the device is received that indicates whether the provisioning has completed or has failed. As discussed previously in some embodiments the service may be incapable of decrypting the provisioning information. Furthermore in some embodiments it may be desirable to delay an update of provisioning system by the service. In such cases the service may send a response to the device that omits the provisioning data headers. The device may determine that the service does not want to update the information currently. Instead the device may send the provisioning state headers and device ID information in subsequent communications with the service.

If the service determines that the last provisioning attempt for the device has failed the service may log the error block . Upon logging the error the service may determine whether to retry the update or not block . For example the service may determine whether a retry flag has been set to true or false. Moreover in some embodiments the retry flag may be an operator configurable option that may be set by the user. If the flag is set to false the service may take no further action block . However if the flag is set to true the service may proceed as if the provisioning state had been set to not provisioned.

Using the device ID the certification bundle is encrypted using a key that is stored on the device at time of manufacture block . Thus the certification bundle may be encrypted in a format that the device for which the bundle in intended is able to decrypt the bundle while one or more intermediate devices are unable to access the certification bundle. In some embodiments the encryption may be created using any suitable algorithm such as the HDKF HMAC SHA256 algorithm. Once the credential bundle is encrypted the encrypted bundle may be stored block . In some embodiments additional information may be added to the credential bundle such as an unencrypted device ID and a device serial number and the additional information may be included with the encrypted bundle to form provisioning information. Moreover in some embodiments storing the bundle may include sending the encrypted bundle to a remote location e.g. provisioning database for storage.

In some embodiments the provisioning information may provide the device with an ability to join a network or fabric. However the device may still lack some network fabric specific information. For example the device may not have a fabric network name and or respective keys for joining the fabric network. In some embodiments the service may not have had this information to share with the device. illustrates a schematic view of an arrangement of a communication between the device and the service . It may also be desirable to connect to a network fabric . For example if the network fabric is considered as a fabric devices may be interconnected using one or more networks e.g. network which are overlaid with a fabric that provides an additional layer of security and or routing communications between the devices using one or more networks. If the network fabric is considered as a network the devices may all be connected via the network and may also be connected via in additional layer through a fabric. Furthermore the network may be a first network type e.g. 802.15.4. and the network may be a second network type e.g. WiFi . Each of the networks may include edge routers that enable the networks to connect to outside devices e.g. the service via the Internet. In some embodiments the devices may be connected to the network using a set of security credentials . For example if the network is a WiFi network the security credentials may include an SSID and password for the network and one or more other parameters such as security type or ports for communication. The devices may also include security credentials for connecting to the network fabric . For example for an 802.15.4 network the security credentials may include a personal area network PAN name and a key. For a fabric the security credentials may include a fabric ID and a fabric key. In some embodiments the fabric ID and the fabric key may be generated by a first device that creates the fabric then shared with subsequent devices. The device does not have the fabric credentials or the network credentials. Thus the device may retrieve the fabric and or network credentials from the device . The service may assist in this retrieval without actually receiving the credentials thereby encouraging security of the networks and fabrics by ensuring that the security credentials do not leave the networks. Thus in such embodiments the service cannot act as a single point of failure leading to vulnerability of the networks and or fabrics were the service to be compromised. To utilize this communication between the device and the devices the service may include a point of contact through which the devices may connect to the service. The service may also include control logic that may be used to connect and or control one or more devices e.g. thermostats HVAC from the service .

The control logic may include a server within the service and maintains buckets of information associated with each device. In some embodiments when a device is updated to incorporate updates for the device the update adds new field value pairs that include the assisting device ID. For example the control logic may include buckets such as those described in U.S. Pat. No. 8 635 373 entitled Subscription Notification Mechanisms for Synchronization of Distributed States filed on Sep. 22 2012 incorporated by reference in its entirety.

As discussed below the service respond to the joining device with a response indicating which device in the network may assist the joining device in joining the network . As discussed below the service may also provide the device with some authentication e.g. authentication information token access token for communication with the device or the device . Using this authentication information the device may connect to one of the devices and request security credentials for the network . In some embodiments the response to the first communication from the device to the service may include the authentication information. In other embodiments the authentication information may be sent at a separate time in response to a token request by the joining device .

Once the device receives a response from the service the device then examines the headers in the response to determine if the device ID corresponds to the device block . If the device ID corresponds to the device the device will then create a network and or fabric as discussed below in relation to block . If the device ID corresponds to another device the device determines whether it is in a state to be a joining device block . For example the device determines whether it has the provisioning information whether the device is a same structure as the assisting device the device is not already a member of the primary fabric for its structure whether the device is online whether the device is not currently busy e.g. not in the middle of a heat cycle and or the device is running a version of software capable of joining the network and or fabric. If the device is not ready to join a fabric or network for any reason the device may report such status to the service block . In some embodiments once the device has reported its inability to join currently the device may return to waiting for a communication from the service .

It should be appreciated that signaling the device to create its own network and or fabric is not necessarily limited to setting the header to the device ID of device . Rather the service may instruct the device to create its own network and or fabric using any of a variety of commands or instructions sent from the service or on behalf of the service to the device. Moreover such an instruction need not be sent in response to the device contacting the service but rather can be communicated to the device at other times.

Returning to if a network and or fabric already exists and the device is ready to join the network fabric the device obtains a token from the service block . For example the service may include an Access Token Retrieval Service that vends access tokens to authorized devices for the purposes of in field joining. For example the Access Token Retrieval Service may be a Representational State Transfer REST web service hosted by the PoC . The service implements a single fetch operation that returns the access token of the account with which the device is paired. In some embodiments the service actively restricts vending of access tokens to devices that authenticate with assigned credentials. Specifically assigned credentials may be credentials that are stored in a device when paired to an account that provide additional functionality over default credentials that may be stored in the device at manufacture as discussed in U.S. Pat. No. 8 635 373 entitled Subscription Notification Mechanisms for Synchronization of Distributed States filed on Sep. 22 2012 incorporated by reference in its entirety. Additionally in some embodiments only devices that are currently undergoing in field joining based on determination by PoC are allowed to retrieve access tokens. Moreover in some embodiments when the communication from the service is received in block the communication may include the token.

Using the obtained token the device connects to the assisting device block . For example the device may connect to the assisting device via the access point over a WiFi network connection. The device uses the id of the assisting device as received from the service to form an IPv6 link local address and then establishes a fabric TCP connection to the address over the WiFi interface for the device . Alternatively the device may attempt to connect directly to devices within range and may attempt to identify them as the assisting device using Bluetooth infrared 802.15.4 and or other wired or wireless connection techniques suitable for establishing a connection between the device and the assisting device. In some embodiments the device may not know the address e.g. IPv4 or IPv6 address for the assisting device and instead the device may send a multicast message asking for the proper assisting device to respond. In some embodiments when the device is attempting to join network of a particular type e.g. 802.15.4 the device may use an unsecured channel of that network type to attempt to communicate with the assisting device. Moreover in some embodiments the device stores the token in volatile memory only during the joining process and actively destroys the token after the process is completed either successfully or unsuccessfully.

In connecting to the assisting device the device establishes a secure session. For example the device may securely connect to the assisting device using an authenticated session establishment such as a Certificate Authenticated Session Establishment CASE protocol as taught in U.S. patent application Ser. No. 14 508 933 titled Authenticated Session Establishment which was filed on Oct. 7 2014 and which is incorporated by reference in its entirety. The device uses the account access token retrieved from the service to authenticate itself to the other device. Similarly the assisting device uses its device certificate to authenticate itself to the joining device . Further communication between the two devices is authenticated and encrypted using the negotiated session keys.

Once the devices have established a secure session the device obtains the fabric and or personal area network PAN information from the assisting device block . For example the device may request a fabric ID a fabric key a PAN ID and or a PAN password from the assisting device using a fabric provisioning protocols. Once the device has obtained the PAN fabric information the device may cause a subordinate device to factory reset if it is connected to a subordinate device such as a radiator controlling device block . Furthermore if the device is a member of a fabric the device may leave the network or fabric after resetting any present subordinate devices a current fabric or network if the device is a member of a network block . By resetting the subordinate device and leaving the network fabric the device causes the subordinate device to reset to a factory default that causes the subordinate device to reattempt to join the device once the device has joined the network fabric. In other words the device causes the subordinate device to leave the fabric network and then leaves the fabric network itself. Furthermore leaving the fabric network means discarding old fabric and or network information. To limit indeterminate state probabilities the device may delay leaving the fabric network until it has successfully connected to the assisting device and retrieve configuration information from the assisting device.

Before or after leaving the network fabric the device may request the assisting device to make the network joinable block . For example the assisting device may broadcast the presence of the network and places the network in a joinable state. The device looks for and joins the network using the receive network information block . Once the device has joined the network the device may store the network information in persistent memory. In some embodiments the device may join the fabric before joining the network. In other embodiments the device may join the network before joining the fabric. After the information has been stored the device sends an update to the service indicating connection to the fabric and or network block . In some embodiments the device may also instruct the assisting device to disable the joining state for the network. Furthermore this update may be included a change in headers in the x nl device descriptor in a communication with the service . For example if the device has connected to a fabric the device may send a message to the service with the HasFabric tagged as true. In other embodiments the joining device may report the result to the service by setting an ifj result field. In some embodiments this field is set to null by the service at the start of in field joining and the transition from null to a result also serves as a signal to the service that in field joining has completed. In some embodiments the value of the ifj result field is an integer status code such as those presented in Table 2 below 

In some embodiments the update to the service allows the service to identify the device as a new potential assisting device in the network fabric. It also enables the service to allow a new joining device to use the currently active assisting device while the assisting device is still awake. In some embodiments after the device has joined the fabric network the device may request service configuration details block . For example the device requests an entry URL for the PoC that causes the PoC to deliver service configuration details.

As previously discussed illustrates a flow chart diagram for forming a new fabric. The device determines whether it is in a state to create a fabric block . For example the device determines whether it has provisioning information whether the device is not already a member of the primary fabric for its structure whether the device is online whether the device is not currently busy e.g. not in the middle of a heat cycle and or the device is running a version of software capable of creating the fabric. If the device is not ready to create a fabric the device may report the unavailability to the service block . If the device is ready to create a fabric the device may cause a factory reset of a subordinate device as previously discussed block . The device then forms a fabric by generating a fabric ID e.g. 16 byte random number and a fabric key using encryption quality random number generation block . The device then stores the fabric ID and the fabric key in memory.

The device then forms a PAN with a PAN ID and PAN password block . In some embodiments if the device generates a PAN the device may generate a PAN ID that incorporates at least a portion of the fabric ID e.g. last 4 digits and a random 16 byte PAN key. The device then requests and receives service configuration details from the service block . The joining device also reports status of the fabric creation similar to the status update discussed above block . Moreover if the device has a subordinate device the device may re pair with the subordinate device on the new fabric after the subordinate device has been factory reset block .

After the wait command the assisting device may receive a request from a potential joining device e.g. device for the assisting device to assist a joining device in joining the network fabric upon which the assisting device resides block . Using a suitable authentication mechanism e.g. token the assisting device may authenticate whether the joining device has authority to receive network fabric credentials block . For example the device may employ the authentication discussed previously in reference to . In some embodiments if the device cannot be authenticated the assisting device may close the connection with the joining device and or send a report to the service of a failed attempt block . In certain embodiments the assisting device may then disallow authentication using the token and may request the generation of a new key by the service . In other embodiments the assisting device may allow a limited number of failures per session e.g. 3 .

Once the joining device is authenticated the assisting device may transmit fabric credentials and or network credentials for the network and or fabric upon which the assisting device resides block . In some embodiments once the credentials are transmitted the assisting device may place the network e.g. 802.15.4 in a joinable state allowing the joining state to join the network using the recently received credentials to join the network block . After the joining device has received the credentials and or joined the network fabric the assisting device may return to a sleep state. In some embodiments the assisting device may implement the wait command again to accommodate any other joining device that may attempt to connect during the assisting device s wake period.

In some embodiments in response to receiving the indication from the device the service may continue processing to facilitate provisioning that device with network fabric credentials. In other embodiments after receiving the indication from the device the service may wait until a device suitable to be an assisting device or a potential assisting device contacts the service before facilitating provisioning of the device in which case the service may wake the device in response to being contacted by the assisting device or the potential assisting device . In either case once the service has determined that it is a suitable time to begin provisioning one or more devices with network fabric credentials for a particular one of the devices processing may continue with block . That is the service may then determine whether a structure e.g. home has a primary fabric block . If there is no primary fabric the service instructs the device to create a fabric block . When determining whether a device can serve as an assisting device it is desirable to determine whether the device is a member of the structure s primary fabric. The primary Weave fabric is the fabric to which all devices will belong once the in field joining process is complete. illustrates a process for determining which fabric is the primary fabric for the structure. The service determines whether the structure has only a single fabric block . If the structure has only a single fabric the fabric may be designated as the primary fabric for the network block . If there is more than a single fabric the service determines whether there is a fabric corresponding to any device of a subset of first device type s within the structure block . For example the service may determine that the structure contains a fabric of a hazard detector. Furthermore the service may determine that devices having fabrics already enabled may be considered as being part of the first device type s . If a fabric corresponds to one of these devices the service may select the fabric corresponding to these devices as the fabric to which all devices will join block . If there is more than one fabric corresponding to the device types the service may randomly choose one of the fabrics as the primary fabric.

If no fabrics contain any devices of the first device type the service determines whether the structure contains any fabrics corresponding to other device types such as thermostats block . For example these devices may be a second tier priority to maintain fabric establishment. If more than one fabric exists that correspond to the second tier priority devices the service may select the fabric having the most number of these devices connected block . If no fabric has more devices than another fabric the service may randomly select one of these fabrics.

If no fabrics contain any devices at all the service determines that a new fabric should be created block . As previously discussed the service sends a create fabric message to the joining device to cause the joining device to create the fabric.

Returning to once a primary fabric has been selected the service determines whether a potential assisting device is available block . For example the service may determine if there are any assisting devices that are currently communicating with the service . The service may verify that any connected devices are qualified to act as assisting devices. For example the service may employ a process such as the one illustrated in to verify that one or more device types capable of assisting in the joining process are located on the fabric. As illustrated in the service may receive a connection from a potential assisting device block . If the structure containing the joining device has a primary fabric block the service determines whether the assisting device candidate is a member of the primary fabric block . If the assisting device candidate is a member of the primary fabric the service may deem that the device is a suitable assisting device for the particular joining device block . If the assisting device is not a member of a present primary fabric the service may deem that the device is not a suitable assisting device for the particular joining device block . If the structure does not include a primary fabric the service may determine whether the assisting device is a member of any fabric within the structure block . If the device is a member of some fabric the service may deem that the device is a suitable assisting device for the particular joining device and if the device is not a member of some fabric the service may deem that the device is not a suitable assisting device for the particular joining device.

Returning to if the assisting device candidate is not deemed a suitable candidate the service may determine whether any another assisting device candidates may be awoken by the service such as remotely awakening a thermostat using the control block . In some embodiments the service may also instruct a user to manually awaken a device by pressing a button on the device. If the service may awaken an assisting device candidate the service may awaken and connect to the assisting device candidate block . In some embodiments the service may determine whether the candidate is suitable for assisting in the joining process after awakening the device as discussed previously in reference to . In other embodiments the service may determine whether the candidate is suitable for assisting in the joining process before awakening the device.

If the service determines that no assisting device candidates may be awoken the service may wait for a connection from an assisting device candidate block . Sometime after waiting the service may receive a communication from an assisting device candidate block . After receiving the connection the service may deploy the assisting device qualifications discussed in relation to previously. It is worth noting that these communications may vary based on a device type of the assisting device candidate. For example for thermostats the selection logic may be invoked during execution of request for PoC URL but for hazard detection devices selection may occur during a service directory request.

Once a device has been qualified as an assisting device the service selects the qualified device as the assisting device block . In some embodiments the service may then determine whether any devices qualify as joining devices block . For example the service may determine whether it has previously received an indication that one or more devices are not a member of a fabric network. The service may also determine whether other qualifications are present. For example the service may determine whether the joining device is an expected device type e.g. thermostat whether the device is running a version of software that supports in field joining whether the device is in the same structure as the assisting device whether the device has already been provisioned with fabric credentials whether the device is not already be a member of the structure s primary fabric although it can be a member of a different fabric whether the device is online at the time device selection occurs whether the device is not busy e.g. in middle of a heat cycle and or other factors relevant to whether the device can currently join a network or fabric.

The service then sends a device ID of the assisting device to the joining device block . As discussed previously the service may receive a request for a token from the joining device for the assisting device block to which the service may respond with a token using a REST service block . In some embodiments the service may also instruct the assisting device to wait for a request for assistance as previously discussed. Furthermore the service may track a status of the joining process throughout the joining process block . For example the service tracks the status of the in field joining process in a centralized data store and uses this information to coordinate in field joining both service wide and on a structure by structure basis. For example the service may track a list of currently active in field joining attempts including the ids of their participants the joining and assisting devices and the structure to which they belong and the start time the fabric network membership state for all devices and or the time and result of the last failed in field joining attempt for each Diamond. Furthermore in some embodiments at the structure level the service coordinates the in field joining process to ensure that only a single joining attempt is in progress within a structure at any given point in time. This includes ensuring that new fabric creation occurs at most once in any structure. This behavior avoids race conditions that arise when multiple devices connect to PoC at the same time. It also reduces the number of states that the joining process can be in significantly simplifying the testing process.

As previously discussed the service may awaken assisting devices as part of the joining process. In such embodiments the service may prioritize which devices to use as assisting devices. illustrates a flowchart diagram that may be used to select an assisting device from multiple candidates. The service may determine that more than one assisting device candidates are present in the fabric block . The service then determines whether the multiple assisting device candidates include one or more devices of a first device type block . For example the service may determine whether the candidates include a hazard detector. The service may then determine whether any of the devices of the first type are line powered block . If any of the devices are line powered the service may select one of the line powered devices of the first device type as the assisting device block . If no devices of the first type are line powered or there are no devices of the first type the service determines whether any devices of the second type are present block . If any of the devices are of the second type the service may select one of the devices of the second type as the assisting device block . If no devices of the second type are present the service may determine whether there are any battery powered devices of the first type block . If any battery powered devices of the first type are present the service may select one of the battery powered devices of the first type as an assisting device block . If no battery powered devices of the second type are present the service may instruct the joining device to create a new fabric in accordance with the foregoing discussion.

In some embodiments devices may establish their relationships with a user account using a pre existing pairing process that pre dates the fabric network joining discussed herein. For example the pre existing pairing process may include the pairing process discussed in U.S. patent application Ser. No. 13 275 311 entitled Methods Systems and Related Architectures for Managing Network Connected Thermostats filed on Oct. 17 2011 and published as U.S. Publication No. 2012 0239221 which incorporated herein in its entirety. Specifically the pre existing pairing process may include an auto pairing mode that uses a common source address detection technique to automatically discover unpaired devices and prompt the user to pair them to their account. The auto pairing feature involves a single click confirmation step on the device which is designed to ensure the device is paired with the correct account.

After provisioning and joining these devices may connect to additional devices. Thus the pairing process may be changed to increase security of the network fabric and or account. Accordingly in some embodiments auto pairing in the service may be changed such that auto pairing only occurs when a device being added is the first device on the account. Note that under the new auto pairing the device may be auto paired only if it is the first device of any type on the account not just the first of a single device type. Once the first device has been added to an account all subsequent device pairings may be blocked from auto pairing and forced to manually pair.

The specific embodiments described above have been shown by way of example and it should be understood that these embodiments may be susceptible to various modifications and alternative forms. It should be further understood that the claims are not intended to be limited to the particular forms disclosed but rather to cover all modifications equivalents and alternatives falling within the spirit and scope of this disclosure.

