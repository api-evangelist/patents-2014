---

title: Managing early media for communication sessions established via the session initiation protocol (SIP)
abstract: A communications device sends an invite to a communication session to multiple target devices and receives first and second media streams from first and second target devices prior to receiving a signaling indication that any of the multiple target devices accepts the invite. The communications device selects between the first and second media streams based upon (i) information contained in a first packet of the first or second media streams and/or (ii) signaling information that indicates a forking context for the communication session. The communication device plays the selected media stream prior to receipt of the signaling indication. In another embodiment, after sending the invite, the communications device detects a network address and port information from (i) a media stream from a target device, and (ii) from a signaling message. The communication device sends media to the target device based on the detected information.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09462124&OS=09462124&RS=09462124
owner: QUALCOMM Incorporated
number: 09462124
owner_city: San Diego
owner_country: US
publication_date: 20140219
---
The present Application for Patent is a Continuation of U.S. application Ser. No. 13 422 211 entitled MANAGING EARLY MEDIA FOR COMMUNICATION SESSIONS ESTABLISHING VIA THE SESSION INITIATION PROTOCOL SIP filed on Mar. 16 2012 by the same inventors as the subject application assigned to the assignee hereof and incorporated herein by reference in its entirety.

Embodiments relate managing early media for communication sessions established via the session initiation protocol SIP .

Wireless communication systems have developed through various generations including a first generation analog wireless phone service 1G a second generation 2G digital wireless phone service including interim 2.5G and 2.75G networks and a third generation 3G high speed data Internet capable wireless service. There are presently many different types of wireless communication systems in use including Cellular and Personal Communications Service PCS systems. Examples of known cellular systems include the cellular Analog Advanced Mobile Phone System AMPS and digital cellular systems based on Code Division Multiple Access CDMA Frequency Division Multiple Access FDMA Time Division Multiple Access TDMA the Global System for Mobile access GSM variation of TDMA and newer hybrid digital communication systems using both TDMA and CDMA technologies.

The method for providing CDMA mobile communications was standardized in the United States by the Telecommunications Industry Association Electronic Industries Association in TIA EIA IS 95 A entitled Mobile Station Base Station Compatibility Standard for Dual Mode Wideband Spread Spectrum Cellular System referred to herein as IS 95. Combined AMPS CDMA systems are described in TIA EIA Standard IS 98. Other communications systems are described in the IMT 2000 UM or International Mobile Telecommunications System 2000 Universal Mobile Telecommunications System standards covering what are referred to as wideband CDMA W CDMA CDMA2000 such as CDMA2000 1xEV DO standards for example or TD SCDMA.

The Session Initiation Protocol SIP is a signaling protocol that can be used for call control for example of telephone conversations. To describe the switched communication connection SIP uses the Session Description Protocol SDP . When an SIP INVITE message is transmitted by an originating UE a forking event may occur where a plurality of target terminals send provisional responses back to the originating UE resulting in a plurality of early dialogs being instantiated before any of the dialogs are actually confirmed e.g. based on a target user answering or accepting the call . In this case it can be difficult for the originating UE to figure out how to handle the early dialogs.

In an embodiment a communications device sends an invite to a communication session to multiple target devices and receives first and second media streams from first and second target devices prior to receiving a signaling indication that any of the multiple target devices accepts the invite. The communications device selects between the first and second media streams based upon i information contained in a first packet of the first or second media streams and or ii signaling information that indicates a forking context for the communication session. The communication device plays the selected media stream prior to receipt of the signaling indication. In another embodiment after sending the invite the communications device detects a network address and port information from i a media stream from a target device and ii from a signaling message. The communication device sends media to the target device based on the detected information.

Aspects of the invention are disclosed in the following description and related drawings directed to specific embodiments of the invention. Alternate embodiments may be devised without departing from the scope of the invention. Additionally well known elements of the invention will not be described in detail or will be omitted so as not to obscure the relevant details of the invention.

The word exemplary is used herein to mean serving as an example instance or illustration. Any embodiment described herein as exemplary is not necessarily to be construed as preferred or advantageous over other embodiments. Likewise the term embodiments of the invention does not require that all embodiments of the invention include the discussed feature advantage or mode of operation.

The terminology used herein is for the purpose of describing particular embodiments only and is not intended to be limiting of embodiments of the invention. As used herein the singular forms a an and the are intended to include the plural forms as well unless the context clearly indicates otherwise. It will be further understood that the terms comprises comprising includes and or including when used herein specify the presence of stated features integers steps operations elements and or components but do not preclude the presence or addition of one or more other features integers steps operations elements components and or groups thereof.

Further many embodiments are described in terms of sequences of actions to be performed by for example elements of a computing device. It will be recognized that various actions described herein can be performed by specific circuits e.g. application specific integrated circuits ASICs by program instructions being executed by one or more processors or by a combination of both. Additionally these sequence of actions described herein can be considered to be embodied entirely within any form of computer readable storage medium having stored therein a corresponding set of computer instructions that upon execution would cause an associated processor to perform the functionality described herein. Thus the various aspects of the invention may be embodied in a number of different forms all of which have been contemplated to be within the scope of the claimed subject matter. In addition for each of the embodiments described herein the corresponding form of any such embodiments may be described herein as for example logic configured to perform the described action.

A High Data Rate HDR subscriber station referred to herein as user equipment UE may be mobile or stationary and may communicate with one or more access points APs which may be referred to as Node Bs. A UE transmits and receives data packets through one or more of the Node Bs to a Radio Network Controller RNC . The Node Bs and RNC are parts of a network called a radio access network RAN . A radio access network can transport voice and data packets between multiple access terminals.

The radio access network may be further connected to additional networks outside the radio access network such core network including specific carrier related servers and devices and connectivity to other networks such as a corporate intranet the Internet public switched telephone network PSTN a Serving General Packet Radio Services GPRS Support Node SGSN a Gateway GPRS Support Node GGSN and may transport voice and data packets between each UE and such networks. A UE that has established an active traffic channel connection with one or more Node Bs may be referred to as an active UE and can be referred to as being in a traffic state. A UE that is in the process of establishing an active traffic channel TCH connection with one or more Node Bs can be referred to as being in a connection setup state. A UE may be any data device that communicates through a wireless channel or through a wired channel. A UE may further be any of a number of types of devices including but not limited to PC card compact flash device external or internal modem or wireless or wireline phone. The communication link through which the UE sends signals to the Node B s is called an uplink channel e.g. a reverse traffic channel a control channel an access channel etc. . The communication link through which Node B s send signals to a UE is called a downlink channel e.g. a paging channel a control channel a broadcast channel a forward traffic channel etc. . As used herein the term traffic channel TCH can refer to either an uplink reverse or downlink forward traffic channel.

Referring back to the components of the wireless communications system and interrelation of the elements of the exemplary embodiments of the invention are not limited to the configuration illustrated. System is merely exemplary and can include any system that allows remote UEs such as wireless client computing devices to communicate over the air between and among each other and or between and among components connected via the air interface and RAN including without limitation core network the Internet PSTN SGSN GGSN and or other remote servers.

The RAN controls messages typically sent as data packets sent to a RNC . The RNC is responsible for signaling establishing and tearing down bearer channels i.e. data channels between a Serving General Packet Radio Services GPRS Support Node SGSN and the UEs . If link layer encryption is enabled the RNC also encrypts the content before forwarding it over the air interface . The function of the RNC is well known in the art and will not be discussed further for the sake of brevity. The core network may communicate with the RNC by a network the Internet and or a public switched telephone network PSTN . Alternatively the RNC may connect directly to the Internet or external network. Typically the network or Internet connection between the core network and the RNC transfers data and the PSTN transfers voice information. The RNC can be connected to multiple Node Bs . In a similar manner to the core network the RNC is typically connected to the Node Bs by a network the Internet and or PSTN for data transfer and or voice information. The Node Bs can broadcast data messages wirelessly to the UEs such as cellular telephone . The Node Bs RNC and other components may form the RAN as is known in the art. However alternate configurations may also be used and the invention is not limited to the configuration illustrated. For example in another embodiment the functionality of the RNC and one or more of the Node Bs may be collapsed into a single hybrid module having the functionality of both the RNC and the Node B s .

UEs and connect to the RAN at a portion served by a first packet data network end point e.g. which may correspond to SGSN GGSN PDSN a home agent HA a foreign agent FA PGW SGW in LTE etc. . The first packet data network end point in turn connects via the routing unit to the Internet and or to one or more of an authentication authorization and accounting AAA server a provisioning server a Session Initiation Protocol SIP signaling server and or the application server . UEs and . . . N connect to the RAN at a portion served by a second packet data network end point e.g. which may correspond to SGSN GGSN PDSN FA HA etc. . The SIP Signaling Server is configured to exchange SIP signaling messages between IP media terminals e.g. VoIP terminals whereby media between the IP media terminals is exchanged in a more direct manner e.g. peer to peer without direct mediation by a particular server . Similar to the first packet data network end point the second packet data network end point in turn connects via the routing unit to the Internet and or to one or more of the AAA server a provisioning server the SIP signaling server and or the application server . UE connects directly to the Internet and through the Internet can then connect to any of the system components described above. In an example the SIP signaling server can also be part of a control subsystem such as an IP Multimedia Subsystem IMS . Thus the network architecture arrangement shown in is not the only environment where the SIP signaling server may operate.

Referring to UEs and . . . N are illustrated as wireless cell phones UE is illustrated as a wireless tablet and or laptop PC. However in other embodiments it will be appreciated that the wireless communication system can connect to any type of UE and the examples illustrated in are not intended to limit the types of UEs that may be implemented within the system.

Referring to a UE here a wireless device such as a cellular telephone has a platform that can receive and execute software applications data and or commands transmitted from the RAN that may ultimately come from the core network the Internet and or other remote servers and networks. The platform can include a transceiver operably coupled to an application specific integrated circuit ASIC or other processor microprocessor logic circuit or other data processing device. The ASIC or other processor executes the application programming interface API layer that interfaces with any resident programs in the memory of the wireless device. The memory can be comprised of read only or random access memory RAM and ROM EEPROM flash cards or any memory common to computer platforms. The platform also can include a local database that can hold applications not actively used in memory . The local database is typically a flash memory cell but can be any secondary storage device as known in the art such as magnetic media EEPROM optical media tape soft or hard disk or the like. The internal platform components can also be operably coupled to external devices such as antenna display push to talk button and keypad among other components as is known in the art.

Accordingly an embodiment of the invention can include a UE including the ability to perform the functions described herein. As will be appreciated by those skilled in the art the various logic elements can be embodied in discrete elements software modules executed on a processor or any combination of software and hardware to achieve the functionality disclosed herein. For example ASIC memory API and local database may all be used cooperatively to load store and execute the various functions disclosed herein and thus the logic to perform these functions may be distributed over various elements. Alternatively the functionality could be incorporated into one discrete component. Therefore the features of the UE in are to be considered merely illustrative and the invention is not limited to the illustrated features or arrangement.

The wireless communication between the UE or and the RAN can be based on different technologies such as code division multiple access CDMA W CDMA time division multiple access TDMA frequency division multiple access FDMA Orthogonal Frequency Division Multiplexing OFDM the Global System for Mobile Communications GSM 3GPP Long Term Evolution LTE or other protocols that may be used in a wireless communications network or a data communications network. Accordingly the illustrations provided herein are not intended to limit the embodiments of the invention and are merely to aid in the description of aspects of embodiments of the invention.

Referring to the communication device includes logic configured to receive and or transmit information . In an example if the communication device corresponds to a wireless communications device e.g. UE Node B etc. the logic configured to receive and or transmit information can include a wireless communications interface e.g. Bluetooth WiFi 2G 3G etc. such as a wireless transceiver and associated hardware e.g. an RF antenna a MODEM a modulator and or demodulator etc. . In another example the logic configured to receive and or transmit information can correspond to a wired communications interface e.g. a serial connection a USB or Firewire connection an Ethernet connection through which the Internet can be accessed etc. . Thus if the communication device corresponds to some type of network based server e.g. SGSN GGSN application server etc. the logic configured to receive and or transmit information can correspond to an Ethernet card in an example that connects the network based server to other communication entities via an Ethernet protocol. In a further example the logic configured to receive and or transmit information can include sensory or measurement hardware by which the communication device can monitor its local environment e.g. an accelerometer a temperature sensor a light sensor an antenna for monitoring local RF signals etc. . The logic configured to receive and or transmit information can also include software that when executed permits the associated hardware of the logic configured to receive and or transmit information to perform its reception and or transmission function s . However the logic configured to receive and or transmit information does not correspond to software alone and the logic configured to receive and or transmit information relies at least in part upon hardware to achieve its functionality.

Referring to the communication device further includes logic configured to process information . In an example the logic configured to process information can include at least a processor. Example implementations of the type of processing that can be performed by the logic configured to process information includes but is not limited to performing determinations establishing connections making selections between different information options performing evaluations related to data interacting with sensors coupled to the communication device to perform measurement operations converting information from one format to another e.g. between different protocols such as .wmv to .avi etc. and so on. For example the processor included in the logic configured to process information can correspond to a general purpose processor a digital signal processor DSP an application specific integrated circuit ASIC a field programmable gate array FPGA or other programmable logic device discrete gate or transistor logic discrete hardware components or any combination thereof designed to perform the functions described herein. A general purpose processor may be a microprocessor but in the alternative the processor may be any conventional processor controller microcontroller or state machine. A processor may also be implemented as a combination of computing devices e.g. a combination of a DSP and a microprocessor a plurality of microprocessors one or more microprocessors in conjunction with a DSP core or any other such configuration. The logic configured to process information can also include software that when executed permits the associated hardware of the logic configured to process information to perform its processing function s . However the logic configured to process information does not correspond to software alone and the logic configured to process information relies at least in part upon hardware to achieve its functionality.

Referring to the communication device further includes logic configured to store information . In an example the logic configured to store information can include at least a non transitory memory and associated hardware e.g. a memory controller etc. . For example the non transitory memory included in the logic configured to store information can correspond to RAM memory flash memory ROM memory EPROM memory EEPROM memory registers hard disk a removable disk a CD ROM or any other form of storage medium known in the art. The logic configured to store information can also include software that when executed permits the associated hardware of the logic configured to store information to perform its storage function s . However the logic configured to store information does not correspond to software alone and the logic configured to store information relies at least in part upon hardware to achieve its functionality.

Referring to the communication device further optionally includes logic configured to present information . In an example the logic configured to present information can include at least an output device and associated hardware. For example the output device can include a video output device e.g. a display screen a port that can carry video information such as USB HDMI etc. an audio output device e.g. speakers a port that can carry audio information such as a microphone jack USB HDMI etc. a vibration device and or any other device by which information can be formatted for output or actually outputted by a user or operator of the communication device . For example if the communication device corresponds to UE as shown in the logic configured to present information can include the display . In a further example the logic configured to present information can be omitted for certain communication devices such as network communication devices that do not have a local user e.g. network switches or routers remote servers etc. . The logic configured to present information can also include software that when executed permits the associated hardware of the logic configured to present information to perform its presentation function s . However the logic configured to present information does not correspond to software alone and the logic configured to present information relies at least in part upon hardware to achieve its functionality.

Referring to the communication device further optionally includes logic configured to receive local user input . In an example the logic configured to receive local user input can include at least a user input device and associated hardware. For example the user input device can include buttons a touch screen display a keyboard a camera an audio input device e.g. a microphone or a port that can carry audio information such as a microphone jack etc. and or any other device by which information can be received from a user or operator of the communication device . For example if the communication device corresponds to UE as shown in the logic configured to receive local user input can include the display if implemented a touch screen keypad etc. In a further example the logic configured to receive local user input can be omitted for certain communication devices such as network communication devices that do not have a local user e.g. network switches or routers remote servers etc. . The logic configured to receive local user input can also include software that when executed permits the associated hardware of the logic configured to receive local user input to perform its input reception function s . However the logic configured to receive local user input does not correspond to software alone and the logic configured to receive local user input relies at least in part upon hardware to achieve its functionality.

Referring to while the configured logics of through are shown as separate or distinct blocks in it will be appreciated that the hardware and or software by which the respective configured logic performs its functionality can overlap in part. For example any software used to facilitate the functionality of the configured logics of through can be stored in the non transitory memory associated with the logic configured to store information such that the configured logics of through each performs their functionality i.e. in this case software execution based in part upon the operation of software stored by the logic configured to store information . Likewise hardware that is directly associated with one of the configured logics can be borrowed or used by other configured logics from time to time. For example the processor of the logic configured to process information can format data into an appropriate format before being transmitted by the logic configured to receive and or transmit information such that the logic configured to receive and or transmit information performs its functionality i.e. in this case transmission of data based in part upon the operation of hardware i.e. the processor associated with the logic configured to process information .

It will be appreciated that the configured logic or logic configured to in the various blocks are not limited to specific logic gates or elements but generally refer to the ability to perform the functionality described herein either via hardware or a combination of hardware and software . Thus the configured logics or logic configured to as illustrated in the various blocks are not necessarily implemented as logic gates or logic elements despite sharing the word logic. Other interactions or cooperation between the logic in the various blocks will become clear to one of ordinary skill in the art from a review of the embodiments described below in more detail.

The Session Initiation Protocol SIP is a signaling protocol that can be used for call control for example of telephone conversations. SIP is standardized by the IETF in RFC 3261 and in an older version in RFC 2543. To describe the switched communication connection SIP uses the Session Description Protocol SDP IETF RFC 2327 in a manner described in IETF RFC 3264. SIP together with the negotiated full user data connections e.g. speech connections can be transmitted using the Internet protocol. SIP is used in the above described manner in for example the Internet Multimedia Subsystem IMS of a mobile radio communication network standardized by 3GPP or 3GPP2.

During initiation of a call from the SIP terminal of a first UE e.g. caller A to a second UE e.g. a called party B the SIP signaling can be redirected by switching nodes or proxies such as SIP signaling server . The proxies are permitted to redirect an incoming message which presents a request by the caller A for a connection to the called party B e.g. an INVITE request to a plurality of other proxies or SIP terminals simultaneously or sequentially for example in order to search for the called party B. Because the last mentioned proxies can branch the message when redirecting it a tree like branching of the message can occur. This branched redirection of messages is referred to in SIP as forking .

When the INVITE message reaches a terminal or UE of called party B this terminal can respond with what is called a 1xx provisional response which can serve for example to negotiate the media e.g. speech video used for the communication connection and their coding or to indicate that the user B is being alerted for example by the ringing of an SIP telephone . In the event of forking a plurality of terminals send such provisional responses for example if a plurality of SIP telephones ring simultaneously. To conclude the initiation of the communication relationship between a terminal of caller A and a terminal of the called party B the latter terminal responds with what is called a 2xx final response for example when called party B has taken the SIP telephone off the hook. A plurality of terminals of called party B can send such final responses for example if a plurality of ringing SIP telephones are taken off the hook e.g. called party B has multiple phones in his her house and different people pick up different phones . Accordingly it can happen that the terminal of caller A receives provisional responses and or final responses from a plurality of terminals of called party B. Each terminal of called party B provides the messages it sends as responses to A with the same unique identification. If SIP response messages with a new identification reach the terminal of A the terminal of A learns therefrom that it is communicating with a new terminal point. In this case the SIP refers to a dialog existing between the terminal of caller A and the responding terminal of called party B. Before caller A and or called party B if applicable receives a final response for at least one dialog each dialog is referred to as an early dialog . After the final response is received for an early dialog that early dialog transitions to an established dialog .

It can happen that before the end of initiation of the communication relationship the terminals of caller A and called party B exchange media user data which is referred to as early media . For example as in a conventional telephone network media packets may be transmitted preferably in the direction from called party B to caller A. This can occur because the exchange of signaling messages for setting up the communication session are exchanged via an SIP server such as SIP signaling server which performs a signaling function for the communication session and the signaling connection via the SIP signaling server generally experiences more latency than the connection used to exchange the media packets.

If a plurality of dialogs are established in with terminal A during initiation of the communication relationship from caller A to called party B as a result of forking caller A may also receive media user data in particular early media from different terminals B B . The terminal of A will attempt to present the incoming media in a suitable fashion. For example it is possible that different incoming video streams are displayed in separate windows on a display screen of terminal A. Frequently however it is appropriate to select only one incoming media stream for presentation and to block or suppress the remaining media streams for example because the display screen in a mobile terminal is typically too small to show a plurality of windows or because the superposing of different ring tones or announcements would make the content unintelligible.

Conventionally information on the corresponding SIP dialogs might be criteria permitting the selection of a suitable media stream user data stream for representation. For example in one conventional approach to early media handling if an early dialog becomes an established dialog through receipt of the first SIP final response terminal A selects the corresponding media stream after the establishment . Alternatively in another conventional approach it may be appropriate for terminal A to select the early media that corresponds to the early dialog last established. For example selecting the early dialog last established may be appropriate if the proxies initiate forking in a sequential manner. If the called terminal B sends a negative response or if after a given time the communication relationship with it has not been established for example because no user has gone off hook the SIP proxy or signaling server redirects the INVITE request to a different terminal. The IETF specifies methods which will permit terminal A to request a proxy to search only sequentially. Terminal A can release dialogs using SIP signaling for example because it is able to support only a limited number of dialogs. The corresponding media can however continue to be received for a certain time because of the delay times of signaling and media. If so the incoming media at terminal A for a terminated dialog is suppressed.

The information contained in SIP and SDP does not always unambiguously allow an SIP dialog to be correlated with the corresponding media stream. In particular the terminal of caller A selects an IP address and port for example a UDP port see IETF RFC to receive the media streams before it sends the INVITE request containing this information. All incoming media for the communication session is therefore received at the same IP address and the same port. The IP address and port of the source media can be distinguished by using the parameter source IP address in the IP header and source port in the UDP header of the packets received i.e. the IP address and the port from which the packets were sent. However according to RFC no information on this source IP address and source port is contained in SIP SDP but only on the destination IP address and the destination port i.e. the IP address and port to which the packets were sent.

When SIP forking was designed the interaction with early media was at first not considered since early media occur in an SIP network only in special cases for example in conjunction with a conventional telephone network. More recently the handling of early media user data in the case of forking includes establishing separate communication connections for early media user data to be negotiated using SIP with terminal B acting as a caller in the communication connections for early media when it receives a call from caller A for the actual user connection and initially enters into an early dialog regarding this call for the user connection with A. However this has the disadvantage that considerably more SIP messages must be exchanged leading to delay in initiating the call and higher resource demand especially when transmitting via an air interface with narrow bandwidth. In addition it might possibly be necessary to reserve separate transmission resources for early media and for the actual user connection.

In another conventional approach to handling early media a parameter which allows expression of the source IP address and the source UDP port from which a recipient wishes to receive packets can be used. This information can be useful in configuring interposed firewalls. However this parameter is unsuitable for correlating SIP dialogs and media streams because it presupposes that the recipient already knows the source IP address and the source UDP port. Moreover the use of this parameter in H.248 signaling has not so far been described.

Referring to following a message in step from the SIP terminal A signaling part to the SIP terminal A connection part a communication set up procedure is initiated. The SIP terminal A connection part selects the address to be used by the SIP terminal A for future reception IP address of A IP A and port number of A port A step and transfers the selected address in step to the SIP A signaling part which in step sends an SIP INVITE message specifying the terminal A reception address IP A port A to the SIP signaling server e.g. via the RAN which applies SIP forking and in steps and transmits this SIP INVITE message to the called subscriber B terminal SIP terminal B and the called subscriber B terminal SIP terminal B .

Then in step the SIP terminal B selects its called subscriber reception address IP B port B and transmission address IP b port b . In step SIP terminal B selects its called subscriber reception address IP B and port B for reception and its called subscriber transmission address IP b and port b for transmission.

In step the called subscriber reception address IP B port B selected in called subscriber B and the called subscriber transmission address IP b port b together with a unique identification of the dialog B are transmitted in an SIP 180 Ringing provisional response message to the SIP signaling server which transmits them to the calling subscriber A in step . In addition in step an SIP 183 Session Progress provisional response message with the further called subscriber reception address IP B port B and the called subscriber transmission address IP b port b and the dialog identification B are transmitted onwards by the further SIP terminal B to the SIP signaling server and in step to SIP terminal A the calling subscriber A .

To transmit the called subscriber transmission addresses IP b port b and IP b port b in messages to an SDP parameter may for example be used. Through the receipt of messages and with different dialog identifications B and B the SIP terminal A connection part knows that it is signaling with two terminals B and B and that at this time both terminals are possibly transmitting data early media to IP A port A as in steps and from the called subscriber SIP terminal B or B to the terminal of the calling subscriber A. As this happens the SIP terminal B or the further destination and SIP terminal B specifies a called subscriber transmission address IP b port b or IP b port b indicating where the data originates to enable the calling subscriber A to determine its origin. In addition the early media data transmitted in step and also contains a destination address of the calling subscriber A which is used for IP routing. Early media data may contain for example ring tones announcements etc.

In the early media received at steps and of is received along with a called subscriber B transmission address IP b port b and the called subscriber reception address IP B port B transmitted in a response in a response message provisional response or final response of a called subscriber B and the called subscriber B transmission address IP b port b is used for the selection further processing or storage or rejection etc. . Eventually SIP terminal B goes off hook step which signifies that a user of SIP terminal B is answering the call. Then after a 200 OK final response message has been forwarded by the called subscriber terminal B to the calling subscriber terminal A in steps and the successful ending of the call initiation is signaled an established dialog between terminal A and terminal B is then established. At this point any early media data streams which do not correspond to the established dialog established with the message and which therefore contain a different subscriber transmission address can be rejected e.g. suppressed or ignored by the calling subscriber A. In this means that the media stream data with transmission addresses other than IP b port b is ignored. The SIP terminal A signaling part informs the SIP terminal A connection part in message that only media stream data with the transmission address IP b port b must be accepted and the SIP terminal A connection part determines to accept only packets configured with IP b port b step .

The SIP signaling server transmits an SIP CANCEL message step from the SDP proxy to the further SIP terminal B and SIP terminal B stops transmitting early media data streams step .

Accordingly in an SDP parameter is used in the provisional responses and or final responses sent by a terminal of B to the SIP terminal of A and this parameter permits the terminal s of caller B to express which IP address and which port is used in each case by these terminals to send IP packets. This is contrasted with other conventional art whereby the SDP from terminals B to A contains only information on the IP address and port at which terminal B wishes to receive IP packets. Because the provisional responses and or final responses contain a unique identification of the SIP dialog and the IP address used by a terminal B for transmission and the port used for transmission i.e. the source IP address and the source port in packets of the corresponding media stream received by A it is possible for A to carry out an unambiguous correlation allocation between an SIP dialog and a received media stream.

The terminal of A uses this correlation to select suitable media streams e.g. according to one or more of the following i when the first early dialog becomes an established dialog upon receipt of an SIP final response the terminal of A selects the appropriate media stream ii the terminal of A selects the early media corresponding to the early dialog last established possibly for only as long as no established dialog yet exists and or iii terminal of A suppresses early media media streams user data as soon as it sends SIP signaling messages to end the corresponding dialogs.

Accordingly in the call set up procedure of the identities of call targets are conveyed in the early media or early dialog that arrives at the UE originator. Before an established dialog is available i.e. before an SIP 200 OK A3 message is relayed to the UE originator from the SIP signaling server on behalf of a call target the UE originator selects the early media corresponding to the early dialog last established. After one of the early dialogs becomes an established dialog i.e. after an SIP 200 OK A3 message is relayed to the UE originator from the SIP signaling server on behalf of a call target the UE originator selects the established dialog and suppresses the other media streams.

Embodiments of the invention are directed to early media management. each illustrate example embodiments of the present invention related to different scenarios whereby early media is received at a UE originator. As shown in early media can arrive at the UE originator in conjunction with a number of scenarios such as a forked session e.g. call forwarding e.g. color ring back tone CRBT e.g. flexible alerting e.g. and or CBRT plus call forwarding CF e.g. . In dx denotes an SIP dialog x e.g. d corresponds to dialog mx denotes a media stream associated with dx e.g. m is associated with d and cx denotes the codec associated with dx e.g. c is associated with d .

In each of it is assumed that a UE originator UE prepares to receive early media on a first codec c in a first SDP offer before receiving an SDP answer i.e. an SIP 180 or 200 OK A3 message and that upon receiving the SDP answer UE plays the media on a negotiated codec associated with the early dialog or the confirmed or established dialog.

In UE optionally loads codec cl in conjunction with sending INVITE messages to UEs and A establishes dialog d with UE A loads c if necessary A receives early media m from UE in response to the INVITE message A and plays m A. UE then establishes dialog d with UE A continues to receive early media m from UE A and begins to receive early media m from UE A. At this point UE can i invoke a first option and block m without loading c and continue playing m ii or invoke a second option switch to playing m based on c and stop playing m A. Eventually an SIP 200 OK A3 message confirming dialog d arrives at UE A. For example the SIP 200 OK A3 message at A may be delayed somewhat from being routed through the SIP signaling server which experiences more latency to UE as compared to the media m. Once the dialog d is confirmed UE loads c if c is not already loaded from A and blocks subsequent media from UE associated with dialog d A.

In UE loads codec cl in conjunction with sending an INVITE message to UE B and establishes dialog d with UE B. UE facilitates the call to be forwarded to UE via a network not shown B such that a dialog d is established between UE and UE B. UE then receives early media m from UE in association with dialog d B and plays m B under either the first or second option discussed above with respect to . Eventually an SIP 200 OK A3 message confirming dialog d arrives at UE B. For example the SIP 200 OK A3 message at B may be delayed somewhat from being routed through the SIP signaling server which generally experiences more latency on its connection to UE as compared to the media m. Once the dialog d is confirmed UE loads c if c is not already loaded from B B.

In UE loads codec cl in conjunction with sending INVITE messages to UE C and establishes dialog d with the CRBT or announcement server C and also establishes dialog d with UE C. UE transmits an SIP 180 message in association with dialog d to the CRBT server in conjunction with alerting the user of UE regarding the call C which prompts the CRBT server to begin sending early media m to UE C e.g. a ringtone . UE receives and plays m C. UE also begins to transmit early media m to UE C. UE then invokes either option e.g. play m and block m without loading c or option e.g. load c to play m and block m as discussed above with respect to A of . Eventually an SIP 200 OK A3 message confirming dialog d arrives at UE C. For example the SIP 200 OK A3 message at C may be delayed somewhat from being routed through the SIP signaling server which generally experiences more latency on its connection to UE as compared to the media m. Once the dialog d is confirmed UE loads c if c is not already loaded from C and blocks subsequent media from the CRBT server associated with dialog d C.

In UE loads codec cl in conjunction with sending INVITE messages to UEs and D and establishes dialog d with UE D. UE also establishes dialog d with UE D via a parallel fork D. UE responds with early media m D and UE plays m D under either the first or second option discussed above with respect to . Next UE sends early media m D and UE then invokes either option e.g. play m and block m without loading c or option e.g. load c to play m and block m as discussed above with respect to A of . Next assume that both UEs and attempt to confirm their respective dialogs d and d by sending SIP 200 OK A3 messages at D and D. As shown in UE begins its transmission at D before UE begins its transmission at D but UE s SIP 200 OK A3 message arrives at UE first. Accordingly UE loads c if necessary begins or continues playing m and blocks m D.

In UE loads codec cl in conjunction with sending INVITE messages to UE E and establishes dialog d with the SIP server D. UE also establishes dialog d with UE E. UE responds with an SIP 180 message E which prompts the server to begin sending early media m E. UE receives and begins to play m E. The server then forwards the call to a voicemail VM server E and dialog d is set up between UE and the VM server E. VM sends early media m to UE E and UE then invokes either option e.g. play m and block m without loading c or option e.g. load c to play m and block m as discussed above with respect to A of . Next assume that the VM server confirms dialog d by sending an SIP 200 OK A3 message at E. Accordingly UE loads c if necessary begins or continues playing m and blocks m E. Also the SIP signaling server stops providing m to UE after the VM server answers at E but there may be a brief overlap where m and m are both provided to UE although UE will cease to play m after E .

In the description of above the first option with respect to early media selection corresponds to a dynamic selection of an earlier received media stream and the second option corresponds to a dynamic selection of a later received media stream. These respective options are described below in more detail with respect to and respectively. Table 1 below illustrates the behavior of UE originating UE with regard to the early media selection for 

Additional description of the decision logic that can be implemented by UE at A of of of of of will now be described in more detail.

Referring to an originating UE transmits an INVITE message that arrives at target terminals and . For example the INVITE message may be sent to both target terminals and by the originating UE or the INVITE message may originally arrive at target terminal and then be forwarded to target terminal as in the call forwarding scenario of etc. Also the target terminals and can each correspond to UEs in an example. Alternatively one or more of the target terminals and can correspond to a CRBT server as in an AS CRBT FW server as in and or a VM as in .

After transmitting the INVITE message at the originating UE establishes an early dialog d with target terminal and begins to receive early media m from target terminal . The originating UE inspects the first RTP packet of the early media m and loads an associated codec c for m. The originating UE also installs a filter based upon a synchronization source identifier SSRC contained within a header of the first RTP packet of m and then begins to play m . For example the filter of may correspond to a Current SSRC parameter that indicates an SSRC value for acceptable packets i.e. packets of a dialog that are not to be dropped by the originating UE . The originating UE establishes an early dialog d with target terminal and at some time after begins to receive early media m from target terminal . The originating UE inspects the first RTP packet of the early media m and determines that the SSRC in the first RTP packet of m is different than the SSRC installed in the filter . Based on the determination of the originating UE drops packets associated with m and continues to play m .

Referring to an originating UE transmits an INVITE message that arrives at target terminals and A e.g. similar to of . After transmitting the INVITE message at A the originating UE initializes a current SSRC variable to an invalid SSRC number i.e. a non permitted SSRC number to reduce the chance or even make it impossible that an incoming RTP packet would actually have the same SSRC number and also initializes a Blocked SSRC list to null or empty A. The originating UE establishes an early dialog d with target terminal and begins to receive early media m from target terminal A. The originating UE inspects a header of the first RTP packet of the early media m to acquire the first RTP packet s SSRC and determines whether the first RTP packet s SSRC equals Current SSRC A. Because Current SSRC has been initialized to an invalid SSRC at this point the originating UE determines that the first RTP packet s SSRC from m does not equal Current SSRC at A. At A the originating determines whether the first RTP packet s SSRC is listed in the Blocked SSRC list. Because the Blocked SSRC list has been initialized to null empty at this point the originating UE determines that the first RTP packet s SSRC from m is not included in the Blocked SSRC list at A.

Accordingly the originating UE sets Current SSRC equal to the first RTP packet s SSRC from m A and the originating UE loads codec c for m and begins to play m A. Thereafter as more RTP packets for m arrive at the originating UE in association with dialog d A the originating UE determines that the SSRC of the incoming m RTP packets equal Current SSRC A and the originating UE continues to play m A.

Referring now to the originating UE establishes an early dialog d with target terminal and at some time after A of begins to receive early media m from target terminal B. The originating UE inspects a header of the first RTP packet of the early media m to acquire the first RTP packet s SSRC and determines whether the first RTP packet s SSRC equals Current SSRC B. Because Current SSRC is set to m s SSRC at this point the originating UE determines that the first RTP packet s SSRC from m does not equal Current SSRC at B. At B the originating determines whether the first RTP packet s SSRC from m is listed in the Blocked SSRC list. Because the Blocked SSRC list is still empty at this point the originating UE determines that the first RTP packet s SSRC from m is not included in the Blocked SSRC list at B.

Accordingly the originating UE moves the current value of Current SSRC i.e. m s SSRC to the Blocked SSRC list B sets Current SSRC equal to the first RTP packet s SSRC from m B and the originating UE loads codec c for m and begins to play m B. Thereafter as more RTP packets for m arrive at the originating UE in association with dialog d B the originating UE determines that the SSRC of the incoming m RTP packet no longer equals Current SSRC B the originating UE determines that the SSRC of the incoming m RTP packet is included in the Blocked SSRC list B and any early media from m is dropped B.

In the originating UE determines whether to transmit early media. For example the UE originator may attempt interaction with a server before the call set up procedure is finalized e.g. before an established dialog is achieved based on a 200 OK A3 message . For example the originating UE may be required to transmit DTMF for dialed digits pin options in the case of a calling card service and so on.

In assume that the originating UE determines to transmit early media. In the originating UE determines whether a codec associated with the SDP body from the SIP signaling message from matches the current codec i.e. c being used to play m i.e. the current media being played in association with the selected dialog and the source IP address of the incoming stream m matches the IP address contained in the connection line of the SDP body of the SIP signaling message from . If not the originating UE does not send the early media . Otherwise if the SDP body from the SIP signaling message from matches cl and the source IP address of the incoming stream m matches the IP address contained in the connection line of the SDP body of the SIP signaling message from the originating UE configures its outgoing RTP media packets to include i a target IP address equal to a source IP address from the m packets of and ii a port number equal to a port number from the SDP body of the SIP signaling message of . This relies on the typical behavior where the source and destination IP addresses of an endpoint terminal i.e. target terminal are identical.

In an alternative example in if the SDP body of the SIP signaling message from specifically or explicitly identifies the media source of m e.g. target terminal by specifying the SSRC as an SDP attribute and the SSRC associated with selected stream m matches the value of this SDP attribute the source IP address from the RTP stream m need not be used to generate the outgoing media stream. Instead the SDP body of the SIP signaling message from which can be identified via the SSRC matching contains the destination IP address and port number to send media to the target terminal . In this instance the source and destination addresses of stream m could be different. In either case the originating UE transmits the configured packet s from to the target terminal .

Referring to an originating UE transmits an INVITE message that arrives at target terminals and A e.g. similar to of . After transmitting the INVITE message at A the originating UE receives an SIP signaling message e.g. an SIP 181 message that contains an SDP body from the target terminal via the SIP signaling server A. In the embodiment of assume that the SDP body within the SIP signaling message from A is configured to indicate that the call is being forwarded by the target terminal. Accordingly the originating UE inspects the SDP body of the SIP signaling message from A determines that the call is being forwarded such that the next dialog is likely to carry relevant media for the call instead of the dialog associated with target terminal A. Eventually dialog d is established between the originating UE and target terminal and the originating UE begins to receive early media m associated with d A. The originating UE loads codec c for m based on the call forward determination from A because m is the next arriving early media following the call forward detection A and the originating UE selects and plays m based on c A. While describes an example whereby the call forwarding context is indicated via the SDP body of the SIP signaling message it will be appreciated that the call forwarding context can be contained in another portion of the SIP signaling message in another embodiment of the invention i.e. other than the SDP body .

Referring to an originating UE transmits an INVITE message that arrives at the CRBT server and target terminal B. After transmitting the INVITE message at B the originating UE receives an SDP body within an SIP signaling message e.g. an SIP 180 message from the CRBT server via the SIP signaling server such as an SIP 180 message B. In the embodiment of assume that the SDP body within the SIP signaling message from B includes an attribute that is configured to identify a codec used by the CRBT server for its dialog with the originating UE. Accordingly the originating UE inspects the SDP body of the SIP signaling message from B determines the codec for the CRBT server s dialog c and loads the CRBT s codec at B. The originating UE receives early media m from the CRBT server via dialog d B and the originating UE selects and plays the early media m B. While describes an example whereby the CRBT context is indicated via the SDP body of the SIP signaling message it will be appreciated that the CRBT context can be contained in another portion of the SIP signaling message in another embodiment of the invention i.e. other than the SDP body .

Referring to an originating UE transmits an INVITE message that arrives at target terminals and C. After transmitting the INVITE message at C the originating UE receives an SDP body within an SIP signaling message e.g. an SIP 181 message from the target terminal via the SIP signaling server C. In the embodiment of assume that the SDP body within the SIP signaling message from C is configured to identify the source of media sent from the target terminal . The originating UE determines a dialog associated with a currently loaded codec e.g. the target terminal s codec or some other codec C and then sets Current SSRC e.g. as used in above equal to the SSRC associated with the determined dialog C e.g. the SSRC in packet headers of packets from the early media corresponding to the determined dialog . Accordingly as will be appreciated from a review of the originating UE can play RTP packets whose SSRC match that of the desired dialog e.g. latest arriving dialog or the first arriving dialog . This is different from playing media associated with the latest arriving stream because the latest arriving stream is not necessarily associated with the latest dialog. Further when a dialog is confirmed as shown in below the SSRC can once again be retrieved from the SDP body associated with that dialog and only packets associated with that SSRC can be played. Thus by including the SSRC in the SDP body of the SIP signaling message which is not conventional stream identification becomes easier at the originating UE. While describes an example whereby the media source is indicated via the SDP body of the SIP signaling message it will be appreciated that the media source can be contained in another portion of the SIP signaling message in another embodiment of the invention i.e. other than the SDP body .

While most of the embodiments described above relate to handling of early media are related to media handling for an established dialog after a dialog for early media is confirmed with an SIP 200 OK A3 message.

Referring to an originating UE transmits an INVITE message that arrives at target terminals and A. After transmitting the INVITE message at A the originating UE establishes early dialogs d and d with target terminals and respectively and receives early media m and m for dialogs d and d respectively A and A. Assume that one of the early media selection procedures discussed above are implemented such that the originating UE selects the codec associated with either m or m and then begins to play the early media for the selected codec A. Eventually a 200 OK A3 message is received from one of the target terminals which confirms its associated dialog d or d A. At this point subsequent media from the confirming target terminal is confirmed media not early media .

In the embodiment of the SIP 200 OK A3 message is received from target terminal for confirming dialog d at A. In response to the 200 OK A3 message the originating UE loads codec c if necessary and begins to play m A. For example if dialog d was already selected at A then codec c would already be loaded at A so that the codec loading operation of A could be bypassed. The originating UE also clears the Blocked SSRC list if necessary A. For example if the selection of A was not based on an embodiment that uses the Blocked SSRC list the Blocked SSRC would not need to be cleared at A. Alternatively if the Blocked SSRC list was still empty or null the Blocked SSRC would not need to be cleared at A.

Referring to the originating UE configures a filter to drop packets that do not match a network address e.g. an SSRC an IP address associated with the confirmed dialog d. For example the network address added to the filter in A can be extracted from an SDP body of the 200 OK A3 message from A in an example. For example if the SDP body of the 200 OK A3 message contains the SSRC of target terminal then the SSRC can be used as the network address that is added to the filter in A. Alternatively if the SDP body of the 200 OK A3 message did not contain the SSRC of target terminal then the IP address of target terminal can be used as the network address that is added to the filter in A.

Referring to the originating UE receives media m for dialog d at A and the originating UE determines that the m packet s do not match the network address or SSRC for d in the filter A. Accordingly the m packet s are dropped at A. The originating UE also receives media m for confirmed dialog d at A and the originating UE determines that the m packet s match the network address or SSRC for d in the filter A. The originating UE sets Current SSRC equal to the SSRC for the m packet if necessary and re initializes the de jitter buffer A. For example the de jitter buffer may be re initialized if the SSRC of the confirmed media stream m in this example is different from the current SSRC i.e. the selected early media stream. Also if the originating UE determines to transmit outgoing media to the target terminal associated with the confirmed dialog d the outgoing media can be transmitted at A directed to the transport address associated with the SDP body of the SIP signaling message e.g. the SIP 200 OK A3 message from A of d.

Referring to correspond to A through A respectively and as such will not be described further for the sake of brevity. At B after confirming the dialog d for target terminal the originating UE waits a threshold period of time while continuing to play the early media from B. As will be appreciated this means that even if m is being played at B the originating UE will not immediately switch over to the confirmed dialog upon receipt of the SIP 200 OK A3 message at B. In an example the threshold period of time at B or wait period can span a duration equal to of an SIP timer T. After waiting for the threshold period of time at B the originating UE loads codec c for the confirmed dialog d if necessary B and the originating UE also re initializes the de jitter buffer B. Also if the originating UE determines to transmit outgoing media to the target terminal associated with the confirmed dialog d the outgoing media can be transmitted at B directed to the transport address associated with an SDP body contained in an SIP signaling message e.g. the SIP 200 OK A3 message from B of d.

While the above described embodiments include references to wireless technologies such as CDMA etc. it will be appreciated the above described embodiments are not limited to wireless devices but instead can be implemented on any type of communication device including wired communication devices. Thus even though the term user equipment or UE is sometimes associated with wireless devices no such implication is intended to be introduced to the UEs discussed above with respect to .

Those of skill in the art will appreciate that information and signals may be represented using any of a variety of different technologies and techniques. For example data instructions commands information signals bits symbols and chips that may be referenced throughout the above description may be represented by voltages currents electromagnetic waves magnetic fields or particles optical fields or particles or any combination thereof.

Further those of skill in the art will appreciate that the various illustrative logical blocks modules circuits and algorithm steps described in connection with the embodiments disclosed herein may be implemented as electronic hardware computer software or combinations of both. To clearly illustrate this interchangeability of hardware and software various illustrative components blocks modules circuits and steps have been described above generally in terms of their functionality. Whether such functionality is implemented as hardware or software depends upon the particular application and design constraints imposed on the overall system. Skilled artisans may implement the described functionality in varying ways for each particular application but such implementation decisions should not be interpreted as causing a departure from the scope of the present invention.

The various illustrative logical blocks modules and circuits described in connection with the embodiments disclosed herein may be implemented or performed with a general purpose processor a digital signal processor DSP an application specific integrated circuit ASIC a field programmable gate array FPGA or other programmable logic device discrete gate or transistor logic discrete hardware components or any combination thereof designed to perform the functions described herein. A general purpose processor may be a microprocessor but in the alternative the processor may be any conventional processor controller microcontroller or state machine. A processor may also be implemented as a combination of computing devices e.g. a combination of a DSP and a microprocessor a plurality of microprocessors one or more microprocessors in conjunction with a DSP core or any other such configuration.

The methods sequences and or algorithms described in connection with the embodiments disclosed herein may be embodied directly in hardware in a software module executed by a processor or in a combination of the two. A software module may reside in RAM memory flash memory ROM memory EPROM memory EEPROM memory registers hard disk a removable disk a CD ROM or any other form of storage medium known in the art. An exemplary storage medium is coupled to the processor such that the processor can read information from and write information to the storage medium. In the alternative the storage medium may be integral to the processor. The processor and the storage medium may reside in an ASIC. The ASIC may reside in a user terminal e.g. UE . In the alternative the processor and the storage medium may reside as discrete components in a user terminal.

In one or more exemplary embodiments the functions described may be implemented in hardware software firmware or any combination thereof. If implemented in software the functions may be stored on or transmitted over as one or more instructions or code on a computer readable medium. Computer readable media includes both computer storage media and communication media including any medium that facilitates transfer of a computer program from one place to another. A storage media may be any available media that can be accessed by a computer. By way of example and not limitation such computer readable media can comprise RAM ROM EEPROM CD ROM or other optical disk storage magnetic disk storage or other magnetic storage devices or any other medium that can be used to carry or store desired program code in the form of instructions or data structures and that can be accessed by a computer. Also any connection is properly termed a computer readable medium. For example if the software is transmitted from a website server or other remote source using a coaxial cable fiber optic cable twisted pair digital subscriber line DSL or wireless technologies such as infrared radio and microwave then the coaxial cable fiber optic cable twisted pair DSL or wireless technologies such as infrared radio and microwave are included in the definition of medium. Disk and disc as used herein includes compact disc CD laser disc optical disc digital versatile disc DVD floppy disk and blu ray disc where disks usually reproduce data magnetically while discs reproduce data optically with lasers. Combinations of the above should also be included within the scope of computer readable media.

While the foregoing disclosure shows illustrative embodiments of the invention it should be noted that various changes and modifications could be made herein without departing from the scope of the invention as defined by the appended claims. The functions steps and or actions of the method claims in accordance with the embodiments of the invention described herein need not be performed in any particular order. Furthermore although elements of the invention may be described or claimed in the singular the plural is contemplated unless limitation to the singular is explicitly stated.

