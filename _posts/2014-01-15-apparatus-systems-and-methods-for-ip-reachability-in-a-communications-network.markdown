---

title: Apparatus, systems, and methods for IP reachability in a communications network
abstract: In a system and method for establishing communications in a communications network, a network service provider can assign IP addresses to mobile devices dynamically to conserve IP address resources. A network service provider can also implement network address translation to further conserve IP address resources and to provide improved security. If a requestor seeks to obtain an IP address of a mobile device and the address is a local address, the system determines if the mobile device has a network address translation (NAT) binding that associates the IP address of the mobile device with a public IP address. If the mobile device does not have a NAT binding, the system creates a NAT binding that associates the IP address of the mobile device with a public IP address.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08924574&OS=08924574&RS=08924574
owner: Cisco Technology, Inc.
number: 08924574
owner_city: San Jose
owner_country: US
publication_date: 20140115
---
This application is a continuation application of U.S. patent application Ser. No. 13 273 039 entitled SYSTEMS AND METHODS FOR IP REACHABILITY IN A COMMUNICATIONS NETWORK filed Oct. 13 2011 which is hereby incorporated by reference herein in its entirety.

This disclosure relates generally to a system and method for determining an IP address of a mobile device and providing network address translation services in a communications network.

Wireless networks are telecommunications networks that use radio waves to carry information from one node in the network to one or more receiving nodes in the network. Cellular telephony is characterized by the use of radio cells that provide radio coverage for a geographic area with multiple cells arranged to provide contiguous radio coverage over a larger area. Wired communication can also be used in portions of a wireless network such as between cells or access points.

Wireless communication technologies are used in connection with many mobile devices including for example satellite communications systems portable digital assistants PDAs laptop computers and mobile devices e.g. cellular telephones user equipment . Such devices can connect to a network e.g. the Internet as long as the user is within range of such a wireless communication technology. Mobile devices are assigned an address that serves as a unique identifier within the network.

Certain embodiments disclose a method of establishing communication in a communications network. The method comprises receiving at a gateway a DNS query from a requestor wherein the domain name system DNS query requests an Internet Protocol IP address of a mobile device for establishing communication with the mobile device over a communications network determining if the IP address of the mobile device is available at the gateway and if so determining if the IP address of the mobile device is a local address that should be network address translated for communication with the requestor. If the IP address of the mobile device is not a local address the method comprises sending to the requestor a positive response that includes the IP address of the mobile device. However if the IP address of the mobile device is a local address the method comprises further determining if the mobile device has a network address translation NAT binding that associates the IP address of the mobile device with a public IP address. If the mobile device does not have a NAT binding the method comprises creating a NAT binding that associates the IP address of the mobile device with a public IP address. The method further comprises sending to the requestor a positive response that includes the public IP address associated with the IP address of the mobile device.

A large number of devices including computers cell phones printers traffic lights and even refrigerators and cars communicate amongst themselves over a communications network. The communications network associates each device with an internet protocol IP address so that just as one person would call another person by dialing the other person s phone number one device i.e. requestor can communicate with another device i.e. recipient by sending a communication request to the recipient s IP address.

In a certain type of network connections the IP address assignment is static. In other words the IP address assigned to each device does not change over time. Therefore once a requestor identifies the IP address of a recipient the requestor can use the same IP address to communicate with the recipient at any point in time. A static network essentially maintain a single permanent IP address database or a single permanent Yellow page to keep track of which device is associated with which IP address. Despite the simple bookkeeping strategy a static network can be impractical for large networks because the total number of devices that can be attached to a static network is limited. This total number is limited by the number of bits used to represent an IP address which is 32 bits for IPv4 and 64 bits for IPv6.

One way to address the dearth of IP addresses is to dynamically assign IP addresses. Suppose that a device is assigned an IP address but the device later detaches from the network. Under the dynamic IP address allocation scheme the network can recycle the IP address assigned to the detached device and re assign the recycled IP address to a different attached device. A network implementing the dynamic IP address allocation scheme is called a dynamic network. To keep track of which device is associated with which IP address a dynamic network can maintain a time dependent IP address database or a time dependent Yellow page that is updated to reflect the most current network configurations. When a requestor wants to communicate with a recipient the requestor can consult the IP address database to determine the recipient s IP address and use that IP address to establish communication with the recipient.

A drawback using an address database in a dynamic network is that it needs to be updated every time a new device is added to the network or every time a device is detached from the network. Because a network is often associated with a large number of devices communications overhead associated with updating the address database can quickly become prohibitive. This is especially wasteful since some entries in the address database may not even be requested. Furthermore whenever a requestor wants to communicate a recipient the requestor needs to consult the address database even if the requestor communicated with the recipient not too long ago. The communication bandwidth overhead and the delay overhead of using an address database in a dynamic network can be significant when compared to a static network which does not have to update the address database as often.

Some of these drawbacks can be addressed using a network address translation NAT scheme. In a NAT scheme a network is divided into two tiers a public network and a private network. For example the public network can be the Internet and the private network can be a Local Area Network LAN . Each device in a public network is assigned an IP address that is unique across the entire public network. This public IP address is often assigned dynamically but can be assigned statically. On the other hand each device in a private network is assigned a unique static IP address that does not change over time. Therefore if devices in the same private network communicate with each other frequently each device can cache the IP address of the counter party and use the cached IP address for future communications which is not possible with a dynamic network. The static IP assignment within the private network eliminates the communication bandwidth overhead and the delay overhead associated with a dynamic network. However as a compromise the IP address of the private network is unique only within the private network. In other words this IP address of the private network cannot be used to communicate with devices outside of the private network because another device could be using the same IP address outside of the private network.

To enable communication between devices residing in different private networks and the public network private networks are interfaced to the public network through NAT devices. For example when a requestor residing in a private network wants to communicate with a recipient residing in the public network the requestor sends a communication request to the recipient over the NAT device. The communication request includes the source IP address and the destination IP address the source IP address being the local IP address of the requestor and the destination IP address being the public IP address of the recipient. However as mentioned earlier the requestor s IP address is only unique within the private network.

Therefore before the communication request is transmitted across the public network the NAT device 1 associates the requestor s local IP address with a public IP address that can be used for communication over the public network 2 replaces the local source IP address of the communication request with the associated public IP address and 3 generates an entry in an address translation table to keep track of the fact that the requestor s local IP address is associated with the assigned public IP address. These entries in the address translation table are called NAT bindings. Subsequently when the NAT device receives a message from the public network to the requestor the NAT device uses the address translation table to translate the message s destination IP address to the requestor s local IP address. This way a two way communication across a public network and private networks can be established. An IP address that needs to be network address translated for communication over a public network is a local address an IP address that does not have to be network address translated for communication over a public network is a public address.

One drawback of NAT is that a NAT binding cannot be created unless the communication is initiated by a device in the private network. When a requestor residing in a public network wants to send data to a recipient in a private network the requestor would have to send data to a public IP address associated with the local address of the recipient. However if the local address does not have a NAT binding there is no public IP address to which requestor can send data to establish communication. Therefore unless the communication is initiated by a device in the private network the two devices cannot establish communication.

These network characteristics are also applicable to a mobile IP network. A mobile IP network provides Internet services to mobile devices such as cell phones. A mobile IP network assigns an IP address to each mobile device. The assigned IP address can be a static IP address or a dynamic IP address depending on how the mobile IP network manages its IP addresses. The assigned IP address can be a public IP address that is unique on the entire public network or it can be a local IP address that is unique only within a private network. Oftentimes a mobile IP network dynamically allocates IP addresses for efficient resource utilization.

Although all the challenges associated with a dynamic network address translated NAT ed network are also applicable to a mobile IP network a mobile IP network has some structures that can be leveraged to efficiently address these challenges. For example mobile devices are anchored at a gateway. Therefore if a mobile device is attached to the network the gateway is aware of the mobile device s identification and its IP address. Also if the network implements NAT this functionality is often implemented at a gateway. Furthermore gateway binding information which specifies the gateway that served the mobile device when the mobile device was most recently to the network is maintained at a home subscription server HSS . The disclosed systems and methods exploit these characteristics of a mobile IP network to address challenges associated with a dynamic IP allocation scheme and a NAT scheme.

At a high level when a requestor wants to establish communication with a recipient the requestor might need to know 1 whether the recipient is attached to the network and 2 if attached what the recipient s IP address is. To find the information the requestor can send an address resolution request to a domain name system DNS server. The address resolution request can be a DNS query but can be any message that includes explicitly or implicitly a mobile device identifier of the recipient. When a DNS server receives the request the DNS server retrieves the gateway binding information and instructs the requestor to send the address resolution request to the gateway specified in the gateway binding information.

The requestor would then send another address resolution request this time to the gateway specified by the DNS server. If the specified gateway can resolve the IP address of the recipient then the specified gateway can send the recipient s IP address to the requestor. If not the specified gateway can find another gateway that has a higher chance of resolving the IP address and help the requestor resolve the requested IP address with that gateway. The specified gateway can help the requestor in one of the following two ways. In the first mode of operation called the recursive mode the specified gateway can send the address resolution request to a new gateway on behalf of the requestor until the requested IP address is resolved. In the second mode of operation called the iterative mode the specified gateway can instruct the requestor to send another address resolution request to a new gateway. In this mode the requestor would then send an address resolution request to the newly specified gateway. These operations are performed iteratively until the requestor receives the IP address of the recipient or until the requestor receives a response that the recipient is not available for communication. If the requestor receives the IP address of the recipient the requestor can establish communication with the recipient. These operations are called the gateway based address resolution operations.

The gateway based address resolution operations are in some ways similar to how DNS queries are handled by DNS servers. However the gateway based address resolution operations are different in that the address resolution requests are recursively resolved by gateways not DNS servers. By enhancing gateways with DNS server functionalities the mobile IP network does not have to maintain an address database. This is especially attractive for a dynamic mobile IP network because otherwise the address database would have had to be constantly updated leading to a communication bandwidth overhead and a delay overhead.

During address resolution if the gateway realizes that the recipient resides in a private network the gateway can 1 associate the recipient s local IP address with a public IP address and 2 create a NAT binding entry in an address translation table that binds the recipient s local IP address to the associated public IP address and 3 send the associated IP address to the requestor. This way all future communications directed to the associated public IP address can be redirected to the recipient. Therefore the requestor can establish communication with a recipient in a private network even if a NAT binding for the recipient does not exist. This feature is particularly useful for data push services. Using this feature an application server can push data to a mobile device in a private network even if the mobile device does not yet have a NAT binding.

The access network can communicate with an access gateway that implements a combination of functionalities such as a packet data serving node PDSN a HRPD serving gateway HSGW and a serving gateway SGW . In operation the PDSN functionality can be used with 1xRTT the HSGW functionality can be used with HRPD and eHRPD and the SGW functionality can be used with the eNodeB . The access gateway can communicate with an anchor gateway which can implement a packet data network gateway PGW and a Home Agent HA and a mobility management entity MME . On the access network side the anchor gateway can also communicate with an evolved packet data gateway ePDG that provides connectivity to the WiFi Femto other transceiver . On the packet core side the anchor gateway can communicate with the operator s IP service domain the internet IP multimedia subsystem IMS and a domain name system DNS server . An authentication authorization and accounting AAA server home subscriber server HSS can communicate with the access gateway the anchor gateway or both.

A DNS server implements a Domain Name System DNS to translate an Internet domain name to an IP address. More particularly the DNS can be used to map domain names of hosts and clients on the Internet to their corresponding IP addresses. Such translation enables the mobile IP network to attach easy to remember domain names e.g. domainname.org to difficult to remember IP addresses e.g. 200.140.130.120 . Since a central list of domain name IP address mappings would be impractical such lists are often distributed throughout the Internet in various DNS servers. By way of example a client typically sends a DNS query to a DNS server that includes a hostname with an indication that an IP address is requested. The DNS server would then return an IP address associated with the hostname. The DNS server can communicate with the HSS over any one of the following interfaces a Diameter Sh interface an interface that implements standardized protocols including a lightweight directory access protocol LDAP and an Authorization Authentication and Accounting AAA protocol or a proprietary interface between the DNS server and the HSS .

The Home Subscriber Server HSS can be a master user database that supports IMS network entities that handle calls. The HSS stores subscription related information subscriber profiles performs authentication and authorization of the user and can provide information about the subscriber s location and IP information. The HSS also maintains binding information on which gateway is currently serving a mobile device. Even when the mobile device is detached from the network the HSS maintains the binding information until the mobile device re attaches itself and updates the binding information. The AAA server can provide authentication access control and accounting to the network. The authentication can involve verification of the subscriber the access control can involve granting or denying access to specific services and the accounting that can take place is the tracking of the use of network resources by subscribers. Other servers such as the Home Location Register HLR can be used in other embodiments. In certain embodiments the AAA HSS can communicate with the access gateway for charging purposes.

The LTE communications network includes a PDN gateway PGW a serving gateway SGW an E UTRAN evolved UMTS terrestrial radio access network and a mobility management entity MME . The evolved packet core EPC of an LTE communications network includes the MME SGW and PGW components. In some embodiments one or more EPC components can be implemented on the same gateway or chassis as described below.

The SGW sits in the user plane where it forwards and routes packets to and from the eNodeB and PGW. The SGW also serves as the local mobility anchor for inter eNodeB handover and mobility between 3GPP networks. The SGW routes and forwards user data packets while also acting as the mobility anchor for the user plane during inter eNB handovers and as the anchor for mobility between LTE and other 3GPP technologies terminating S4 interface and relaying the traffic between 2G 3G systems and PGW . For idle state UEs the SGW terminates the down link data path and triggers paging when down link data arrives for the UE. The SGW manages and stores UE contexts e.g. parameters of the IP bearer service and network internal routing information. The SGW also performs replication of the user traffic in case of lawful interception.

The PGW acts as the interface between the LTE network and other packet data networks such as the Internet or SIP based IMS networks fixed and mobile . The PGW serves as the anchor point for intra 3GPP network mobility as well as mobility between 3GPP and non 3GPP networks. The PGW acts as the Policy and Charging Enforcement Function PCEF which manages Quality of Service QoS online offline flow based charging data generation deep packet inspection and lawful intercept. The PGW provides connectivity to the UE to external packet data networks by being the point of exit and entry of traffic for the UE. A UE may have simultaneous connectivity with more than one PGW for accessing multiple packet data networks. The PGW performs policy enforcement packet filtering for each user charging support lawful interception and packet screening. The PGW also provides an anchor for mobility between 3GPP and non 3GPP technologies such as WiMAX and 3GPP2 standards CDMA 1X and EVDO .

The MME resides in the EPC control plane and manages session states authentication paging mobility with 3GPP 2G 3G nodes roaming and other bearer management functions. The MME can be a standalone element or integrated with other EPC elements including the SGW PGW and Release 8 Serving GPRS Support Node SGSN . The MME can also be integrated with 2G 3G elements such as the SGSN and GGSN. This integration is the key to mobility and session management interworking between 2G 3G and 4G mobile networks.

MME is a control node for the LTE access network. The MME is responsible for UE tracking and paging procedures including retransmissions. MME handles the bearer activation deactivation process and is also responsible for choosing the SGW for a UE at the initial attach and at time of an intra LTE handover. The MME also authenticates the user by interacting with the HSS . The MME also generates and allocates temporary identities to UEs and terminates Network Access Server NAS signaling. The MME checks the authorization of the UE to camp on the service provider s Public Land Mobile Network PLMN and enforces UE roaming restrictions. The MME is the termination point in the network for ciphering integrity protection for NAS signaling and handles the security key management. Lawful interception of signaling is also supported by the MME. The MME also provides the control plane function for mobility between LTE and 2G 3G access networks with the S3 interface terminating at the MME from the SGSN not shown . The MME also terminates the S6a interface towards the home HSS for roaming UEs.

The ePDG is responsible for interworking between the EPC and fixed non 3GPP access technologies such as a WiFi WiMAX LTE metro and femtocell access networks. The ePDG can use IPSec IKEv2 to provide secure access to the EPC network. Optionally the ePDG can use Proxy Mobile IPv6 PMIPv6 to interact with the PGW when the mobile subscriber is roaming in an untrusted non 3GPP system. The ePDG is involved in tunnel authentication and authorization transport level packet marking in the uplink policy enforcement of Quality of Service QoS based on information received via Authorization Authentication Accounting AAA infrastructure lawful interception and other functions.

In some embodiments the gateway based address resolution operations can be implemented on gateways such as PGW HA PDSN HSGW SGW SGSN MME PGW GGSN or SGW . The gateways can access and maintain information relating to the communication session the subscriber the radio bearers and the policies relating to the communication session. The gateways may be used to provide various services to a mobile device and implement the quality of service QoS on packet flows. Several of these functions are used in providing for example voice over IP VoIP routing and enhanced services such as enhanced charging stateful firewalls traffic performance optimization TPO . The communications networks also allow provision of applications such as VoIP streaming video streaming music multi user gaming location based services and a variety of content delivered to a mobile node. Residing within the gateways can be one or more network processing units line cards as well as packet and voice processing cards.

In some embodiments gateways can be enhanced with a DNS module that is configured to handle DNS queries. Also in some embodiments the DNS modules in gateways can be configured in a hierarchical manner so that the IP address of a hostname can be resolved recursively or iteratively similar to that of a regular DNS.

In a requestor wants to initiate communication with a UE . The requestor can be another UE residing in the network or an application server that wants to push data to the UE . In order to initiate communication the requestor might need to know 1 whether the UE is attached to the network and 2 if the UE is attached to the network the IP address assigned to the UE . Therefore the requestor initiates the gateway based address resolution operations to find out the status and the IP address of the UE .

In step to initiate gateway based address resolution the requestor can send an address resolution request to a DNS server . The address resolution request can include 1 the mobile device identifier of the UE and 2 an indication that the IP address of the hostname is requested. The mobile device identifier can be any one of the following International Mobile Equipment Identity IMEI International Mobile Subscriber Identity IMSI Temporary Mobile Subscriber Identity TMSI Mobile Equipment Identifier MEID Mobile Subscriber Integrated Services Digital Network Number MSISDN or any identifier that uniquely identifies the UE within the network. In certain embodiments the address resolution request can be a DNS query which includes 1 the hostname of the UE and 2 an indication that the IP address of the hostname is requested. The hostname of the UE can be constructed from 1 the mobile device identifier of the UE and 2 the domain in which the UE resides in. For example if the mobile device identifier of the UE is imsi and if the UE resides in vzw.com then the hostname for the UE is imsi.verizon.com .

In step when the DNS server receives the DNS query the DNS server can first check whether the requested IP address is readily available from its cache. If the requested IP address is available from its cache the DNS server can retrieve that IP address and send it to the requestor step . If the cache in the DNS server does not have the IP address associated with the hostname the DNS server can send a HSS query to the HSS . The HSS query requests the HSS to return the IP address of the PGW that most recently served the UE . The HSS query can include the mobile device identifier of the UE . The DNS server can send the HSS query to the HSS over any one of the following interfaces a Diameter Sh interface an interface that implements standardized protocols including a lightweight directory access protocol LDAP and an Authorization Authentication and Accounting AAA protocol or a proprietary interface between the DNS server and the HSS .

In step the HSS sends a HSS query response to the DNS server . The HSS query response can include 1 a flag bit indicating whether or not the UE was ever attached to the network and 2 if the UE was ever attached to the network the IP address of the PGW that most recently served the UE . In step the DNS server analyzes the received HSS query response. If the HSS query response indicates that the UE was never attached to the network the DNS server can send a DNS negative response to the requestor . The DNS negative response indicates that the UE is not attached to the network and is not available for communication. If the HSS query response indicates that the UE was at least once attached to the network and includes the IP address of the PGW the DNS server sends a DNS redirect message to the requestor . The DNS redirect message includes the IP address of the PGW that was included in the HSS query response.

In step if the requestor received the DNS redirect message the requestor can send another DNS query to the PGW specified in the DNS redirect message. The PGW can include a DNS module that is configured to resolve DNS queries. The DNS module can include a DNS cache that maintains the IP address of recently resolved UE addresses. To resolve the IP address of a hostname the DNS module can 1 check the DNS cache to determine if the cache maintains the IP address for the requested hostname or 2 determine an attachment status of the mobile device that indicates whether the UE corresponding to the hostname is currently attached to the network and is anchored at the gateway . If the DNS module finds the requested IP address the DNS module can send a DNS response with the identified IP address.

If the DNS module cannot resolve the DNS query the DNS module can find another gateway or its DNS module that has a higher probability of handling the DNS queried host name. To do so the DNS module can maintain a mapping table that indicates which gateway would be able to resolve the DNS query. Also if the host name in the DNS query includes more granular location information of the UE for example the region name in the fully qualified domain name FQDN e.g. imsi region1.eastarea.vzw.com then the DNS module can use that information to determine which gateway could most likely resolve the DNS query. In certain embodiments the gateways within a predetermined region can share the information on which UEs are being served by each gateway.

The DNS module can support a recursive DNS mode and or an iterative DNS mode for IP address resolution. In a recursive DNS mode the DNS module can operate as a DNS resolver that recursively sends DNS queries to other PGWs on behalf of the requestor until the requested IP address is resolved. In an iterative DNS mode the PGW can send a DNS redirect message to the requestor so that the requestor can recursively send DNS queries to PGWs until the UE s IP address is resolved i.e. step . If the PGW cannot resolve the requested IP address and cannot find the PGW that has a higher probability of having access to the requested IP address the PGW returns a DNS negative response to the requestor indicating that the UE is not attached to the network or that the UE is temporarily out of reach.

In certain embodiments the NAT binding entry in the address translation table can be associated with an expiration timer also called a time to live TTL timer. If a NAT binding entry is not used for a fixed period of time i.e. the expiration period then the NAT binding can expire and can be removed from the address translation table.

In certain embodiments the PGW can create an application level NAT binding. A DNS query can include in addition to the hostname of the recipient an application identifier that identifies the application sending the query. When the PGW receives a DNS query with an application identifier the PGW can create a NAT binding that associates the UE s local IP address with the public IP address assigned to the UE and the particular application sending the DNS query. This way the PGW can block unwanted malicious data transfers from another application such as a malware running on the same requestor . The application level NAT binding information can also be stored in an address translation table and can be associated with an expiration timer.

In some embodiments a UE can have multiple IP addresses. For example in a Long Term Evolution LTE network a UE can have two IP addresses one for IPv4 and another for IPv6. Therefore a PGW responding to a DNS query may not know which one of the two addresses should be sent to the requestor. To resolve this issue a requestor can include in the DNS query the type of address the requestor is looking for which would specify the access point name APN . Therefore the DNS server or the PGW can analyze the DNS query to determine the type of address the requestor is looking for. However if the DNS query does not specify the type of address being sought or if a UE has multiple addresses of the same type the DNS server can look up its database of APN to PGW bindings so that the DNS server redirects the DNS queries to the PGW.

In another embodiment the PGW can create a NAT binding with port information which is also called a network address and port translation NAPT binding. Using NAPT the PGW can anchor more mobile devices than the number of public network IP addresses the PGW is eligible to use. However NAPT has a challenge similar to a regular NAT in that a NAPT binding needs to be created by a device in the private network before a device in a public network can communicate with the device in the private network. This issue can be addressed using the gateway based address resolution scheme. In step of if the UE does not have a NAPT binding the PGW can create a NAPT binding and generate a NAPT binding entry in the address translation table. The NAPT binding entry associates the local IP address of a UE with a a public IP address and b a unique port assigned to the UE at the PGW for this communication. The port information can be retrieved from existing or enhanced service records SRV records . The PGW then responds to the DNS query by sending a DNS response that includes the public IP address and the unique port assigned to the UE . The NAPT binding entry can also be associated with an expiration timer.

The PGW can be configured to provide DNS service to only authorized requestors. In one embodiment the PGW can maintain a blacklist of requestors that are not authorized to retrieve IP addresses of recipients. If the PGW receives a DNS query from a requestor on the blacklist the PGW can ignore the query or send a DNS negative response that the recipient is not available for communication. In another embodiment the PGW can maintain a whitelist where only those on the whitelist can retrieve IP addresses of recipients through DNS queries. If the PGW receives a DNS query from a requestor on the whitelist the PGW can resolve the DNS query and send a DNS response to the requestor if the PGW receives a DNS query from a requestor that is not on the whitelist the PGW can ignore the query or send a DNS negative response that the recipient is not attached to the network. In certain embodiments a requestor is not authorized to retrieve IP addresses of recipients unless the requestor communicates over an authorized Application Programming Interface API. The authorized API can allow Diameter queries to the HSS or an Extensible Markup Language XML queries to the PGW .

In certain embodiments DNS service requestors can be charged for a DNS query which can potentially stop spammers and Distributed Denial of Service DDOS attackers from pushing malicious spam data to mobile devices. When a PGW receives a DNS query from a requestor and creates a NAT binding in response to the DNS query the creation of the NAT binding can serve as a trigger to charge the requestor. Furthermore the PGW can also apply any special charging schemes that are locally configured on the PGW .

A DNS module can provide DNS server functionalities at the gateway . The DNS module can resolve a DNS query to find an IP address associated with a hostname identified in the DNS query. The DNS module can include a DNS cache that maintains IP addresses of recently resolved hostnames. To resolve the IP address of a hostname the DNS module can 1 check the DNS cache to determine if the DNS cache maintains the requested IP address or 2 determine whether the UE corresponding to the hostname is currently anchored at the gateway . If the DNS module can find the IP address of the requested hostname the DNS module can send a DNS response with the identified IP address.

If the DNS module cannot find the requested IP address the DNS module can find another gateway or its DNS module that has a higher probability of having access to the requested IP address. The DNS module can support both a recursive DNS mode and an iterative DNS mode. In a recursive DNS mode the DNS module can operate as a DNS resolver that recursively sends new DNS queries to other gateways or their DNS modules on behalf of the requestor until the requested IP address is resolved. In an iterative DNS mode the DNS module can instruct the requestor to send the new DNS query to the gateway with a higher probability of having access to the requested IP address. The DNS module can be implemented in software using the memory such as a non transient computer readable medium a non transitory computer readable medium a programmable read only memory PROM or flash memory. The software can run on a processor that executes instructions or computer code. The DNS module may also be implemented in hardware using an application specific integrated circuit ASIC programmable logic array PLA or any other integrated circuit.

A NAT module can provide network address translation for UEs anchored at the gateway . The NAT module can create a NAT binding which binds the local IP address of the UE with a public IP address and store the NAT binding information in an address translation table . The address translation table can reside in the gateway but it can also be a stand alone device. The NAT binding can be created when a UE anchored at the gateway initiates communication with another device in a public network or when a device in a public network initiates communication with a UE anchored at the gateway . The NAT module can maintain a blacklist of devices that should not be allowed to create a NAT binding with any of the UEs anchored at the gateway . The NAT module can also maintain a whitelist of devices where only those on the whitelist are allowed to create a NAT binding with UEs anchored at the gateway .

The NAT module can create an application level NAT binding. An application level NAT binding binds UE s local IP address with an assigned public IP address and an application the UE is authorized to communicate with. An application level NAT binding can be created when the gateway receives a DNS query with an identification of an application sending the DNS query. The application level NAT binding information can also be stored in the address translation table . The NAT module and the address translation table can be implemented in software using the memory such as a non transient computer readable medium a non transitory computer readable medium a programmable read only memory PROM or flash memory. The software can run on a processor that executes instructions or computer code. The NAT module and the address translation table may also be implemented in hardware using an application specific integrated circuit ASIC programmable logic array PLA or any other integrated circuit.

An interface can provide an input and or output mechanism to communicate with other network devices. The interface can provide communication with DNS servers application servers and user equipment as well as other core network nodes to send and receive control data. The interface can be implemented in hardware to send and receive signals in a variety of mediums such as optical copper and wireless and in a number of different protocols some of which may be non transient.

The user equipment described above can communicate with a plurality of radio access networks using a plurality of access technologies and with wired communications networks. The user equipment can be a smart phone offering advanced capabilities such as word processing web browsing gaming e book capabilities an operating system and a full keyboard. The user equipment may run an operating system such as Symbian OS iPhone OS RIM s Blackberry Windows Mobile Linux Palm WebOS and Android. The screen may be a touch screen that can be used to input data to the mobile device and the screen can be used instead of the full keyboard. The user equipment may have the capability to run applications or communicate with applications that are provided by servers in the communications network. The user equipment can receive updates and other information from these applications on the network.

The user equipment also encompasses many other devices such as televisions TVs video projectors set top boxes or set top units digital video recorders DVR computers netbooks laptops and any other audio visual equipment that can communicate with a network. The user equipment can also keep global positioning coordinates profile information or other location information in its stack or memory. The user equipment can have a memory such as a non transient computer readable medium a non transitory computer readable medium flash memory a magnetic disk drive an optical drive a programmable read only memory PROM and or a read only memory ROM . The user equipment can be configured with one or more processors that process instructions and run software that may be stored in memory. The processor can also communicate with the memory and interfaces to communicate with other devices. The processor can be any applicable processor such as a system on a chip that combines a CPU an application processor and flash memory. The interfaces can be implemented in hardware or software. The interfaces can be used to receive both data and control information from the network as well as local sources such as a remote control to a television. The user equipment can also provide a variety of user interfaces such as a keyboard a touch screen a trackball a touch pad and or a mouse. The user equipment may also include speakers and a display device in some embodiments.

The gateway based address resolution mechanism described above can be implemented in a network device in some embodiments. This network device can implement multiple and different integrated functionalities. In some embodiments one or more of the following functionalities can be implemented on the network device including a security gateway SeGW an access gateway a Gateway General packet radio service Serving Node GGSN a serving GPRS support node SGSN a packet data inter working function PDIF an access service network gateway ASNGW a User Plane Entity UPE an IP Gateway a session initiation protocol SIP server a proxy call session control function P CSCF and an interrogating call session control function I CSCF a serving gateway SGW and a packet data network gateway PDN GW a mobility management entity MME a mobility access gateway MAG an HRPD serving gateway HSGW a local mobility anchor LMA a packet data serving node PDSN a foreign agent FA and or home agent HA . The gateway based address resolution mechanism can be implemented on network devices of the same type implementing the same set of functionalities.

In certain embodiments the functionalities are provided by a combination of hardware and software in the network device. General purpose hardware can be configured in the network device to provide one or more of these specialized functionalities. The gateway can also support sessions originated from a Femto base station which would connect to the gateway using a broadband network. A person or corporation may use a Femto base station in a home or business to support one or more mobile nodes. The gateway can provide trigger based traffic management during a handoff from a Femto base station to a macro base station while maintain traffic management for the mobile node. The offload gateway can be implemented as any combination of the following including an xGSN an xGW an xGW SGW and an xGW PGW.

In some embodiments the network device is implemented using a collection of integrated circuit boards or cards. These cards include input output interfaces for communication amongst each other at least one processor for executing instructions and running modules that are stored in memory and memory for storing data. The features of a network device that implements a gateway in accordance with some embodiments are further described below. illustrates the implementation of a network device in accordance with some embodiments. The network device includes slots for loading application cards and line cards. A midplane can be used in the network device to provide intra network device communications power connections and transport paths between the various installed cards. The midplane can include buses such as a switch fabric a control bus a system management bus a redundancy bus and a time division multiplex TDM bus. The switch fabric is an IP based transport path for user data throughout the network device implemented by establishing inter card communications between application cards and line cards. The control bus interconnects the control and management processors within the network device. The network device management bus provides management of system functions such as supplying power monitoring temperatures board status data path errors card resets and other failover features. The redundancy bus provides transportation of user data and redundancy links in the event of hardware failures. The TDM bus provides support for voice services on the system.

The network device supports at least four types of application cards a switch processor I O card SPIO a system management card SMC a packet service card PSC and a packet accelerator card not shown . Other cards used in the network device include line cards and redundant crossbar cards RCC . The line cards when loaded in the network device provide input output connectivity to the network and other devices as well as redundancy connections. The line cards include interfaces to the network through Ethernet Fiber Optic and the other communication mediums. The redundant crossbar card RCC includes a non blocking crossbar and connections to each of the cards in the network device. This allows a redundant connection to be made through the redundant crossbar card from any one card to any other card in the network device. The SPIO card serves as a controller of the network device and is responsible for such things as initializing the network device and loading software configurations onto other cards in the network device.

The system management card SMC and switch processor card not shown are system control and management cards for managing and controlling other cards in the network device. The packet accelerator card PAC and packet service card PSC provide packet processing context processing capabilities and forwarding capabilities among other things. The PAC and PSC perform packet processing operations through the use of control processors and a network processing unit. The network processing unit determines packet processing requirements receives and transmits user data frames to from various physical interfaces makes IP forwarding decisions implements packet filtering flow insertion deletion and modification performs traffic management and traffic engineering modifies adds strips packet headers and manages line card ports and internal packet transportation. The control processors also located on the packet accelerator card provide packet based user service processing.

The operating system software can be based on a Linux software kernel and run specific applications in the network device such as monitoring tasks and providing protocol stacks. The software allows network device resources to be allocated separately for control and data paths. For example certain packet accelerator cards and packet services cards can be dedicated to performing routing or security control functions while other packet accelerator cards packet services cards are dedicated to processing user session traffic. As network requirements change hardware resources can be dynamically deployed to meet the requirements in some embodiments. The system can be virtualized to support multiple logical instances of services such as technology functions e.g. a SeGW PGW SGW MME HSGW PDSN ASNGW PDIF HA or GGSN .

The network device s software can be divided into a series of tasks that perform specific functions. These tasks communicate with each other as needed to share control and data information throughout the network device. A task is a software process that performs a specific function related to system control or session processing. Three types of tasks operate within the network device in some embodiments critical tasks controller tasks and manager tasks. The critical tasks control functions that relate to the network device s ability to process calls such as network device initialization error detection and recovery tasks. The controller tasks mask the distributed nature of the software from the user and perform tasks such as monitor the state of subordinate manager s provide for intra manager communication within the same subsystem and enable inter subsystem communication by communicating with controller s belonging to other subsystems. The manager tasks can control system resources and maintain logical mappings between system resources.

Individual tasks that run on processors in the application cards can be divided into subsystems. A subsystem is a software element that either performs a specific task or is a culmination of multiple other tasks. A single subsystem can include critical tasks controller tasks and manager tasks. Some of the subsystems that can run on a network device include a system initiation task subsystem a high availability task subsystem a recovery control task subsystem a shared configuration task subsystem a resource management subsystem a virtual private network subsystem a network processing unit subsystem a card slot port subsystem and a session subsystem.

The system initiation task subsystem is responsible for starting a set of initial tasks at system startup and providing individual tasks as needed. The high availability task subsystem works in conjunction with the recovery control task subsystem to maintain the operational state of the network device by monitoring the various software and hardware components of the network device. Recovery control task subsystem is responsible for executing a recovery action for failures that occur in the network device and receives recovery actions from the high availability task subsystem. Processing tasks are distributed into multiple instances running in parallel so if an unrecoverable software fault occurs the entire processing capabilities for that task are not lost. User session processes can be sub grouped into collections of sessions so that if a problem is encountered in one sub group users in another sub group will not be affected by that problem.

The architecture also allows check pointing of processes which is a mechanism to protect the system against any critical software processes that may fail. The self healing attributes of the software architecture protects the system by anticipating failures and instantly spawning mirror processes locally or across card boundaries to continue the operation with little or no disruption of service. This unique architecture allows the system to perform at the highest level of resiliency and protects the user s data sessions while ensuring complete accounting data integrity.

Shared configuration task subsystem provides the network device with an ability to set retrieve and receive notification of network device configuration parameter changes and is responsible for storing configuration data for the applications running within the network device. A resource management subsystem is responsible for assigning resources e.g. processor and memory capabilities to tasks and for monitoring the task s use of the resources.

Virtual private network VPN subsystem manages the administrative and operational aspects of VPN related entities in the network device which include creating separate VPN contexts starting IP services within a VPN context managing IP pools and subscriber IP addresses and distributing the IP flow information within a VPN context. In some embodiments within the network device IP operations are done within specific VPN contexts. The network processing unit subsystem is responsible for many of the functions listed above for the network processing unit. The card slot port subsystem is responsible for coordinating the events that occur relating to card activity such as discovery and configuration of ports on newly inserted cards and determining how line cards map to application cards.

The session subsystem is responsible for processing and monitoring a mobile subscriber s data flows in some embodiments. Session processing tasks for mobile data communications include S1 S5 S8 interface termination for LTE networks A10 A11 interface termination for CDMA networks GSM tunneling protocol GTP termination for GPRS and or UMTS networks asynchronous PPP processing IPsec packet filtering packet scheduling Diffserv codepoint marking statistics gathering IP forwarding and AAA services for example. Responsibility for each of these items can be distributed across subordinate tasks called managers to provide for more efficient processing and greater redundancy. A separate session controller task serves as an integrated control node to regulate and monitor the managers and to communicate with the other active subsystem. The session subsystem also manages specialized user data processing such as payload transformation filtering statistics collection policing and scheduling.

In providing emulation as MIPv4 is received from a mobile node the session subsystem can setup a MIPv4 termination and setup a PMIPv6 session towards the core network. A session manager can track the mapping of the sessions and processing to provide the emulation and inter working between the networks. A database can also be used to map information between the sessions and store for example NAI HoA AE information in some embodiments.

The network device allows system resources to be allocated separately for control and data paths. For example certain PACs PSCs could be dedicated to performing routing or security control functions while other PACs PSCs are dedicated to processing user session traffic. As network requirements grow and call models change hardware resources can be added to accommodate processes such as encryption packet filtering etc. that require more processing power. illustrates a logical view of the software architecture of a network device in accordance with certain embodiments. As shown the software and hardware can be distributed within the network device and across different circuit boards processors and memory. includes a primary switch processor card SPC system management card SMC a secondary SPC SMC PAC PSC a communication path and a synchronization path . The SPC SMC include a memory a processor a boot configuration high availability tasks resource manager switch fabric control and controller tasks .

The SPC SMC manage and control the network device including the other cards in the network device. The SPC SMC can be configured in a primary and secondary arrangement that provides redundancy and failsafe protection. The modules or tasks running on the SPC SMC are related to network device wide control and management. The boot configuration task includes information for starting up and testing the network device. The network device can also be configured to startup in different configurations and providing different implementations. These can include which functionalities and services are capable of running on the SPC SMC . The high availability task maintains the operational state of the network device by monitoring the device and managing recovery efforts to avoid disruption of service. The resource manager tracks and assigns the available resources for sessions and demands on the network device. This can include load balancing among different processors and tasks running on the network device. Processes can be distributed across the system to fit the needs of the network model and specific process requirements. For example most tasks can be configured to execute on SPC SMC or a PAC PSC while some processor intensive tasks can also be performed across multiple PACs PSCs to utilize multiple CPU resources. Distribution of these tasks is invisible to the user. The switch fabric control controls the communication paths in the network device. The controller tasks module can manage the tasks among the resources of the networks to provide for example VPN services assign ports and create delete and modify sessions for user equipment.

The PAC PSC are high speed processing cards that are designed for packet processing and the tasks involved with providing various network functionalities on the network device. The PAC PSC include a memory a network processing unit NPU a processor a hardware engine an encryption component a compression component and a filter component . Hardware engines can be deployed with the card to support parallel distributed processing for compression classification traffic scheduling forwarding packet filtering and statistics compilations. The components can provide specialize processing that can be done more efficiently than using a general processor in some embodiments.

Each PAC PSC is capable of supporting multiple contexts. The PAC PSC are also capable of running a variety of tasks or modules. PAC PSC provides routing managers with each covering routing of a different domain. PAC PSC provides a session manager and an AAA manager . The session manager manages one or more sessions that correspond to one or more user equipment. A session allows a user equipment to communicate with the network for voice calls and data. The AAA manager manages accounting authentication and authorization with an AAA server in the network. PAC PSC provides a deep packet inspection task and a signaling demux . The deep packet inspection task provides inspection of packet information beyond layer for use and analysis by the network device. The signaling demux can provide scalability of services in combination with other modules. PAC PSC provides redundancy through standby tasks . Standby tasks store state information and other task information so that the standby task can immediately replace an active task if a card fails or if there is a scheduled event to remove a card.

In some embodiments the software needed for implementing a process or a database includes a high level procedural or an object orientated language such as C C C Java or Perl. The software may also be implemented in assembly language if desired. Packet processing implemented in a network device can include any processing determined by the context. For example packet processing may involve high level data link control HDLC framing header compression and or encryption. In certain embodiments the software is stored on a storage medium or device such as read only memory ROM programmable read only memory PROM electrically erasable programmable read only memory EEPROM flash memory or a magnetic disk that is readable by a general or special purpose processing unit to perform the processes described in this document. The processors can include any microprocessor single or multiple core system on chip SoC microcontroller digital signal processor DSP graphics processing unit GPU or any other integrated circuit capable of processing instructions such as an x86 microprocessor.

Although the present disclosure has been described and illustrated in the foregoing example embodiments it is understood that the present disclosure has been made only by way of example and that numerous changes in the details of implementation of the disclosure may be made without departing from the spirit and scope of the disclosure which is limited only by the claims which follow. Other embodiments are within the following claims. For example DNS queries from a requestor can be resolved at a SGW.

