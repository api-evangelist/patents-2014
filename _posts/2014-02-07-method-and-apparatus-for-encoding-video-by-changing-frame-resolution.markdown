---

title: Method and apparatus for encoding video by changing frame resolution
abstract: Encoding a video signal having a plurality of frames is described. Test frames in the sequence of test frames have an original resolution. A variance for each test frame in the sequence is calculated, as is a first peak signal-to-noise ratio (PSNR) for each test frame using the original resolution. A threshold is determined using the variances and first PSNRs. The threshold is provided to an encoder to select a frame resolution for a first frame of the plurality of frames, the frame resolution being one of the original resolution or a resolution different from the original resolution.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09210420&OS=09210420&RS=09210420
owner: GOOGLE INC.
number: 09210420
owner_city: Mountain View
owner_country: US
publication_date: 20140207
---
This application is a continuation of U.S. patent application Ser. No. 13 095 968 filed Apr. 28 2011 the entire content of which is incorporated herein in its entirety by reference.

This application is related to U.S. patent application Ser. No. 13 095 967 filed Apr. 28 2011 and U.S. patent application Ser. No. 13 096 285 filed Apr. 28 2011 each of which is incorporated herein in its entirety by reference.

The present disclosure relates in general to video signal transmission and particularly to the encoding and decoding of such a signal.

An increasing number of applications today make use of digital video signals for various purposes including for example business meetings between people in remote locations via video conferencing high definition video entertainment video advertisements and sharing of user generated videos. As technology is evolving users have higher expectations for video quality and resolution even when video signals are transmitted over communications channels having limited bandwidth.

To permit transmission of digital video streams while limiting bandwidth consumption a number of video compression schemes have been devised including formats such as VPx promulgated by Google Inc. of Mountain View Calif. and H.264 a standard promulgated by ITU T Video Coding Experts Group VCEG and the ISO IEC Moving Picture Experts Group MPEG including present and future versions thereof. H.264 is also known as MPEG 4 Part 10 or MPEG 4 AVC formally ISO IEC 14496 10 .

These compression schemes can use quantization techniques on frames of a digital video stream to reduce the bitrate i.e. data size of the encoded digital video stream. These quantization techniques discard part of a frame s data using standard computations thereby reducing the frame s bitrate. Although these quantization techniques reduce the bitrate they may not suitably maintain the quality of the video signal.

One aspect of the disclosed embodiments is a method for encoding a video signal having a plurality of frames each frame having a plurality of blocks. The encoding method includes identifying a first frame from the plurality of frames as an I frame the first frame having an original resolution determining a variance for the first frame using a processor and if the variance exceeds an intra threshold selecting a frame resolution for the first frame that is less than the original resolution and encoding the first frame using the selected frame resolution.

Another aspect of the disclosed embodiments is a method for determining at least one threshold used for encoding a video signal having a plurality of frames each frame having a plurality of blocks. The method further includes identifying a test sequence of frames the frames in the test sequence of frames having an original resolution. The method further includes calculating at least one variance for at least one frame in the test sequence and calculating at least one first PSNR for the at least one frame using the original resolution. The method further includes determining the at least one threshold using the variances and first PSNRs.

Another aspect of the disclosed embodiments is an apparatus for encoding a video signal having at least one frame each frame having a plurality of blocks each block having a plurality of pixels. The apparatus comprises a memory and at least one processor configured to execute instructions stored in the memory to identify a first frame from the plurality of frames as an I frame the first frame having an original resolution determine a variance for the first frame and if the variance exceeds an intra threshold select a frame resolution for the first frame that is less than the original resolution and encode the first frame using the selected frame resolution.

Another method for encoding a video signal having a plurality of frames described herein includes calculating a variance for each test frame in a sequence of test frames the test frames in the sequence of test frames having an original resolution calculating a first peak signal to noise ratio PSNR for each test frame using the original resolution determining a threshold using the variances and first PSNRs and providing the threshold to an encoder to select a frame resolution for a first frame of the plurality of frames the frame resolution being one of the original resolution or a resolution different from the original resolution.

Another apparatus for encoding a video signal having at least one frame described herein includes a memory and a processor. The processor is configured to execute instructions stored in the memory to calculate a variance for each test frame in a sequence of test frames the test frames in the sequence of test frames having an original resolution calculate a first peak signal to noise ratio PSNR for each test frame using the original resolution determine a threshold using the variances and first PSNRs and provide the threshold to an encoder to select a frame resolution for a first frame of the plurality of frames the frame resolution being one of the original resolution or a resolution different from the original resolution.

A display configured to display a video stream can be connected to transmitting station . Display may be implemented in various ways including by a liquid crystal display LCD or a cathode ray tube CRT . Display may also be configured for other uses such as screencasting. Alternatively or in addition to display a video stream can be generated from a video camera or received from a video file and can be transferred to transmitting station .

A video stream can consist of a number of adjacent video frames i.e. images which may be still or dynamic. Adjacent video frames can be further subdivided into a single frame. At the next level the frame can be divided into a series of blocks which contain data corresponding to for example a 16 16 block of displayed pixels. Each block can contain luminance and chrominance data for the corresponding pixels. The blocks can also be of any other suitable size such as 16 8 pixel groups or 8 16 pixel groups. In other embodiments video stream may only include a single frame and may be in applications such as screencasting.

A network connects transmitting station and a receiving station for encoding and decoding of the video stream. Specifically the video stream can be encoded by an encoder in transmitting station and the encoded video stream can be decoded by a decoder in receiving station . Network may for example be the Internet. Network may also be a local area network LAN wide area network WAN virtual private network VPN or any other means of transferring the video stream from transmitting station .

Receiving station in one example may be a computer having an internal configuration of hardware include a processor such as a central processing unit CPU and a memory . CPU is a controller for controlling the operations of transmitting station . CPU can be connected to memory by for example a memory bus. Memory may be RAM or any other suitable memory device. Memory stores data and program instructions which are used by CPU . Other suitable implementations of receiving station are possible.

The method describes a process for determining whether to encode a GOP at the lower pixel resolution based on frame variance. Encoding a GOP at the lower pixel resolution reduces the bitrate of the encoded GOP and can provide a higher quality encoding at a target bitrate even if quantization is employed when the variance of frames are high as compared to the sole use of quantization to achieve a target bitrate of the encoded GOP.

For a current frame in a digital video stream the encoder first checks if conditions are met to set a pre determined resolution for the next I frame in the digital video stream . The conditions function as a watchdog to revert encoding of the digital video stream from a lower pixel resolution to the original resolution of the frames or to force encoding at a lower pixel resolution when warranted. The conditions can be based on the encoding of a set of P frames coming before the current frame in the current frame s GOP or the previous frame s GOP for example where the current frame is an I frame in a fixed length GOP encoding .

The following are examples of when the pre determined resolution is set. In one implementation the P frames in the set of P frames are encoded at least partially with respect to a previously encoded frame. As described later a variance set can be calculated for each P frame including an intra prediction variance and an inter prediction variance. For example if the variances in the set of P frames are mostly small values the conditions are met to set the pre determined resolution for the next I frame to the original resolution of the frames in the digital video stream. Alternatively if the variances in the set of P frames are mostly large values the conditions are met to set the pre determined resolution for the next I frame to the lower pixel resolution of the frames in the digital video stream. An encoder can implement both one or none of these conditions depending on the implementation.

In another implementation the encoder can determine for example whether the variances are mostly small values or mostly large values by considering one or both of the variances and by comparing an aggregate e.g. the sum average or any other aggregate of those variances to a lower watchdog threshold value and an upper watchdog threshold value. For example if the aggregate of variances is less than the lower watchdog threshold value the pre determined resolution is set to the original resolution. In another example if the aggregate of variances is greater than the upper watchdog threshold value the pre determined resolution is set to the lower resolution. In another example if neither condition is met the pre determined resolution is left as is.

Alternatively other methods of evaluating the set of P frames to determine the pre determined resolution may be used. In another implementation each P frame in the set can be determined to be complex or non complex by comparing one variance of each frame to an intermediate threshold value. The intermediate threshold value can be for example the inter threshold the intra threshold or any other determined threshold. A complexity percentage is then calculated using the number of complex frames and the total number of frames in the set of P frames. If the percentage is less than a lower watchdog threshold the pre determined resolution is set to the original resolution. If the percentage is greater than an upper watchdog threshold value the pre determined resolution is set to the lower resolution. If neither condition is met the pre determined resolution is left as is.

Next the encoder determines whether the current frame is an I frame . The current frame may be an I frame based on for example its position in the digital video stream. The current frame can be an I frame based on a number of alternative considerations that may or may not be used by the encoder. For example the current frame could be an I frame if requested by the receiving station or if the pre determined resolution is set. However some encoding schemes may require that a GOP be of a fixed length. In these encoding schemes the I frame determination would be based on a number of frames since the last I frame.

If the current frame is an I frame the encoder checks if there is a pre determined resolution set . If there is not a pre determined resolution set the encoder determines the variance of the current frame . A method of determining an I frame variance is described in more detail later with respect to . Next the encoder selects the frame resolution for encoding the current frame and the GOP based on the variance of the current frame . A method of selecting the frame resolution is described in more detail later with respect to .

Once the frame resolution of the current frame is selected or if there is a pre determined resolution from stage the I frame is encoded using the selected frame resolution or the pre determined resolution . The encoding process can be performed using any encoding scheme such as various standard video encoding schemes presently available. The encoding process may be performed in parallel to the remainder of method . For example the encoding of stage may be performed on one processor in a computer whereas the other stages of method may be performed on another processor. Such a scheme would allow for the encoding of a first frame while method determines the resolution of a next frame. Once the current frame is encoded the method ends.

Returning to stage if the current frame is not an I frame the encoder determines whether the current frame s GOP is being encoded at a resolution less than the original resolution . If the GOP is at the original resolution the encoder determines a variance set for the current frame . A method of determining a P frame variance is described in more detail later with respect to . Next the encoder selects the resolution of the next I frame based on the variance set . A method of selecting the resolution of the next I frame is described in more detail later with respect to . Once the next I frame resolution is selected the pre determined resolution is set using the selected next I frame resolution. However there may not be a next I frame resolution. In such a case the pre determined resolution remains unset if it was not previously set and remains at its previous value if it was previously set.

Once the resolution of the next I frame is selected or if the current frame s GOP is being encoded at a lower resolution from stage the encoder encodes the current frame using the GOP s selected frame resolution . As described previously with respect to stage the encoding of the current frame in stage may be performed on one processor in a computer whereas the other stages of method may be performed on another processor. Such a scheme would allow for the encoding of a first frame while method determines the resolution of a next frame. Once the current frame is encoded the method ends.

Referring again back to stage instead of encoding the current frame stage the encoder can alternatively redefine the current frame as an I frame and return to stage as shown by the dotted line . To do so the encoder must use an encoding scheme that allows for GOPs having varying numbers of frames in the encoded digital video stream.

The intra prediction variance can be calculated by performing intra prediction on the blocks in the current frame. Intra prediction can be based on previously coded image samples within the current frame. Intra prediction can be performed on a current block by for example copying pixels or filtered pixels from adjacent previously coded blocks to form a predicted block. The manner in which the pixels are copied can be by vertical prediction horizontal prediction DC prediction True Motion prediction southwest prediction southeast prediction vertical right diagonal prediction vertical left diagonal prediction horizontal down prediction horizontal up prediction etc.

Intra prediction can also be performed using a technique other than copying pixel values. For example a predicted block can be formed for a current block using one or more parameterized equations. These parameterized equations can be for example an expression representing a curve that has a best fit to a defined set of previously coded pixels in the frame. Other techniques of determining a predicted block using intra prediction are also possible.

A residual block is determined based on the difference between the predicted block and the best matching block. The intra prediction variance can then be calculated using the below equations 

The mean for the residual block is first calculated by averaging the values of all pixels within the residual block. The intra prediction variance is then calculated by averaging the absolute value of the difference of each pixel from the mean of the residual block. The calculations above are exemplary only and other similar means of determining the intra prediction variance may be utilized.

The encoder next adds the calculated intra prediction variance for the selected block to the intra prediction variance total for the current frame . The encoder then returns to determine whether additional blocks are available within the current frame stage . Once there are no blocks left to process the encoder then normalizes the intra prediction variance total 92 . Normalization is used to equalize the scale of the intra prediction variance total with the intra threshold that it will be later compared with. For example the intra threshold may be of a per block scale. In such a case the intra prediction variance total would be normalized by dividing it by the number of blocks in the current frame and that result would be used as the frame s variance. In another example the intra threshold may be of a per frame scale. In such a case the intra prediction variance total would be normalized by leaving the intra predicting variance total as is and using it directly as the frame s variance.

As described before the intra prediction variance can be calculated by copying pixel values from previously coded blocks using a parameterized equation or any other possible technique. A residual block is determined based on the difference between the predicted block and the best matching block. The intra prediction variance can then be calculated using equations 1 and 2 above or by an equivalent set of calculations.

The inter prediction variance can be calculated by first performing an inter frame motion vector search for a best matching block in a reference frame. The reference frame can be any reference frame available in the encoding scheme used including a last frame a last I frame or an alternative reference frame. A residual block is determined based on the difference between the current block and the best matching block. A motion vector is also encoded that describes the position of the best matching block relative to the position of the current block. The inter prediction variance can then be calculated using equations 1 and 2 above or by an equivalent set of calculations.

In one embodiment the inter prediction variance can be replaced by the intra prediction variance. The inter prediction variance is replaced when the intra prediction is the smallest variance of the two. The replacement can be done because an inter predicted frame may contain blocks that are both inter predicted and intra predicted. In this case the encoder may take this into account by using the intra prediction variance if it finds a better matching block than can be found using inter prediction.

The encoder next adds the calculated intra prediction variance for the selected block to the intra prediction variance total for the current frame and adds the calculated inter prediction variance for the selected block to the inter prediction variance total for the current frame . The encoder then returns to determine whether additional blocks are available within the current frame stage . Once there are no blocks left to process the encoder then normalizes the intra prediction variance total and the inter prediction variance total 122 . The normalization process is the same as that described previously with respect to stage . The normalized intra prediction variance total is the intra variance and the normalized inter prediction variance total is the inter variance. The intra variance and the inter variance together form the variance set of the current frame.

If the intra variance is not greater than the intra threshold the next I frame resolution is set to the original resolution . Otherwise if it is greater the next I frame resolution is set to a resolution less than the original resolution . And referring back to stage if the inter variance is not greater than the inter threshold the next I frame resolution is left as is 150 .

The method operates on a test sequence of frames. The test sequence of frames can contain video data similar to that expected to be encoded. For example in a screen casting encoding application the test sequence of frames could be an exemplary screen casting video data stream. In another example if an encoder could be used for screen casting and for encoding of moving pictures i.e. video clips and or movies the test sequence of frames can include both a screen casting video data stream and a moving picture video data stream. The test sequence of frame can also be based on video data from other sources.

Once variables are initialized the method next checks to see if any frames are left to process in the test sequence of frames . If there is at least one frame left the next frame for processing is selected . The variance of the selected frame is calculated using a method such as method of determining an intra frame variance . The selected frame is encoded and then decoded using its original resolution . The encoding is performed to create an encoded frame that is within a target bitrate.

An original resolution peak signal to noise ratio PSNR O will be calculated using the frame and the decoded frame . A PSNR value is a measure of quality comparing the original frame and a lossy encoded reconstructed decoded frame. In this case the PSNR O measures the quality of the resulting decoded frame after being compressed to the target bitrate using techniques other than the changing of pixel resolution i.e. quantization .

The PSNR can be calculated using a mean squared error MSE . The PSNR alternatively can be calculated using other means. One exemplary equation for calculating the MSE and PSNR is provided 

Once the PSNR O has been calculated the selected frame will be downsampled to a resolution less than the original resolution the downsampled frame will be encoded and then decoded and the decoded downsampled frame will then be upsampled to the original resolution . As with the encoding of the original resolution frame the encoding of the downsampled frame is performed using a target bitrate. The purpose is to create a decoded upsampled frame for comparison with the selected frame. The resolution of the downsampled frame can be determined using one or more pre determined lower resolutions. Alternatively the resolution of the downsampled frame can be determined on a frame by frame basis selected by a user or any other technique.

A lower resolution peak signal to noise ratio PSNR L is then calculated . In this case the PSNR L measures the quality of the resulting decoded upsampled frame after being compressed to the target bitrate using the technique of changing the pixel resolution.

Once the intra variance PSNR O and PSNR L have been calculated for the selected frame the method returns to stage to determine if any additional frames are available in the test sequence of frames. Once there are no frames left the method includes plotting the variance PSNR O and PSNR L values calculated for each frame . The plot includes two series of data. The first series includes the variance for each frame versus the PSNR O value for each frame. The second series includes the variance for each frame versus the PSNR L value for each frame.

The first and second series can be plotted using fitted curve techniques. For example an approximate fitted curve function can be determined to approximate each series. The fitted curve techniques used can include techniques such as the least squares method. Alternatively the first and second series can be plotted using their actual values. Plotting may not involve the actual placement of data points on a coordinate plane. Rather plotting may merely be an intermediate step performed by a processor.

Next an intersection between the first series and the second series is determined . The intersection may be determined computationally by a processor based on the fitted curves determined for each series. But the intersection can also be determined using other methods. For example a programmer or other person may select the intersection based on a plot of each series on a coordinate plane. The selected intersection is the intra threshold . Alternatively the selected intersection s value may be multiplied by a constant or processed by a standard function to normalize it for use in the encoder as the intra threshold.

The method operates on a test sequence of frames. The test sequence of frames can contain video data similar to that expected to be encoded. For example in a screen casting encoding application the test sequence of frames could be an exemplary screen casting video data stream. In another example if an encoder could be used for screen casting and for encoding of moving pictures i.e. video clips and or movies the test sequence of frames can include both a screen casting video data stream and a moving picture video data stream.

Once variables are initialized the method next checks to see if any frames are left to process in the test sequence of frames . If there is at least one frame left the next frame for processing is selected . The variance of the selected frame is calculated using a method such as method that includes determining an inter frame variance . The selected frame is encoded and then decoded using its original resolution . The encoding is performed to create an encoded frame that is within a target bitrate.

A peak signal to noise ratio PSNR will be calculated using the frame and the decoded frame . As discussed previously a PSNR value is a measure of quality comparing the original frame and a lossy encoded reconstructed decoded frame. In this case the PSNR measures the quality of the resulting decoded frame after being compressed to the target bitrate using techniques other than the changing of pixel resolution i.e. quantization . The PSNR can be calculated using a MSE such as described previously.

Once the inter variance and PSNR have been calculated for the selected frame the method returns to stage to determine if any additional frames are available in the test sequence of frames. Once there are no frames left a candidate variance set is selected that contains a series of inter variances and PSNR values for frames where the PSNR value exceeds a PSNR threshold . The candidate variance set can alternately include only the selected inter variances. The largest variance in the candidate variance set is then identified . This identified maximum largest variance value is the inter threshold . Alternatively the identified maximum variance value may be multiplied by a constant or processed by a standard function to normalize it for use in the encoder as the inter threshold.

The above described embodiments of encoding or decoding may illustrate some exemplary encoding techniques. However in general encoding and decoding as those terms are used in the claims are understood to mean compression decompression transformation or any other change to data whatsoever.

The embodiments of transmitting station and or receiving station and the algorithms methods instructions etc. stored thereon and or executed thereby can be implemented in hardware software or any combination thereof including for example IP cores ASICS programmable logic arrays quantum or molecular processors optical processors programmable logic controllers microcode firmware microcontrollers servers microprocessors digital signal processors or any other suitable circuit. In the claims the term processor should be understood as encompassing any the foregoing devices either singly or in combination. The terms signal and data are used interchangeably. Further portions of transmitting station and receiving station do not necessarily have to be implemented in the same manner.

Further in one embodiment for example transmitting station or receiving station can be implemented using a general purpose computer processor with a computer program that when executed carries out any of the respective methods algorithms and or instructions described herein. In addition or alternatively for example a special purpose computer processor can be utilized which can contain specialized hardware for carrying out any of the methods algorithms or instructions described herein.

Transmitting station and receiving station can for example be implemented on computers in a screencasting system. Alternatively transmitting station can be implemented on a server and receiving station can be implemented on a device separate from the server such as a hand held communications device i.e. a cell phone . In this instance transmitting station can encode content using an encoder into an encoded video signal and transmit the encoded video signal to the communications device. In turn the communications device can then decode the encoded video signal using a decoder. Alternatively the communications device can decode content stored locally on the communications device i.e. no transmission is necessary . Other suitable transmitting station and receiving station implementation schemes are available. For example receiving station can be a personal computer rather than a portable communications device.

Further all or a portion of embodiments of the present invention can take the form of a computer program product accessible from for example a computer usable or computer readable medium. A computer usable or computer readable medium can be any device that can for example tangibly contain store communicate or transport the program for use by or in connection with any processor. The medium can be for example an electronic magnetic optical electromagnetic or a semiconductor device. Other suitable mediums are also available.

The above described embodiments have been described in order to allow easy understanding of the present invention and do not limit the present invention. On the contrary the invention is intended to cover various modifications and equivalent arrangements included within the scope of the appended claims which scope is to be accorded the broadest interpretation so as to encompass all such modifications and equivalent structure as is permitted under the law.

