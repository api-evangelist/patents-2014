---

title: System and method for client communication in a distributed telephony network
abstract: A system and method for regional routing of internet protocol based real-time communication that includes registering a set of client application endpoint routes, comprising registering at least a first client gateway route of a first endpoint in a first region; receiving a communication invitation of the first endpoint; processing a set of communication instructions associated with the communication invitation and identifying a set of communication resources and at least a second endpoint; querying the client application endpoint routes and identifying a client gateway route of the second endpoint; and dynamically directing signaling path and media path of the communication according to the regional availability of the communication resources, the client gateway route of the first endpoint, and client gateway instance route of the second endpoint.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09553799&OS=09553799&RS=09553799
owner: Twilio, Inc.
number: 09553799
owner_city: San Francisco
owner_country: US
publication_date: 20141112
---
This application claims the benefit of U.S. Provisional Application Ser. No. 61 902 995 filed on 12 Nov. 2013 which is incorporated in its entirety by this reference.

This invention relates generally to the telephony field and more specifically to a new and useful system and method for client communication in a distributed telephony network.

In recent years innovations in the web application and Voice over Internet Protocol VOIP have brought about considerable changes to the capabilities offered through traditional phone services. In some distributed or cloud based telephony systems the routing of audio video or other media files can be determined or limited by the location and or availability of the appropriate computing resources. In some instances some or all of the callers reside in the same region country or continent as the bulk of the computing resources thereby promoting increased call quality. However if one or more of the parties to the call is located in a different region country or continent then it is not readily apparent which computing resources should be utilized. Similarly if the platform infrastructure is based in one region communication outside of that region will be poor quality. For example if the two callers reside in different countries it might be unclear which of many computing resources should be allocated to the particular session. Furthermore as more communication platforms are supported by cloud computing services located in distinct areas core computing infrastructure may be limited to particular locations. Accordingly there is a need in the art for determining the shortest highest quality and or optimized route for session traffic in a globally distributed telephony system. This invention provides such a new and useful system and method described in detail below with reference to the appended figures.

The following description of preferred embodiments of the invention is not intended to limit the invention to these preferred embodiments but rather to enable any person skilled in the art to make and use this invention.

As shown in a system of the preferred embodiment is configured for managing a distributed communication network operation in at least two regions . The preferred system can be used with any suitable cloud computing environment such as the one described in patent application Ser. No. 12 417 630 filed 2 Apr. 2009 entitled System and Method for Processing Telephony Sessions which is incorporated in its entirety by this reference. The system preferably functions to provide the highest quality path for communication between two endpoints in response to one or both of a selected media type and or the location configuration of the endpoints of the communications. As an example the preferred system can function to minimize network latency between different types of endpoints mobile PSTN browser based telephony client mobile devices client browsers using different types of media voice video text screen sharing multimedia and disposed in different regions countries or continents. In one preferred embodiment the system is configured for managing a distributed telephony network but may alternatively be configured for mobile browser client communication networks video communication screen sharing communication synchronous media communication or any suitable communication network. In operation the preferred system can perform routing and latency minimization in response to one or more of the features capabilities of the endpoints a media quality measurement video and audio recording codec availability compatibility media resource availability and or any suitable metric. During operation the communication flow of the system will preferably shift between operations modes a first mode comprising communication flow between an endpoint of a local region to a remote region with more resources and a second mode comprising communication flow within the local region. Communication flow is preferably a media data stream that is used in the substantially real time communication of media or multimedia. An exemplary benefit of the system is that complex stateful or expensive communication resources may be maintained in limited regions and other resources can be implemented globally or regionally to support particular local regions. The limited communication resources may be complex because they maintain considerable state information of the platform and replicating the state information regionally globally would result in increased complexity and cost. Communication platforms which may be susceptible to global regional scaling issues due to the real time nature of synchronous communication can use the system to dynamically switch between communicating within a local region and communicating with resources of a remote region.

As shown in the preferred system is operable in at least two regions which are connectable through and or serviced by a communication processing server . The preferred system can also include one or more provider services P1 P2 P3 PN and one or more gateways X1 X2 XN in the first region and one or more communication processing servers H1 H2 H3 HN in the second region . The preferred system functions to maintain functional communication when the first region and second region are spatially separated by a globally significant transmission distance. A globally significant distance in this document may be understood to be a transmission distance greater than 2000 miles and more preferably greater than 5000 miles. For example the first region may be on the West coast of the US and the second region may be on the East coast separated by a geographic distance greater than 2500 miles. In another example the first region may be in the United States and the second region may be in Europe separated by a distance greater than 3500 miles. The first region and the second region are not limited to functioning with such distance ranges and may be separated by a distance less than 2000 miles or exceeding 5000 miles.

The provider services P1 P2 P3 preferably receive or initiate communication to an endpoint such as a caller a mobile or browser client. The provider service is preferably an interface between the communication platform of the system and communication providers. Communication providers preferably include telephony carrier networks client applications using IP based communication protocols or any suitable outside network. The system may include a plurality of regions in addition to the first and second regions . The provider services are preferably specific to each region as they are determined by the communication service providers networks and established contracts with various communication entities.

Incoming communications to a destination endpoint are preferably routed to the provider services in response to the destination endpoint being registered with the system . For example a user dialing a PSTN number belonging to the system will preferably have the communication directed to a provider service P1 P2 or P3 . Another example a user dialing a SIP based endpoint that specifies a domain registered in DNS to the system will preferably have the communication directed to a provider service P1 P2 or P3 . The provider additionally creates invite requests and responses that are preferably sent to a regional address e.g. europe.twilio.com and resolved to a communication gateway. In some variations communication may be directly connected to a communication gateway to achieve a lower latency audio video. This may be particularly advantageous to mobile and browser clients. The Domain Name System DNS anycast or any suitable addressing and routing methodology may be used to forward to the closest communication gateway of a particular zone. The provider services preferably use SIP protocol for communication within the system but the outside connected communication devices may use any suitable communication protocol. Similarly the medium of the communication can preferably include any suitable combination of possible media mediums such as audio video screen sharing or other suitable synchronous media mediums.

The communication gateways X1 X2 are preferably configured for both media and signaling. A communication gateway preferably mediates Session Initiation Protocol SIP signaling between at least one endpoint of a communication from call establishment to termination. SIP is a signaling protocol widely used for controlling communication sessions such as voice and or video calls over Internet Protocol. Any suitable communication protocol such as RTP or combination of protocols may alternatively be used. As a SIP mediator the communication gateway preferably creates SIP invites issues other SIP signaling messages and facilitates transfer of media e.g. audio video between various end points. The communication gateways X1 X2 XN are preferably logical network elements of a SIP application and more preferably configured as back to back user agents b2bua for one or both of media and signaling control. A b2bua as would be readily understood by a person of ordinary skill in the art preferably operates between endpoints involved in a communication session e.g. a phone call video chat session or screen sharing session . The b2bua also divides a communication channel into at least two communication legs and mediates signaling between the involved endpoints from call establishment to termination. As such the communication gateway can facilitate switching the communication flow from flowing through a remote region to use remote resources to flowing just within the local region e.g. when establishing a call with another endpoint in the local region . The communication gateway may additionally include media processing components resources such as Dual tone Multi frequency DTMF detector media recorder text to speech TTS and or any suitable processor or service. The media processing and signaling components of a communication gateway may alternatively be divided into any suitable number of components or services in cooperative communication. In one variation the communication gateway is implemented by two distinct components a signaling gateway that handles the signaling and a media gateway that handles media processing and media communication. In an alternative embodiment the communication gateways may be configured as a control channel that functions to allow devices to directly communicate peer to peer. Browser clients mobile clients or any suitable combination of clients may have direct media communication in this variation. This alternative embodiment is preferably used with low latency media. As an additional security precaution communication gateways may be configured to allow traffic from only a distinct set of providers. Other providers are preferably firewalled off to protect infrastructure from the public Internet. The communication gateways will preferably respond to communications and or propagate the communication messages to a communication processing server. The communication processing server may be in a different remote region. Load balancers may additionally facilitate a communication propagating from a communication gateway to an optimal communication processing server. For example there may be multiple remote regions with available communication processing servers that can service a communication. A load balancer or alternatively a routing policy engine may direct the communication to an appropriate the region and or communication processing server.

The communication processing servers H1 H2 H3 function to process communication from a communication gateway. A communication processing server preferably provides value added features or services to a communication. A preferred communication processing server is preferably a call router or telephony application processing component as described in patent application Ser. No. 12 417 630 referenced and incorporated above. A communication processing server or more specifically a call router will preferably retrieve an addressable application resource e.g. HTTP URI address document associated with the phone number or communication indicator. In a preferred embodiment the resource is a telephony application that indicates sequential telephony commands for the communication session of the client s . The telephony commands may include instructions to call another communication endpoint to start a conference call to play audio to record audio or video to convert text to speech to transcribe audio to perform answering machine detection to send text or media messages e.g. SMS or MMS messages to collect DTMF key entry to end a call or perform any suitable action. The telephony instructions are preferably communicated in a telephony instruction markup language such as TwiML. The addressable resource is preferably hosted at the HTTP Server . The servers H1 H2 H3 and HTTP server communications are preferably RESTful in nature in both all directions. RESTful is understood in this document to describe a Representational State Transfer architecture as is known in the art. The RESTful HTTP requests are preferably stateless thus each message communicated from any component in the system preferably contains all necessary information for operation and or performance of the specified function. Signaling will preferably be transferred through the server but media may not be transferred through the server.

The communication processing server is preferably part of a telephony application platform and may cooperatively use several other resources in operation. The communication processing server may be a central component to the service provided by a platform and as such may be associated with considerable stateful data generated in use of the server. The stateful data may be used in internal logic and operation of the platform and or for providing API accessible data and information. The system is preferably implemented in a multi tenant environment where multiple accounts share operate with the same resources. As such there may be benefits in keeping the communication processing servers centrally located in a limited number of regions. Since the communication processing server may not be located in each local region a local region may call out bridge or otherwise communicate with a remote region that does hold a communication processing server. As mentioned above the communication processing server may provide any suitable processing services in addition to or as an alternative to the call router variation described above.

As shown in the preferred system can route communication traffic between User 1 and User 2 wherein the communications traffic can include any suitable media type device endpoint type and or network type usable in a suitable cloud based communications system of the type described above. In an example of the preferred system s operation when User 1 wants to communicate with User 2 a PTSN number that is part of the cloud based system his call is routed to provider P2. As described below the number dialed is preferably associated with a URL or other identifier usable in the aforementioned cloud communications system. Preferably provider P2 creates a corresponding invite request in block and sends it to a predefined server address e.g. europe.twilio.com us 1.twilio.com us 2.twilio.com etc. which in turn resolves to communication gateway X1. Upon receipt the communication gateway X1 preferably transmits or forwards the request to communication processing server H3 in block S which as shown can be located in the second region . The server H3 functions to query the HTTP server associated with the URL of the dialed number in block S to determine receive download and or capture any instructions commands or content associated with the dialed number. The HTTP server is preferably an outside server managed by a developer or administrating entity. In a simple example the server H3 contacts the HTTP server and receives a single command i.e. a dial verb associated with the number. Other suitable commands each of which can be referred to as a TwiML verb in the example embodiment can include saying text to the caller sending an SMS message playing an audio and or video file getting input from the keypad recording audio or video connecting the call to another phone or any other suitable type or media of communication.

As shown in in block S the HTTP server returns the TwiML to server H3 at which point the server H3 processes the TwiML to determine the particulars of the initial request i.e. to whom the call is directed where the other endpoint is located what type of media is being directed to the second user and the like. In the example embodiment shown in the second user is located in the first region with the first user and therefore the server H3 returns the invite request back to communication gateway X1 for further processing in block S. Upon receipt the communication gateway X1 determines that the inbound request is related to the prior invite request received in block S and transmits the request to a predetermined provider P3 in block S for eventual connection of the communication to the second user from P3. Preferably upon connection between provider P3 and the second user the communication traffic between the first and second users will flow directly between the providers P2 and P3 in block S with little to no input from any other component of the preferred system in the second region . In one variation of the preferred system media files and or functionality are stored at and or performed by one or more of the communication gateways X1 working alone or in combination with each other or additional servers databases and or controllers. As will be described in further detail below the communication traffic may be subsequently dynamically redirected to route through the server H3. For example one of the endpoints may hang up and the remaining endpoint may have communication traffic flow from the endpoint of P1 to X1 to H3 and back during the execution of other communication instructions.

As shown in one variation of the preferred system can additionally include a routing policy server in communication with the communication gateway XN and or a communication processing server H3 and further include a SIP API in communication with both the communication gateway and server HN . In one example configuration of the preferred system the communication gateway functions in part as a back to back user agent b2bua for one or both of media and signaling control. As an example the communication gateway can be configured to handle multiple types of re invite scenarios and to transfer audio video or other media between various communicating endpoints. Preferably the communication gateway can be configured to record audio or video streams and or play any suitable type of media file e.g. addressed to a URL . In other configurations of the preferred system the communication gateway can be configured as a real time transport protocol RTP hub for handling RTP communications RTP events and or generating consuming RTPC sender and receiver reports. As described below the RTPC reports can be transmitted and or made available to the policy server such that the policy server has real time or near real time information about the quality of different traffic routes in the larger system . The quality reports and the routing policy server can additionally work in cooperation with a best quality routing BQR routing approach. In another variation of the preferred system the communication gateway can be configured as a single component unit that handles both media and signaling processes. Alternatively the communication gateway can be configured as two distinct components media and signaling residing on one or more nodes in the larger system environment or in any other suitable configuration or deployment in a distributed network.

As shown in the present variation of the preferred system can include a routing policy server in communication with the communication processing server and or the communication gateway . The routing policy server preferably functions to optimize the flow of traffic throughout the preferred system by selecting and or aiding in selecting the best available communication gateway X1 X2 XN and or communication processing server H1 H2 for routing the network traffic. Preferably the routing policy server optimizes traffic flow in response to one or both of the types number location of the endpoints browser VOIP PSTN mobile cellular and the type of media voice video text multimedia used in each communication. As shown in the routing policy server preferably receives input s from each of the communication gateways for example in the form of RTCP sender and receiver reports which enables the routing policy server to determine in real time or near real time the current status of each of the communication gateways and in turn to select the optimal communication gateway for any present network session. Preferably one or both of the communication gateway and or the server can query the routing policy server for the optimal route which can be determined in response to one or more inputs received requested from the communication gateway . Additionally or alternatively the routing policy server can receive from each communication gateway a live quality of service report from which the policy server can determine the current optimal route for any pending sessions. In another variation of the preferred system the routing policy server can apply a universal or generic routing protocol between nodes without consideration of the type of media being enjoyed in the communication session. In use the preferred policy server can function to prevent overloading of any particular node server or route in the preferred system by continuously and substantially simultaneously selecting and or aiding in the selection of the optimally configured communication gateway and or server for each pending session.

Additionally or alternatively the system can include a registrar proxy and a location registrar service as shown in . The registrar proxy can be supplemental to the routing policy server be integrated into the routing policy server or used in place of the routing policy server. The registrar proxy and the location registrar service are preferably used to provide an interface to store update and accessing route records for different communication endpoints. The registrar proxy and the location registrar service are preferably used to store and keep updated routes for client application instances. They can additionally include phone number routing information SIP device routing information or any suitable form of routing information. The registrar proxy and the location registrar service preferably reside in main regions e.g. a region that contains a communication processing server . The registrar resources can alternatively be located in any suitable region regional border proxies can be configured with knowledge of location of the registrar resource so that the registration resources can be accessed regardless of where they are located. The registrar proxy can be a server that acts as the interface to the location registration information. The registrar proxy can additionally facilitate establishing media channels between appropriate endpoints. For example when attempting to connect two client application in a region remote from a communication processing server the registrar proxy can

As shown in the present variation of the preferred system can further include one or more application programming interfaces APIs functioning and or exposed by one or more components in the preferred system . For example a session initiation protocol SIP API is shown in for coordinating messages communications between the communication gateway and the server . Additionally or alternatively the routing policy server can include one or more APIs for determining the optimal route between two endpoints in the pending communication. A preferred routing policy server API can be a RESTFul or any suitable alternative type of API. As noted above in one alternative configuration the communication gateway can include a media portion and a signaling portion in which case the media portion not shown can include an API such as a REST or Java API to respond to media allocation requests from the signaling portion not shown of the communication gateway . In operation a suitable communication gateway API can expose one or more functionalities i.e. allocation of a media resource with the following capabilities and then return a resource identifier IP address and or port to where the media should be directed.

The SIP API can include one or more additional headers and or configurations for use in the preferred system including a regional header an action header a features header a support header and or a required header. In this example implementation the regional header can indicate a zone from which the request is originating including for example a regional or sub regional zone of Europe Asia North America and or South America. The example action header can include instructions for the receiver to perform one or more designated actions such as a hang up action. The example features header can include one or more system specific features such as an instruction to hang up if the user presses the star key on his or her terminal whether the hardware supports call recording and the like. The example support required headers can include information that identify any features protocols functions and or other features that are desirable optional or necessary for properly routing the session through any particular set of communication gateways and servers .

As shown in the system can additionally or alternatively include client gateways and regional border proxies in supported regions which function to support use of client application instances as communication endpoints. Client application instances additionally can rely on a registrar proxy and a location registrar service as described above. A client application is preferably defined as an IP connected communication device that is leveraging web based real time communication protocol. The client gateway is used to service media and signaling channels with the client application instances. The client gateways additionally translate client application communication protocols to those of the communication platform. In one implementation SIP is used internally within the communication platform and the client gateway translates between browser or application based communication to SIP. When communicating between client applications in the same region a media channel is preferably established between the two client applications through the client gateways. As latency can be less sensitive to latency the signaling channel can be maintained with a region with higher level functionality services e.g. the communication processing server . The regional border proxies preferably provide the media and signaling gateway between different regions. The regional border proxies can be configured to know the main regions and the route information to their respective regional border proxy.

The system preferably can be configured to perform one or more of the foregoing functions in a computer readable medium storing computer readable instructions. The instructions are preferably executed by computer executable components preferably integrated with the one or more communication gateways X1 X2 XN in the first region the one or more communication processing servers H1 H2 H3 HN in the second region the HTTP server the SIP API and or the routing policy server . The computer readable medium can be stored on any suitable computer readable media such as RAMs ROMs flash memory EEPROMs optical devices CD or DVD hard drives floppy drives or any suitable device. The computer executable component is preferably a processor but the instructions can alternatively or additionally be executed by any suitable dedicated hardware device.

As shown in a method of the preferred embodiment can include receiving a communication invitation of a first endpoint from a communication provider S signaling the communication invitation to a communication processing server in a second region S dynamically directing signaling and media of the communication according to communication processing instructions and the resources available in at least the first and second regions S that includes selectively routing media communication exclusively through communication resources of the first region if media resources to execute the processing instructions are available in the first region S and selectively routing media communication through at least the communication processing server if media resources are not in the first region S. The system functions to dynamically redirect traffic for signaling and media. The method is preferably employed in a regionally globally distributed communication platform that works with communication susceptible to latency performance issues. The method is preferably used within a communication processing platform such as the telephony platform incorporated by reference above. The method may additionally or alternatively be used with video communication client based audio communication e.g. VoIP screen sharing applications and or any suitable communication platform. Replicating all components in different regions can be expensive and increase complexity of a system. The method enables components to be intelligently and progressively rolled out to new regions or be statically implemented without fully replicating the system needed to support the features of a platform some components may be available in one region and some in others. Preferably a geographically distributed communication computing platform will include a subset of resources in a first region and a subset of resources in a second region. The subsets of resources are preferably not identical sets in terms of the function of the components . A local region used to service particular geographic regions is preferably a limited sub set of a remote region used to provide core platform functionality . Preferably lightweight and ancillary services and components e.g. signaling and standalone media processing services are deployed in various regions to support local communication endpoints and more core or complex resources e.g. ones that maintain state within the platform are deployed in a limited number of regions which are often remotely located from the local regions. The method is preferably used to implement communication instruction processing with a communication stream between the first and second region as shown in and when a media communication stream can flow exclusively through the first region dynamically establishing the communication flow to not flow through intermediary media resources of the second region but instead to use media resources of the first region as shown in .

Block S which includes receiving a communication invitation of a first endpoint from a communication provider functions to initiate a communication session. Preferably a call will be directed to the system through a provider service of the first region. The called destination is preferably registered with the system. For example the telephony endpoint the phone number phone number prefix SIP address the domain of the SIP address and the like is used to route communication to the system any suitable manner. The provider services preferably ports or provides a network access interface through which outside communication networks connect to the system and or conversely how the system connects to the outside communication networks . A communication will preferably include a call from an endpoint being directed through outside networking to a provider service interface. The provider service will preferably use SIP signaling or any suitable protocol to direct a communication stream to a communication gateway of the first region. A SIP communication invite is preferably received at the communication gateway or more specifically a SIP signaling gateway acting as a b2bua. Herein calls may refer to PSTN phone calls IP based video calls screen sharing sessions multimedia sessions and or any suitable synchronous media communication. Calls can additionally be mixed medium protocols. For example a call i.e. communication session may have one leg connect to a PSTN telephony device while a second leg connects to a Sip based client application. Calls may alternatively be initiated from within the system such as in response to an API request or any suitable event.

Block S which includes signaling the communication invitation to a communication processing server in a second region functions to direct the communication to a communication processing server in another region. The other region the second region is preferably spatially separate and remotely located from the first region. The distance of separation is preferably a globally significant distance. Within the US the distance may be greater than 2000 miles across country . Across the globe the distance may be greater than 5000 miles. The communication gateway preferably directs the communication signaling. As shown in the communication invitation is preferably a SIP invite but may alternatively be a communication invitation of any suitable protocol. The communication gateway may additionally query a routing policy engine prior to transmitting the communication invitation. The routing policy server will preferably determine an appropriate routing of the call. Preferably the routing policy server will identify the appropriate communication processing server in the second region. Additionally the routing policy server may consider communication processing servers in a plurality of regions possibly including the first region . In another variation the routing policy server may detect that the resources for processing the particular call can be handled within the first region and direct that call appropriately within the first region. For example a particular phone number may not be configured for telephony application processing and simply redirect to another endpoint accessible through the first region. In this example the communication gateway may forego accessing a call router in a second region and establish media communication flow between the first and second endpoint using resources of the first region.

The communication processing server can provide any suitable communication processing service. Preferably the communication processing server acts as a call router that manages execution of a communication session application. Processing a communication application can include operations such as connecting to endpoints recording media processing media converting text to speech transcribing audio to text transcoding between media codecs retrieving device inputs e.g. DTMF capture sending messages or emails ending calls providing answering machine detection or providing any suitable service. In one preferred variation the method may additionally include within the second region a communication processing server retrieving application instructions from an internet accessible server at a URI that is associated with a destination endpoint of the communication invitation. In this variation the communication processing server is preferably a call router as described in the incorporated patent application Ser. No. 12 417 630. The application instructions are preferably formatted as markup instructions within a document retrieved over HTTP using a web request response model.

Block S which includes dynamically directing signaling and media of the communication according to communication processing instructions and the resources available in at least the first and second regions functions to redirect communication to appropriate regions. The directing of signaling and media is preferably dynamically responsive to the active state of the communication. Preferably the signal and media direction is responsive to application state of a communication. Application state may include streaming media between two outside endpoints playing media from the system to an endpoint processing or recording media of a communication or any suitable application state. The communication routing is preferably changed to increase the communication performance of the current state of a communication. For example if a first endpoint is connected to a second endpoint and the first and second endpoints are in the same region the communication media stream is preferably kept within the first region. This can preferably reduce the amount of communication latency that might be involved in routing through a second region. In a contrasting situation if the communication of a first endpoint necessitates particular media processing not available in the first region a communication flow may be established with a second region. Additionally an application can be configured with any suitable logic. For example a call may be responsive to a new connection to an endpoint to one of two endpoints hanging up to initiating media processing e.g. audio recording transcription or DTMF detection or to sending an out of stream communication e.g. SMS or MMS and the like.

Block S which includes selectively routing media communication exclusively through communication resources of the first region if media resources to execute the processing instructions are available in the first region functions to route communication within a region. The resources of the region are preferably sufficient to support the current state of the communication session. In a preferred variation the media communication is exclusively routed through the communication resource of the first region for calls to other endpoints in the region. Block S preferably includes a communication processing server inviting a second gateway the second communication gateway inviting a second endpoint accessible through a provider service of the first region and the communication processing server re inviting the first and second communication gateways to establish media communication flow between the first and second endpoints. The communication is also directed away from the communication processing server of the second region. As a slight variation the media communication flow may even be established to flow directly between the first and second endpoints without passing through a gateway of the first region. The first and second endpoints can be PSTN based endpoints SIP based endpoints RTP based endpoints and or any suitable endpoint. An endpoint is preferably any addressable communication destination which may be a phone a client application e.g. desktop or mobile application an IP based device or any suitable communication device. The endpoints can use any suitable protocol and the first and second endpoints may additionally use different communication protocols or mediums.

Additionally or alternatively routing media communication exclusively through communication resources of the first region may include selecting a media resource of the first region to facilitate the media communication flow. In some cases select media resources may be deployed implemented in the first region. When the current communication media stream transitions to a state where it requires only the media resources of the first region the media communication flow will preferably utilize the media resources of the first region rather than those of the remotely located resources in the second region. For example an application may initiate a media recording instruction. If a recording resource is in the first region the communication gateway may direct communication flow to go to the local recording server as opposed to a recording server in a different region. In another example a media transcoding server may be accessed to transcode media for two endpoints. Two endpoints may use different media codecs that are not compatible. The transcoding service will preferably be added as an intermediary in the communication flow so that the media can be transcoded with low latency.

The method may include querying a routing policy service for a selected communication route which functions to dynamically select a communication route. The routing policy server can use the current state of the system individual regions individual resources services components of a region application state or any suitable parameter as an input. In one variation the routing policy service is substantially statically defined. A set of rules and or architecture configuration may be used to select the routes. In another variation the routing policy service performs an analysis and selects a route that has statistical indications to be an optimal route based on the analysis. The routing policy server is preferably queried by the communication processing server to select communication gateways. The routing policy server may additionally or alternatively be used by the communication gateway to select a communication processing server in block S. There may be one canonical routing policy server or multiple routing policy server instances may be established in multiple regions.

Block S which includes selectively routing media communication through at least the communication processing server if media resources are not in the first region functions to route communication between the first and second regions. This selective option is preferably taken when the resource needed or preferred for handling the communication session is not within the local region i.e. the first region . As with the initiation of a call the communication gateway preferably initially connects to a communication processing server. As was mentioned above this default behavior may not be taken if the next state of the communication is known without accessing the communication processing server. Additional resources within the second region may additionally or alternatively be used with the communication processing server. For example media resources such as recording service text to speech servers transcoding servers transcription speech recognition servers and or any suitable media resource may be implemented in the second region and may act on the media communication flow.

As mentioned above the directing of the communication can dynamically change. The method may additionally include re establishing communication with the communication processing server upon a second endpoint terminating the media communication flow S as shown in . Block S can function to enable the communication to recover after communication flow has moved away from a resource of the second region. As mentioned the second region preferably includes a communication processing server that can be configured for processing application state of a communication session. Since the communication processing server may not be in the communication flow when two endpoints are connected a communication gateway in the first region will preferably re invite a communication processing server and reestablish communication flow between the first endpoint and the communication processing server. For example two callers may be talking in a first region. When the callee hangs up the first caller may be connected to a call router in a second region that can play text to speech audio or perform any suitable application action. The communication flow can be redirected any number of times.

As shown in the method may additionally be expanded such that communication flow may be directed between any suitable number of regions. In an exemplary implementation there may be at least two base regions in the US with globally diversified local regions such as one in Europe one in Asia and one in South America. These regions may dynamically route communication based on an optimal or preferred route. The preferred route may be based on substantially static configuration of the different regions e.g. how many resources are in each region but may alternatively be based on quality metrics such as latency quality of service reports or any suitable metrics.

In an alternative embodiment a method of a preferred embodiment can additionally or alternatively utilize regional communication gateways to achieve global low latency platform operation.

As shown in one example implementation of the system and or method of the preferred embodiment can include a telephone call between a pair of PSTN telephone users. Those of skill in the art will readily appreciate that the following description is of an exemplary setting of the system and or method of the preferred embodiment and does not limit the claimed invention to any particular aspect or feature described below. As shown in method in block S can include receiving a call invitation at a first communication gateway X1 from a first user s POP point of presence provider or in other words a provider server . As noted above illustrates a single use case in which the desired communication is between two PSTN users. Accordingly the content of block S can include an invitation for a voice call identifying both the media voice as well as the desired endpoint phone number to which the call is directed .

In block S the first communication gateway preferably performs any necessary authentications security checks verifications and or credential checks for one or both of the caller and the recipient. Block S can additionally include looking up and or identifying a target uniform resource identifier URI for the invitation which designates the next destination for the transmission i.e. the suitable regional communication processing server H1 for the request. As shown in upon receipt of the request at the server H1 the server H1 responds to the communication gateway X1 which in turn propagates the response back to the POP point of presence service e.g. the provider service in block S.

In block S the server H1 downloads and or retrieves the TwiML based on the URI associated with the dialed number which corresponds to an address in one variation of the preferred system and method . Preferably block S can further include determining if there is any media associated with the session. Preferably the existence or requirement of a particular media can be determined with reference to the TwiML which can contain predefined actions or verbs. Suitable actions or verbs can include dialing a number saying text to the caller sending an SMS message playing an audio or video file getting input from the keypad recording audio or video connecting the call to another browser client or device or any other suitable type or media of communication. In the example implementation the TwiML would contain the dial verb which requires media. Following a series of mutual acknowledgements the transmission of media is opened up between the POP and the server H1 in block S.

As shown in the example implementation can include block s which includes determining an optimal route for the media at the routing policy server. Preferably block S is performed substantially simultaneously with the series of acknowledgements performed in block S. Preferably the policy server optimizes traffic flow in response to one or both of the types number location of the endpoints browser VOIP PSTN mobile cellular and the type of media voice video text multimedia used in each communication. As noted above the routing policy server preferably receives input s from one or both of the communication gateways X1 or X2 for example in the form of RTCP sender and receiver reports which enables the routing policy server to determine in real time or near real time the current status of each of the communication gateways X1 and X2 and in turn to select an optimal communication gateway X2 for the proposed call. Here optimal is used to indicate an algorithmically probable best route. As shown in the server H1 requests the optimal route from the policy server in block S. Additionally or alternatively the routing policy server can receive from each communication gateway XN a live quality of service report from which the policy server can determine the current optimal route for any pending sessions.

As shown in once the policy server determines the optimal route i.e. a second communication gateway X2 it will return the appropriate URI to the server H1 so that the server H1 can communicate directly with the second communication gateway X2. In block S the example implementation can include a series of requests invites and acknowledgements between the server H1 the second communication gateway X2 and the second POP destination of the call recipient. Upon establishing the second leg of the communication session block S can include checking the two endpoints via first and second communication gateways X1 and X2 and then permitting media to flow between the first and second communication gateways X1 and X2 in block S.

Preferably the server H1 is not involved in the media flow of block S. Accordingly another example implementation can include detecting at each of the first and second communication gateways X1 and X2 whether each respective side of the session has timed out for some reason. In response to a timeout at the first communication gateway X1 the first communication gateway X1 will alert the server H1 which in turn will hang up both the caller side and the callee side of the session. Alternatively if it is the second communication gateway X2 that times out then the server H1 can be configured to only terminate or hang up on the callee side in the event that there are more actions or verbs to execute on the caller side.

The foregoing example implementation illustrates one aspect of the preferred system and method using a single dial verb between two PSTN users in a telephony system. However the preferred system and method can be readily configured for any suitable combination of verbs user types and media types found in a cloud based communication network system. Some example alternative implementations can include usage of the say verb the hang up verb the gather verb either alone or in combination with the dial verb described above.

As shown in a second exemplary implementation of the system and or method of the preferred embodiment can include video streaming between two mobile devices. In this example client mobile or browser devices may connect directly to communication gateways X1 and X2. This variation functions in a substantially similar manner to the above example but may vary in communication medium protocols and user devices. In this variation block S may include receiving a video invitation at a first communication gateway X1 from a mobile device. Alternatively a video invitation may be received at a first communication gateway X1 from a POP. Blocks S S S S S and S are substantially similar to steps S S S S S and S except in implementation differences accommodating for video streaming and direct connection of the mobile devices to the communication gateways. These blocks preferably establish two legs of a communication session such that video can flow between the first and second mobile device in block S.

As shown in a third exemplary implementation of the system and or method of the preferred embodiment can accommodate a dial followed by a text to speech command. This is preferably an extension of method above where a user handing up re invites between the communication processing server and the communication gateway can occur multiple times throughout the lifetime of a call. A communication will preferably be initialized as described above so that media communication flows between two endpoints of a first region. One of the endpoints hangs up causing a SIP BYE signal to be sent to a second communication gateway X2 . X2 then propagates the BYE to the communication processing server H1 in the second region. The H1 in this scenario will evaluate the application instructions. If more instructions exist within the application then the H1 can re invite the first endpoint to bring media communication flow back to the H1 The H1 re invites the first communication gateway X1 a 200 OK reply is received an acknowledgement signal is delivered and media communication will once again flow between X1 and H1. In this variation the next communication instruction is to play text to speech audio. The H1 will preferably call out to a TTS service to download or access the audio and then the H1 will stream the media to the X1 and the X1 will stream the media to the first endpoint. In an alternative version the H1 may instruct the X1 to perform the TTS operations or to use a TTS service of the first region.

As shown in a fourth exemplary implementation of the system and or method of the preferred embodiment can accommodate a say followed by a dial. A caller form a first region dials in and is invited to a H1 via a communication gateway X1 as in the initial portion of method . Once the call has been established the H1 preferably downloads or accesses the communication platform with the communication instructions. In this particular example the instructions include a say instruction followed by a dial instruction. The H1 will contact a TTS server and play the media. After the media of the TTS has completed the H1 will preferably continue to execute the communication instructions and will thus execute the dial instruction. If the dial instruction is to an endpoint in the first region the second endpoint will be added to the communication flow in a manner similar to that in .

As shown in a fifth exemplary implementation of the system and or method of the preferred embodiment can accommodate hanging up a call on a detected input. In this example the detected input will be the DTMF input of a star . A user presses star when they are ready to end a call. An RTP event is sent to the provider service which is then delivered to X1. X1 will initiate a hang up of the other party. To hang up a re invite signal is sent to the H1 with an action header that asks the communication processing service to hang up the other side. The H1 then issues a BYE sequence to the second endpoint through the X2 and continues executing any remaining application instructions. In an alternative implementation shown in X1 delivers the RTP event to X2 which initiates the hang up process. X2 signals the end of the call and ends communication with the H1. H1 will then re invite X1 or hang up depending on the state of the communication platform.

A sixth exemplary implementation of the system and or method of the preferred embodiment can accommodate timeout scenarios on the caller or callee side. Each communication gateway is preferably responsible for detecting timeouts for their respective leg of the communication. As shown in the caller side X1 may detect a timeout scenario when the caller endpoint stops sending RTP for a configurable amount of time. X1 then signals the H1 to notify that a timeout has occurred. The H1 will preferably hang up terminate the caller side and the callee side. The BYE signal preferably includes a header that specifies the reason for the termination e.g. an RTP timeout . As shown in the callee side X2 may detect a timeout scenario when the callee endpoint stops sending RTP for a configurable amount of time. X2 signals the error to the H1 and the communication flow is terminated for the callee. As there may still be application instructions that can execute for the caller the H1 preferably executes any remaining instructions or alternatively terminates communication with the caller.

One or more aspects of the example embodiment can be configured partially or entirely in a computer readable medium storing computer readable instructions. The instructions are preferably executed by computer executable components preferably integrated with one or more APIs servers routing policy servers POP servers and or communication gateways. The computer readable medium can be stored on any suitable computer readable media such as RAMs ROMs flash memory EEPROMs optical devices CD or DVD hard drives floppy drives or any suitable device. The computer executable component is preferably a processor but the instructions can alternatively or additionally be executed by any suitable dedicated hardware device.

As shown in a system for processing communication media in a regionally distributed communication platform of a preferred embodiment functions to enable communication media services within a local region. When deploying a communication platform across geographically diverse regions some services can benefit by having low latency interactions with real time synchronous communication. In addition to providing the media services with low latency the system enables a platform to provide consistent data across the platform. This is beneficial for maintaining consistent API resources. For example recordings generated in local regions will be available through an API. The method is preferably used in combination with the system and methods described above. The system preferably includes the elements described above for at least two regions. A first region a local region preferably includes a plurality of provider services communication gateways and supplemental media services. The second region the remote region preferably includes at least a communication processing server and any additional resources services or components. The remote region preferably includes more resources and services. For example API resources are preferably stored and maintained in the remote region.

The system and method can be used with any suitable media resource or resources that may benefit from being deployed to local regions. The media resources are preferably configured as a media services. A media service can be easily deployed in a local region and operate independently and consistently integrate with other regions such as the remote region where API resources and state is maintained. A media service preferably has a defined interface and manages its own high availability load balancing scalability redundancy and other service oriented orchestration considerations. Storage and state can preferably be maintained internally within the media service. For example a database used to manage the service orchestration of the media service can be kept internally and may at least in part not be shared outside of the service. Information records and data that is to be shared outside of a media service is preferably distributed across regions for other services to consume. The media service may include a media service API to facilitate access and integration of the media service with other services and components of a communication platform. Media services are preferably composed of components or computing resources. The components can be software libraries or other services e.g. a mini service . The components preferably perform a specific task. Some of these components which facilitate a particular feature of a service may or may not be activated or included in a locally deployed media service. For example for a recording service transcription may or may not be an included component. Multiple media services may be implemented within a local region and the media services may target a variety of communication functions. A media service may be a recording service a text to speech TTS service a speech recognition service a transcoding service an input detection service answering machine detection service a conferencing service a communication queuing service and or any suitable media service.

Recording services preferably enable recording of calls or communication sessions that are routed through communication gateways within the local region. This avoids routing media communication flow through a remote region to access a recording resource. Recording is preferably for audio recording but may additionally or alternatively include video recording screen sharing recording multimedia recording or any suitable recording service. The recording service may have additional features that may or may not be integrated into the recording service of the local service. Transcription is one preferred feature of the recording service. Transcription may use algorithmic speech recognition techniques automated manual transcription semi automated techniques and or any suitable approach. The audio recording files the meta data of the recording e.g. timestamp time duration audio quality and format and or the recording transcripts are preferably synchronized with a remote region. As shown in a recording service preferably includes a recording component a transcription component and at least a storage component. The recording service additionally includes communication interfaces with a communication processing server e.g. a call router API and the resources of one ore more regions.

The recording component is preferably responsible for taking a stream audio video etc. manipulating the stream e.g. trimming off silence transcoding it to a different format codec etc. and writing the recording to a file. Inputs for the recording component may include the audio stream the file name and or arguments for trimming file format recording quality volume adjustment and or any suitable parameter of the recording. Outputs of the recording component preferably include an audio stream saved as a file meta data such as the duration of the saved audio file and size of the file. The transcription component can include inputs such as the audio stream transcription arguments an HTTP callback to call when transcription is complete and or any suitable parameter. The transcription arguments may include the accuracy level of the transcription e.g. level of service language of transcription and or any suitable variable of the transcription process. The transcription component preferably outputs the text of the stream. An interface of the recording service preferably abstracts away the inner workings of the components of the recording service. The interface of the recording service uses inputs of a recording ID an audio stream to record and or a HTTP callback to call after complete. In one variation the HTTP callback is called after transcoding of the recorded file is complete. Other inputs and parameters may additionally or alternatively be exposed of the recording service. Additional inputs may include transcription inputs such as if a recording should use transcription and the parameters of the transcription. The recording service interface preferably outputs a URI or alternative resources address of a recording parameters of the recording e.g. duration of the recording timestamp and or file parameters such as file size.

A Text to speech service preferably generates plays and or converts text into audible speech. The audible speech is then played within a communication stream. For example a phone call may connect to a telephony application that specifies a script that should be read to the caller. The script is preferably directed to the TTS service to be played during the phone call. The text to speech services are preferably for audio communication. However a computer generated video simulation or rendering of a speaker may additionally be created for video communication. The text to speech service preferably takes text as an input and outputs an audio stream and or an audio file as an output. The audio file may be cached internally within a local region implementation of a media service. The audio file of a TTS request may additionally be synchronized with a TTS cache of a remote region.

A speech recognition service is preferably a service used in collecting spoken input and converting it into a format for transcription natural language processing or interpretation of responses. The speech recognition may use the transcription component described above but may alternatively use an alternative approach. The input to the speech recognition is preferably an audio stream and parameters of speech recognition. Parameters of speech recognition may include expected language of speech. In one variation the speech recognition service is used to detect or identify categories of responses. For example the speech recognition may be used to identify a number with a set number of digits to identify particular key words or classes of responses. In one example classes of responses may include a confirmation class and a cancel deny response. The output may be the interpretation of the speech. In one variation an HTTP callback may be specified where the output may be posted after speech recognition is completed. In another variation the speech recognition service may work in cooperation with the recording service. Alternatively a speech recognition component may be integrated into the recording service an input detection service and or any suitable service.

A transcoding service functions to convert between formats. The transcoding may convert an active media stream to another format. For example a call with two endpoints may natively use two different codecs. The transcoding service may convert one or two of the legs of the communication to a common or compatible media stream format. Additionally the transcoding service may work to convert accessed media resources that are or will be used in a communication session. For example an MP3 file accessed from a URI may be converted to a wave file for playback during a phone call. The transcoding service preferably accepts a media stream in a first format and outputs a media stream in a second format. The transcoding preferably is used on communication that flows within the local region. The transcoding service may additionally be used if communication flows between two different local regions as opposed to including a third remote region just for the transcoding service .

An input detection service functions to gather inputs of a communication device. Preferably the input detection service collects DTMF inputs from a user. In the DTMF input detection variation an audio stream and parameters of detection are preferably an input to the service. Parameters of DTMF detection can include timeout a key to finish detection on number of digits a callback URI to call after input is captured and or any suitable input. As an additional service an answering machine detection service may be used to identify an answering machine. The components of an answering machine detection service may alternatively be integrated into the input detection service or any suitable service.

Conferencing services preferably facilitate calls with more than two endpoints connected. Various features of conference calls may be enabled through components of conferencing services. Additionally a conferencing service may generate accessible API resources that can be used by applications to programmatically query and modify aspects of in progress or past conference calls. The API resources are preferably streamed or transmitted to a remote region where consistent representations of API resources are managed for a platform. This preferably functions to make API resources to be regionally globally consistent despite media services handling communication processing within a local region. For example a conference call may be in progress in Europe. The communication is preferably routed between multiple European endpoints possible communication gateways facilitating the signaling and a conferencing service in the European region. Data for conference call API resources is preferably communicated back to a remote region that is used in managing the API resources. Now if an application anywhere in the world queries for the in progress conferencing resource and modifies the resource that occurs on a platform consistent version of the API resource. The synchronous communication preferably avoids increased latency that may occur if the communication was routed to a remote region to a conferencing service but the API resources used to programmatically interact with the conference call are maintained consistent in the platform.

A communication queuing service functions manage phone queues or in other words communication holding lines. Similar to the conference call above API resources for querying and managing a call queue may be accessible within the platform. The data to support such API resources is preferably synchronized with the platform services and components in a remote region.

As mentioned above any suitable services may be implemented within a local region. The media services used within a local region depend on the use case of the communication platform. While any of the above media services or suitable alternative media services may used the below method primarily uses a recording service as an exemplary media service but any suitable media service may additionally or alternatively be used.

As shown in a service for processing communication media in a global of a preferred embodiment can include providing a communication processing platform with components of at least two regions S routing communication to at least one media service of the local region S tunneling a media stream to the remote region S and storing the data of the media service S. The method functions to enable communication media services within a local region. When deploying a communication platform across geographically diverse regions some services can benefit by having low latency interactions with real time synchronous communication. In addition to providing the media services with low latency the method enables a platform to provide consistent data across the platform. This is beneficial for maintaining consistent API resources. For example recordings generated in local regions will be available through a global API. The method is preferably used in combination with the system and methods described above.

Block S which includes providing a communication processing platform with components of at least two regions functions to dynamically direct communication traffic between two regions. The provided communication processing platform is preferably substantially similar to the system and methods described above. Communication can preferably be routed within a local region if resources are available in that region or communication can be routed between at least a local and remote region to use the resources used during a communication session. Providing communication processing platform may include initializing signaling and media communication flow as described above. The subsequent steps below are preferably used in the context where the media communication flow is established within a local region. In other words media communication flow is from at least one endpoint through a provider service of a first region and to at least a communication gateway. A one legged variation where only one outside endpoint is connected preferably uses at least one media resource to act as the other endpoint e.g. play audio and or collect input . Other variations preferably involve a communication session having at least two outside endpoints connected. The communication route preferably is from a first endpoint through a provider service to a first communication gateway to a second communication gateway and then through a provider service to the second endpoint. Any suitable number of endpoints may additionally be connected. Additionally communication is additionally routed to a media service as described below in Block S.

Block S which includes routing communication to at least one media service of the local region functions to incorporate a media service with active communication. The media service may also be provided by a remote service as well as a local region. A benefit of using the media service of the local region is that latency issues quality of service and other issues may be avoided by containing communication flow within a local region. A media service is preferably activated by a communication processing server e.g. a call router of a remote region deciding that a media process should be used. The communication processing server preferably signals to the communication gateway of the local region to inform the communication gateway that it should use activate or enable the media service. Preferably the signal is sent through a SIP control channel using SIP INFO. Additionally some record within the remote region may initially be created by the communication processing server. The record may be used in creation of an API resource or for internal logic of the remote region. The record is preferably stored in a database or some other suitable storage mechanism. In initializing the record some information such as a resource ID or secure ID may be automatically generated before a media service is notified. Record information such as account information media resource ID and other instructions may be included in the signal communication to the communication gateway in the local region. For example if a call router encounters an instruction to record audio. The call router preferably creates a recording resource in the remote region transmits a SIP INFO signal to a communication gateway managing the endpoint in a remote region wherein the SIP INFO also includes recording instructions the resource ID and account information.

The communication gateway preferably activates the media resource by connecting the communication stream to the media service. Depending on the type and use case of the media service the media service may be an intermediary service a side service or an endpoint service. As an intermediary service the media communication flow passes through the media service. This may include a transformation of the media stream between different legs of the communication. For example a transcoding service may convert the communication stream to a common compatible media format. A side service is preferably an ancillary service that has a communication stream pushed to the media service. The media service may be passively observing the communication stream such as in the case of a recording service. The media service may alternatively actively interact with the communication stream such as if an input service signals the communication gateway that an input event was detected. The media service may additionally be a communicating endpoint of the communication session. For example a media service for playing audio files and or performing speech recognition may act as one leg of a phone call. In the case of a recording service the two streams of a media communication are preferably merged and pushed to the recording resource over HTTP. The stream is additionally stored in local disc of the local region. The local disc storage functions as a backup in case of failure. In one variation the media service of the local region is implemented as a static proxy of the media service and the media stream is tunneled from the static proxy to a service proxy and media service of a remote region as shown in . A static proxy of a media service may provide temporary storage or processing capabilities. Long terms data and more complicated asynchronous processing of a media service may be kept within remote regions. The static proxy preferably runs a server mode tunnel service e.g. stunnel and a load balancing service.

Block S which includes tunneling a media stream to the remote region functions to transfer data for persistent storage in the remote region. Tunneling to the remote region is preferably used to update records in the remote region. There may be several ways to accomplish this. A first variation include tunneling of a media stream may include establishing VPN proxies that function to get around firewalls. A firewall for HTTP is preferably opened to enable servers of the local region push media streams to media services of the remote region. As described above service proxy servers may be implemented within the remote region to receive incoming SSL encrypted connections from local regions terminate the SSL and forward requests to an appropriate media service of the remote region. Another variation may include cutting database dependence of a media service and promoting a resource of the remote region to update the database. Data generated in the media service is preferably streamed from the local region to the remote region. In one variation an existing SIP channel may be used as the signaling and media channel for streaming media to the remote region. Special handling of SIP failures or media processing failures may used to ensure updating of the database. Another variation would be to open up firewalls for the databases with records used by a media service. Measures are preferably with the communication link between the regions to avoid a security risk of opening up firewalls for the databases.

Block S which includes storing the data of the media service functions to store the data of the media service in a consistent and accessible manner. The data is preferably stored within a remote region that is used at least in part as a core central or main sub system of the platform. The remote region will preferably be a region where at least part of state data of the platform is kept. There may need to be numerous local regions deployed to service different geographic regions. However replicating and making the data consistent across each region increases complexity and cost of the platform. A subset of the regions possibly even one or two regions is preferably used as the central region where persistent data is stored. The persistent data may be used within logic of the platform or alternatively used as accessible resources available through an API user interface or other suitable interface. Once the data from the media service of the local region has completed the communication processing server will preferably signal back to the local region over the signaling control channel to stop the recording. Alternatively a media service in may signal to the communication gateway which may contact a component of the remote region to indicate that the storing of the persistent data is complete. While storing of persistent data is used for some media services some media services may not generate persistent data that requires storing outside of the local region.

As shown in an implementation of the method may include media communication being established within a local region as described above. A call router of a remote region may determine that a call should be recorded. To initiate recording the call router creates a new recording record in a database and uses SIP as a control channel to send a SIP INFO signal to a communication gateway in the local region. The SIP INFO preferably includes information of a recording request such as the account name and recording record secure ID. The communication gateway then merges streams of an active call within the first region and pushes the merged media stream over HTTP. A temporary or cached version of the recording may be stored locally. A static proxy component preferably uses the host header and pushes the stream to a service proxy. The service proxy is preferably configured to listen for changes in platform orchestration to determine the load balancing and media resources available.

As shown in a method of the preferred embodiment can include registering a set of client application routes S receiving a communication invitation of a first endpoint from a client application in a first region S processing a set of communication instructions associated with the communication invitation and identifying a set of communication resources S querying registered routes of endpoints specified in communication processing instructions S dynamically directing signaling and media of the communication according to communication processing instructions and the resources available in at least the first and second regions S. Dynamically directing signaling and media of the communication can include selectively negotiating or otherwise establishing different routing scenarios. In one variation S can include selectively routing media communication exclusively through communication resources of the first region if media resources to execute the processing instructions are available in the first region S and selectively routing media communication through at least the communication processing server if media resources are not in the first region S. As the method is preferably applied to client applications media and optionally signaling can be negotiated to run through a path outside of the platform to be a substantially peer to peer media path P2P . The method functions to dynamically redirect traffic for signaling and media across multiple regions. In one preferred variation the method is used within a platform with a communication processing service wherein the method includes signaling the communication invitation to a communication processing server in a second region S. In this variation the initial state of a communication session may initialize by accessing a communication processing server of a central region and then appropriately re negotiate a media path that factors in regional resource availability and requirements. In another variation the initial state of a communication session starts with resource capacity scoped to the regions of the involved endpoints and then elevates to include other regions if additional communication processing resources are required for a particular communication session. The method is preferably employed in a regionally globally distributed communication platform that works with communication susceptible to latency performance issues. The method can additionally be applied to handling multiple client application instances to providing data insight into the client applications participating in the communications exposing policy to apply targeted control over how media and signaling network topologies are established across different regions.

The method is preferably substantially similar to the one described above. Blocks S S S and S can be substantially similar to those described in blocks S S S S but method Shoo is preferably applied to at least one leg of communication involving a client application. The method can be used for performing low latency routing for a client application communicating with a second client application with a media service with a PSTN or other suitable endpoint or communicating with any suitable endpoint. The method can additionally or alternatively be used with any suitable variations including the system and method variations described herein. Furthermore the methods and systems for client communication can include any of the variations of media path variations such as those described in the system and method of U.S. patent application Ser. No. 14 278 993 filed 12 May 2014 which is hereby incorporated in its entirety by this reference.

The method is preferably used to implement communication instruction processing with a communication stream between the first and second region and when a media communication stream can flow exclusively through the first region dynamically establishing the communication flow to not flow through intermediary media resources of the second region but instead to use media resources of the first region. For example the method is preferably applied when a client application calls a communication application endpoint in a first region the relevant application is processed and the communication application connects the calling client application to a second client application while localizing media flow within the region of the first and second client applications. The method is preferably implemented through a system that preferably includes client gateways and at least one regional border proxies that reside in each supported region and a communication processing server a registrar proxy and a location registrar service.

Block S which includes registering client application endpoint routes functions to create a record of client application locations. A client application endpoint route is preferably registered when a client application associated with a particular endpoint comes online e.g. becomes active on the communication platform when the client application changes location routes or needs to update route information. The set of client application endpoint routes can include registering at least one instance of a client gateway route for a registered endpoint within the platform. The set of client application endpoint routes can include registration of multiple edge resources e.g. client gateways distributed across multiple regions. In the scenario where one endpoint will communication with a second endpoint the method includes at least registering first and second client gateway route of a first and second endpoint. The first and second client gateway routes can be in the same or different regions. A client application in a first region will preferably establish a media and signaling connection with a client gateway of a local region. DNS or other mechanisms can be employed to direct a client application to an appropriate client gateway. The client application may connect to the client gateway through a load balancer.

The client gateway can then use a system wide signaling protocol such as SIP to negotiate communication at the appropriate time. The client gateway will preferably communicate with a regional border proxy in interacting with platform resources outside of the local region. The regional border proxy uses internal configuration to communicate with a regional border proxy of a main region. The route information to access the client application can then be stored in the main region. A location registrar service preferably facilitates receiving route information and recording registering the client application route. The location registrar service is preferably hosted or operable within a main region. The main region is preferably a region that includes a communication processing server. The communication processing server preferably maintains state of execution of a communication application and can be more expensive from an operational cost infrastructure complexity and or feasibility perspective to duplicate in every region. Registering the client application route in a centralized location registrar service allows active client applications managed in various infrastructure regions to be integrated into a global communication platform. Route information additionally includes a client destination endpoint identifier that can be used to query and identify the client application as an endpoint.

Client applications in different regions preferably register routes such that for any valid endpoint identifier a route can be provided. Additionally the location registrar can maintain the state of endpoints. State of an endpoint can include active offline idle away or any suitable status. Additionally a client application endpoint can be registered for multiple instances. The method will include registering multiple instances of client application endpoint routes for an endpoint. The different instances can be registered with different route information. For example a user can activate a native application on a mobile device at the same time the user has the same account activated on a browser of a different computing device. When multiple instances are registered dynamically directing signaling and media of the communication S can include selecting a client application endpoint instance of the second endpoint according to an instance prioritization policy which functions to select an appropriate instance for use with a given communication. The instance prioritization policy can depend on prioritizing media path performance e.g. minimizing latency increasing call quality minimizing call cost etc. prioritizing user preference of a client application instance e.g. user history of instance activity defined rules of where to call first etc. or other suitable ways of differentiating between multiple instances. For example a call directed at the client application endpoint can initiate parallel calls to both instances and the first one to respond gets connected. Similarly a presence server can be used to dynamically select a preferred instance to receive a call inbound to the endpoint. While the method describes a process to connect a first client application in a first region with a second client application also in the first region the approach of the method can be generalized to apply to connecting client applications or any type of endpoint in the same or different region.

Block S which includes receiving a communication invitation of a first endpoint from a client application in a first region functions to have a client application initialize a call or communication session. The client application preferably uses a real time communication protocol to establish signaling and media channels through a client gateway. The client gateway is preferably a local client gateway in the same region as the device of the client application. Route optimizing DNS can be employed or leveraged to select an appropriate client gateway.

In a first variation of a first region receiving a communication invitation of a client application in a first region can include receiving a connection request from a first client application verifying at least one parameter of the communication request merging the real time communication of the client with real time communication of a communication destination e.g. the communication processing server . Establishing a connecting between the client application and the gateway is preferably substantially similar to the client described in U.S. patent application Ser. No. 14 054 254 filed 15 Oct. 2013 which is hereby incorporated in its entirety by this reference.

In a second variation of a main region the communication invitation of the first endpoint is received at the communication processing server. The communication invitation can include registered route information from the client application in a first region. The communication invitation is preferably received through the regional border proxy of the main region.

Block S which includes processing a set of communication instructions associated with the communication invitation and identifying a set of communication resources functions to process how the communication invitation should be processed. In one preferred variation the processing of communication instructions is performed at the communication processing server upon the signaling the communication invitation to the communication processing server S. A preferred scenario would have the first client gateway of the first endpoint in a region that is distinct from the region of the communication processing server the signaling at least has to initially span to at least a second region. In another variation the communication invitation may include data that conveys communication instructions. For example the communication invitation may specify a client endpoint to connect to. Processing a set of communication instructions is preferably mapped to at least a subset of the communication processing resources. The subset of communication processing resources includes signaling and or media resources requested to act on the communication session. The communication processing resources can include a communication application processor a media recording service a transcoding service a text to speech service a transcription service or any suitable service and or any suitable type of communication processing service.

Block S which includes querying registered routes of endpoints specified in communication processing instructions functions to determine a location of a specified destination endpoint. A registrar proxy server is preferably operated within the main region where the communication processing server is located. The registrar proxy server communicates an identifier of the intended destination communication endpoint. The identifier is preferably a name or number that is used to address or specify the intended communication destination. The identifier can be used to access an associated route if an instance of a client application is active for that identifier. As mentioned before multiple instances of a client application can be simultaneously active. Multiple routes can be selected. Alternatively a route or routes can be selected according to a suitable heuristic such as application instance prioritization user preference location usage history presence information or any suitable type of heuristic. Querying registered routes preferably resolves by identifying at least one regional route of a second endpoint. The second endpoint is preferably a communication destination to which the first endpoint will be connected. The route is preferably used in block S to establish a media channel between the original communication endpoint and the destination communication endpoint. The media channel preferably short circuits use of extraneous resources such as a communication processing server which can result in a media channel passing through the main region when not required.

Block S which includes dynamically directing signaling and media of the communication according to the regional availability of the communication resources the client application route of the first endpoint and the client gateway route of the second endpoint functions to interpret the communication processing instructions into negotiated signaling and media to appropriately use the resources available in at least regions of the platform. In block S an application is preferably processed and executed for the connected client application. Instructions of the application can direct various actions. One type of action is performing media related action between a service of the platform and the connected endpoint e.g. a caller connected to an automated phone service . Other types of actions can connect at least two communication endpoints. When an instruction depends on the platform providing a media service the signaling and media is routed appropriately between regions to provide the media service. For example TTS instructions can be executed that direct execution of a media action facilitated from a service. In such a state the media channel can be routed through the first region and a TTS media service in the main region. Signaling and media communication can alternatively be routed in any suitable manner depending on the availability of media services in a region. When an application instruction directs connecting a communication endpoint with a second communication endpoint the signaling and media channels are directed to take a preferred path through the regions.

Block S can result in various signaling and media routing scenarios. The selected scenario preferably depends on required and or requested communication resources e.g. media resources and or signaling resources and the region location of the client gateway instances to be used for involved endpoints. The signaling can be setup with a topology that differs from the media as shown in . The media path can have a greater impact on user experience and in one variation only the media path is considered in the dynamic directing. At least three different modes of media routing can be achieved which can include different variations and sub combinations. The set of communication processing resources will preferably include a non empty set of media processing resources that operate as intermediary nodes in a media path of the communication. Block S will negotiate a media path that satisfies a routing policy for a media topology that includes the client application of the first endpoint the client application of the second endpoint and at least the media processing resources. In one variation the negotiated media path will preferably satisfy a routing policy for a media topology that minimizes number of regions. In another variation it is the latency media stream quality internal cost of streaming media customer cost of streaming media or any suitable metric or metrics that can be used in selecting a path. In one variation a routing policy can be customized and set as described below.

A first mode of signaling and media direction can be multi regional routing where media spans multiple regions to access communication processing resources and or client gateway instances. In a first variation the multi regional routing is used to access communication processing resources not available in a region of an involved endpoint. In particular in a communication application platform one type of communication processing server may be exclusive to a central region or regions and block S can include routing media communication through at least the communication processing server if media resources are not in the first region S as shown in the exemplary media topologies of . In another variation the endpoints may be in different regions and in yet another variation a communication processing server may be in a region other than a central region but also not in the region of an involved client gateway instance such as in the exemplary topology shown in . A second mode of signaling and media direction can be a local routing wherein media is kept within a single region and short circuits a path through other regions as shown in the exemplary media topologies of . More specifically a local routing mode can include routing media communication exclusively through communication resources of the first region when the set of communications resources to execute the communication instructions are available in the first region S. A local routing mode preferably depends on the involved endpoints of a communication to be connected through a client gateway instance in the same region what resources are mapped to the instructions for the communication session and then the signaling and media is routed appropriately between regions to integrate the communication processing resources into the media path. For example the regional route of the destination endpoint is in the first region of the calling endpoint. In yet a third mode dynamically directing signaling and media of the communication can include establishing P2P connection which can be an option when both the client application endpoints are in a networking context that allows P2P media paths and where there are no communication processing resources required from the platform as shown in . In one variation a communication processing resource may be delegated to one of the client applications. This P2P mode can include negotiating a peer to peer media path between the first endpoint and the second endpoint as shown in . Other suitable media topologies can additionally be established such as branches to outside resources as shown in exemplary media topologies of . Additionally an arbitrary number of endpoints can be handled wherein different branches of each media path can be selected independently or as a whole as shown in the exemplary media topology of .

Block S which includes selectively routing media communication exclusively through communication resources of the first region when media resources to execute the processing instructions are available in the first region functions to isolate media channel communication to relevant regions. The destination communication endpoint can be in any suitable region relative to the original communication endpoint. A general approach selectively routing media communication exclusively through communication resources of the first region includes establishing inviting or re inviting the original communication endpoint to communicate with the destination communication endpoint through a media channel that passes between the application original client application a first client gateway a second client gateway and the destination communication. In a first exemplary scenario the original client application and the destination communication endpoint are both in the first region. In a second exemplary scenario the original client application is in the first region the destination endpoint is in a second region and the first region and the second region are different from the main region with the communication processing server. In the first and second exemplary scenarios the media signaling can short circuit hop or otherwise avoid routing through the main region. In a third exemplary scenario the destination communication endpoint is in the main region. In such an exemplary scenario the media channel can route through the communication processing server or alternatively route around the communication processing server.

The registrar proxy can facilitate establishing the media channel. The registrar can use the queried route to invite the destination communication endpoint. The signaling channel is preferably maintained with the communication processing server after the media channel is routed for regional low latency. The signaling channel can enable API initiated actions established at the platform to be acted on by the communication processing server. For example if a call is established between two client applications in the first region and an outside entity makes an API call to redirect the caller to another destination during the call the signaling channel can be used to tear down the established media channel and establish a new media channel in a substantially a similar manner.

Additionally the method can include registering a set of client application endpoint routes further comprises logging client application information S which functions to collect data through which the state of client application status and history can be understood and used in augmenting operation as shown in . Logging client application information preferably collects additional meta data about each connected instance. The meta data can include device type client application type regional association media stream type media bandwidth capabilities device capabilities actual approximate geographic location network location information e.g. IP address and or any suitable type of information. As a client application may change networks as a user moves the history of changes for a client application instance can additionally be logged. The logged information can be stored in a raw format or may be processed into more a higher level data model. AS described above the client applications of an endpoint preferably communicate media over an internet protocol but the set of client applications and devices may vary greatly. Some client application endpoints may be running through a web browser client some may be native applications some may be on mobile devices and some may be hosted on a dedicated computer. The type of media can additionally vary wherein the set of different media types can include audio video multimedia and or any suitable type of real time stream.

The logged client application information can be used in a variety of ways. In one variation the information is used internally for data analytics and or setting new routing policies. In another variation a subset or all of the information can be exposed to appropriate accounts. Client application information and associated communication sessions can be exposed through an application programming interface API . In another variation a user interface dashboard can be used in communicating data concerning the client application information. The amount of data is preferably scoped to only data of one particular account or subaccount. However global data from across the platform may be exposed in some manner.

As mentioned above another variation of the method can include setting a routing policy of at least one account in the platform. In this variation dynamically directing signaling and media can include applying the routing policy of the account on routing to communication endpoints and media resources. Routing policies may set what metrics are prioritized when selecting regional media topology. More specifically routing policies includes rules defining regional resource preference as shown in . A routing policy can be set per account per sub account per endpoint per region e.g. for calls made from a region or for being terminated in a region for time of day or for any suitable subset of communication. In another variation particular regions can be prohibited prioritized or otherwise weighted. For example a routing policy of one account may prevent resources of one region from being used which forces media to not pass through that region. In another example an account may set all media to exclusively route media through one of a subset of the available regions.

As a person skilled in the art will recognize from the previous detailed description and from the figures and claims modifications and changes can be made to the preferred embodiments of the invention without departing from the scope of this invention defined in the following claims.

