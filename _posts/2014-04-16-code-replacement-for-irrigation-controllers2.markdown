---

title: Code replacement for irrigation controllers
abstract: Some embodiments provide irrigation controllers comprising: a housing; a control unit including a first microcontroller configured to execute irrigation programs and a first set of code; and a removable plug-in device that removably mates with a portion of the irrigation controller and communicationally couples to the first microcontroller, wherein the plug-in device comprises a memory storing a second set of code to replace at least a portion of the first set of code, wherein the plug-in device is configured to re-flash at least a portion of the first set of code allowing a copy of the second set of code to overwrite at least the portion of the first set of code; wherein the first set of code comprises a bootloader that writes the copy of the second set of code over the first set of code with the exception of the bootloader that is not written over.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09547313&OS=09547313&RS=09547313
owner: Rain Bird Corporation
number: 09547313
owner_city: Azusa
owner_country: US
publication_date: 20140416
---
This application is a continuation of U.S. application Ser. No. 13 794 489 filed Mar. 11 2013 entitled CODE REPLACEMENT FOR IRRIGATION CONTROLLERS which is a continuation of U.S. application Ser. No. 12 911 683 filed Oct. 25 2010 entitled CODE REPLACEMENT FOR IRRIGATION CONTROLLERS now U.S. Pat. No. 8 417 390 which is a continuation of U.S. application Ser. No. 11 767 390 filed Jun. 22 2007 entitled CODE REPLACEMENT FOR IRRIGATION CONTROLLERS now U.S. Pat. No. 7 844 367 which is a continuation in part of U.S. patent application Ser. No. 11 022 329 filed Dec. 23 2004 entitled MODULAR AND EXPANDABLE IRRIGATION CONTROLLER now U.S. Pat. No. 7 640 079 which claims the benefit of U.S. Provisional Application No. 60 532 498 filed Dec. 23 2003 entitled MODULAR AND EXPANDABLE IRRIGATION CONTROLLER all of which are incorporated herein by reference in their entirety.

This invention relates to an irrigation controller for controlling the operation of an irrigation system. In particular this invention relates to a modular irrigation controller with expandable features.

Modular irrigation controllers use optional modules that can be added to the controller to increase the number of irrigation stations that may be controlled by the controller. For example U.S. Pat. No. 5 956 248 William et al. provides an irrigation controller having a housing that encloses a microprocessor that stores and executes watering programs and includes station modules that can be added within the housing to increase the number of irrigation stations controlled. Additionally U.S. Pat. No. 5 262 936 Faris et al. provides a controller having a base unit for actuating a predetermined minimum number of irrigation stations. External station expansion modules can be added to the base unit for increasing the number of irrigation stations controlled by the controller. Also describes are optional pump modules and accessory timer modules that behave the same as the station modules in that they provide an electrical output signal to a pump or to an accessory such as a light instead of to an irrigation station. However the expansion modules in these patents simply act as additional station outputs e.g. a conduit extension of the logic inside the controller and only include driver circuitry responsive to commands from the base unit and do not provide any additional functionality or intelligence. In order to add functionality to these controllers apart from adding additional station outputs e.g. to control additional stations or accessories a user would have to purchase another irrigation controller configured with the desired functionality.

There exists therefore a need for an improved irrigation controller with a flexible and expandable architecture modular design along with an enhanced communications to the modules that will provide enough flexibility for further additions to an irrigation system not only to include additional output stations but also to upgrade to new features and capabilities of expansion and re configuration.

Several embodiments of the present invention answer the above and other needs by providing an irrigation controller with flexible and expandable capabilities for controlling the operation of an irrigation system. In accordance with this several embodiments the irrigation controller includes a base unit with a removable and programmable control panel and a bus for communicating with a plurality of removable modules capable of performing a variety of functions and expanding the capacity of the irrigation controller beyond the physical limitations of its housing. Also provided are various methods and features for use in the modular irrigation controllers described herein as well as in other irrigation control systems.

Some embodiments provide methods of implementing irrigation control these methods comprise detecting a presence of a first module coupled with a control unit of an irrigation controller the control unit operating in accordance with a bootloader set of code and a first set of code to implement irrigation control identifying that the first module stores a second set of code and activating the bootloader set of code to replace the first set of code with the second set of code.

Other embodiments provide methods of implementing irrigation control. These methods comprise operating an irrigation control unit of an irrigation controller according to a first set of code to implement irrigation control and a bootloader code receiving a second set of code from a first module that is removably coupled with the control unit and replacing the first set of code with the second set of code.

Still other embodiments provide methods of a module supplying a set of code to an irrigation controller the method comprising determining a current module mounting location of the irrigation controller to which the module is mounted receiving a request for a first set of code stored on the module that is to replace a second set of code of the irrigation controller where the irrigation controller is operating according to the second set of code and transferring a copy of the first set of code to the irrigation controller.

Some embodiments provide an expansion module for a modular irrigation controller comprising a housing an electrical connector coupled to the housing to removably connect to one of a plurality of module mounting locations of the modular irrigation controller each module mounting location electrically coupled to a control unit of the modular irrigation controller that executes stored irrigation programs a memory within the housing that stores a first set of code where the memory allows a copy of the first set of code to be transferred to the control unit to replace at least a portion of a current set of code stored in the control unit.

Still other embodiments provide modular irrigation controllers that comprise a housing a control unit within the housing the control unit including a first microcontroller for executing stored irrigation programs and a first set of code of the control unit a plurality of module mounting locations within the housing adapted to removably receive modules each module mounting location communicationally coupled to the first microcontroller a module removably mounted to a first module mounting location and contained within the housing the module communicationally coupled to the first microcontroller and the module comprises memory storing a second set of code to replace at least a portion of the first set of code of the control unit and allows a copy of the second set of code to be transferred to the control unit to overwrite at least a portion of the first set of code of the control unit.

Some embodiments provide an apparatus that couples with an irrigation controller and provides the irrigation controller additional functionality the apparatus comprising a processor a communication port that communicationally couples with an irrigation controller and a memory that stores a first set of irrigation controller code that replaces existing irrigation controller code stored on the irrigation controller a functional set of code that provides irrigation functionality where the functional set of code is activated by the irrigation controller and implemented from the apparatus to provide at least some irrigation control functionality during irrigation.

Other embodiments provide expansion modules for a modular irrigation controller comprising a housing an electrical connector adapted to removably connect to any one of a plurality of expansion module mounting locations of a modular irrigation controller each expansion module mounting location electrically coupled to a control unit controlled by firmware stored in the control unit the control unit executes stored irrigation programs a microcontroller within the housing and coupled to the electrical connector and a memory coupled to the microcontroller the memory containing a new firmware version of the firmware stored in the control unit the microcontroller adapted to load the new version of the firmware into the control unit.

Some further embodiments provide expansion modules for a modular irrigation controller comprising a housing an electrical connector adapted to removably connect to any one of a plurality of expansion module mounting locations of a modular irrigation controller each expansion module mounting location electrically coupled to a control unit controlled by firmware stored in the control unit the control unit executes stored irrigation programs and a memory within the housing and coupled to the electrical connector the memory containing a new firmware version of the firmware stored in the control unit the memory adapted to allow the control unit of the modular irrigation controller to load the new version of the firmware from the memory into the control unit.

Additionally some embodiments provide methods of implementing irrigation control comprising coupling a module storing a first set of code to a controller operating according to a second set of code automatically replacing the second set of code with the first set of code and activating the controller to operating according to the first set of code to provide irrigation control.

In one embodiment the invention may be characterized as an expansion module for a modular irrigation controller comprising a housing an electrical connector coupled to the housing and adapted to removably connect to one of a plurality of expansion module mounting locations of the modular irrigation controller each expansion module mounting location electrically coupled to a control unit of the modular irrigation controller that executes stored irrigation programs a microcontroller within the housing and coupled to the electrical connector the microcontroller adapted to determine that the expansion module has been connected to the one expansion module mounting location and transmit a signal to the control unit to indicate the presence of the expansion module to the control unit.

In another embodiment the invention may be characterized as an expansion module for a modular irrigation controller comprising a housing an electrical connector coupled to the housing and adapted to removably connect to one of a plurality of expansion module mounting locations of the modular irrigation controller each expansion module mounting location electrically coupled to a control unit of the modular irrigation controller that executes stored irrigation programs a microcontroller within the housing and coupled to the electrical connector a visual indicator coupled to the housing and the microcontroller wherein at least a portion of which is visible from outside of the housing and indicates a status of the expansion module.

In yet another embodiment the invention may be characterized as an expansion module for a modular irrigation controller comprising a housing an electrical connector coupled to the housing and adapted to removably connect to one of a plurality of expansion module mounting locations of the modular irrigation controller each expansion module mounting location electrically coupled to a control unit of the modular irrigation controller that executes stored irrigation programs a microcontroller within the housing and coupled to the electrical connector an audible indicator coupled to the housing and the microcontroller the audible indicator emitting an audible sound that indicates a status of the expansion module.

In a further embodiment the invention may be characterized as an expansion module for a modular irrigation controller comprising a housing an electrical connector coupled to the housing and adapted to removably connect to any one of a plurality of expansion module mounting locations of the modular irrigation controller each expansion module mounting location electrically coupled to a control unit of the modular irrigation controller that executes stored irrigation programs a microcontroller within the housing and coupled to the electrical connector an input device coupled to the housing and to the microcontroller the input device adapted to send a signal to the microcontroller in response to the operation of the input device by a user.

In another embodiment the invention may be characterized as an expansion module for a modular irrigation controller comprising a housing an electrical connector adapted to removably connect to any one of a plurality of expansion module mounting locations of a modular irrigation controller each expansion module mounting location electrically coupled to a control unit adapted to execute stored irrigation programs and a microcontroller within the housing and coupled to the electrical connector the microcontroller adapted to transmit commands to the control unit the commands causing the control unit to display information to a user.

In yet another embodiment the invention may be characterized as a modular irrigation controller comprising a housing a control unit within the housing the control unit including a first microcontroller for executing stored irrigation programs and a memory a plurality of expansion module mounting locations within the housing adapted to removably receive expansion modules each expansion mounting location electrically coupled to the first microcontroller a first expansion module removably mounted to a first expansion module mounting location and electrically coupled to the first microcontroller the first expansion module including driver circuitry for actuating irrigation valves in accordance with control signals received from the first microcontroller and the first microcontroller adapted to store user defined configuration data specific to the first expansion module in the memory the user defined configuration data retained in the memory when the first expansion module is removed from the first expansion module mounting location.

In a further embodiment the invention may be characterized as a modular irrigation controller comprising a housing a control unit within the housing the control unit including a first microcontroller for executing stored irrigation programs the control unit having a first internet protocol address a plurality of expansion module mounting locations within the housing adapted to removably receive expansion modules each expansion mounting location electrically coupled to the first microcontroller an expansion module removably mounted to a first expansion module mounting location and contained within the housing the expansion module electrically coupled to the first microcontroller the expansion module including a second microcontroller the second microcontroller adapted to operate with the first microcontroller the expansion module having a second internet protocol address wherein the control unit addresses the expansion module using an internet transmission protocol.

In another embodiment the invention may be characterized as a modular irrigation controller comprising a housing a control unit within the housing the control unit including a first microcontroller for executing stored irrigation programs a plurality of expansion module mounting locations within the housing adapted to removably receive expansion modules each expansion mounting location electrically coupled to the first microcontroller an expansion module removably mounted to a first expansion module mounting location and electrically coupled to the first microcontroller the expansion module including a second microcontroller the second microcontroller adapted to operate with the first microcontroller wherein the first microcontroller is adapted to transmit an authentication request to the expansion module receive a response to the authentication request from the expansion module and determine based on the response if the expansion module is authorized to operate with the first microcontroller.

In another embodiment the invention may be characterized as a modular irrigation controller comprising a housing a control unit within the housing the control unit including a first microcontroller for executing stored irrigation programs a plurality of expansion module mounting locations within the housing adapted to removably receive expansion modules each expansion mounting location electrically coupled to the first microcontroller an expansion module removably mounted to a first expansion module mounting location and electrically coupled to the first microcontroller the expansion module including a second microcontroller the second microcontroller adapted to operate with the first microcontroller wherein the first microcontroller is adapted to transmit an authentication request to the expansion module receive a response to the authentication request from the expansion module and determine based on the response if the expansion module is authorized to operate with the first microcontroller.

In another embodiment the invention may be characterized as an expansion module for a modular irrigation controller comprising a housing an electrical connector adapted to removably connect to one of a plurality of expansion module mounting locations of a modular irrigation controller each expansion module mounting location electrically coupled to a control unit that executes stored irrigation programs and a microcontroller within the housing and coupled to the electrical connector the microcontroller adapted to operate with the control unit wherein the microcontroller is adapted to transmit an authentication request to the control unit receive a response to the authentication request from the control unit and determine based on the response if the control unit is authorized to operate with the microcontroller.

In another embodiment the invention may be characterized as a modular irrigation controller comprising a housing a control unit within the housing the control unit including a first microcontroller for executing stored irrigation programs a plurality of expansion module mounting locations within the housing adapted to removably receive expansion modules a back plane circuit board comprising a bus coupling the first microcontroller to each of the plurality of expansion module mounting locations wherein the bus comprises a serial multi drop bus comprising a serial data in line and a serial data out line.

In another embodiment the invention may be characterized as an expansion module for a modular irrigation controller comprising a housing having a surface adapted to contact one of a plurality of expansion module mounting locations of a modular irrigation controller each expansion module mounting location electrically coupled to a control unit of the modular irrigation controller that executes stored irrigation programs an electrical connector coupled to the surface and adapted to removably connect to the one of the plurality of expansion module mounting locations driver circuitry within the housing adapted to actuate irrigation valves in accordance with control signals received from the control unit a guidepost extending substantially perpendicularly from surface the guidepost adapted to insert into a corresponding guide hole formed in expansion module mounting location a tab extending substantially perpendicularly from the surface the tab having a ledge formed at a distal end of the tab the tab adapted to fit within a corresponding tab hole formed in the expansion module mounting location such that the ledge is located under an edge of a periphery of the tab hole.

In another embodiment the invention may be characterized as a modular irrigation controller comprising a housing a back plane circuit board within the housing a control unit removably mounted within the housing and electrically coupled to the back plane circuit board the control unit including a first microcontroller for executing stored irrigation programs a plurality of expansion module mounting locations within the housing and electrically coupled to the back plane circuit board and adapted to removably receive expansion modules a first expansion module removably mounted to a first expansion module mounting location and electrically coupled to the first microcontroller the first expansion module comprises a second microcontroller the second microcontroller adapted to operate with the first microcontroller driver circuitry adapted to actuate irrigation valves in accordance with control signals received from the first microcontroller and current detection circuitry coupled to the second microcontroller wherein the second microcontroller is adapted to detect a short circuit condition or an over current condition and suspend irrigation.

In another embodiment the invention may be characterized as a user interface for an irrigation controller comprising a display screen and a microcontroller for driving the display screen to display information wherein the microcontroller is adapted to display a user interface screen that allows a user to select one of a plurality of user groups and in response to a selection of the user generate and display a sequence of display screens to facilitate the programming of the irrigation controller corresponding to the selected user group where the sequence of display screens is different for each of the plurality of user groups.

In another embodiment the invention may be characterized as a user interface for an irrigation controller comprising a display screen a microcontroller for driving the display screen to display information and a memory storing user interface displays in each of a plurality of languages wherein the microcontroller is adapted to display a user interface screen that allows a user to select one of the plurality of languages and in response to a selection of the user generate and display at least one menu display screen in the selected language.

In another embodiment the invention may be characterized as an expansion module for a modular irrigation controller comprising a housing an electrical connector adapted to removably connect to any one of a plurality of expansion module mounting locations of a modular irrigation controller each expansion module mounting location electrically coupled to a control unit controlled by firmware stored in the control unit the control unit executes stored irrigation programs a microcontroller within the housing and coupled to the electrical connector and a memory coupled to the microcontroller the memory containing a new firmware version of the firmware stored in the control unit the microcontroller adapted to load the new version of the firmware into the control unit.

In another embodiment the invention may be characterized as an expansion module for a modular irrigation controller comprising a housing an electrical connector adapted to removably connect to any one of a plurality of expansion module mounting locations of a modular irrigation controller each expansion module mounting location electrically coupled to a control unit controlled by firmware stored in the control unit the control unit executes stored irrigation programs and a memory within the housing and coupled to the electrical connector the memory containing a new firmware version of the firmware stored in the control unit the memory adapted to allow the control unit of the modular irrigation controller to load the new version of the firmware from the memory into the control unit.

In another embodiment the invention may be characterized as a user interface for an irrigation controller comprising a control unit that executes stored irrigation programs a display coupled to the control unit the control unit adapted to cause information to be displayed on the display for the user a memory adapted to store irrigation program parameters wherein the control unit is adapted to display parameters stored in the memory relating to an irrigation program in a single user interface comprising one or more display screens that do not allow for the parameters to be edited.

In another embodiment the invention may be characterized as a user interface for an irrigation controller comprising a control unit that executes stored irrigation programs a display coupled to the control unit the control unit adapted to cause information to be displayed on the display for the user a memory adapted to store irrigation program parameters wherein the control unit is adapted to determine and store in the memory a total run time for an irrigation program and display the total run time for the irrigation program in a display screen that does not allow for the program related parameters to be edited.

In another embodiment the invention may be characterized as an irrigation controller comprising a housing a control unit within the housing the control unit including a first microcontroller configured to execute stored irrigation programs and a first set of code of the control unit and a removable plug in device that removably mates with a portion of the irrigation controller such that the removable plug in device is communicationally coupled to the first microcontroller wherein the removable plug in device comprises a memory storing a second set of code to replace at least a portion of the first set of code of the control unit wherein the removable plug in device is configured to re flash at least a portion of the first set of code allowing a copy of the second set of code to be transferred to the control unit to overwrite at least the portion of the first set of code of the control unit wherein the first set of code of the control unit comprises a bootloader that when implemented writes the copy of the second set of code over the first set of code of the control unit with the exception of the bootloader that is not written over.

In another embodiment the invention may be characterized as a method of implementing irrigation the method comprising activating a first microcontroller of a control unit positioned within a housing storing in a controller memory of the control unit communicationally coupled with the first microcontroller one or more irrigation programs and a first set of code of the control unit wherein the first microcontroller is configured to implement the one or more irrigation programs and to execute the first set of code receiving a removable plug in device that mates to a portion of the irrigation controller wherein the plug in device when mated is communicatively coupled with the first microcontroller wherein the removable plug in device stores a second set of code configured to replace at least a portion of the first set of code of the control unit and re flashing at least a portion of the controller memory copying the second set of code from the removable plug in device and overwriting at least the portion of the first set of code of the control unit with a copy of the second set of code transferred from the removable plug in device to the control unit wherein the re flashing at least the portion of the controller memory comprises executing a bootloader code of the first set of code that implements the overwriting the first set of code with the copy of the second set of code over the first set of code of the control unit with the exception of the bootloader code that is not written over.

Corresponding reference characters indicate corresponding components throughout the several views of the drawings. Skilled artisans will appreciate that elements in the figures are illustrated for simplicity and clarity and have not necessarily been drawn to scale. For example the dimensions of some of the elements in the figures may be exaggerated relative to other elements to help to improve understanding of various embodiments of the present invention. Also common but well understood elements that are useful or necessary in a commercially feasible embodiment are often not depicted in order to facilitate a less obstructed view of these various embodiments of the present invention.

The following description is not to be taken in a limiting sense but is made merely for the purpose of describing the general principles of exemplary embodiments. The scope of the invention should be determined with reference to the claims.

Described herein are several embodiments relating to irrigation controllers for controlling irrigation stations. In many embodiments the irrigation controllers are modular in that various functional components of the irrigation controller are implemented in removable modules that when inserted into position within the controller provide certain functionality. Accordingly the embodiments described herein cover various functionalities features and methods useful in such modular controllers however many embodiments apply to irrigation controllers generally. The following specification describes several embodiments of the invention in the context of two example modular controller implementations. For example many embodiments of the invention are described in one or both of a modular controller as illustrated variously in and and a modular controller as variously illustrated in and .

The present embodiments describe the modular capabilities of the irrigation controller as well as the ability to enhance and or upgrade the controller. Some embodiments further provide abilities to provide new or revised operating code instructions software programs and or firmware to an irrigation controller without having to replace a processor or memory and or without having to take apart the irrigation controller. Firmware generally is a set of instructions code and or software that is embedded in a hardware device or memory. It is often provided on flash ROMs or as a binary image file on a computer readable medium.

Referring to the modular controller design such as variously illustrated in and one embodiment of the invention designated as irrigation controller is generally illustrated in . According to several embodiments herein the controller is a modular irrigation controller that has an expandable architecture. As shown the expandable architecture irrigation controller is installed in a water resistant controller housing indicated in . When the unit is installed on site typically on a wall or the like through mounting holes indicated in valve control wires and power wires run through a wiring access hole s at the bottom and the back of the rear housing as seen in . Also provided are additional wiring access holes and in the event additional wires need access into the housing . This innovative irrigation controller having an expandable architecture modular design allows for economical expansion as well as easy installation and addition of capabilities and features not found in other irrigation controllers. Further the expandable architecture allows enhancements and or upgrading of the irrigation controller .

The controller housing formed of plastic or other suitable material is designed to withstand various environmental conditions. In one form the controller housing includes rear housing and door that enclose the electrical components housed within the housing . In one embodiment the housing encloses the base unit the base module and a plurality of expansion modules to protect their electronic components and connections. As described further throughout this specification in preferred form a plurality of different types of expansion modules are provided that may be removably inserted in any one of one or more locations within the controller . Thus in many embodiments a controller is provided with different types of expansion modules having different functionality with the same controller. Additionally in many embodiments expansion modules used as station outputs may have a different number of station outputs and be inserted in any one of one or more locations within the controller. Still further some expansion modules provide functionality that is not provided through the controller . In some implementations some expansion modules cannot operate with a current operating version of the controller and as such the module can provide an upgrade or a new operating version of firmware code instructions software and or other operating code to a controller to allow at least in part the functionality provided by the expansion module to be utilized.

The base unit shown in and carries out basic irrigation functions and also performs other advanced functions. The base unit is comprised of the control panel also referred to generically as the main control unit or the control unit and the controller housing as further indicated in and accommodates the backplane which is indicated in . The backplane provides backplane circuitry one embodiment of which is illustrated in to provide electrical interconnections between various components and modules to be housed within the housing .

The door pivotally swings open from a closed position to an open position as seen in to reveal the removable and programmable control panel that includes a user interface to enter and maintain an irrigation schedule and to display controller status and other functions. The door contains an opening or hole to provide direct viewing of the illuminating status indicator on the control panel when the door is closed. The door has a lock to restrict access to the base unit .

Looking at a battery compartment is provided to accommodate the battery of the control panel . The storage posts used for storage of a battery connector also visible in are recessed to facilitate flat placement of the control panel on a table during programming when the control panel is detached from the base unit . Also provided is an optional station wiring guide that may be adhered to an interior surface of the control panel to provide easy identification of the various station modules.

The reset button on the back of the control panel consists of a right angle mounted switch component not shown on the front side of the control panel circuitry for easy and cost effective manufacturing and can be discretely actuated by a pencil or a screwdriver for hardware reset. The reset button serves to restart the control panel microcontroller from a potential lock up condition possibly caused by electrical disturbances.

Indicated in the communication wire retention channel conveniently restrains and directs the communications cables not shown to the external communication interface see while the external communication interface panel is closed and the electronic components are protected against environmental damage.

Importantly it is an objective of several embodiments of the invention to have the control panel modular and removable from the controller housing and the base unit as seen in . Advantageously the control panel can be programmed with irrigation schedules by a user while detached from the rest of the base unit . A pin and socket mechanism plus a ribbon cable connection to the backplane circuitry of the back plane permits the control panel to be removed from the base unit . To provide power so that the control panel can be removed and programmed independent of an outside power source a battery not shown is provided in the recessed battery compartment seen in at the back of the control panel . This further provides additional flexibility and economic advantage in that for example a damaged control panel can quickly be changed and replaced with a new control panel without the need to replace the entire base unit . It is noted that while in many embodiments the control unit or control panel is modular and removable in other embodiments the control unit is integral to the controller housing and not intended to be removable.

Now looking at located within the control panel the control panel circuitry includes the main microcontroller that communicates with base module through base module signal lines extending through the backplane circuitry and the pins of a base module connector . The main microcontroller also communicates with the expansion modules through a communication bus extending through the backplane circuitry and the pins of the module connectors shown in to control the irrigation functions as defined in the irrigation program as well as the other functions contained in expansion modules . Depending on the implementation the bus may be a serial or parallel bus. In preferred form the communication bus is a multi drop serial bus and is described further below. It is also noted that as used throughout this specification the term microcontroller refers to an electrical device that minimally includes a processor logic e.g. one or more microprocessors memory e.g. one or more memory devices and inputs and outputs and is adapted to execute instructions based on information stored in memory either within the microcontroller or external to the microcontroller. Microcontrollers as used herein also include any necessary timers and or clocks.

It is also an object of several embodiments of the invention to have the communications interface port as part of the control panel circuitry connecting to a plurality of modular cartridges not shown facilitating a communications link via a plurality of media such as a radio modem a telephone modem wireless networks hard wired or fiber optic systems etc. interfacing to a plurality of computers and networks. Such a communications link allows the irrigation controller to intercommunicate for various commands including those for irrigation for the update of the firmware without the removal of any electronic components from the irrigation controller and for the uploading and downloading of irrigation schedules. Also the schedules that the user has entered at the control panel may be extracted and sent to a central control system via the communications interface . In one example the communications interface port uses a dual sided 2 5 pin edge card type with pin assignments illustrated in .

The main microcontroller gathers information or commands from the user interface processes them and sends the commands to the base module via control signals and to the expansion modules via the communication bus to drive the valves. As illustrated in the control panel microcontroller also has the ability to interface with other external peripherals including expansion modules external expansion housing s including additional expansion modules and the external communications interface . The expansion modules are provided in many different forms including an expansion module that provides additional station outputs to control additional irrigation valves an expansion module that provides outputs to devices other than to additional irrigation stations an expansion module that provides inputs to the main microcontroller e.g. in the form of external conditions provided by sensors a smart expansion module that provides additional functionality not originally found in the main microcontroller as originally configured one or more expansion modules that upgrade the irrigation controller and or provide new or revises operating code s instructions and or firmware that at least in part allows the irrigation controller to operate according to the new or revised firmware to control irrigation and or interaction with modules and interface extension smart expansion modules that provide functionality to direct the main microcontroller to provide a user interface extension to the expansion module so that the expansion module can performed its additional functionality.

In many embodiments the main microcontroller and the communication bus have an architecture that allows the main microcontroller of the main control panel to work together with the expansion modules in order to implement the functionality of the irrigation controller . For example in preferred form one or more of the expansion modules include their own microcontroller e.g. microcontrollers as seen in . In smart expansion modules the microcontrollers of the expansion modules are adapted to communicate with and share data with the main microcontroller. The main microcontroller is configured to be able to accept additional expansion modules and work together with them. For example the main microcontroller is configured to be able to transmit data parameters or variables which correspond to or are a part of one or more irrigation programs stored by the main microcontroller in response to requests from the expansion module s for such data parameters and variables. Additionally the main microcontroller is configured to accept and store changes updates and or replacements to parameters variables one or more irrigation programs as provided by an expansion module operating conditions operating code and or firmware. For example in one embodiment an expansion module receives a copy of a stored irrigation program from the main microcontroller adjusts the program based on the functionality of the expansion module and sends the updated irrigation program to the main microcontroller to replace the existing irrigation program. Advantageously such architecture allows an irrigation controller to be designed while allowing for expansion modules to be designed to add additional functionality to the capabilities of the irrigation controller. The additional functionalities may not even be known at the time of the manufacture of the irrigation controller and the control panel however since the main microcontroller is configured to share its data and accept data and control signaling from an expansion module the capabilities of the irrigation controller may be expanded without requiring that a user purchase a new irrigation controller. Instead the user would simply purchase a new expansion module having the desired functionality. Accordingly additional functionality can be provided to the irrigation controller through the use of some types of expansion modules without requiring that any firmware or software in the main microcontroller be added changed or replaced. Further some expansion modules provide updates to operating code of the control unit and or replacement of code instructions and or firmware referred to generally herein as firmware implemented by the main microcontroller to enhance the irrigation controller without having to replace the irrigation controller.

Generally this type of coordinated operation between the main microcontroller of the control panel and the various expansion modules is provided through the configuration of the main microcontroller to be able to operate together with expansion modules of unknown functionality and its ability to share data with the expansion modules and ability to act in response to data and commands from the expansion module. Additionally a communication link and protocol are provided that allow data flow between the main microcontroller and the various expansion modules . Further details and description are provided throughout this specification.

The main microcontroller is also capable of directly monitoring other inputs such as the valve solenoid current the presence of the base module sensor inputs e.g. rain and flow and the AC line frequency. In addition to the user interface the main microcontroller is able to accept commands through the remote control port shown in and an external communication interface illustrated in .

Importantly it is an objective of several embodiments of the invention to provide a communication link between the main microcontroller and the distributed microcontrollers of the expansion modules seen in . In one embodiment the communication protocol uses a physical layer based on a 9 bit capable Universal Synchronous Asynchronous Receiver Transmitter USART . This provides an addressing mechanism internal to the USART that avoids continuously interrupting the distributed microcontrollers . The USART utilizes a serial protocol on the module communication bus that has a plurality of data in and data out pins as well as an optional serial clock pin. The transmission of data from the main microcontroller occurs on the data out pin e.g. SMB DO of and the reception occurs on the data in pin e.g. SMB DI of . A serial clock is used in the case of synchronous data communication only. In the case of asynchronous communication the serial clock pin is not used. In various forms the communication protocol for communications on the bus works with asynchronous data communication or with synchronous data communications when a serial clock is provided. However the irrigation controller takes the technology a step further by programming the microcontrollers of the expansion modules to configure their serial data out pins to be in high impedance mode until they are addressed. For example in one embodiment the main microcontroller always drives its data out pin actively as it is the only device driving this signal. When individually addressed each distributed microcontroller of the expansion modules re configures its serial transmit data out pin e.g. SMB DI of on the fly to drive the data bus and transmit data on this pin. Consequently several embodiments offer a communications protocol that can be extended and modified with minimum impact on the rest of the system. The bus could be expanded to virtually any length and the expansion modules could be located remotely from the irrigation controller either independently or located in an external expansion housing s . It is noted that the USART is a well known communication protocol. Accordingly the communication bus is a multi drop bus structure in that all expansion modules are coupled to the same bus and each pulls any communications intended for it from the bus through the addressing mechanism of the USART. In preferred form the bus comprises a serial data bus however it is understood that in other embodiments the bus has a parallel line structure.

Interconnect communication busses in existing modular irrigation controllers use a master slave architecture. For example the controller of U.S. Pat. No. 5 748 466 McGivern et al. employs a query response model with the main microcontroller making a query to the module and expecting a response from it to ascertain the number of stations installed in the irrigation controller. Such a query response relationship of the controller and modules results in unnecessary overhead and bandwidth usage on the interconnecting bus becoming a limiting factor in expansion capability. Further such overhead can reduce the operating speed of the system. Several embodiments of the invention solve this problem by having the expansion module self detect its installation and announce its presence to the main microcontroller . Generally the microcontroller of the expansion modules is configured to detect when it is connected to the connector of the backplane . Once this determination is made the microcontroller causes a message to be transmitted to the main microcontroller via the communication bus announcing that the expansion module has been installed. The microcontroller waits for an acknowledge message back from the main microcontroller . If no acknowledge is received the microcontroller sends additional messages to the main microcontroller until the main microcontroller acknowledges the presence of the expansion module . Therefore since the expansion modules are configured to self detect their installation in the controller the main microcontroller does not need to query the expansion modules . This results in saved overhead and bandwidth usage allowing the irrigation controller to self configure and provide for more overall expansion capacity with less demand on the main microcontroller and the bandwidth of the communication bus .

It is an object of several embodiments to make the programming of a watering schedule into the irrigation controller free of historical challenges that users have been facing with the prior art irrigation controllers. One embodiment solves the problem of difficult entry and incorrect setup of a watering schedule into existing controllers through the incorporation of a water wizard for easy setup programming and use. The water wizard allows the irrigation controller to confirm automatically that a watering schedule entered by the user is consistent and logical and guides the user through the programming steps necessary to setup the irrigation controller and program a watering schedule into it. This intelligent water wizard is based on the main microcontroller built into the irrigation controller . The water wizard guides the user through a series of logical steps asking only for the needed information in an intuitive form and subsequently creating a schedule to satisfy the needed irrigation. For example the water wizard asks if the irrigation is for lawn trees or shrubs. Then it asks what the soil type is. And then it inquires about the Sun exposure. The water wizard would ask for a specific zone or watering time as necessary to complete the irrigation schedule. This union of native human language with the logic of an irrigation controller has been unprecedented in the art of inventing irrigation controllers.

It is a further object of other embodiments to include a novel water conserving feature in which the user interface provides program review and total run time features. Using the program review feature the controller displays to the user e.g. on the LCD generically referred to as a display a listing of all stations and watering times on a single display screen or series of displays screens that a user may scroll through. Advantageously the user does not have to manipulate the rotary dial or navigate complex menus in order to separately view irrigation settings or the irrigation program for various stations.

In response to selecting option 1 in the display screen of the display screen of is displayed. This screen displays the watering start times for all valves . . . . It is noted that if no start times are programmed the display screen of is displayed instead of the screen of . Furthermore it is noted that this display screen and the other displays screens of illustrate the status of program A. To view the status of programs B C etc. the user simply moves the program selector switch to the appropriate program.

Selecting the soft key corresponding to next in the screens of results in the display screen of one of providing the watering day cycle for the selected program to be displayed depending on whether the watering day cycle is cyclical custom odd odd or even. Selecting the next option in any of the displays of displays the display screen of which then provides the watering days based on the watering day cycle . Selecting the next option in the display of displays the display screen of which then provides the run times for each valve. The soft keys corresponding to and allow the user to scroll through more valves not fitting on one the single display screen. Selecting the next option in the display of displays the display screen of which then provides the amount of seasonal adjust e.g. 115 . If there is no seasonal adjust present e.g. the value is 100 the display screen of is skipped. Selecting the next option in the display of or if is skipped displays the display screen of which then provides the number of rain delay days remaining. Again if there are no rain delays days remaining this display screen is skipped. Selecting the next option in the display of of if there is a skipped display displays the display screen of which then provides the status e.g. either on or a programmed off day for each calendar day. The and allow the user to scroll through subsequent and previous days while indicating the status for that day. Selecting the next option in the display of displays the display screen of which then provides any programmed valve delays. Selecting the next option in the display of displays the display screen of which then provides cycle and soak times for all valves. In the illustrated embodiment since all valves will not fit on the same display screen the and soft keys allow the user to scroll through the valves. For example pressing the key once advances the list to the display screen of to reveal valve and remove valve . Likewise pressing the soft key further further advances the display to the display of and eventually to the display of . Selecting the next option in any of the displays of displays the display screen of which then provides the status of the master valve or pump for valve . Again the user may press the and soft keys to scroll through more valves. Selecting the next option in the display of displays the display screen of which then provides the status of a sensor override e.g. overriding the rain sensor for each valve. The user can use the and soft keys to scroll through more valves. The display screens of provide one embodiment of a program review feature in the display menus that allows a user to easily review the entire program for any program A B C etc. and switch between the same display information for different programs easily by using the program selector switch in a simple intuitive manner. This is in contrast to known controllers that require a user to traverse through extensive programming menu systems to retrieve the same information.

One advantage of the various program review user interface display screens such as shown in is that this interface only allows the user to review the programs and parameters. In this interface the user can not make changes to the program as the user is trying to review the program. This user interface solves a problem encountered in many controllers in which while attempting to review a given program or parameter a user accidentally makes changes to the program since when viewing program information in such controllers the user has entered programming interface displays and menus .

Irrigation controllers are being provided with more and more features buttons labels and ever thickening manuals while trying to provide the user with more feedback and while supposedly simplifying the user interface but ultimately adding to the complexity. Several embodiments answer the user interface complexity problem in the field of art by pushing the complexity into the internal computer program logic of the irrigation controller . Basically the user is asked about the watering or typical conditions or constraints existing on the landscape. The irrigation controller configures itself in terms of the overall watering needs and objectives. This Intelligent Use of Water concept relieves the user of having to know detailed information about station run times optimum watering time of the day start times number of start times etc.

In one embodiment the irrigation controller intelligently stores and recalls module programming and configuration information in order to eliminate the need to reprogram the controller or expansion module when expansion modules are changed. For example information unique to each expansion module is stored in a configuration data table residing in the non volatile storage device EEPROM of the main microcontroller see . As an alternate embodiment this same configuration data could be stored in the flash memory . This configuration data typically represents data that is specific to the expansion module . For example the configuration data may include what type of module the expansion module is e.g. whether it is a station expansion module an input module a decoder module etc. how many station outputs are provided by the expansion module how many and what type of inputs are provided by the expansion module in the event the expansion module receives inputs from sensor devices what type of sensor devices the expansion module is coupled to e.g. moisture rain wind sensors etc. This configuration data is transferred to the main microcontroller from the microcontroller of the expansion module over the bus . This data is then stored in the non volatile configuration data table. When the configuration data needs to be installed into a new replacement module the data is recalled from the non volatile memory and transferred to the module over the bus .

When a given expansion module is removed and replaced by an identical expansion module or a different module with similar function all configuration data and programming related to the expansion module removed is retained by the controller and is applied to the replacement expansion module. In one embodiment the module location and module s electronic SKU stock keeping unit number are used to track if a new module in a module mounting location can accept the data. Once the newly installed expansion module announces its presence to the main microcontroller of the control unit the configuration data table is scanned to verify that the same type of modules are mounted in the controller housing. If there is a match the newly installed expansion module is passed the programming and configuration data already existing in the non volatile memory or eliminating the need for the user to reprogram the expansion module configuration or irrigation schedule. In the event there is not a match then the main microcontroller determines that the newly installed expansion module is not identical to the removed module or is not intended to be a replacement for the removed expansion module and the stored configuration data may be deleted or overwritten with new configuration data if the memory is needed.

Irrigation controllers are growing in complexity with each generation. According to several embodiments the use of a Real Time Operating System RTOS in the main microcontroller of the irrigation controller simplifies and makes the operation of the microcontroller more robust. It allows for a more complex program to be developed that is more robust and of higher quality in a shorter amount of time. In preferred form the controller employs the real time operating system RTOS to allow separate program sections to communicate between themselves in a well defined fashion. Since each piece of program runs independently in its own context it is easier to write and read the supporting software as well as to troubleshoot software bugs during the development stage and have a bug free software running in the irrigation controller .

The microcontroller of the main control unit or control panel houses non volatile memory backup EEPROM shown in which is used to store and maintain while the power is off information provided as input via the user interface UI remote control port or the communications interface . This non volatile memory backup on the main microcontroller maintains the watering schedule details module data and other system parameters upon line power outage.

Also shown in the firmware for the irrigation controller is stored in the flash memory . This flash memory allows the firmware to be updated in the field without the need to replace the main microcontroller by using an expansion module referred to as a re flash module one example of which is illustrated and described further in connection with or through the communications interface without the need to replace any physical component on the controller .

One of the objectives of another embodiment is to customize the user interface according to the needs of the different user groups such as the contractors or the commercial users and novice users who lack experience in programming controllers. One embodiment solves the problem of having to design redesign an irrigation controller according to the changing interface demands of the different user groups such as a classic contractor a modern contractor a novice user etc. by offering a simple menu of user groups. The user simply makes a selection based on what user group they belong to and the overall user interface changes with display driven menus tailored exclusively for that specific user group. For example according to one embodiment the user is able to specify in a user interface display settings display screen what type of group the user programmer of the irrigation controller belongs to a modern contractor a contractor who is accustomed to modern methods to program an irrigation controller a classic contractor a contractor who is accustomed to a traditional method of programming an irrigation controller or a novice a user not familiar with the programming of an irrigation controller . Once the user selects which group the user belongs to the user interface i.e. the display screens and programming sequence are presented to the user accordingly. Thus the programming process the user must navigate to program the controller will vary depending on which group the user selects. One embodiment is illustrated in which presents a programming setup display screen offering the user to select whether the user is an advanced user such as a contractor option 1 or a beginner option 2 . Once the user selects which group the user belongs to the display screens and programming sequence changes. For example if the user is advanced display screen sequence is followed while if the user is a beginner display screen sequence is followed.

As seen in the user interface UI consists of a rotary dial for programming a plurality of indicators a liquid crystal display LCD generically referred to as a display a status indicator e.g. a visual and or audible alarm to alert the user to a status condition the unlabeled soft keys a sensor switch and a program selector switch . In one embodiment the status indicator indicates the status of the functionality of the control panel . For example when flashing the status indicator indicates to the user a fault condition in the controller while when the indicator is constantly illuminated this indicates that the controller has suspended irrigation e.g. due to a rain sensor. In preferred form the status indicator comprises a visual indicator such as a light emitting device e.g. a light emitting diode LED that visibly indicates a status of the controller. In preferred form the opening or hole formed in the door is aligned with the status indicator so that the status indicator is visible from the exterior of the controller housing while the door is closed. In other words the user does not have to open the controller housing in order to determine that there is a fault. In other embodiments the status indicator comprises an audible alarm e.g. a sound emitting device e.g. a small speaker that emits an audible sound to indicate the status e.g. fault condition or normal operation of the controller. In another embodiment the status indicator is both a visual indicator and an audible indicator of a status of the controller .

Shown in an annular ring molded onto the control panel runs around the rotary switch post not shown and forms a barrier against water entry into the controller . This protects the internal circuitry from water damage. In the illustrated form the annular ring is a raised wall rib or barrier that extends perpendicularly from the surface of the control panel and annularly about a recess within which is formed a hole that is provided to allow a post to connect the rotary dial to the switching components within the controller . The annular ring is designed to fit underneath the lip or edge of the rotary dial . In use with the control panel oriented such that the surface of the control panel is vertical in the orientation of any water that seeps underneath the lip of the rotary dial contacts the raised surface of the annular ring and is directed around the outer perimeter of the annular ring and away from the recess and hole . Thus the annular ring provides additional protection from water entering the interior of the control panel .

The unlabeled soft keys also shown in are used interactively with the commands that appear on the LCD . This approach places the label for each key on the LCD rather than on the keys themselves allowing the label to change as appropriate making the irrigation controller easier to use and eliminating the need to create a different button for each label needed.

Existing irrigation controllers are limited to small simple LCD segmented displays with limited language capability and limited graphic capability. It is a further objective of several embodiments to enhance the user experience through a display that can support a plurality of graphics and different alphabetical characters of different languages. To this end the irrigation controller employs a graphical display controlled by the control panel microcontroller accommodating a superior language and graphics support with more lines of information displayed on the LCD having the pinout configuration as illustrated in . This pinout provides 8 bits of data D D to the LCD . As seen in in one embodiment the firmware which implements multiple alphabets languages font sizes and graphics facilitates the offering of the alphabets of multiple languages for display by the irrigation controller . This solution involves a specialized and innovative set of graphics routines that enable the multiple alphabets and text strings to be stored in memory or and written to the display with limited RAM resource demand on the main microcontroller . In preferred form this innovative firmware graphic routines treat each language s alphabet as a collection of bitmap characters. As each character is displayed on the screen the individual dots on the screen are made dark or light to form that character. This results in a single character stored in the firmware controlling up to several hundred individual dots that represent the character on LCD . This is done through a look up process where the single character indexes into the bitmap collection stored in the firmware. A similar method is used for storing pictures and icons where a single character stored in EEPROM is used to translate into up to thousands of dots on the screen by looking up the stored graphic bitmap based on the single character. This results in minimized memory usage which is crucial for the high volume manufacturing of the irrigation controller at a low cost.

In several embodiments the user is allowed to select which language to view the display screens in. Known controllers are configured to display screens in a single language e.g. English . However since the controller stores display screens in multiple languages the user can select a given language or change the display screen language. The language selection is stored in non volatile memory e.g. EEPROM so that the setting is saved for use after a power outage occurs. For example the user simply navigates through the rotary switch the display screen menus and soft keys to a language select screen to select the language of choice. Additionally the language of initial display may be set when shipping the product if for example the controller will be shipped to a specific country having a commonly accepted language. The user will have the ability to change this language but at least the initial language will be in the most common language of that country.

While the user interface in accordance with some embodiments of the invention utilizes different fonts to emphasize certain details to the user different portions of the display can be flashing to emphasize certain other details. A plurality of graphic icons is also employed as part of the emphasis mechanism of the user interface .

Now returning to located within the rear housing the backplane circuitry is used primarily as an interconnection between the various modular components e.g. the modules and the control panel circuitry one example of which is illustrated in . The backplane circuitry one example of which is illustrated in is also used to connect with the remote control unit not shown here via remote connection port as well as the external expansion housings via external expansion housing connector whose pin configuration is illustrated in . The backplane circuitry additionally accommodates two terminal blocks shown in connecting the 24 VAC supply voltage to the controller and one grounding terminal block which is used for grounding to provide electrical surge protection.

The backplane circuitry provides a valve test through a single position screw terminal also shown in . The valve test connection terminal is provided with a 24 VAC supply voltage.

The backplane also includes a base module mounting location and a plurality of expansion module mounting locations . Each mounting location and provides a location on the backplane where a module can be mounted thereto. The base module mounting location includes a connector that includes pins or contacts electrically coupled to the backplane circuitry . Each expansion module mounting location also includes a connector that includes pins or contacts electrically coupled to the backplane circuitry . In operation the base module is mounted within the housing at the base module mounting location of the backplane and the expansion module s are mounted within the housing at corresponding expansion module mounting locations of the backplane .

As seen in the backplane circuitry is connected to the control panel circuitry via a ribbon cable assembly . The connector layout and assigned signals for the ribbon cable are illustrated in .

According to several embodiments of the invention mechanisms are provided to ensure that modules installed into the controller are compatible with the controller and that these modules were built by an authorized manufacturer. In one embodiment each module contains a predetermined textual message e.g. a textual message that is copyright protected that is transmitted by the module over the bus to the main microcontroller . The main microcontroller expects to receive a valid textual message e.g. the copyright message from every module . If it does not receive such a message the main microcontroller will treat that specific module as rogue and ignore it. According to a second embodiment both the modules and the main microcontroller contain a challenge authenticate mechanism. This allows for a mutual authentication scheme that can be initiated by either the main microcontroller or the expansion module microcontroller . As shown in in one form where the main microcontroller initiates the authentication procedure Step the main microcontroller will generate a random number Step pass this random number to the module as a challenge Step which can be generically expressed as transmitting an authentication request to the expansion module and also process this random number Step through a secret authentication algorithm contained inside the main microcontroller . The module will receive this random number and also process this same random number Step through an identical secret authentication algorithm contained inside the module s microcontroller . The module s microcontroller will send the result Step from the secret authentication algorithm as a reply to the main microcontroller . Based on the response from the expansion module the main microcontroller will determine if the expansion module is an authorized expansion module. For example the main microcontroller will compare the result it computed internally with the result provided by the module Step . If the results match then this indicates to the main microcontroller that the module does indeed know the secret authentication algorithm and therefore must be a valid module built by an authorized manufacturer Step . The main microcontroller will then continue to interact and communicate with that module . If the result does not match the expansion module is not authorized to operate with the main microcontroller and a rogue alert will issue Step . The controller is also able to display a message on the LCD to indicate that a rogue module has been detected.

Expansion modules would also like to have assurance that they are installed in a controller that has also been built by an authorized manufacturer. In this embodiment the module issues a challenge to the main microcontroller Step as shown in . The module will generate a random number Step pass this random number to the main microcontroller as a challenge Step which can be generically expressed as transmitting an authentication request to the main microcontroller and also process this random number Step through a secret authentication algorithm contained inside the module . The main microcontroller will receive this random number and also process this same random number Step through an identical secret authentication algorithm contained inside the main microcontroller . The main microcontroller will send the result from the secret authentication algorithm as a reply to the module Step . Based on the response from the main microcontroller the module will determine if the main microcontroller is an authorized control unit. For example the module will then compare the result it computed internally with the result provided by the main microcontroller Step . If the results match then this indicates to the module that the controller does indeed know the secret authentication algorithm and therefore must be a valid controller built by an authorized manufacturer Step . The module will then continue to interact and communicate with the controller. If there is no match then the main microcontroller of the control unit is not authorized to operate with the expansion module and a rogue alert will issue Step .

In preferred embodiments the confidentiality of these transfers steps is maintained by encrypting the data sent over the communication bus .

With an expandable architecture it is possible that users could attempt to keep adding modules without limits. This may make it difficult to distinguish different products with different capacities in the market. A further object of some embodiments of the invention is to limit the number of modules the number of each type of module the number of external expansion housings or any combination thereof. To that end a mechanism exists in the firmware such that if the user attempts to exceed the imposed limits the irrigation controller advises the user that a limit has been reached. Also the controller refuses to operate any modules that exceed the limit. For example in one embodiment a limit of the number of modules or a limit of the number of certain types of modules that is allowed to be attached to the controller including all expansion housings is stored in the memory of the microcontroller e.g. firmware or the EEPROM . When a module is enumerated the main microcontroller checks to see if there are stored any limits. If there are beyond the limit the main microcontroller will not enumerate the additional modules or operate therewith. Additionally the main microcontroller will send or cause an error message to be displayed to the user indicating that the user has exceeded the maximum number of modules or maximum number of modules of a given type of module .

As indicated in each module contains a module status indicator e.g. a light emitting diode LED that is activated either by the module itself or by the main microcontroller . This module status indicator is utilized to report status information error conditions correct operation or other functions to the user. To distinguish different status values the indicator utilizes a combination of different colors changing illumination pattern extending from steady to various blinks and or uses a combination of blinking and colors. It will be obvious to those skilled in the art that this status indicator could be any alternate type of electro illumination element. In other embodiments the status indicator comprises a sound emitting device such as a small speaker driven by the microcontroller of the module.

An alternate embodiment of a module status indicator to communicate the module status is using a display screen such as an LCD directly on the module that is operated by the microcontroller of the modules . See for example the diagram of . This display screen will display module status and fault conditions through text and or graphical elements. The modules can also have an LCD or other numeric alpha numeric or graphical display to convey more information than a simple lighted indicator such as an LED . The display would be used to convey module specific or module related information such as status setup or operational readings. This could be for example evapotranspiration data the real time status of alarm inputs or the activation or enabling of features. This would allow the end user to more efficiently and better use the module and the product as a whole. In another embodiment the module itself includes a user input device such as a keypad or other data entry or manipulation method. The microcontroller of the module is configured to accept inputs based on user interaction with the user input device and information displayed on a display screen located on the module. See for example the diagram of . For example in the case of a decoder module this would make the module very flexible and autonomous. This could also serve to decrease the burden placed on the control panel microcontroller .

As illustrated in the embodiment of the irrigation controller can easily be expanded in capacity beyond the physical size of the controller housing by the addition of external expansion housings see the expansion housing of that are chained together and function as one controller operated by a single control panel . In preferred form the external expansion housing expands the communication bus from the main microcontroller to allow more modules and or . In an alternate embodiment the external expansion housings are linked to one another with a power line wherein the power line carries both power and data between the main microcontroller and the external expansion housings . Other alternate embodiments utilize fiber optics wireless links or infrared links to transfer data between the main microcontroller and the external expansion housings . In one form the backplane circuitry interfaces to the external expansion housing through a 1 10 pin header connector shown in . The connector pinout and assigned signals are shown in . The external expansion housing interface connector see allows coupling of the external expansion housing to the bus . The connector facilitates the attachment of a further external expansion housing serving to extend the bus so that multiple external expansion housings can be daisy chained together. Any module except for the base module can be in any position in the main body housing or in any of the external expansion housings . Referring to one embodiment of the expansion housing is similar to the housing in that it has a rear housing and a door lock and hole . The cable connecting to the connector of the backplane of the housing couples at the other end to the connector of the backplane of the expansion housing. Advantageously the expansion housing allows additional expansion modules to be coupled to the main microcontroller of the controller .

Shown in detail in the base module is a non intelligent unit which is used to drive the master valves the module status indicator and to carry rain sensor input signals from the rain sensors to the main microcontroller . As seen in the base module accommodates a connector e.g. a 2 5 pin header connector to interface with the connector coupled to the backplane circuitry . The base module includes circuitry one example of which is illustrated in a plurality of wire output terminals and the module status indicator in this case an LED . In preferred embodiments the controller cannot function to control irrigation operations without the base module mounted in the controller housing . As seen in the base module circuitry includes the base module pinout driver circuitry for the master valve a sensor input circuit surge protection circuitry and the output terminals . The connector pinout and the assigned signals are illustrated in . It is noted that as used throughout this application the term driver circuitry in connection with actuating or activating an irrigation valve generally refers to any combination of electrical circuitry to cause an appropriate actuating signal to be delivered or deliverable to the irrigation valve. For example in one embodiment the driver circuitry includes drivers and output switches such as triacs or relays . Additionally the driver circuitry may vary depending on the type of irrigation valve that the circuitry is to drive e.g. whether the valve is a latching or non latching solenoid activated irrigation valve .

In one embodiment a mechanism exists whereby the accidental installation of the base module in any of the expansion module mounting locations or the accidental installation of an expansion module in the base module mounting location is mechanically prevented. In one form this mechanism utilizes the polarity key feature in which the base module connector is turned 180 degrees in the opposite direction from the placement of the expansion module connector . This connector polarity key feature is also reflected on the corresponding pins of connectors and of backplane circuitry that couple and interconnect with the base module connector and the expansion module connector respectively. This mechanism prevents the base module from properly mating if there is an attempt to mount the base module into one of the expansion module mounting locations and also prevents the expansion module from properly mating if there is an attempt to mount an expansion module to the base module mounting location

Additionally as seen best in the connectors are located off center within the respective mounting locations such that even if the module were turned 180 degrees it would be physically prevented from connecting into the mounting location. For example guideposts formed on the back of the modules are designed to fit within guide holes of the mounting locations and . As seen in the vertical spacing between the guide holes on the left and right sides of the mounting locations varies such that if the module were turned 180 degrees it could not mate into the mounting location. Additionally in some embodiments the male female connectors are switched on the base module and the expansion modules . For example in one embodiment the connector on the expansion module mounting location is a male connector while the corresponding connector on the expansion module is a female connector. In order to prevent the base module and the expansion modules from getting mixed the connector on the base module mounting location is a female connector while the corresponding connector on the base module is a male connector.

Seen in the module identification strip located on the module tops provide easy identification of modules while eliminating the need to manufacture different covers for different module types. These identification strips may be color coded and or contain labeling text and or icons.

The expansion modules interface with the backplane circuitry through the connector e.g. a 2 5 pin header connector indicated in . The expansion module pinout and the assigned signals for the connectors and are illustrated in . The expansion module s can be used at any connector of any expansion module mounting location except for the one connector at the base module mounting location allocated to the base module . It is noted that due to the communication bus structure and communication protocol expansion modules are allowed to be placed in any expansion module mounting location in any order coupled with the fact that the main microcontroller is configured to not expect modules to be connected in any specific order in the expansion module mounting locations

In addition to station output expansion modules each module connector can also accept other types of input output modules that will work together with the main microcontroller. In one example an expansion input module can include a plurality of inputs coupled to the microcontroller such as one providing sensor inputs with an architecture that is illustrated in . This type of module identifies itself e.g. once the module detects its installation to the main irrigation microcontroller as an input module type so that the main microcontroller can store configuration data and interact appropriately with the expansion module. Depending on its configuration as dictated by the firmware the microcontroller either passes the input data to the main control unit via the bus or processes the input data in some way prior to passing the data to the control unit. The irrigation controller can then use these inputs as conditional qualifiers to alter the way it runs an irrigation schedule or program.

The architecture for an expansion module type known as a smart expansion module is shown in . This type of module may contain any combination of input and or output signals e.g. station output signals to actuate additional irrigation valves or other output signals . The signals are not only restricted to irrigation applications but may also consist of data signals communication signals etc. The microcontroller inside the smart expansion module is programmed to perform a specific set of tasks dependant on the overall function of the expansion module. A smart expansion module is also unique in that it can interact with the main irrigation microcontroller by sharing internal data. A unique aspect of several embodiments is that the communication methods messages and protocols between the microcontroller of the smart expansion module and the main irrigation microcontroller of the main control unit or control panel allow either microcontroller to access data variables and constants contained in the other s memory space. For example the microcontroller can request and receive irrigation program related data or the irrigation program itself make changes to it in accordance with its programmed functionality and return the irrigation program related data to the main microcontroller . The main microcontroller is designed such that it can respond to requests for data and information from the smart expansion module as well as accept commands from the smart expansion module . This allows a smart expansion module to observe intricate details occurring inside the main microcontroller and also allows the smart expansion module to affect how the main microcontroller behaves by changing data in the main microcontroller s memory space. In this manner the installation of a smart expansion module to the irrigation controller can dramatically change the overall behavior of the system. Advantageously this allows the controller to have a significant upgrade of features and capability just by installing a smart expansion module and not having to replace any existing electronics or code in the irrigation controller itself. It is noted that in preferred embodiments there is a two way communication of irrigation program related data between the main control unit and the expansion module . This two way data communication is the type of communication that can alter the operation of the main microcontroller or otherwise alter the stored irrigation programs of the main microcontroller .

In the diagram of the smart expansion module includes inputs and outputs which in some embodiments includes station output terminals coupled to the microcontroller which communicates with the control unit or control panel via the bus . The module also includes module firmware to operate the microcontroller and additional module memory .

One example of a smart expansion module is an evapotranspiration ET module that receives ET data at an input and may optionally include one or more station outputs . The microcontroller requests and receives an irrigation program from the main microcontroller alters the program in accordance with the decision making programmed into the module based on received ET data and returns the irrigation program with altered parameters to the memory of the main microcontroller . The main microcontroller is adapted to receive the replacement irrigation program store it and execute it. In this manner the expandable and open architecture of the main control unit or control panel together with the addition of the smart expansion module provides additional functionality e.g. the ability to adjust schedules based on ET data to the irrigation controller that was not present in the originally designed and configured control panel without any firmware updates or other changes to the control panel. According to this architecture the main microcontroller does not need to know in advance the types of possible smart expansion modules that it could operate together with it simply shares its data with other modules of unknown functionality and responds to commands and executes adjusted schedules provided by these modules . Advantageously the user does not need to purchase a new control panel to upgrade to functions not provided by the control panel the user simply purchases a smart expansion module that provides the desired functionality.

Moreover in other embodiments a variation of smart expansion modules defined as interface extension smart modules is provided which also has the ability to interact with the user interface of the control panel . The interactions between the user and the interface extension module are shown in . For example the interface extension expansion module has the ability to send control signaling to the main microcontroller of the control panel to cause textual and graphical information to be displayed on the LCD display . It performs this by sending special messages containing the information to display to the main irrigation microcontroller . The main microcontroller which is directly connected to the LCD driver electronics then places that information on the LCD for the user to see. For full interaction with the user the main microcontroller can also monitor any pressings of the soft keys and will forward that information to the interface extension smart module. The interface extension smart module is also illustrated in the diagram of with the module firmware specific to the functionality of the module . In addition all of the other front panel main control unit controls switches and and the rotary dial are also able to be monitored in the same way by the interface extension smart module. In this manner the interface extension module is able to display menus and other information to the user and then monitor the user s selections with the soft keys. The interface extension smart module is able to create a user interface and entry interaction that does not exist in the firmware of the controller without changing or upgrading any firmware operating the main microcontroller . For example in an interface extension module including ET functionality such as the smart expansion module described above the interface extension smart module can generate specific types of displays and prompts for user input e.g. to configure the ET adjustment processes. The main microcontroller would cause these displays to be displayed on the LCD and monitor the user responses on the soft keys and finally forward the user response to the display screen or menu provided by the interface extension smart module . Advantageously this provides an easy way for the user to access and or configure a smart expansion module using the main control panel .

One embodiment of an interface extension smart module is illustrated in . This embodiment is similar to the embodiment of but does not have any inputs or outputs . Also illustrated are functional features stored in the firmware and or memory of the interface extension module . For example functionality to implement a display driver through the main microcontroller to monitor the user inputs of soft keys through the main microcontroller additional menu displays and menus to be sent to the main microcontroller for display and any additional fonts for the display menus is stored in the firmware and or the memory .

Another variation of a smart expansion module is illustrated in . In this embodiment the expansion module does not provide terminal inputs or outputs and adds functionality not present in the main microcontroller . For example functionality of the module is stored in the firmware and in the microcontroller . Additionally like the other modules and the expansion module can be interchangeably and removably inserted into any module mounting location . In one embodiment the expansion module comprises a re flash module which stores new firmware in memory to replace the existing firmware in the control panel . shows a smart expansion module according to some embodiments that is similar to the smart module illustrated in and stores a version of firmware in the memory . The version of the firmware can replace the firmware of the control panel which can provide the control panel with enhanced features fix problems with a prior version of firmware provide additional communication capabilities and or interactive capabilities to interact with the re flash smart expansion module to utilize additional functionality available through the module that was not available in previous expansion modules and or the control unit and or other such capabilities and functionalities at the time of development of the firmware . When this re flash module is inserted into the controller the main microcontroller and or the microcontroller initiates the process of loading the new firmware into the control panel typically after the control panel has authenticated the expansion module as described fully below.

In some embodiments the expansion module and or add functionality to the irrigation controller that does not require inputs or outputs. In an alternative embodiment a re flash expansion module is provided that does not require a microcontroller and where the memory storing the new firmware in the module is directly coupled to the electrical connector of the module. Upon installation the main microcontroller of control unit extracts the new firmware from the memory and the memory is allowed to directly transmit a copy of the firmware to the main microcontroller without the need for a microcontroller in the re flash expansion module. In this way the functionality of the controller is updated e.g. to include ET adjustment capabilities flow control user language selection additional user language and or other such functionality . In still other embodiments the expansion module provides additional irrigation functionality e.g. flow control signal decoding ET adjustments sensor monitoring defining a user operating language while the module is connected adding and or replacing an optional user operating language and or other such irrigation functionality to the irrigation controller that is not provided by the irrigation controller as well as providing a re flash of the firmware and or other operating code of the control unit and or main microcontroller .

In some embodiments the firmware of the control unit includes a dedicated code application and or program referred to below as bootloader code see for example . The bootloader code can be a limited functionality code that implements a re flash of the firmware and or activates the irrigation controller to operate according to currently store firmware. For example the flash memory of the control unit can store a version of the firmware that is about a 128 Kbyte image of the firmware code. A portion of the 128 Kbyte code can include the bootloader code . In some instances this portion can comprise 8 Kbytes of bootloader code that has specific functionality. This bootloader code is protected and or restricted so that it cannot be overwritten or cannot be overwritten without additional authorization. Upon activation of the main microcontroller and or irrigation controller the bootloader can be initially activated to start the remainder of the controller by providing a boot up process that activates the firmware of the control unit . By protecting the bootloader code the main microcontroller can be activated even if a version of the firmware becomes corrupt is incompletely replaced and or other such potential errors. Further the bootloader can initiate and or control the replacing or re flashing of the firmware except for the bootloader code . The bootloader continues to operate even while the firmware is being replaced because the bootloader is protected and is not overwritten. In other embodiments however the bootloader may also be replaced for example by copying a second bootloader to the flash memory and or over a portion of the firmware. The microcontroller can then be reactivated to access the second bootloader instead of the initial bootloader. Further the second bootloader can initiate a subsequent re flash of the remainder of the flash memory and firmware to update the firmware and or copy over the initial bootloader and provide a complete firmware.

In some embodiments a re flash device cartridge and or module can couple with the communication interface port the external expansion connector the remote control port or other relevant connection that allows the re flash device or module to communicate with the control unit and provide a firmware image to the control unit. For example a re flash device e.g. a re flash module or other device can couple with the external expansion connector and operate similar to other modules in the mounting locations a portable computing device such as a laptop or other such computing device can couple with the communication interface port of the irrigation controller to similarly provide an upgrade and or replacement of the firmware and or other re flash devices can couple with one or more other connections and or ports to communicate e.g. an RS232 connection with the microcontroller .

Further some implementations provide for a modular cartridge not shown to couple with the communication interface port . The modular cartridge can provide one or more functions to the irrigation controller such as providing a modem or other communication link. Still further the modular cartridge can provide a firmware image that can be used to replace the firmware of the control unit . In some implementations the cartridge can include a controller capable of taking control of the irrigation controller and forcing a re flash of the firmware . For example when the cartridge is installed it can identify a version of firmware in the flash memory and determine that the cartridge contains a newer version and activate a re flash.

Additionally or alternatively a remote device such as a remote central irrigation controller or remote computer can communicationally couple with control unit through the communication interface port of the irrigation controller to supply a version of firmware to replace the existing firmware . Similarly an expansion module or other device can couple with the external expansion connector to provide a re flash or replacement of the firmware . Some embodiments further provide for additional functionality in addition to the re flashing of the firmware. For example a re flash module could couple with the expansion connector to provide a re flash but additionally identify language selection that is used by the irrigation controller . Upon connecting the module with the expansion connector the microcontroller identifies the language selection and transitions to the defined language without further user interaction. Other embodiments provide similar language selection through devices other than re flash modules such as a simple language designation device that can couple with the expansion connector .

In some embodiments the memory of the re flash module is an external memory chip that is external to the processor chip that contains the microcontroller memory to store at least the application firmware and the bus interface . In other embodiments however the memory can be part of the processor chip. Further in some embodiments the application firmware is part of the memory and or is stored in memory .

When a re flash extension module is inserted into the irrigation controller the module in some embodiments enumerates itself to the control unit . Prior to enumerating for example when utilizing the serial bus the module waits for a silent period on the bus. When the bus is silent for a predefined period of time e.g. 5 ms 10 ms 20 ms or some other relevant duration the re flash extension module announces its presence to the control unit and or main microcontroller and then waits for a reply. A collision on the bus is assumed when the re flash module does not receive an enumerate command from the control unit within a second predefined period and will attempt to re enumerate or re send the enumeration. In some instances the re flash module implements a random back off e.g. based on a mounting location and or slot number into which the re flash extension module is inserted and then re attempts the enumeration. In some embodiments re flash modules can operate without enumerating themselves and instead the main microcontroller detects their insertion e.g. by querying modules periodically based on a schedule and or randomly . When the re flash module is detected the main microcontroller can request information from the module such as module type version of firmware functions connections and or other relevant information.

Once enumerated the re flash module returns an identification to the main microcontroller identifying itself as a re flash module. Upon detecting that the module is a re flash module the main microcontroller can activate the bootloader to implement a re flash and or a replacement of the current firmware or other code with a copy of the new version of firmware from the re flash extension module when such re flashing is desirable.

In step it is determined whether the expansion module is verified or authenticated. When the module is not authenticated the module is de enumerated as described with reference to step of below and or an error is indicated e.g. displayed on the LCD display the module status indicator is activated e.g. flashes or other such indications. Alternatively when the expansion module is authenticated step is entered where it is determined whether the module is a re flash module. This determination can be based on information provided by the expansion module during the enumeration process information provided in response to a request from the main microcontroller and the like. When the expansion module is not a re flash module the process terminates and the control unit continues with normal operations.

Alternatively when the expansion module is a re flash module step is entered where the main microcontroller requests and receives a version of the firmware on the re flash module . In step the microcontroller further identifies a version of the current firmware operating on the control unit . The microcontroller then determines in step whether the re flash version of the firmware is greater than the current version of the firmware i.e. whether the re flash version is newer than the current version of firmware . When the current version is greater the process terminates and the control unit continues with normal operations. In those instances where the re flash version of the firmware is greater than the current version step is entered and a re flash flag is set. This re flash flag can be a flag set in the non volatile memory e.g. EEPROM flash memory a latch or register separate from the memory in external memory and or other relevant flag. The process then continues to step where the bootloader is activated to implement a re flash based on the version of the firmware in the expansion module . In some embodiments the activation of the bootloader initiates a process described below with reference to .

In step it is determined whether the current firmware is valid or verified e.g. the CRC test passed . When the verification or check e.g. CRC fails the process activates a subsequent process to access a re flash expansion module as described fully below. Step compensates for at least those instances where a previous re flash of the firmware failed to complete a corrupted firmware was stored and or other similar conditions. Step is entered when the verification in step passes and the bootloader determines whether a re flash flag is set. As introduced above with reference to the process of in some embodiments when a re flash expansion module is identified the re flash flag can be set. When the re flash flag is not set the process terminates and the irrigation controller continues to step and normal irrigation control operations. As introduced above in some instances the bootloader is activated upon start up power up and or reset of the control unit and or the main microcontroller . Steps and verify the firmware and initiate the normal operation of the irrigation controller when a re flash is not to be performed.

Alternatively when a re flash flag is set the process in some embodiments enters optional step to determine whether a mounting location and or slot number is known. In some implementations when a re flash expansion module is detected during the enumeration such as during the process of the mounting location can be recorded when the re flash flag is set. When the mounting location is not known the process activates an additional process of to identify a re flash module that might be utilized during a re flash. As indicated step can be optional and in those embodiments that do not include step the process activates the subsequent process of in attempts to identify one or more re flash modules . When step is included and a mounting location is known step is entered where a re flash is activated. Some embodiments further confirm that version of the firmware of the re flash module is greater than the current version of the firmware before activating the re flash.

The re flash initiated in step retrieves a copy of the firmware image on the re flash expansion module . In some implementations the re flash image is retrieved in pages portions or packets at a time and stored to the flash memory . Typically these pages of the re flash image are stored to flash memory replacing the previous version of the firmware such that a complete re flash copies over the entire flash memory with the exception of the bootloader that remains intact. As indicated above typically the bootloader is protected and cannot be overwritten and or cannot be overwritten without additional authorized accesses. The re flashing of the flash memory provides a revised or new version of the firmware to the irrigation controller providing enhanced functionality and or communication capabilities abilities to utilize additional functionality provided by expansion modules including functionality that may be provided by the expansion module that has just provided the new version of the firmware correct errors in a prior version of firmware and or other such advantages.

Still referring to in step it is determined whether a timeout has been detected and or whether the re flash is complete. This timeout can occur for example if a response to a request e.g. request for a portion of the firmware image is not received from the re flash expansion module or other such timeouts. In those instances where a timeout occurs or other similar errors occur the process returns to step to again activate the bootloader in attempts to activate the main microcontroller and or implement a re flash of the flash memory . Alternatively when a timeout does not occur and or the re flash is complete a verification is performed in step to verify the re flashed firmware. Again this verification can be based on a CRC check sum and or other relevant verifications. When the verification is valid and or the CRC is verified the re flash flag is cleared and or reset and the process returns to step to reactivate the bootloader to activate the main microcontroller to operate in accordance with the new version of firmware stored in the flash memory and enter the normal irrigation control operation step . Alternatively the process returns to step without clearing or resetting the re flash flag and attempts to again re flash the firmware or return to the normal irrigation operations without re flashing when a valid version of the firmware is still accessible and or following a verification e.g. step .

The return to step can be implemented for example to compensate for those instances where multiple re flash modules are occupying multiple mounting locations and the bootloader does not identify a highest or most current version of firmware of the multiple re flash modules prior to initiating a re flash. This way the bootloader sequentially accesses the multiple re flash modules and does not implement a re flash associated with those modules with the same or lower versions of the recently re flashed firmware while subsequently accessed re flash modules with newer or high versions can be utilized to again re flash the flash memory . This operation of not checking each re flash module prior to implementing a re flash can simplify the bootloader code which may be advantageous in those instances where the memory space of the firmware available for the bootloader code is limited as well as avoiding having to store re flash versions and associated mounting locations and having to make a determination of which re flash version is to be utilized in a re flash when a re flash is to be employed.

In step it is determined whether a reply is received from the expansion module and or mounting location . In some implementations a time period is monitored and if a reply is not received from the mounting location it is determined that a expansion module is not mounted in the addressed mounting location and or the module mounted does not recognize communications sent based on a secondary bootloader protocol as fully described below. For example the time period can be about 2 ms 4 ms 5 ms or other relevant time periods. Further the time period can depend on many factors such as the number of mounting locations whether one or more expansion housings are coupled with the controller types of expansion modules expected to be incorporated and or other such factors.

When a reply is not received e.g. within the time threshold the process jumps to step to determine whether further mounting locations or slots are to be evaluated. Alternatively when a reply is received from an expansion module step is entered and the response from the expansion modules is evaluated to determine whether the responding expansion module is a re flash expansion module. In those instances where the module is not a re flash module the process continues to step . When the module is a re flash expansion module step is entered where a request is transmitted for a version of the firmware image stored in the re flash expansion module . Step may be skipped when a version is provided with the reply to the polling in step . In step the version of the firmware of the re flash module is evaluated to determine whether it is newer and or higher than the current version of the firmware being utilized by the irrigation controller .

When the current version of the firmware is newer than or the same as the firmware image of the re flash module the process continues to step . Alternatively some embodiments include optional step where the process attempts to identify whether the firmware image of the re flash module is the newest or highest version of multiple re flash modules coupled with the irrigation controller by determined whether the version of the firmware image of the re flash modules is newer or greater than firmware images of other re flash modules. When one or more other re flash modules have a firmware image that is newer or has a higher version of the firmware of the re flash module being evaluated the process skips to step . Alternatively in optional step the mounting location and or module identification is recorded and or stored when the re flash module being evaluated contains a re flash firmware image that is newer or greater than the current version and is newer and or greater than firmware versions of previously identified and evaluated re flash modules. Other embodiments however do not attempt to identify which re flash module has a newest version when multiple re flash modules are incorporated into the irrigation controller . Instead the process can optionally skip from step to step to implement a re flash when a re flash module is identified as having a version of the firmware that is newer than the current version of the firmware . The newest version is ultimately retrieved when multiple re flash modules are incorporated into the irrigation controller in these embodiments by cycling through at least a portion of the process where successive re flash modules are accessed in determining whether those modules have newer versions of the firmware image.

Still referring to in step as introduced above it is determined whether further mounting locations and or modules are to be queried to determine whether those mounting locations contain re flash modules. In those instances where further mounting locations are to be evaluated the process returns to step to query another mounting location and or module. Alternatively the process continues to step to determine whether a mounting location or module has been recorded indicating that a re flash module is mounted in a mounting location that contains a firmware image that is newer and or has a higher version number than a current firmware image stored in the flash memory . When a mounting location has not been identified and recorded the process transitions to step of the process of where a verification of current firmware is performed.

In those instances where a mounting location has been recorded and or identified the process continues to step to initiate a challenge and or authentication of the identified re flash module. This challenge or verification can be similar to step of the process of and or the authentication procedure of and or of as further described below. Step can also be an optional step in those embodiments when the expansion module is challenged and or verified prior to initiating the bootloader code and the processes and e.g. in steps and of the process of . In step it is determined whether the identified re flash module is verified. When the module is verified the process transitions to step of the process of to implement the re flash of the firmware with the newer version of firmware stored in the identified re flash expansion module . Optionally when the module is not verified the process continues to step to determine whether another re flash expansion module was identified in steps that contains a firmware image that is newer than a version of the current firmware utilized by the main microcontroller . When another re flash module was identified the module with the next highest version is selected and the process returns to step to authenticate the module. When there are no other re flash modules identified with versions of firmware newer than a current version the process terminates and activates step of the process of to initiate a validation e.g. performs CRC testing of the current firmware in attempts to activate the irrigation controller using the current firmware. In some embodiments steps and are optional. In those instances where they are not included once a re flash module with a higher version firmware image is detected in step the process skips to step to initiate an authentication of the expansion module. The process can then be repeated for each subsequent module that has a newer version of the firmware.

The above process is typically implemented by the bootloader of the main microcontroller . As such the bootloader controls the re flash of the firmware . In some embodiments however some or all the control of the re flash can be transferred to the re flash module . For example the main controller can forward information about the current version of the firmware as well as information of other versions available from other re flash modules coupled with the bus and or the main microcontroller . The re flash module can then make a determination whether it contains a version of firmware that is newer than the current version in the flash memory and or of other re flash modules. In those instances where the module identifies itself as having the higher version of firmware it can direct the activation of the bootloader to initiate a replacement of firmware and or control the copying of the newer version to the flash memory .

Further typically the re flash of the firmware is implemented without the need for user interaction. This allows a streamlined process and provides users with the relevant versions of firmware without the user having to implement the code replacement and or without the user even having to know or understand that a code replacement was taking place. In other embodiments however additional steps can be included for example in one or more of the processes and or that provide for user interaction and or confirmation. For example the user can be notified e.g. on the display of the control panel of the re flash and asked to confirm the re flash this confirmation can be achieved in some instances by the user inserting the re flash expansion module selecting a key and or other such confirmation having the user select a firmware version e.g. through user interface keys and or the like when multiple versions are available and or other such user interaction. Many embodiments however do not need user interaction and can implement the code replacement or re flash without user input. Further some embodiments notify the user of the re flash but do not need further user interaction.

Another variation of a smart expansion module is illustrated in . In this embodiment the expansion module includes one or both of a display and a user input device such as one or more keys buttons knobs or any other type of device to allow a user to input information to the module. Although the module is illustrated without terminal inputs or outputs some variations of this module include inputs and outputs. The display minimally acts as a status indicator to indicate to the user a status of the operation of the module . Additionally the display functions to provide an additional user interface as might be required in order for the user to program and implement the functionality of the expansion smart module . Additionally the input device s provides a way for the user to enter data or otherwise program or configure the module . The firmware allows the microcontroller to drive the display and interpret user interactions with the input device s .

In one embodiment once the rotary dial is turned to the Smart Module setting the LCD provides a list of the installed smart expansion modules and smart expansion modules having interface extension capabilities e.g. modules . When this list appears thanks to their built in intelligence these type of expansion modules have the ability to report their name and capabilities. Through the data received from the expansion modules during the enumeration process i.e. the process of the expansion modules self detecting their installation and reporting their presence type and configuration information to the main microcontroller the main microcontroller knows what module mounting locations have modules in them so it knows how many modules belong on this list. Once the user selects the expansion module which he she wants to program from the list by using the soft keys the smart features are activated and the selected interface extension module takes control of the controller display e.g. LCD and provides the user interface screens to the main microcontroller for display. The availability of an exit option on the menus created by the interface extension module allows exiting from the user interface extensibility mode bringing back the list of smart expansion modules to the LCD .

Various expansion modules and particularly smart expansion modules may be added to the controller to perform a variety of functions that expand the capabilities of the irrigation controller beyond its basic irrigation functions. Other examples of functional expansion modules not specifically described above that may be added to the controller include a latching solenoid module that sends a DC pulse along a wire to a latching solenoid operated valve a wireless module having a wireless transmitter radio optical etc. that sends a wireless signal to a receiver at a self powered valve a feature module containing an extra feature such as cycle and soak etc. not present in the original controller an alarm module for communicating fault conditions to a homeowner an alarm company or alike an lighting module that provides a low voltage output signal to outdoor lighting system similar to an irrigation output but intended to operate lights a fertigation module connecting an automatic fertilization system and allowing the irrigation controller to automate fertilization a communication module connecting the controller to other communication channels and or networks including the internet etc.

Referring next to a flow chart is shown that illustrates one embodiment of the module enumeration process. Enumeration generally involves the process of each expansion module determining its location in the controller backplane and reporting this information and other details about the module to the main microcontroller. Initially the modular controller is in normal operational mode executing one or more irrigation programs or waiting to be programmed by a user. Many embodiments of the invention allow expansion modules to be inserted and removed during operation of the controller without having to power down the controller or control panel . Since the main microcontroller does not query for new modules when a new expansion modules is mounted to an expansion module mounting location the new module detects its presence determines which mounting location it is in and announces its presence along with its type or functionality and the number of output stations it includes Step . Typically the expansion module waits until the communication bus is quiet and sends a signal such as an announce message to the main microcontroller. It is noted that in some embodiments rather than sending a message containing some data to announce its presence the expansion module sends or causes an electrical signal to be output to the main microcontroller the characteristics of the signal or simply its presence at the microcontroller serve as an announcement of the expansion module. The control unit receives the signal e.g. announce packet or message from the expansion module and decides if it is a newly installed module Step . If so it adds the module to a tracking list so that the main microcontroller knows which modules are present. The control unit will then respond to acknowledge the new expansion module not shown . Since the module expects to receive a response from the controller if the module does not receive an acknowledge packet or message back from the main microcontroller of the control unit the module will assume that a data collision has occurred and it will wait a period of time either random or fixed duration and make another announcement attempt. In one embodiment the module performs a pseudo random back off and retransmits the announce message Step . That is the module waits and retries sending the message. The amount of time can depend for example on the mounting location and different mounting locations can have different back off periods. Once acknowledged the main microcontroller will initiate a two way challenge authentication with the module such as described with reference to . Additionally the expansion module provides any additional information Step needed to the main microcontroller . Alternatively the microcontroller requests any required information from the expansion module. In accordance with several embodiments the main microcontroller then stores any configuration data for the expansion module in memory Step . At this point the controller e.g. the main control unit control panel or the main microcontroller knows what type of expansion module is connected. In preferred form configuration data includes data or parameters that is user defined and is not specific to the characteristics of a given expansion module itself but is data that is learned or programmed in the use of the expansion module. For example in one form configuration data for an input expansion module may include the types of sensor inputs that the input expansion module is coupled to. That is the configuration data could include the fact that a given input expansion module is coupled to a moisture sensor as opposed to a rain sensor or other type of input or the number of inputs outputs that are connected. These details are useful to the main microcontroller but not evident in the characteristics or functional capabilities of the expansion module itself such as how many inputs or outputs the expansion module has which is evident in the characteristics of the expansion module . Thus configuration data can be user defined in use of the expansion module at the installation.

In normal operation the main microcontroller continuously sends refreshing signals on a periodic basis to each connected module to confirm that the module is still connected. For its part the expansion module replies to these refresh signals to let the controller know that it is still connected. If during operation a given expansion module is unplugged from the backplane the main microcontroller will stop receiving responses to the refresh signaling sent by the main microcontroller Step . The microcontroller then increments it retry counter Step and sends additional refresh signals until a response has still not been received from the expansion module after a maximum number of retry attempts Step . At this point the main microcontroller assumes that the expansion module has been removed and de enumerates the expansion module Step . In other words the expansion module is removed from the list of enumerated modules . In preferred embodiments the configuration data including user defined configuration data stored in memory is retained until another expansion module is mounted into the location of the removed module. In the event the new module following steps is a replacement module identical in nature to the recently removed module the same configuration data is used for the replacement module. Advantageously a module replacing an expansion module does not need to be reconfigured. That is it can use the already learned or programmed configuration data as the previous module it is replacing. In one embodiment upon the enumeration of a replacement expansion module a copy of the configuration data stored in the memory of the control unit is transmitted to the expansion module and stored in the expansion module as well since some configuration data may relate to a programmed or user defined parameter of the control unit as it relates to its interaction with the expansion module.

In some implementations the enumeration by one or more expansion modules can be restricted or limited during a re flash and or while the bootloader is operating. Communication over the bus from modules attempting to enumerate during a re flash and or while the bootloader is active are typically not recognized by the bootloader and the bootloader does not respond to these requests. As a result if these enumerations are not restricted expansion modules added while the bootloader is active may continue to try and re enumerate creating potentials for collisions on the bus. In some instances an expansion module waits until the bus is silent before initiating an enumeration. This silence can further be a silence for a predefined period of time e.g. 10 ms 20 ms 100 ms or other relevant time periods . When the expansion module determines that it should enumerate e.g. upon being inserted into the controller the module monitors the bus looking for a silence period. Once the silence period is detected the expansion module initiates the transmission of its enumeration communication. It is noted that in some implementations the expansion modules may wait for additional periods for example based on mounting location back off times and or other such factors in attempts to further avoid collisions on the bus.

Further to implement communication between the main controller and the re flash expansion module some embodiments further employ a relatively simple secondary bootloader protocol for communication on the bus between the bootloader code and the re flash modules . Employing a relatively simple protocol allows the bootloader code to be relatively small and or compact. This can be particularly advantageous when the flash memory has a limited amount of memory capacity and or when attempting to limit the amount of flash memory occupied by the bootloader . For example in some implementations the flash memory can be limited to 128 Kbytes e.g. when utilizing a microcontroller chip with only a portion of the limited memory e.g. about 8 Kbytes reserved for the bootloader . As such some embodiments employ two different communication protocols to communicate over the bus depending on the state of operation. A first protocol can be used during normal irrigation control operation with the second relatively simple protocol utilized at least by the bootloader

The bootloader protocol can limit the communications available over the bus . In some implementations the bootloader protocol provides for four communications 

In providing the second protocol some embodiments further attempt to limit and or prevent confusion and conflicts with modules on the bus because of the two protocols. In some implementations the bootloader when activated maintains control over the bus by limiting which modules communicate over the bus while the bootloader is active. As described above and throughout the specification some embodiments are configured such that the modules upon insertion into a mounting location and or upon a reset a time out or other such conditions enumerate themselves to the main controller . This enumeration is postponed until a silent period is detected on the bus . Further the modules re enumerate if a reply is not received from the main controller in response to an enumeration. Often this re enumeration occurs when the reply from the main controller is not received within a threshold time period. The bootloader in some implementations can maintain control over the bus by in part preventing sufficient silent periods from occurring on the bus. As such the modules do not enumerate or re enumerate because a sufficient silent period is not detected.

Those expansion modules that can communicate with the bootloader and or can utilize the bootloader protocol comply with the bootloader protocol during bootloader operation and or re flashing. In some implementations addressing is utilized to focus communications to intended devices. As introduced above some communications can additionally or alternatively employ a 9 bit communication protocol. These embodiments can utilize the ninth bit in some implementations to indicate to receiving modules and or the controller that a communication is to be evaluated. For example a communication can be configured such that a first character packet or byte of the communication includes an 8 bit address with a ninth bit set to a predefined level e.g. set high . In the description below the character containing an address with the ninth bit set is referred to as address character.

A receiving module and or controller upon detection that the ninth bit is set evaluates the 8 bit address of the address character to determine whether the communication is directed to the module and or is to be further evaluated. Additionally in some instances once a module determines that a communication is not directed to that module the module can effectively disregard further communications on the bus with the exception of identifying an address character until a subsequent communication is detected that contains an address character where the module again evaluates the address of the address character. For example the modules can be configured e.g. using their UART so that they are alerted when an address character is received and disregard or ignore other communications with a character that has the ninth bit cleared when the previous address character was not directed to that module.

When an address character is received the expansion module and or controller checks the address byte of the address character e.g. through firmware to determine whether it matches the mounting location or slot number in which the module is mounted or a controller address. When it does then the firmware sets one or more flags e.g. a UART flag so that it is alerted for subsequent communication packets and or characters even when the ninth bit is cleared. This allows the modules to receive additional communications. When the address does not match the mounting location the firmware disregards the data byte s and or payload and the module controller or CPU will not be alerted until another address character is received.

Utilizing the address character allows modules to disregard communications until a communication is directed to that module. This can free up resources of the modules to perform other functions and or allow the module to enter an idle or sleep state rather than having to continue to monitor communications on the bus. Additionally this communication protocol can be implemented through relatively minimal code reducing memory resources.

The bootloader protocol can additionally or alternatively utilize addressing in distinguishing bootloader protocol communications. In some implementations one or more addresses can be defined as special or bootloader protocol addresses. Re flash modules and or other expansion modules capable of communicating with the bootloader can detect the one or more address characters identifying that these communications are to be further evaluated. For example a first address e.g. an address of 001 or substantially any other relevant predefined address can be defined as a bootloader address. Expansion modules capable of communicating with the bootloader recognize the address and further evaluate the communication and those devices that cannot communicate with the bootloader will disregard the communication.

The third representation of shows an example of a bootloader communication that includes a predefined bootloader designation address which in some instances has the ninth bit set a secondary address and a bootloader data or payload portion . Modules the bootloader and or other devices coupled with the bus that can communicate utilizing the bootloader protocol recognize the predefined bootloader designation address and continue to further evaluate the communication . This predefined bootloader designation address can be substantially any relevant address that is predefined as the bootloader designation address e.g. an address of 002 or substantially any other relevant address . Those devices that are unable to utilize the bootloader protocol and or cannot communicate with the bootloader disregard the communication and in some instances continue to disregard further communications on the bus until a subsequent communication is received that has an address character with its ninth bit set . Those modules and or the controller that can utilize the bootloader protocol detect the predefined bootloader designation address and continue to evaluate the secondary address to determine whether the bootloader communication is directed to that module and is to be further acted upon. For example when the secondary address matches the mounting location within which the module is positioned the module can extract the payload and take appropriate action e.g. identifying one of the predefined communication commands or messages such as request version request version reply request page request page reply or other relevant commands or messages .

As described above some embodiments further provide for a predefined broadcast address e.g. an address of 001 . The bootloader protocol can similarly utilize the broadcast address in transmitting communications. Still referring to the fourth representation shown in is an example of a bootloader communication that includes the predefined bootloader designation address which in some instances has the ninth bit set a secondary address that is the broadcast address and a bootloader data portion . This communication configuration allows one device on the bus e.g. the bootloader code to broadcast a single bootloader communication that the other devices on the bus receiving the communication and capable of utilizing the bootloader protocol will further evaluate and or take appropriate actions depending on the contents of the data portion . In some instances similar to the broadcast communications described above modules capable and or configured to receive and process the bootloader broadcast communications do not issue acknowledgement to the broadcast communication. These communication configurations allow the modules controller and or bootloader to communicate over the bus and in part limit or avoid confusion on the bus.

The example communications of are shown with the addresses preceding the data portions. It is noted however that the communications do not have to be configured in this order and instead the addresses can be positioned in substantially any relevant order and or location within the communication that can be extracted by the receiving device.

As with other smart modules the re flash modules can be configured to monitor the bus and initiate communicates in response to various conditions. For example in some embodiments the re flash modules can initiate an enumeration as described above when the module detects that it is inserted into a mounting location it is reset the microcontroller requests enumeration the bus is silent for a predefined amount of time and or when other conditions occur. As a further example when a re flash module detects that the bus has been silent for a predefined reset period of time e.g. such as 500 ms 100 ms 50 ms or other such relevant periods the re flash module can initiate reset code that starts operations as if the module had just been mounted or plugged into a mounting location which can include the enumeration process.

Many re flash modules additionally provide functionality beyond the re flashing of the firmware of the irrigation controller such as flow measure and or control ET monitoring other types of sensor tracking actuate irrigation valves provide additional or alternative communication ports and or modes of communication e.g. providing wireless communication enhanced communication security provide a display provide additional user interface e.g. additional buttons dials and the like provide additional operating languages irrigation initiation additional communication ports to the irrigation controller and or substantially any other relevant functionality. In some instances a current version of the firmware of the main controller may not be able to utilize the irrigation control functionality or other functionality provided by an expansion module . As a result the expansion module may contain a new version of the controller firmware that is to replace the current firmware of the controller to allow at least the utilization of the functionality provided by the module. Additionally or alternatively the new version of the controller firmware can provide additional functionality enhancements fixes to one or more problems with a prior version of firmware and the like.

In some embodiments re flash modules as well as other modules can transition to an idle or sleep state. This can reduce power consumption communication traffic over the bus and or have other such beneficial effects. The transition to an idle state can be based on time thresholds power consumption conditions and or other such factors. For example a re flash module may transition to an idle state when a predefined idle time period expires without receiving a communication addressed to that module or a broadcast communication in those embodiments that employ broadcast communications . Further some modules that contain triac input outputs that do not receive communications or packets addressed to them over a predefined idle threshold period e.g. a period of 10 seconds 5 seconds or substantially any other relevant time threshold can effectively transition to an idle state turning off outputs. Further expansion modules can be configured to recognize broadcast communications and or the predefined broadcast address . That way the control unit main microcontroller and or other devices on the bus can at least send a communication to shut down or force one or more modules to an idle state prior to the predefined idle threshold period by issuing an all sleep or idle command globally. In some implementations the broadcast communication can be a fixed communication and or packet and the controller can issue the string without a stack.

As described above and further below the bootloader can attempt to limit communication collisions on the bus that can interfere with the bootloader operation. As such in some embodiments the bootloader additionally monitors the communications over the bus and ensures that a communication is transmitted over the bus within at least the period of time that is less than the wait period to initiate an enumeration and or the predefined re enumeration threshold period that could trigger a re enumeration. For example in some implementations the bootloader initiates a communication at least once every prevention threshold period when other communications are not being transmitted and or received. These additional prevention communications can be sent even while the bootloader is waiting for a flash page write cycle to complete. This prevention threshold period can be substantially any relevant period depending on the parameters of one or more expansion modules such as 8 ms 5 ms 1 ms and or other such relevant periods. These additional prevention communications can be dummy communications that do not include a valid address and or payload can be a broadcast communication e.g. designating status information and or other such communications. The prevention communications can additionally address potential conflicts or collisions on the bus from modules that are enumerated with the irrigation controller modules that have not yet started to enumerate and or modules that are still trying to enumerate typically these modules continue to wait for a sufficient silence period .

Additionally in some instances the bootloader following the completion of a re flash of the flash memory stops communicating over the bus in attempts to maintain the bus in a silent state for a predefined threshold period. By keeping the bus in a silent state at least those expansion modules that are in a bootloader state communicating using the secondary protocol will detect the silence on the bus and exit a bootloader state and or activate a reset transitioning these modules from the bootloader state to a normal operating state. In some implementation this silent state is initiated at a start up of the control unit and or main microcontroller as well as following a re flash so that modules return to normal or non bootloader operating states. Alternatively or additionally the bootloader and or controller can issue a command that directs modules to exit the bootloader state.

In step the address is evaluated to determine whether the address matches a mounting location into which the module is mounted and or whether the address is a broadcast communication e.g. containing a predefined broadcast address recognized by the module and thus identifying the communication as a communication to be acted upon. When the communication is directed to the module the process continues to step to extract the payload and or data from the communication. In step the extracted payload is assessed to determine whether an action is to be taken. In those instances where an action is to be taken step is entered where appropriate action is initiated. This action can be substantially any action that can be implemented by the module such as but not limited to enter a bootloader state and or utilize the bootloader protocol implement flow monitoring implement ET evaluation activate one or more valves monitor sensors enumerating shifting to an idle state which may trigger step generating an acknowledgement and or substantially any other relevant action.

Following step and when it is determined in step that no action is to be taken e.g. the communication is a status communication an acknowledgement that does not trigger further action a dummy communication or other communication where no action is needed the process continues to step where the action performed and or communication is further evaluated to determine whether a response or reply is to be transmitted e.g. sending an acknowledgement forwarding status information forwarding results detected by a sensor returning an ET value and or evaluation returning a flow value and or evaluation and or other such relevant responses . The process returns to step when a response is not to be sent. When a response or reply is to be transmitted step is entered where the response or reply is configured and or formatted and transmitted. The process then returns to step to determine whether further communications are received.

In those instances where it is determined in step that the extracted address does not match the mounting location and or is not a broadcast address step is entered where the communication is further evaluated to determine whether it contains a predefined bootloader designation address . As described above some embodiments utilize one or more predefined bootloader designation addresses that can be recognized by those modules capable of communicating with the bootloader and or can utilize the bootloader protocol. Step identifies those bootloader communications by detecting the predefined bootloader designation address . When the address is the predefined bootloader designation address step is entered where the communication is further evaluated to extract a secondary address to determine whether the secondary address matches the mounting location within which the module is mounted and or is a broadcast address . In those instances where the secondary address matches the mounting location or is a broadcast address the process continues to step to extract the payload to step to determine whether action s is to be taken to step to implement appropriate actions when actions are to be performed e.g. identify a version of re flash firmware stored on the re flash module retrieve a page or portion of the re flash firmware to be forwarded to the bootloader and the like to step to determine whether a response reply is to be generated and to step to communicate a response e.g. transmitting a version of the re flash firmware transmitting a portion of the re flash firmware acknowledgement and or other such response when appropriate.

Alternatively when it is determined in step that the communication is not a bootloader communication and or when it is determined in step that the secondary address does not match the mounting location and or is not a broadcast address the process skips to step . In step the module evaluates its current state of operation to determine whether it is in an idle or sleep state or mode. When the module is in an idle state step is entered where the idle state is maintained. The process continues to step when the module is not in the idle state to determine whether a communication has been received that has been addressed to the module within a predefined idle time threshold or period or a broadcast communication has been received in those embodiments that employ broadcast communications . The process continues to step to enter the idle state when communications have not been received within the predefined idle time threshold.

Step is entered when the predefined idle time threshold has not been exceeded to determine whether the bus has been silent for a predefined reset threshold or period. When the reset threshold has been exceeded the re flash module can initiate reset code and start operations as if it has just been plugged into a mounting location which can include the enumeration process in step . Alternatively the process continues to step to determine whether the module is in a bootloader mode e.g. in a mode to communicate with the bootloader and or utilize the bootloader protocol . When it is determined that the module is not in the bootloader mode the process skips to step . Step is entered when the module is in the bootloader mode to determine whether the bus has been silent for a predefined exit bootloader mode threshold. The process enters step when the bus has been silent for the exit bootloader threshold where the re flash modules triggers firmware to exit the bootloader mode or state and or to activate a reset transitioning from the bootloader mode to a normal operating state e.g. that can allow the module to provide other functionality when such additional functionality is provided by the re flash module .

Still referring to when the bus has not been silent for the exit bootloader threshold the process continues to step to determine whether the module has re enumerated during this silent period on the bus . Step is entered when the module has not re enumerated to determine whether the bus has been silent for a re enumeration threshold period. In step the module re enumerates when it is determined in step that the bus has been silent for the re enumeration threshold.

The process returns to step to continue monitoring for communications over the bus following the reset in step or the transition from the bootloader mode to the normal mode of step . Similarly the process returns to step when it is determined in step that the module has enumerated during the silent period on the bus or when it is determined in step that the bus has not been silent for the re enumeration threshold.

The process is an example process that can be implemented by a re flash module or other module capable of operating in the bootloader mode and or communicating using the bootloader protocol when employed. In some embodiments one or more of steps and are not implemented and or are optional steps. The module can operate without employing one or more of these steps e.g. receiving commands to reset step and or exit the bootloader mode step . Similarly the threshold periods can be substantially any relevant threshold period. Further the threshold periods identified in the process may vary depending on a state of operation of the module the main microcontroller and or the irrigation controller . Still further in some embodiments these thresholds can be adjusted and or altered during operation for example depending on a state of operation of the module the main microcontroller the irrigation controller an irrigation system and or based on commands from the bootloader the main microcontroller and or a central controller in communication with the irrigation controller .

In some embodiments the firmware image is stored in memory on the re flash module in an encrypted form. Typically the module does not decrypt the image and further typically does not have the capabilities and or authorization to decrypt the firmware image. Instead the firmware is transferred typically in portions or pages at a time to the control unit in the encrypted form. Maintaining the firmware image in the module in an encrypted form provides protection of the firmware image. Further the firmware image is transferred to the control panel in the encrypted form and the bootloader contains the key to decrypt the image to be stored in the flash memory providing additional security and or protection so that even if the image is intercepted during transfer it is still encrypted. Further in some embodiments prior to initiating a transfer of the firmware image the re flash module performs a verification and or validation of the firmware image . This validation is performed in an attempt to ensure that the image is complete and accurate before allowing the firmware image to be supplied to the bootloader . The validation can be substantially any validation. For example the validation can include a CRC of the encrypted firmware image prior to initiating a transfer. In some embodiments the firmware image is validated prior to being encrypted and stored in the memory on the module . For example a CRC can be performed on the unencrypted firmware image and this CRC value can be incorporated within the re flash image which is then protected such as by providing password protections encrypting or otherwise protecting for example by applying convolution bit byte block or the like applying exclusive OR bit byte block level or the like data encryption standard DES triple DES 3DES substitution RSA Ron Rivest Adi Shamir and Leonard Adleman digital signature standard DSS scrambling digital signature algorithm DSA key encryption public key encryption PKI CipherSaber Rivest Cipher 2 RC2 Rivest Cipher 4 RC4 rearranging content scrambling system CSS transposition a combination of substitution and transposition advanced encryption standard AES Diffe Hellman DH secure hash algorithm SHA message digest algorithm MD5 pretty good protection PGP and or other such protections and or combinations of protections. The CRC value is then encrypted with the firmware so that the firmware upon copying to the flash memory can be validated when the bootloader decrypts the copied image. Further CRC value of the encrypted firmware image allows the re flash module to perform the validation of the encrypted firmware image without having to decrypt the firmware image prior to initiating communication of the image to the control panel . The microcontroller of the re flash module further implements a portion of the firmware to allow the microcontroller to perform the validation of the firmware forward the encrypted firmware image to the control panel communicate with the control panel provide additional functionality and or other such operations of the module.

Additionally or alternatively some embodiments provide modules that do not include a microcontroller . depicts a simplified block diagram of a smart module according to some embodiments that is similar to the smart module illustrated in and stores a version of firmware in the memory . The version of the firmware can replace the firmware of the control panel which can provide the control panel with enhanced features fix problems with a prior version of firmware provide additional communication capabilities and the like. When this re flash module is mounted with the controller the main microcontroller detects its presence e.g. through polling power signal and or other such indication that module is present. The microcontroller can further detect the memory and that the memory contains the new firmware which can be pulled by the bootloader to overwrite the portion of the current firmware.

As described above some embodiments provide for the modules to enumerate. One embodiment for a module to determine its position within a plurality of expansion module mounting locations is to have pulse code modulated PCM coded pulses sent to each connector . This ensures a robust digital signal for the expansion modules to use in determining which mounting location they are attached to and requires only a single signal pin at the module connector . The PCM pattern delivered is unique for each connector . The expansion module sees this PCM pattern and determines which mounting location it is attached to since it knows what PCM coded signals match with which mounting location . show the details of the PCM signal sent to the expansion modules . The PCM signal has a frame SYNC marker to allow the module to know that a PCM stream is about to arrive. In this embodiment the SYNC marker consists of a pulsed duty cycle of 60 low 6t in followed by a 40 high 4t in . The module microcontroller can either use an interrupt to detect the falling edge of the SYNC marker or use rapid polling to detect it. Each data bit in the PCM signal is then sent using a duty cycle of 25 low followed by 75 high to represent a logic 0 or a duty cycle of 75 low followed by 25 high to represent a logic 1 . A total of 7 bits are sent allowing for a total of 2 to the power of 7 128 modules . This PCM technique requires only one data line versus the normal seven data lines required to represent 128 unique module addresses. Anyone skilled in the art will easily realize that changing the number of bits the duty cycle of either the bits or SYNC marker using an alternate style of SYNC marker or eliminating the SYNC marker altogether are obvious alternate embodiments. One embodiment of the technique for generating these PCM signals is using a digital device such as a microcontroller e.g. microcontroller or other logic device that will generate a series of pulse streams as shown in . At each module connector a combination of low cost diodes as shown in is then used to mix these pulse streams to create a unique PCM slot identifier for each module. The diode arrangement technique is cost effective when there are a large number of module mounting locations e.g. more than four in the housing or provided through expansion housings s as it requires less pins from the pulse stream generator than the number of slots. If the digital device generating the PCM codes has sufficient pins this device could directly generate the signal waveforms as shown in eliminating the diodes. Other obvious embodiments to anyone skilled in the art will be to use a different form of serial data transmission other than PCM. The advantage of this embodiment is the use of a unique digitally encoded identifier signal for each module consisting of fewer signal lines per module connector than would normally be required to represent the total number of module connectors in a modular irrigation controller.

In another preferred embodiment for the expansion module to determine its location to report back the main microcontroller each module mounting location is identified by the combination of two input signals. One is an analog signal and the other is a frequency signal. The analog signal is used to identify the module mounting location of a single module within a group of expansion modules GOM and the frequency signal is used to identify what group of expansion modules such module belongs to for example the irrigation controller is considered as the first group of modules GOM whereas groups of expansion modules in additional expansion housing s would be considered in another group of expansion modules. For example the first external expansion housing which is daisy chained to the irrigation controller is considered the second group of module GOM . And if there is another external expansion housing which is coupled to the first external expansion housing it is considered to be the third group of module GOM and so on. When used in combination the analog and frequency signals give a unique identifying address to each module in the system. The analog signal is a voltage divider network may be formed in the backplane circuitry and is formed by 1 resistors that are connected in series. Each module mounting location will be assigned to a pre determined voltage signal which is between the logic ground and VCC. For example In this case there are four different voltages for four different module mounting locations . Module mounting location will be assigned to 0.5V module mounting location will be assigned to 1V module mounting location will be assigned to 1.5V and module mounting location will be assigned to 2V . This same voltage divider network will also be applied to the backplane circuitry of any external expansion housing . In order to distinguish between groups of modules which expansion housing the frequency signal is initially generated by the main microcontroller of the irrigation controller . This signal will be divided by 2n n 1 2 . . . by a frequency divider circuit in the external expansion housing that is daisy chained to the irrigation controller . It will continuously be divided by another 2n by a subsequent frequency divider circuit in the second external expansion housing if connected. In one embodiment the frequency divider circuit is a simple flip flop or frequency counter device that will be embedded in the external expansion housing . In operation the expansion modules store a table of what voltages and frequencies corresponds to what module mounting location of what housing either the main controller housing or an expansion housing .

A further preferred embodiment for the expansion module to determine its location to report back the main microcontroller uses a low cost module microcontroller a resistor and a capacitor to physically locate the expansion module to its physical module mounting location. In operation each connector has a single dedicated pin e.g. ENUM RCX that has a single dedicated resistor e.g. see resistor in connected to ground or circuit reference. The value of these resistors is different on the backplane circuitry for each module mounting location . Typically there might be from four to twelve module mounting locations in an enclosure although only 4 are illustrated in . However this technique is not limited to that range. The resistor value might be assigned as powers of two such as 1 000 Ohms 2 000 Ohms 4 000 Ohms etc. or some other range and step size in value. On the circuitry of the expansion module there is a single capacitor see capacitor of connected to the same corresponding pin e.g. ENUM RC and this capacitor is connected to a reference voltage such as supply voltage circuit reference or ground or some other voltage. The junction of the capacitor and the resistor is also connected to the input pin e.g. AIN0 of of the module microcontroller . When the expansion module is installed into a module mounting location a circuit is closed including the resistor which charges the capacitor to some voltage. This could be performed by configuring this processor pin as an output pin and driving it to the processor supply voltage. Upon charging the capacitor the module microcontroller then configures the pin to be an input or sensing pin and allows the capacitor to discharge through the resistor that is located on the backplane circuitry and then measure the time it takes to discharge the capacitor . The capacitor values are the same on all plug in modules. Therefore since the resistor values are different depending on which mounting location it is coupled to the time constant is different for every mounting location because the resistor located on the backplane circuitry forms a resistive capacitive RC time constant with the module capacitor . The microcontroller measures the amount of time required to discharge this RC circuit and based on the values measured compared to a stored table of known values corresponding to each mounting location determines which module mounting location that expansion module has been installed into. This measurement could be made by a general purpose timer counter or program cycle counter in the software of the microcontroller and could use an analog comparator input such as is found on many microcontrollers to increase the accuracy of the measurement. The module mounting location once detected is reported by the expansion module to the main microcontroller . As a result the user can see and know which station numbers valves or other devices are associated with the expansion module. In alternative embodiments rather than measuring the time to discharge the time to charge is instead measured and will achieve the same result.

In preferred embodiments since the main microcontroller has an open architecture adapted to work with and share data with expansion modules the main microcontroller can make sure the expansion module or the external expansion housing to which it is communicating is legitimate . Before establishing a normal communication activity the main microcontroller and the module microcontroller conduct an authentication scheme. In one embodiment this is accomplished by exchanging challenge codes and response codes. For example as described above with reference to this mutual authentication scheme can be initiated by either the main microcontroller or the expansion module microcontroller . In the preferred embodiment the main microcontroller sends a random value challenge to the module microcontroller . The module microcontroller then processes this value by passing it through its secret authentication algorithm. The resulting value response is sent back to the main microcontroller . The main microcontroller processes the challenge value through the identical secret authentication algorithm. The response value coming from the module microcontroller is compared to the value expected by the main microcontroller . If these values match the module is recognized to be legitimate by the microcontroller and the irrigation controller resumes its normal operation. If the values do not match the main microcontroller displays a rogue device alert on LCD .

Historically dealing with a large number of heavy gauge wires extending from the irrigation controller to each station on the site has been an issue of intense labor rising cost and wire mapping complexity especially in large sites such as golf courses and cemeteries. In one embodiment this problem is solved by introducing a special type of expansion output module namely a decoder module plugged into an expansion module mounting location of the irrigation controller which will require just a single wire pair to connect to plurality of decoder enabled station valves on the site. This greatly minimizes the wiring requirements by having just a single pair of wires be connected to the controller. Stand alone specialty controllers that work with decoder valves exist in the irrigation industry. However one embodiment of the invention provides this decoder functionality in an expansion module to a modular controller that can also operate with other types of regular station expansion modules input expansion modules and smart expansion modules that co exist with the decoder type outputs. In addition the use of smart expansion modules in combination with a decoder output module allows the smart expansion modules and to control the decoder outputs of a decoder module in a powerful manner not possible with any other controllers in the industry. The components of the decoder module are similar to the components found in however they may not include any inputs . The decoder module includes at least one output signal a decoder output that sends signaling to actuate selectable ones of a plurality of decoder based valves each coupled to the single wire pair coupled to the output signal . Additionally the decoder module may have multiple decoder outputs to independently control multiple sets of decoder based irrigation valves. In accordance with the execution of an irrigation program the microcontroller indicates to the microcontroller of the decoder module which irrigation valves are to be actuated and the microcontroller of the decoder module sends the appropriate signaling to its output terminals to address and actuate the desired valve s .

Each expansion module and likewise modules contains an independent microcontroller and communicates with the main irrigation microcontroller to report its capability to the controller . In the presently preferred embodiment the microcontroller of the expansion module is an ATMEGA8L 8AC microcontroller. The controller then adjusts its operation accordingly based on the module capability. For example if a new expansion module is detected with a 4 station capacity then the controller will add only an increment of 4 stations to the total available in the programming menus. This flexibility of employing a plurality of expansion modules provides operational and economic advantages to the contractor who no longer has to stock install and learn to operate completely different controllers for different types of applications. By allowing different expansion module types to be mixed on a single controller modular controllers in accordance with several embodiments of the invention provide the contractor with virtually infinite flexibility to tailor controller outputs to the unique set of needs of each individual site. For example a site may have two or three valve locations that are difficult to access. The contractor could add wireless output module s to the controller and install wireless valves in these locations while using lower cost AC output modules and standard solenoids for the other valves in the system.

It is common for prior art irrigation controllers to detect a short circuit caused by a mis wired or a malfunctioning valve and suspend the watering. Those controllers typically assigned the responsibility of reading the short condition and alleviating the problem to the main microcontroller which is typically housed within the control panel. However this responsibility of the main microcontroller introduces additional burden on the communication path causing a delay in corrective action before undesirable effects take place. It is an object of another embodiment of the invention to move the short circuit and over current detection mis wired or malfunctioning valve might have short circuit preventing the normal operation out of the control panel and into the expansion modules thus bypassing the bottleneck of the bus and the main circuitry shown in and having the ability to detect and take action within milliseconds. This is made possible due to the fact that the module microcontroller has enough processing power and it is connected directly with the valve actuator not shown . The module takes immediate action and then at its leisure notifies the main circuitry . The main circuitry does its traditional job of sorting out the error conditions and displaying the status to the user. When the module detects this short or over current condition it turns the valve off before any damage is done. The user will also be notified of the problem. In one embodiment the short circuit and over current detection is implemented in the form of a current sensor circuit in the modules . For example the current sensor circuit illustrated in detects changes in the current from the AC FUSE S signal from the backplane circuitry and provides inputs to the microcontroller so that the microcontroller in the expansion module can determine if there is a short circuit or over current condition. Again since this determination occurs within the expansion module irrigation may be immediately stopped in the event of a short circuit or over current condition without having to wait for the control panel to make such termination.

As best seen in embodiment illustrated in the terminals of the base module and the expansion modules comprise snap in wire terminals that are known in the art of electrical connection. These terminals provide the necessary connection points to the valve outputs. In preferred form there are two connection points for each terminal on expansion modules and one connection point for each terminal on base module with wire sizes up to 12 AWG. For each connection point or pair of connection points a wire release feature is provided which when pushed allows the wires to be released from the corresponding connection point

Seen clearly in the module mounting locations and accommodate docking and the electrical coupling of the modules and to the backplane . The base module mounting location is reserved for the base module and the expansion module mounting locations are for the expansion modules . The backplane connectors and include pins that carry power and data signals. In one embodiment these connectors are reverse polarized from contacts through the physical contact housing in order to prevent module and modules from being interchangeable. In preferred form the connection of these pins from the modules to the backplane is designed to function in accordance with the industry standard term hotswappable . In addition to this hotswapping feature any expansion module can be installed in any receptacle allowing maximum flexibility for the user. This provided in part by the common bus structure all expansion modules communicate using the same bus structure and communication protocol as well as that the microcontroller is configured to not expect modules to be inserted in any particular mounting location or order. This is in contrast to known modular controllers in which the data line structure through the modules requires that modules be inserted in a specific order. Additionally this is further allowed in that the main microcontroller is configured to expect that a new module can appear and disappear at any time. For example the main microcontroller automatically receives an announce message when a new module appears and constantly checks to verify that attached modules remain attached. Furthermore the communication protocol can be asynchronous so that the main microcontroller and the modules can asynchronously communicate. As a result several embodiments of the invention allow the user to remove or install modules without the need to power down and restart the controller . This feature is novel in the irrigation industry as other modular irrigation controllers must first have their power removed before any module can be removed or inserted. To accomplish hotswapping the contacts in the connector are arranged in a manner whereby the power signals establish a circuit connection at either end of the row of contact pins in e.g. AC COM and AC FUSE are located at either end of the pin configuration at the same time or before the connection of the data lines e.g. SMB DO and SMB DI in the center of the connector which are contacted into the mating connector of module . This is done to prevent the possible non orthogonal insertion of the modules from damaging module circuitry. In this manner the module s microcontroller power will have contacted before any voltage appears on the data lines. This hotswapping feature also allows the module to detect and indicate to the user that the module is not fully engaged mechanically. This condition could be caused by the user not fully applying pressure to the module to engage latch mechanism or by some other reason which prevented the module from fully engaging. The module having gotten power from one set of pins at either end of the contacts would be able to detect if the data pins in the center of receptacle were fully engaged and able to communicate with control panel . In the case where pin engagement was not made the module would communicate the problem through the use of the status indicator e.g. an LED so that the user could then reseat the module to provide for full insertion.

The prior art irrigation controllers have certain disadvantages in regards to the placement of the modules. One such controller by a competitor requires modules to be installed in a specific order. In contrast modular controllers in accordance with several embodiments of the invention eliminate the need to move an existing module renumber irrigation zones or disconnect and reconnect valve wires when adding a module to the irrigation controller . It is a further object of several embodiments of the invention to allow expansion modules of any output station size capacity to be placed on any receptacle in any order. This is allowed in many embodiments because the modules report their station output capability to the main microcontroller which is configured to accept any number of station outputs including decoder station outputs. The microcontroller is also configured not to be confused if there is a gap in sequential modules as installed.

A latching mechanism between the modules or and the backplane cover facilitates the secure firm and reliable connection of modules or to the backplane circuitry . The module or is placed perpendicularly onto the module mounting location or seen in on the backplane cover . To install the module the four guideposts in the form of tapered posts on the bottom of the module or are matched into the guide holes located on the backplane cover and the module is pressed into the module mounting location . The mating guideposts provide alignment to prevent improper insertion of the modules or as well as provide initial alignment for the interconnect between the module or and the backplane circuitry and also allows for flat on table storage of modules preventing damage to the connectors and . Releasing the module latching buttons accessible through an opening in the side of the module allows the button latch mechanism also referred to as a latch having a ledge formed at one end to expand underneath the backplane cover through the holes causing the module or to be held firmly in place. A snap or click sound is heard from the module latching buttons when the module is fully installed. The module or is released by pressing the two module latching buttons on opposing sides of the module or and pulling the module perpendicularly away from the backplane cover .

Each module and has a status indicator e.g. a light emitting diode LED that illuminates to indicate correct installation of the module or or that the module or is active during valve or other operation. In some embodiments the status indicator is a sound emitting device.

To facilitate power consumption reduction the microcontroller in modules can go to sleep and be awakened by a command or signal from the control panel microcontroller . In some embodiments the controller also incorporates a power supply feature that enhances the component reliability while providing higher power output through a new method based on a modified form of pass regulator topology. The pass regulator transistor instead of always being on is switched to on and off modes using available line frequency. The advantage yielded with this approach is the increased system efficiency at no additional cost.

The backplane circuitry holds the remote connector and the ground terminal blocks the power terminals blocks base module connector for the base module mounting location and the connectors for four additional expansion module mounting locations for expansion modules . In the illustrated embodiment no station outputs are found on the backplane circuitry although it is understood that in some embodiments station outputs may be implemented in the backplane circuitry .

In one embodiment the remote connector indicated in provides the means to connect a wireless receiver to the irrigation controller . A person equipped with the wireless control has now the means to manually activate irrigation valves modify the irrigation schedule or the behavior of any additional tasks that the irrigation controller is capable of performing. The remote connection ports found on prior art irrigation controllers are typically placed on the back of the front panel. This type of installation requires cumbersome wiring and wire routing often times causing the tangling of wires behind the front panel hinge making the unit difficult to close. The preferred embodiment keeps the remote connection port and the wire not shown on the backplane contained within the rear housing only eliminating any complicated wiring and wire routing.

The prior art irrigation controllers have invented ad hoc or proprietary bus methodologies to solve communication problems. However the software and firmware used for communications in such prior controllers is often not extensively tested documented or reliable and is often inflexible thus offering few expandability options. Modular controllers in accordance with several embodiments of the invention incorporate in a unique manner the time proven robust Transmission Control Protocol Internet Protocol TCP IP computer communication protocol for use on the controller s internal communication bus . The use of such a powerful protocol in a modular irrigation controller has never been undertaken in the industry. This preferred method using TCP IP allows for superior flexibility for internal communications between the main microcontroller and other microcontrollers located in the irrigation controller . It also offers easier and greater communication with external control networks and larger networks. As illustrated in a Socket Application Programming Interface allows the main program of the main microcontroller which operates the irrigation controller to pass data from the main microprocessor to expansion modules via a User Datagram Protocol UDP . The physical layer of this TCP IP driven communication protocol is a 9 bit serial port and takes advantage of the Serial Line Internet Protocol SLIP . While the preferred embodiment utilizes the aforementioned physical layer means the networking software is not hardware specific and can be adapted to many other physical layer methods such as RS232 RS485 or a parallel bus to move data.

One embodiment incorporates a very compact and efficient TCP IP protocol stack so that it may fit in the small memory space of the module s microcontroller thus keeping the cost of the module s microcontroller as low as possible to create a cost effective product. Traditionally the use of a TCP IP protocol would not be considered viable in a product of this nature. To keep the memory requirements as low as possible the invention utilizes the UDP flavor of the TCP IP protocol. The use of TCP IP protocols within the modular controller allows utilizing the powerful addressing and routing features inherent in the TCP IP protocol. The control panel and each expansion module are treated as separate internal network devices each with a uniquely assigned IP address Internet Protocol address .

To communicate within a larger network of a centralized system this embodiment has an external communication interface . In preferred form this communication interface also uses a TCP IP protocol to communicate with the main microprocessor . Thus the controller has the ability to be connected to an external network and assigned a unique IP address dynamic or static and be fully controlled over the Internet or other network. By using the TCP IP protocol each expansion module including input modules smart expansion modules can communicate with either the main microprocessor or an external computer located on a private or public network. In return the external computer can interact directly with every expansion module as the main microprocessor will act as a TCP IP router directing the data to the correct module. In the preferred embodiment the external communication interface incorporates a phone line modem using Point to Point Protocol PPP . It will be obvious to those skilled in the art that the communication interface could alternately be an Ethernet interface wireless interface etc. Optionally Internet email may be used to send messages back to the main microcontroller. In addition a Hypertext Markup Language HTML web server can be optionally installed to make communications easier. This way the irrigation controller can be updated with the latest input data such as weather and environmental conditions by email or by direct sending of UDP packets to the controller.

The following description provides more details regarding many of the pinout configurations of various electrical components of the modular controller in accordance with several embodiments of the invention. Each pinout configuration comprises a plurality of pins of an electrical connector interface designed to couple to a corresponding interface having the same pin assignments. In one embodiment the pinout assignments for the ribbon cable interface between the control panel and the backplane circuitry as illustrated in is as follows 

In one embodiment the pinout assignments for the base module connector interface between the connector of the base module and the connector of the backplane circuitry as illustrated in is as follows 

In one embodiment the pinout assignments for the expansion module connector interface between the connector of the expansion module and the connector of the backplane circuitry as illustrated in is as follows 

In one embodiment the pinout assignments for the external expansion port connector interface to an expansion housing as illustrated in is as follows 

In one embodiment the pinout assignments for the interface to the LCD of the user interface as illustrated in is as follows 

In one embodiment the pinout assignments for the communications interface port as illustrated in is as follows 

Next while referring to a modular controller in accordance with several other embodiments of the invention generally designated at is illustrated in . As shown the expandable architecture modular irrigation controller of this embodiment is installed in a water resistant controller housing or cabinet having a generally box shaped appearance with a front cover door and a rear main cabinet portion the front cover door being attached to the rear cabinet portion by a hinge that permits the front cover door to be opened for access to the inside of the rear cabinet as best seen in . When the unit is installed on site typically on a wall or the like through a key hole mount power wires and valve control wires not shown here run though wiring access holes in the bottom of the controller housing as seen in . The new and improved irrigation controller having an expandable architecture modular design allows for easy and economical expansion of the controller capabilities not found in other controllers.

The controller housing preferably formed of plastic or other suitable material is designed to withstand various environmental conditions and houses a base unit a base module expansion modules and smart modules also referred to as smart expansion modules . To releasably retain the cabinet door in the closed position the door edge opposite the hinge includes a laterally inwardly projecting lip that releasably mates with an opening formed in a tab projecting forwardly from the front edge of the rear cabinet portion . Upon release of the lip from the opening the cabinet door pivotally swings open about the hinge to reveal a removable and programmable control panel that includes a user interface to enter and maintain an irrigation schedule. The cabinet door contains a window to which is mounted a light pipe . The light pipe is positioned on the cabinet door to provide direct viewing of a light emitting diode led alarm indicator when the cabinet door is closed.

The base unit carries out basic irrigation functions and also performs other advanced functions and comprises the control panel that is removably attached to the front of the rear cabinet portion and a back plane circuit board see FIGS. and permanently housed in the rear cabinet portion and having circuitry for connection to the base module expansion modules and smart modules . The control panel is pivotally coupled to the rear cabinet and swings open to provide access to the interior within which various electronic components including the backplane circuit board are located. Terminal blocks on the back plane circuit board designated in provide an interface to the power supply line an earth ground line and various sensor input lines not shown here .

It is an object of one embodiment of the present invention to have an easy and intuitive user interface to enter and modify a plurality of irrigation schedules for an irrigation system. As seen in the front surface of the control panel includes various operational controls and indicators that assist a user in interfacing with and programming the controller and the irrigation system. In this instance a liquid crystal display LCD provides a visual output of information to the user such as when operating the programming functions among other tasks. An LED Alarm Indicator seen in illuminates when a faulty condition is detected for example at a station output in a standard expansion module or a programming error in the control panel microcontroller . Illumination of the LCD is visible through the window in the cabinet door when it is closed.

With reference to the control panel has circuitry shown in that includes a control panel microcontroller that communicates with the backplane circuitry to activate the irrigation functions as defined in an irrigation program as well as other functions as may be contained in the smart modules . The microcontroller sends commands via the back plane circuitry to the base module and or the expansion modules to activate irrigation valves according to a pre programmed schedule or via a manually initiated irrigation cycle. In the presently preferred embodiment the microcontroller of the control panel circuitry employs a TMP87CM20F microcontroller manufactured by Toshiba and is powered by a 5 VDC power supply. A non volatile memory backup EEPROM maintains the watering schedule upon line power outages.

As best seen in the back plane circuitry herein includes 13 active input stations station is not active that communicate with the microcontroller of the control panel . In this instance the stations include four station inputs for actuating valves a master valve station a rain sensor station a ground line station four communications stations an AC com station and an AC fuse station. The information conveyed from the control panel to the back plane circuitry is then distributed to individual output bays see into which one or more irrigation function control modules and have been inserted. As shown in the base plane circuitry includes an output connection module that communicates information to the base module two output connections module and module for bays that can receive expansion modules and an output connection for a smart module module . As will become more apparent hereinafter not only can an expansion module be used in place of a smart module in the station designated module but expansion modules can be used in any of the bays with the sole exception of module which is reserved for the base module .

The control panel can be removed from the controller as seen in for remote stand alone programming by the user. In this connection the control panel is pivotally attached to the front edge of the rear housing portion through a pair of hinge pins that are releasably received in holes formed in tabs projecting forwardly from the rear housing portion. The tabs are sufficiently flexible to permit the pins to be released for removal of the control panel but are sufficiently rigid to retain and support the control panel on the rear housing.

A detachable ribbon cable removably connects the control panel to the backplane circuitry so as to permit the control panel to be completely removed from the base unit . To provide power so that the control panel can be removed and programmed independent of an outside power source a battery not shown is provided in a recess in the control panel . This further provides additional flexibility in that for example a damaged control panel can quickly be changed and replaced with a new control panel without the need to replace the entire base unit . This feature also lets the user enter program information before installing the controller at a job site. In this instance the battery is retained by a cantilever type spring biasing element that frictionally presses against the side of the battery to hold it in position. The battery is easily removed via a finger access hole located in the spring biasing element which allows the user to simply insert a finger pull up on the spring element slightly to release the frictional contact and remove the battery from the recess shown in . The spring biasing element allows the battery to be retained and or replaced without the use of any tools such as screws and retains the battery without additional parts such as a latch or a swinging door. This results in less cost for manufacturing due to lack of additional parts screws doors etc. this also results in an easy single handed removal and insertion of the battery.

A reset button is located at the back of the control panel as seen in . The reset button serves to restart the control panel microcontroller from a potential lock up condition possibly caused by electrical disturbances. A remote connector also indicated in provides the means to connect a wireless receiver to the irrigation controller and a wire retention channel is provided to direct and restrain the remote connection cables not shown . An authorized person equipped with the wireless control now has the means to manually activate irrigation valves modify the irrigation schedule or the behavior of any additional tasks the irrigation controller is capable of performing.

The base unit relies on the insertion of the base module to be capable of activating any irrigation stations. The base unit does not have sufficient capability by itself to control an irrigation station as there are no driver or output switches for irrigation stations within the base unit . Instead drivers and switching means are located in the base module and the expansion modules . It is an object of several embodiments of the present invention to achieve flexibility and cost savings. For example a damaged component such as a microcontroller or station switch in a prior art base unit would require that the entire base unit be replaced. In one embodiment a damaged component in the base module the expansion module or the smart module requires only that the damaged module be swapped out and replaced on site by a new module in much less time than is needed to install a new base unit and at significant cost savings. The expandable architecture allows the user to choose from a variety of expansion modules that can include standard irrigation modules for carrying out watering schedules or smart modules for carrying out additional functions.

Moreover as shown in each module and is relatively simple in construction and incorporates similar basic components. As seen in which depicts the structure of an expansion module but which is also representative of the structures of each of the base and smart modules and the module includes a housing comprising a lower portion and an upper portion which mate together to encase and protect the module circuit board and herein are held together by a screw . Rotatably attached to the top of the upper module housing is a rotary locking lever that function to securely hold and retain the module in position when installed into the controller . The locking lever has a downwardly projecting pin that is snap fit through a cylindrical sleeve formed in the upper module housing to pivotally attach the locking lever to the upper module housing and includes an upwardly projecting locking tab that functions to lock the module in its operative position. As best seen from the expansion modules and the smart module in when the locking lever is in one rotary position herein the left rotary position the locking lever is unlocked while when the lever is in the counterclockwise rotary position to the right such as shown for the base module the lever is in the locked position as shown in in detail. To frictionally retain the locking lever in the locked and unlocked rotary positions the underside of the locking lever has a small downwardly projecting nipple not shown that snap fits into corresponding recesses or dimples in the upper module housing .

As shown in module insertion paths A D lead to individual bays that accommodate docking and electrically coupling of the expansion modules and smart module with the back plane circuit board . In this instance path A is reserved for the base module and paths B and C are for expansion modules and path D is for either another expansion module or the smart module . Each of the modules and electrically couples and interconnects with the backplane circuitry via sets of conventional spring finger contacts indicated in that electrically couple with complementary sets of conventional electrical contact pins A of the backplane circuitry see . Each module also includes output terminals and herein in the form of conductive screws to which output wires to irrigation components such as valves and solenoids can be attached in a conventional manner.

In this connection the electrical contact pins A of the back plane circuitry are grouped in sets corresponding to the location of each bay into which a module can be positioned. Herein as seen in the electrical contact pin sets A for each bay are carried on generally rectangular shaped tongues A formed as part of the back plain circuit board and slide into complementary slots B see in the front end of the housing to make electrical contact with the corresponding set of spring finger contacts . It should be apparent that additional modules could be accommodated by the addition of an expanded base unit and its back plane and number of bays . To secure and retain the Base module the expansion module s and the smart module s to the base unit and to releasably retain the modules in position the module insertion paths A D are partially covered by the backplane cover as seen in such that the modules can be slid into the module insertion paths A D and into the bays to be coupled to the backplane circuit board as best shown in .

To properly position and guide the modules and into the bays each module includes longitudinal recesses not shown formed along the bottom of the lower module housing that can mate with upstanding guide rails formed on the bottom wall of the rear cabinet portion as seen in . Once the module is inserted into the bay the user indexes the locking lever from the unlocked to the locked position. In this instance as best seen in the backplane cover has a downwardly projecting wall A extending along the length of the forward edge and which has openings corresponding to the locations of the insertion paths A D and through which the locking tabs of the modules can move when the module locking lever is in the unlocked position. When a module is fully inserted into one of the insertion paths A D the locking lever is then rotated counterclockwise which causes the locking tab to move out of alignment with the opening and into abutting engagement with the rear side of the wall A adjacent the opening. With the tab abutting the wall A the module is securely locked in position and cannot be pulled out of the controller unless the locking lever is first rotated to align the locking tab with the opening .

The base module is responsible for the carrying out basic irrigation functions such as turning on or off irrigation system valves not shown here which control the flow of water to the irrigation stations for the preset programmed duration. The presently preferred circuitry for the base module is illustrated in . As can be seen the base module circuit includes a bus interface having input connections from the back plane circuit board for controlling a master valve and four individual station valves and incorporates surge protection circuitry for lightning protection. Valve test circuitry is also provided to allow the user to assess the condition of the system. As best seen in the base module includes a number of conductive screws that serve as output terminals for connecting the module to irrigation station valves. Herein the base module includes a plurality of station output terminals D G preferably four station output terminals a hot post terminal A VT to test the valves during installation a terminal B for a master valve MV and a terminal C for a common wire terminal COM .

The expansion modules which are generally identical to each other enable a user to quickly and easily expand the capabilities of the controller functions without requiring the purchase of a new base unit . Each of the expansion modules includes three station output terminals herein in the form of conductive screws as seen in to which output wires to irrigation components such as valves and solenoids can be attached.

Each expansion module includes a microcontroller see capable of communicating with the microcontroller of the base unit . By using a micro controller in the expansion module the number of connections required is reduced as well as space and cost. As illustrated in the circuit diagram of the microcontroller is capable of communicating with the control panel microcontroller and controls the drivers and switches for the output stations. In the presently preferred embodiment the microcontroller employed in the expansion module is an Atmel AT TINY12L 4 microcontroller that provides communication to the base unit thereby substantially reducing the number of connections between the module and the base unit while at the same time handling the drivers to the output stations. The basic irrigation controller in accordance with one embodiment of the invention has no irrigation stations but separate modules can be added later for a determined location and to provide possible upgrade for a future improvement to the initial installation.

The microcontroller in the expansion module and the microcontroller in the base unit are mutually dependent upon each other in order to operate. The communication between the control panel microcontroller and the expansion modules takes place through an asynchronous serial communication line namely COMMX. During the communication data bits are transmitted in 100 microsecond intervals. In order to obtain a consistent time reference for data reception bit marks are set at 100 microseconds. Due to the fact that the control panel microcontroller and the modules and are running asynchronously each running on a separate clock a bit jitter of 8.4 microseconds worst case could be realized. To guarantee the bit jitter not exceeding 8.4 microseconds it is necessary that the control panel microcontroller disables any interrupts associated with any other interrupt functions such as key actuation by a user and only service the communication task at hand. Other functions and operations should not be affected adversely since the communication sequence lasts only for approximately half a millisecond per module.

Preferably the communication protocol consists of a negative start bit 3 data bits and an active low acknowledge. The recognition of the start bit by the module prompts the module to read the station status bits near the center of each 100 us bit mark. Upon completion of the status bits by the control panel microcontroller the control panel microcontroller releases the serial communication line and allows the module to acknowledge data reception by pulling down the serial communication line.

The microcontroller in the expansion module looks at the received data which contains information about which irrigation stations attached to this module should be activated or deactivated. In preferred form he microcontroller receives three consecutive messages with identical information before it actually makes a change to the irrigation station outputs. This provides a robust communication implementation whereby the irrigation stations do not erratically turn on or off under noisy data conditions.

The control panel microcontroller sends irrigation station data to every expansion module through the backplane circuitry on a one second interval thereby insuring that each microcontroller in each expansion module is refreshed with irrigation station data every one second. The microcontroller in the expansion module also includes a timeout mechanism. A timer inside the microcontroller and an interrupt service routine in the microcontroller firmware is used to create a repetitive internal clock tick every few hundred microseconds which in turn increments a counter to keep track of seconds. This clock tick and counter is used to measure the interval time gap since the last valid communication packet received by the module microcontroller from the control panel microcontroller . If this time interval gap exceeds five seconds the microcontroller in the expansion module decides that a fatal communication failure has occurred and the microcontroller deactivates all irrigation station outputs connected to itself.

Each time that the control panel microcontroller sends irrigation station data to an expansion module the microcontroller in the expansion module will respond with an acknowledge bit. This acknowledge bit is transmitted by the microcontroller immediately after the receipt of the station status bits in the serial communication. If the control panel microcontroller does not receive an acknowledge bit this is an indication that a module is not installed in that specific path A D of the bay . After communicating with each connector in the bay the control panel microcontroller will know which paths have modules installed and which do not. The firmware of the control panel microcontroller will correlate this information to determine which irrigation stations are effectively available to the irrigation program. If a user attempts to program an irrigation station that is not present the firmware will alert the user by displaying a message such as No Module .

The spring finger contacts of the expansion modules mate with complementary contact pin sets formed in the backplane circuitry for example as is shown in . The backplane contact pins carry power and data signals and are arranged as sets in a manner whereby the power signals establish a circuit connection prior to the data lines when the module is inserted into the bay. In this manner the module s microcontroller power will have stabilized before any voltage appears on the data lines. Stabilizing the power of the module s microcontroller before voltage is applied to the data lines prevents the microcontroller in the module from latching up or overloading its current ratings on its input output pins. This allows the module to be removed from and inserted into the bay without the need to first remove power from the remainder of the controller . Many embodiments of the modular controller are novel in the industry as other modular irrigation controllers using microprocessors in their modules must first have their power removed before any modules can be removed or inserted. In addition the firmware in the control panel microcontroller is able to handle the dynamic appearance and disappearance of irrigation stations without the need to restart or reboot the firmware. This is made possible by having the firmware continuously verify if a module that corresponds to each irrigation station is installed. For stations that are detected as being not available the firmware prohibits the user from enabling that station. In addition it alerts the user that the station is unavailable by displaying a message such as No Module .

As shown in the set of spring finger contacts for coupling the expansion modules to the corresponding set of connector pins A of the back plane herein include two AC power line connections an earth ground line connection and a data communication signal line connection. The corresponding pin out of the back plane circuit is illustrated in and the corresponding signals are as follows 1 EARTH GROUND 2 AC COM 3 AC HOT and 4 COMM 1 or 2 or 3 depending on which bay the module is positioned in and indicated in as COMM X .

The communication between the control panel microcontroller and each of the expansion modules and the smart modules takes place through a serial communication line so that the particular module insertion path A D into which an expansion or smart module is inserted makes no difference. Thus if an expansion module in insertion path B malfunctions and needs to be replaced the removal of that module will have no effect on the operation of the remaining modules in insertion paths C and or D.

If the control panel circuit illustrated in detects the presence of one or more expansion modules the control panel microcontroller assigns a default identity to each module and queries the module to identify its functionality. Once in communication the expansion modules work in concert with the control panel microcontroller to carry out the programmed functions. For example the expansion modules can inform the base unit of various conditions such as temperature humidity rain gauge readings moisture of the ground etc. the base unit also contains the basic irrigation schedules and is programmed to adjust irrigation schedules based on data received from the expansion modules . Although the expansion modules enable the base unit to change to permit advanced functions such as adjusting for weather conditions neither the expansion modules nor the base Unit can adjust or change themselves.

Various smart modules may be used to perform a variety of functions that expand the capabilities of the irrigation controller beyond its basic irrigation functions. In this instance the smart module circuit shown in includes a microcontroller that is of the same type as that employed in the expansion modules . This and other types of microcontrollers can be employed in the smart modules and which could be used for example to perform such functions as being a latching solenoid module sending a DC pulse along a wire to a solenoid a wireless module sending a signal to a valve a decoder module interpreting a command from the controller that indicates when a valve should turn on off an input module accepting inputs from sensors and providing information to the controller about environmental condition weather etc. a feature module containing an extra feature such as cycle and soak etc. an alarming module communicating fault conditions to a homeowner an alarm company or alike a fertigation module connecting an automatic fertilization system and allowing the irrigation controller to automate fertilization an evapotranspiration module receiving evapotranspiration data or weather conditions and allowing the controller to adjust irrigation accordingly a communication module connecting the controller to other communication channels and or networks including the internet etc.

Like the expansion modules the smart modules have a set of conventional spring finger contacts that mate with a corresponding set of conventional connector pins A of the backplane circuitry . In this instance as best seen in each smart module includes an earth ground connection two AC power line connections and two data communication signal connections. As shown in the complementary set of connector pins A of the back plane circuit for the smart module referred to as Module in have pin outs for the corresponding signals are as follows 1 EARTH GROUND 2 AC COM 3 AC HOT 4 COMM X and 5 COMM 4

The smart modules use a dedicated line herein designated COMM4 to communicate their presence and identity to the control panel microcontroller . This COMM4 connection is provided in the right most slot D of the base unit so that a module inserted therein has access to this additional communication signal. Smart modules can also utilize the asynchronous serial communication line COMMX in a similar manner to the expansion modules . In addition if a Smart module requires extended two way communications with the base unit it can achieve that through a software based communications protocol programmed into the microprocessor of the smart module and that of the base unit . Moreover if desired the backplane circuit board can be modified to include additional bays for receiving additional smart modules simply by adding bays with a COMM 4 communication line for two way communication with the control panel microcontroller and or by adding COMM 4 lines to one or more of the bays in which expansion modules are mounted.

Notably the expandable architecture modular design allows the communication between the smart modules and the base unit such that all smart functions are carried out in the smart modules rather than the base unit . The smart modules herein having circuitry as shown in allow the abilities of the base unit to be upgraded to include new and different functions without requiring the replacement of the base unit . For example the smart modules provide flexibility by allowing the base unit to interface with an outside user such as a home security company to alert the outside user if a sprinkler is not working. The smart modules may be programmed so as to provide an alert that there is a bad solenoid because a valve did not activate. In the case of automatic fertilization the smart modules could interface with a homeowner gardener etc. to provide an update on conditions.

To guard against the failure of the control panel microcontroller a mechanism is in place that allows both the expansion modules and the smart modules to be aware of such failures. The control panel microcontroller communicates with the modules on a frequent basis. This allows a module to detect the loss of communication. In effect this action is similar to that of a watchdog timer. While the control panel microcontroller is active the expansion modules execute the commands as received in real time from the control panel microcontroller . However should there be a communication gap greater than expected the expansion modules microcontrollers interpret this as a control panel microcontroller failure and immediately shut down any watering activities or other functions until the watchdog conditions have been properly restored. For each command sent to the expansion modules the expansion modules respond with an acknowledgment. Absence of this acknowledgment informs the control panel microcontroller that the module has suffered a hardware or software failure. Notably it makes no difference into which bay an expansion module is positioned nor to which of the output terminals irrigation station wires are connected. The microcontroller of the control panel monitors the bays for the presence or absence of expansion modules and cooperates with the microcontrollers of the expansion modules to send control signals only to those irrigation stations detected. In this manner there is no requirement that any particular bay include an expansion module thus allowing the user to add or remove modules in random order even while the controller is on and active.

In addition to the normal irrigation program set labeled A B C and stored in non volatile EEPROM the Controller also contains a contractor s default program set. This contractor s default program set is stored at a separate location in non volatile EEPROM than the active program set. Irrigation programs for A B C are entered through the User Interface . A menu choice is available to store this set of irrigation programs into the EEPROM as a contractor s default program set. Thereafter the user may make changes to the programs A B C without concern about making irrigation program mistakes since there is a backup copy. In addition a knowledgeable irrigation expert can enter a set of programs and store them as the contractor s default program set. A menu choice is available to recall the contractor s default program set from the EEPROM and replace the normal irrigation program set A B C. This allows the user to quickly and easily restore a known working irrigation schedule. Other irrigation controllers in the industry have a set of factory defaults with fixed program settings that a user may recall but do not have the ability to store and recall a set of irrigation programs customized for each individual site.

Generally the contractor default program set is a program set that has been modified relative to the factory default typically by a contractor during installation and is preferably site specific. In one embodiment the contractor saves this customized program as a set recallable default program. Thus if a user modifies the program that was input by the contractor the user has the ability to recall the contractor default if the user is not happy with the changes made. In a prior art controller the user could recall only the factory default and would have to re program the controller just to get it back to the customized state the contractor had set up. By having the ability to recall this customized contractor default program the user can easily go back to the customized state of the program which was set up for the installation. Generically the contractor default program may be referred to as modified default program which is specifically not a factory default. Additional memory space is provided to be able to store both the factory default and the contractor s default in addition to the active program set.

In other embodiments a contractor user may set a contractor default program save it then make further changes to the contractor default so that the active program is the modified contractor default program. Then the user instructs the controller to recall the stored contractor default program after a set period of time days hours etc. . In operation the controller executes the active program for a set period of time e.g. 30 days then the controller automatically stops using the active program and reverts back to the stored contractor default program. This feature may be useful in situations where the new grass is being planted and this new grass has initial watering needs until the grass takes root and becomes established in the soil. At this later point in time the watering needs of the grass will have changed. In this example the contractor will modify the factory default to generate a set of programs that will match the watering needs of the grass after 30 days once the grass has fully grown in. The contractor saves this program set as the contractor default then modifies these programs further to generate an active program that will meet the current watering needs of the grass and sets the expiration of the active program for 30 days. After 30 days the controller stops using the active program and recalls the contractor default to use as the active program while continuing to save the contractor default to be recalled in the event a user modifies the active program and is not satisfied with the modified program . Advantageously this embodiment allows more flexibility in the programming of the controller and greater ease to a user who knows that a set of programs customized to the installation may be recalled as opposed to being able to only recall a factory default which is not site specific.

While the invention herein disclosed has been described by means of specific embodiments examples and applications thereof numerous modifications and variations could be made thereto by those skilled in the art without departing from the scope of the invention set forth in the claims.

