---

title: Method and device for determining a jitter buffer level
abstract: A buffer level for jitter data buffer is determined. A frame payload size difference is determined for a plurality of video frames encoded into data packets sequentially received from a network. The difference is a difference in a payload size of a current frame and a previous frame. A frame network transit delay is determined as a difference in a transport time between the current frame and the previous frame and an expected transport time between the current frame and the previous frame. A slope and a variance of a linear relationship between the frame payload size difference and the frame network transit delay are determined for the plurality of video frames. Finally, a buffer level of a jitter data buffer is determined using a maximum frame payload size, an average frame payload size, the slope and the variance.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09042261&OS=09042261&RS=09042261
owner: Google Inc.
number: 09042261
owner_city: Mountain View
owner_country: US
publication_date: 20140207
---
This application is continuation of U.S. patent application Ser. No. 13 497 625 filed Mar. 22 2012 which was a National Stage of International Application No. PCT EP2010 063818 filed Sep. 20 2010 and claimed priority to European Patent Application No. 09171120.0 filed Sep. 23 2009 and U.S. Provisional Patent Application No. 61 245 003 filed Sep. 23 2009 all of which are hereby incorporated by reference in their entireties.

The present disclosure generally relates to electrical telecommunication and more particularly to data packet delivery in networks using the Internet protocol IP .

In a video over IP system each image or frame may be encoded into one or several data packets that are sent with minimal delay back to back to the IP network. The frames are usually produced at a constant frame rate wherefore the packet clusters are sent at the same constant rate. On the receiver side the packets arrive with a variable delay. This delay is mainly due to the delays inflicted by the IP network and is often referred to as jitter. The severity of the jitter can vary significantly depending on network type and current network conditions. For example the variance of the packet delay can change with several orders of magnitude from one network type to another or even from one time to another on the same network path.

In order to reproduce a video stream that is true to the original that was transmitted from the source s the decoder or receiver must be provided with data packet clusters at the same constant rate with which the data packet clusters were sent. A device often referred to as a jitter buffer may be introduced in the receiver. The jitter buffer may be capable of de jittering the incoming stream of packets and providing a constant flow of data to the decoder. This is done by holding the packets in a buffer thus introducing delay so that also the packets that were subject to larger delays will have arrived before their respective time of use.

There is an inevitable trade off in jitter buffers between buffer delay on the one hand and distortions due to late arrivals on the other hand. A lower buffer level and thus a shorter delay generally results in a larger portion of packets arriving late or even being discarded as the packets may be considered as being too late while a higher buffer level and thus a longer delay is generally detrimental in itself for two way communication between e.g. humans.

It is with respect to the above considerations and others that the present invention has been made. In particular the inventors have realized that it would be desirable to achieve a method for determining a buffer level of a jitter data buffer comprised in a receiver adapted to sequentially receive data packets from a communications network wherein frames are encoded into the data packets which method is capable of determining the appropriate buffer level in various network conditions. Furthermore the inventors have realized that it would be desirable to determine the buffer level of a jitter data buffer on the basis of a first part of frame arrival delay related to payload size variation between frames and a second part related to the amount of crosstraffic in the communications network.

To better address one or more of these concerns a method and a receiver having the features defined in the independent claims are provided. Further advantageous embodiments of the present invention are defined in the dependent claims.

According to a first aspect of the present invention there is provided a method for determining a buffer level of a jitter data buffer comprised in a receiver adapted to sequentially receive data packets from a communications network wherein frames are encoded into the data packets each frame comprising timestamp information T and payload size information L. The buffer level is determined on the basis of a first part of frame arrival delay related to payload size variation between frames and a second part related to the amount of crosstraffic in the communications network. The method may comprise for each frame determining a frame pay load size difference L by comparing L of the current frame with L of a previous frame determining a frame inter arrival time t by comparing the measured arrival time of the current frame with the measured arrival time of a previous frame determining a temporal frame spacing T by comparing T of the current frame with T of a previous frame and or determining a frame network transit delay d on the basis of the difference between t and T. The method may comprise for each frame estimating a set of parameters of a linear relationship between L and d on the basis of L and d for the current frame and L and d determined for at least one previous frame. A first parameter and a second parameter comprised in the set may be adapted to be indicative of the first and second part respectively. The method may comprise for each frame estimating a maximum frame payload size and an average frame payload size on the basis of L of the current frame and L of at least one previous frame. For each frame the buffer level may be determined on the basis of the maximum frame payload size the average frame payload size and the parameters of the linear relationship.

Such a configuration enables the determination of an appropriate buffer level of the jitter buffer in various network conditions by determining the buffer level on the basis of statistical measures of current network conditions. In this manner both frame arrival delay related to payload size variation between frames self inflicted frame arrival delay and a frame arrival delay related to the amount of crosstraffic in the communications network may be taken into account in the determination of the buffer level. This is generally not the case in known devices and methods.

By the separation of the packet delay contributions into self inflicted and cross traffic delays an improved adaptability to varying network conditions may be obtained. For instance consider a typical situation where a majority of the frames are roughly equal in size i.e. having a roughly equal payload size while few frames are relatively large e.g. in comparison with the majority of frames . Conventionally only the frame inter arrival time is considered in the procedure of setting the buffer level. In such a case only the few packets that result in the largest inter arrival time would provide any useful information for the procedure of setting the buffer level. In contrast according to embodiments of the present invention all of the frames encoded in the arriving packets in general contributes with information that may be utilized for estimating the set of parameters of a linear relationship between L and d. In this manner an improved accuracy and an increased adaptability with regards to varying network conditions may be achieved.

According to a second aspect of the present invention there is provided a receiver adapted to sequentially receive data packets from a communications network. Frames are encoded into the data packets each frame comprising timestamp information T and payload size information L. The receiver may comprise a jitter data buffer and a processing unit adapted to determine a buffer level of the jitter data buffer on the basis of a first part of frame arrival delay related to payload size variation between frames and a second part related to the amount of cross traffic in the communications network. The receiver may comprise a time measuring unit adapted to measure the arrival time of each frame. The receiver or the processing unit may be adapted to for each frame determine a frame payload size difference L by comparing L of the current frame with L of a previous frame determine a frame inter arrival time t by comparing the measured arrival time of the current frame with the measured arrival time of a previous frame determine a temporal frame spacing T by comparing T of the current frame with T of a previous frame and or determine a frame network transit delay d on the basis of the difference between t and T. The receiver or the processing unit may be adapted to for each frame estimate a set of parameters of a linear relationship between L and d on the basis of L and d for the current frame and L and d determined for at least one previous frame. A first parameter and a second parameter comprised in the set are indicative of the first and second part respectively. The receiver or the processing unit may be adapted to for each frame estimate a maximum frame payload size and an average frame payload size on the basis of L of the current frame and L of at least one previous frame. For each frame the buffer level may be determined on the basis of the maximum frame payload size the average frame payload size and the parameters of the linear relationship.

By such a receiver or decoder there may be provided a receiver or decoder adapted to sequentially receive data packets from a communications network which receiver or decoder may achieve the same or similar advantages achieved by the method according to the first aspect of the present invention.

According to a third aspect of the present invention there is provided a computer program product adapted to when executed in a processor unit perform a method according to the first aspect of the present invention or any embodiment thereof.

According to a fourth aspect of the present invention there is provided a computer readable storage medium on which there is stored a computer program product adapted to when executed in a processor unit perform a method according to the first aspect of the present invention or any embodiment thereof.

Such a processing unit or microprocessor may for example be comprised in a receiver or decoder according to the second aspect of the present invention. Alternatively or optionally such processing unit or microprocessor may be arranged externally in relation to the receiver or decoder with the processing unit or microprocessor being electrically connected to the receiver or decoder.

The estimation of the parameters of a linear relationship between between L and d may for example be performed by means of an adaptive filter algorithm such as adaptive linear regression recursive least squares estimation a Kalman filter etc. Such adaptive filter algorithms may be used in different combinations. By utilizing one or more adaptive filter algorithms the accuracy of the estimation of the linear relationship between between L and d may be refined by the choice of the adaptive filter algorithm s and or the model parameters of the respective adaptive filter algorithm. For example the adaptive filter algorithm s may be selected and or the parameters thereof may be modified on the basis of user capacity and or application requirements.

There may be determined whether the absolute value of a difference between d for the current frame and at least one of the first part of frame arrival delay related to payload size variation between frames for respective previous frames exceeds a predetermined threshold value.

In other words a so called sanity check or extreme outlier identification can be made on the measurements e.g. frame payload sizes arrival time differences prior to performing an estimation of a set of parameters of a linear relationship between L and d. In this manner the effect of undesired spurious events in the data packet delivery in the communication network may be avoided or mitigated.

An indication of a discontinuous change in a parameter of the communications network may be sensed. The parameter may be indicative of traffic conditions of the communications network.

In other words so called change detection may be performed to assess whether a discontinuous or abrupt change has occurred in traffic conditions of the communications network. Such change detection may be performed in various manners for example in accordance with user capacity and or application requirements. For example change detection may be performed by means of a CUSUM test.

In case an indication of a discontinuous change in the parameter is sensed at least one model parameter used in the estimation of the parameters of a linear relationship between L and d may be reset. In this manner re convergence of the process of estimating a set of parameters of a linear relationship between L and d for the new network conditions may be facilitated.

The at least one model parameter may for example comprise a Kalman covariance matrix a noise estimate etc. depending on implementation details.

There may be determined on the basis of T of the current frame and T of the previous frame whether the previous frame was transmitted earlier with regards to transmission order compared to the current frame. In other words it may be checked whether the current frame has suffered from re ordering. In this case the processing of the current frame may be stopped and discarded. Subsequently the receiver may await the arrival of the next frame for processing thereof.

According to another aspect of the teachings herein a method includes determining a frame payload size difference for a plurality of video frames encoded into data packets sequentially received from a communications network wherein a frame payload size difference is a difference in a payload size of a current frame and a payload size of a previous frame determining a frame network transit delay for the plurality of video frames wherein the frame network transit delay is a difference in a transport time between the current frame and the previous frame and an expected transport time between the current frame and the previous frame determining a slope and a variance of a linear relationship between the frame payload size difference and the frame network transit delay for the plurality of video frames and determining a buffer level of a jitter data buffer using a maximum frame payload size an average frame payload size the slope and the variance.

According to another aspect of the teachings herein an apparatus includes memory and a processing unit. The processing unit is configured to execute instructions stored in the memory to determine a frame payload size difference for a plurality of video frames encoded into data packets sequentially received from a communications network wherein a frame payload size difference is a difference in a payload size of a current frame and a payload size of a previous frame determine a frame network transit delay for the plurality of video frames wherein the frame network transit delay is a difference in a transport time between the current frame and the previous frame and an expected transport time between the current frame and the previous frame determine a slope and a variance of a linear relationship between the frame payload size difference and the frame network transit delay for the plurality of video frames and determine a buffer level of a jitter data buffer using a maximum frame payload size an average frame payload size the slope and the variance the jitter data buffer located in the memory.

Further objects and advantages of the present invention are described in the following by means of exemplifying embodiments.

The present invention will now be described more fully hereinafter with reference to the accompanying drawings in which exemplifying embodiments of the invention are shown. This invention may however be embodied in many different forms and should not be construed as limited to the embodiments set forth herein rather these embodiments are provided by way of example so that this disclosure will be thorough and complete and fully convey the scope of the invention to those skilled in the art. Furthermore like numbers refer to like or similar elements or components throughout. The steps of any method disclosed herein do not have to be performed in the exact order disclosed unless explicitly stated.

According to the present invention the transmission delay of a packet or cluster of packets may be considered to be made up of two independent parts self inflicted delay and cross traffic delay. Because a large packet i.e. having a large payload generally takes a longer time to transmit over a network link with limited capacity compared to a smaller packet the payload size variations from one image or frame to the next generally give rise to a payload size dependent delay variation which is referred to in the context of some embodiments of the present invention as self inflicted delay. Any delays that arise because of other network traffic cross traffic utilizing the links and queues of the network are referred to in the context of some embodiments of the present invention as the cross traffic delay. To the receiver the cross traffic delay may appear as quasi random and independent of the video traffic.

The present invention is based on separating the packet delay contributions into self inflicted and cross traffic delays estimating appropriate parameters describing the current conditions for the self inflicted delay and the cross traffic delay and determining an appropriate jitter buffer level based on the estimates.

In a video over IP system the encoder may operate on clusters of packets that make up each image. In the context of some embodiments of the present invention such a group of packets is referred to as a frame . When the arrival of a frame is completed at the receiver i.e. when all the packets included in the frame have arrived at the receiver the arrival time may be determined. Comparing the arrival time with the arrival time of a previously received frame provides a frame inter arrival time t.

In general each frame comprises some kind of timing information or time stamp information that indicates the production time of the frame. Such timing information may for example comprise the timestamp field in a real time transport protocol RTP header. Such timing information may provide a nominal temporal frame spacing between the present frame and a previously received frame denoted T. The nominal temporal frame spacing T may for example comprise the time between capturing the two frames from a camera. By determining a difference between the actual inter arrival time t and the nominal temporal frame spacing T a deviation measure or a frame network transit delay d for the currently received frame may be obtained. For example d t T.

In general each frame comprises payload size information L. The difference L between the payload size between the currently received frame and a previously received frame may be determined.

The self inflicted delay and the cross traffic delay described in the foregoing may be described as a part of d that can be attributed to L and a part that generally cannot be attributed to L. Namely in case of a relatively large value of L the current frame is larger than the previous frame and the current frame may generally be expected to be later than the previous frame. This would result in an increased t resulting in a larger value of d. On the other hand the cross traffic related delay generally affects t in ways that are difficult to correlate with L.

On receiving the complete frame with frame number k the frame delay d k t k T k t k t k 1 T k T k 1 may be calculated. The payload size difference is denoted L k L k L k 1 . The differential frame delay or frame network transit delay may be assumed to follow the model where w k represents the cross traffic related delay. It may be assumed that w k k 0 1 2 . . . is a sequence of independent realizations of a zero mean stochastic variable with variance . Hence the relation between d k and L may be represented by a straight line with offset A and slope B with a scattering around the line determined by .

In view of the foregoing description and with reference to in there is shown a schematic exemplifying straight line and scatter plot of the frame network transit delay d versus the frame payload size difference L. The quantities d and L may for example be given in units of ms and bytes respectively.

Given estimates of the parameters A B and respectively and knowledge of the largest expected L the worst case frame inter arrival time may be estimated. On the basis of this worst case frame inter arrival time a size of the jitter buffer may be set that mitigates the jitter.

In view of the above an embodiment of the present invention may comprise collecting measurements of d k and L k for a number of frames k estimating parameters A B and storing or estimating the largest expected frame size difference L and determining a jitter buffer level based on the estimates.

Referring now to there is shown a schematic view of a receiver according to an exemplifying embodiment of the present invention. The receiver is communicating in a wireless manner with a communications network via an air interface . The receiver comprises a data jitter buffer . The receiver may comprise a time measuring unit and a processing unit .

The communication between the receiver and the communications network may be performed in a non wired e.g. by means of wireless radiowave communications or a wired e.g. by means of electrical conductors or optical fibers or the like fashion.

Referring now to the receiver may be adapted to sequentially receive data packets from the communications network wherein frames are encoded into the data packets each frame comprising timestamp information T and payload size information L Each frame may alternatively or optionally comprise additional information. According to an embodiment of the present invention the buffer level of the data jitter buffer is determined on the basis of a first part of frame arrival delay related to payload size variation between frames and a second part related to the amount of crosstraffic in the communications network .

Optionally or alternatively the receiver may comprise a sensing unit which may be adapted to sense an indication of a discontinuous change in a parameter of the communications network . This parameter may for example be indicative of traffic conditions in the communications network .

Referring now to there is shown a schematic flow diagram of a method according to an exemplifying embodiment of the present invention. With reference to a receiver may be adapted to sequentially receive data packets from a communications network . The data packets may be such that frames are encoded in the data packets.

Referring now again to at step a frame payload size difference L may be determined for each frame by comparing L of the current frame with L of a previous frame.

At step a frame inter arrival time t may be determined by comparing the measured arrival time of the current frame with the measured arrival time of a previous frame.

At step a temporal frame spacing T may be determined by comparing T of the current frame with T of a previous frame.

At step a frame network transit delay d may be determined on the basis of the difference between t and T.

The method may further comprise for each frame in step estimating a set of parameters of a linear relationship between L and d on the basis of L and d for the current frame and L and d determined for at least one previous frame. With reference to a first parameter and a second parameter comprised in the set may be adapted to be indicative of a first part of frame arrival delay related to payload size variation between frames and a second part related to the amount of crosstraffic in the communications network .

The method may further comprise for each frame in step estimating a maximum frame payload size and an average frame payload size on the basis of L of the current frame and L of at least one previous frame.

The method may further comprise for each frame a step of determining the buffer level on the basis of the maximum frame payload size the average frame payload size and the parameters of the linear relationship.

Optionally the method may comprise a step comprising determining on the basis of T of the current frame and T of the previous frame whether the previous frame was transmitted earlier with regards to transmission order compared to the current frame.

Optionally the method may comprise a step comprising determining whether the absolute value of a difference between d for the current frame and at least one of the first part of frame arrival delay related to payload size variation between frames for respective previous frames exceeds a predetermined threshold value.

Optionally the method may comprise a step comprising sensing an indication of a discontinuous change in a parameter of the communications network. The parameter may for example be indicative of traffic conditions in the communications network. Optionally if an indication of a discontinuous change in such a parameter has been sensed at least one model parameter used in the estimation of the parameters of a linear relationship between L and d may be reset step .

In the following a method according to an exemplifying embodiment of the present invention is described in some detail.

The method of the exemplifying embodiment can be described using three phases inter arrival delay calculation parameter estimation and buffer level calculation each phase being carried out at least once each time arrival of a frame is completed i.e. when all the packets included in the frame have arrived at the receiver. Additionally there may be a reset phase carried out in the beginning of the method and also when otherwise found necessary. The phases are described in the following.

At time index k 0 all parameters and variables may be reset to suitable initial values. What constitutes a suitable initialization may vary depending on current communications network conditions and application.

In case the current frame has suffered from re ordering in other words if the current frame is earlier in transmission order sequence than the last processed frame the processing for the current frame may be stopped and the current frame may be discarded.

In other case a nominal inter arrival time is calculated using the timestamps of the current frame and a previously received frame . The actual inter arrival time is calculated . The frame network transit delay is calculated 

All of these times and time periods may be adjusted in order to use the same time scale e.g. milliseconds or sample periods.

A frame size difference is calculated . The average estimate for frame size is calculated 1 1 The estimate of the maximum frame size is calculated max 1 An extreme outlier identification may then be performed. Let 1 1 .

Next change detection may be performed in order to assess whether an abrupt change has occurred in the network. Change detection can be performed in many manners for example by utilizing a CUSUM test. In case an abrupt change is detected a suitable set of variables may be reset. For instance the Kalman covariance matrix M k k can be reset to its initial large value in order to facilitate a rapid re convergence to the new communication network conditions. Alternatively or optionally the noise estimates k and or m k can be reset.

The last phase in the exemplifying method comprises calculation of the desired buffer level square root over .

Referring now to there are shown schematic views of computer readable digital storage mediums according to exemplifying embodiments of the present invention comprising a DVD and a floppy disk On each of the DVD and the floppy disk there may be stored a computer program comprising computer code adapted to perform when executed in a processor unit a method according to the present invention or embodiments thereof as has been described in the foregoing.

Although only two different types of computer readable digital storage mediums have been described above with reference to the present invention encompasses embodiments employing any other suitable type of computer readable digital storage medium such as but not limited to a non volatile memory a hard disk drive a CD a flash memory magnetic tape a USB stick a Zip drive etc.

The receiver may comprise one or more microprocessors not shown or some other device with computing capabilities e.g. an application specific integrated circuit ASIC a field programmable gate array FPGA a complex programmable logic device CPLD etc. in order to perform operations such as estimating a set of parameters of a linear relationship between L and d. Such a microprocessor may alternatively or optionally be comprised in integrated with or be the processing unit of the receiver.

When performing steps of different embodiments of the method of the present invention the microprocessor typically executes appropriate software that is downloaded to the receiver and stored in a suitable storage area such as e.g. a Random Access Memory RAM a flash memory or a hard disk or software that has been stored in a non volatile memory e.g. a Read Only Memory ROM . Such a microprocessor or processing unit may alternatively or optionally be located externally relatively to the receiver and electrically connected to the receiver .

A computer program product comprising computer code adapted to perform when executed in a processor unit a method according to the present invention or any embodiment thereof may be stored on a computer e.g. a server adapted to be in communication with a receiver according to an exemplifying embodiment of the present invention. In this manner when loaded into and executed in a processor unit of the computer the computer program may perform the method. Such a configuration eliminates the need to store the computer program locally at the receiver. The communication between the computer and the receiver may be implemented in a wired fashion e.g. by means of Ethernet or in a non wired fashion e.g. by means of wireless infra red IR communications or other wireless optical communications or by means of wireless radiowave communications.

While the invention has been illustrated and described in detail in the appended drawings and the foregoing description such illustration and description are to be considered illustrative or exemplifying and not restrictive the invention is not limited to the disclosed embodiments. Other variations to the disclosed embodiments can be understood and effected by those skilled in the art in practicing the claimed invention from a study of the drawings the disclosure and the appended claims. The mere fact that certain measures are recited in mutually different dependent claims does not indicate that a combination of these measured cannot be used to advantage. Any reference signs in the claims should not be construed as limiting the scope.

