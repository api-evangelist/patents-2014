---

title: Method and apparatus for provisioning traversal using relays around network address translation (TURN) credential and servers
abstract: Various disclosed embodiments include methods and systems for provisioning traversal using relays around network address translation (TURN) credentials and servers for network address translation/firewall (NAT/FW) traversal via a Voice-over-Internet-protocol/Web Real-Time Communication (VoIP/WebRTC) signaling channel. The method comprises receiving, at a signaling gateway, a signaling message from a first electronic device (ED) when the first electronic device registers with the signaling gateway or sends other signaling messages for requesting a TURN credential. The signaling message comprises one or more signaling message parameters. The signaling message further comprises a request that the signaling gateway generate a TURN credential for the first electronic device, the TURN credential associated with the one or more signaling message parameters. The method comprises sending, from the signaling gateway, the TURN credential to the first electronic device.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09621518&OS=09621518&RS=09621518
owner: Futurewei Technologies, Inc.
number: 09621518
owner_city: Plano
owner_country: US
publication_date: 20140815
---
This application is related to U.S. patent application Ser. No. 14 142 465 filed on Dec. 27 2013 the content of which is hereby incorporated by reference in its entirety.

A Network Address Translation NAT device modifies an internet protocol IP header when a packet transits across the NAT device. NAT devices are widely deployed at home enterprise networks and the internet. NAT devices however break Voice over Internet Protocol VoIP calls.

Some firewalls are configured to block User Datagram Protocol UDP and only allow Hypertext Transfer Protocol HTTP TCP 80 or HTTP Secure HTTPS TCP 443 to pass usually for security reasons. Because voice packets are sent on UDP firewalls that block UDP also block voice traffic. To summarize both NAT and firewalls that block UDP can block media communication in VoIP and result in one way voice or no voice.

According to one embodiment there is provided a method for traversal using relays around network address translation TURN credential and server provisioning in a communication system where the communication system comprises a signaling gateway a TURN server and an electronic device. The method comprises receiving at the signaling gateway a signaling message from a first electronic device ED when the first electronic device registers with the signaling gateway or sends other signaling messages for requesting TURN credential. The signaling message comprises one or more signaling message parameters. The signaling message further comprises a request that the signaling gateway generate a TURN credential for the first ED. The TURN credential is associated with the one or more authentication message parameters. The method comprises sending from the signaling gateway the TURN credential to the first ED.

In another embodiment there is provided an electronic device for traversal using relays around network address translation TURN credential and server provisioning in a communication system where the communication system comprises a signaling gateway and a TURN server. The electronic device comprises a processor and memory coupled to the processor. The electronic device is configured to send to a signaling gateway a signaling message. The signaling message comprises one or more signaling message parameters. The signaling message further comprises a request that the signaling gateway generate a TURN credential for the first ED. The TURN credential is associated with the one or more signaling message parameters. The electronic device is configured to receive from the signaling gateway the TURN credential.

In another embodiment there is provided a signaling gateway. The signaling gateway comprises a processor and memory coupled to the processor. The signaling gateway is configured to receive a signaling message from a first electronic device ED . The signaling message comprises one or more signaling message parameters. The signaling message further comprises a request that the signaling gateway generate a TURN credential for the first ED. The TURN credential is associated with the one or more authentication message parameters. The signaling gateway is configured to send the TURN credential to the first ED.

An example NAT device is shown in where the NAT device translates the source IP port of a packet to a new value e.g. 10.0.1.1 6554 1.2.3.4 8877 as the packet transits across it. NAT devices can solve an Internet Protocol version 4 IPv4 address shortage problem by reusing private IP addresses. NAT devices also hide internal network topologies from outside for security protection. NAT devices however break Voice over Internet Protocol VoIP calls. The NAT breaks VoIP calls because the originating UE sends its private address un NATted as a media address in the signaling message when the call is being set up. Because private addresses are not routable in public networks media packets sent to a private address will be discarded by routers or switches on the path and do not reach the peer UE.

One solution to solve the above NAT firewall issue is by using ICE STUN TURN. illustrate simplified steps for ICE STUN TURN. As illustrated in during a first step a first UE collects its public and relay addresses by sending a request to a STUN or TURN server shown as a TURN server in . As illustrated in during a second step the first UE sends collected media candidates to the peer or a second UE . The peer or second UE collects its public and relay addresses by sending a request to the TURN server and sends collected media candidates to the first UE . As illustrated in during a third step the first and second UEs check media paths by sending connectivity check messages for each possible path and select a path that works.

ICE STUN TURN are among the most common NAT Firewall traversal solutions for P2P communication and have recently been adopted by the World Wide Web Consortium W3C and the IETF for Web Real Time Communication WebRTC as the required NAT traversal mechanism. WebRTC enables users to make voice or video calls with a web browser. Because browsers are readily available on most types of electronic devices desktop smart phone tablet pad etc. WebRTC is regarded as a disruptive technology because of its potential for large user bases and its ability to integrate voice video with web applications. Therefore a scalable secure and efficient ICE TURN STUN solution is desirable.

There are several drawbacks with existing ICE STUN TURN solutions. One drawback is TURN credential provisioning. For example the TURN standard defines a mechanism for user authentication using TURN long term credentials. When a UE sends a request to the TURN server the TURN server challenges the UE with a random value and the UE must send an authentication code computed with the shared credential to authenticate itself. This is critical for security. Otherwise hackers can send a flood of requests to exhaust resources on the TURN server e.g. relay addresses or table entries.

However current standards do not specify how to provision the long term credential to UEs. Common practices include 

Several approaches have been proposed recently to IETF and other standard bodies regarding TURN credential management.

Because TURN messages are often sent in clear text it is possible for an attacker or 3party to find user call information by tracking the user name in TURN messages. This may reveal the user s call time call destination IP call duration etc. It is possible to reveal user call ID if attackers use active attack techniques e.g. call a user first and analyze the TURN message from the user to find his TURN user name etc. Therefore it may be desirable to change the TURN user name regularly. For example it is desirable to change the TURN user name to a different user name for anonymous calls. Current approaches do not allow the user to retrieve a new TURN user name for anonymous calls or change user names regularly to avoid privacy issues.

According to the present disclosure a method to provision TURN credentials e.g. user name password using a VoIP WebRTC signaling channel is provided. The method provides a mechanism to manage credentials between the signaling gateway e.g. the VoIP WebRTC signaling gateway and the TURN server. The method provides a mechanism to handle users for different realms. The method provides a mechanism to control credential expiration time and credential revocation. The method provides a mechanism to renew a credential anytime by the ED e.g. before anonymous calls to protect user privacy. The method provides a mechanism to retrieve TURN servers dynamically e.g. based on network condition or security issues.

An embodiment of a system for provisioning TURN credentials and servers for NAT FW traversal via a VoIP WebRTC signaling channel in accordance with the present disclosure is described with reference to the call flow diagram of . The system includes a first electronic device ED a first NAT Firewall a signaling gateway such as a VoIP WebRTC signaling gateway a second NAT Firewall a TURN server and a second ED . The signaling gateway may integrate signaling media and TURN functions together. The first and second EDs are configured to operate and or communicate in the system . For example the EDs are configured to transmit and or receive wireless signals or wired signals. Each ED represents any suitable end user device and may include such devices or may be referred to as a user equipment device UE wireless transmit receive unit WTRU mobile station fixed or mobile subscriber unit pager cellular telephone personal digital assistant PDA smartphone laptop computer touchpad wireless sensor or consumer electronics device. An example signaling protocol used in the system is Session Initiation Protocol over WebSocket SIP over WS .

The signaling gateway may include an operating system that provides executable program instructions for the general administration and operation of that gateway and typically will include a computer readable medium storing instructions that when executed by a processor of the signaling gateway allow the signaling gateway to perform its intended functions. Suitable implementations for the operating system and general functionality of the signaling gateway is known or commercially available and are readily implemented by persons having ordinary skill in the art.

When the first ED registers with the signaling gateway such as a VoIp signaling server e.g. Proxy Call Session Control Function P CSCF or a WebRTC signaling server e.g. eP CSCF it sends a REGISTER e.g. REGISTER for SIP SIP over WS or other registration or authentication message that comprises a TURN credential provision request and one or more parameters such as a tun cred parameter to request the signaling gateway to provide TURN credentials to the first ED step . The format of the tun cred parameter is 

When the signaling gateway receives the registration message with the tun cred parameter it validates the tun cred parameter and selects the realm and TURN server for the realm. For example the signaling gateway may determine that the format of the realm is recognized that the realm is recognized that a value of the expiration time is not negative or infinite etc. The realm may be a string used to describe the server or a context within the server and may tell a client device which username and password combination to use to authenticate requests. The signaling gateway then generates a user portion of the TURN credential TURN USR step . The user portion of the TURN credential TURN USR may be in the following format 

The signaling gateway identifies a pre shared key k for the selected TURN server and generates a password portion of the TURN credential TURN PWD by hashing the user portion of the credential using the pre shared key step . The password portion of the TURN credential TURN PWD may be in the following format 

The signaling gateway sends the generated TURN credential TURN USR and TURN PWD to the first ED in a response to the registration message e.g. 200 OK for SIP step . The result may be encoded as tur cred usr name realm exp val revoke tur pwd turn password. Those of skill in the art will recognize that other formats may also be used.

The first ED receives the response for registration with TURN credential from the signaling gateway and uses the TURN credential to request a TURN relay address. The first ED uses the entire string of TURN USR as the TURN user name that is it includes the user name realm exp value revoke in its allocation Alloc request and uses the TURN PWD to generate the message authentication code MAC for the Alloc request step .

The TURN server receives the Alloc request from the first ED parses the user string e.g. user name realm exp value revoke and extracts the TURN user name the realm the expiration time and the revoke keyword step . The TURN server validates the extracted values and discards the request if the parameters are invalid e.g. unknown or unrecognized format of the realm unknown or unrecognized realm negative expiration time etc. . The TURN server identifies the pre shared key from the realm and calculates the TURN PWD by hashing the received TURN user string in the Alloc request with the pre shared key step . The TURN server uses the TURN PWD generated by hashing the received TURN user string in the Alloc request with the pre shared key to validate the received message. If the user string in the Alloc request includes the revoke keyword the TURN server revokes previously received unexpired credentials e.g. using a local cache to record unexpired credentials for a user and the status of the credential . If a credential is revoked it is rejected by the TURN server . After the received message is validated the TURN server sends an Alloc response including a relay address to the first ED step .

If the first ED receives a relay address from TURN server it proceeds to make calls using existing protocols or procedures e.g. the first ED sends an INVITE request step to the signaling gateway to initiate a call. The signaling gateway receives the INVITE request from the first ED and checks whether the call can proceed. If the call cannot proceed e.g. the called party e.g. the second ED is not registered or not online the signaling gateway returns an error code to the first ED not shown and terminates the call.

If the call can proceed the signaling gateway forwards the INVITE message to the called party e.g. the second ED step . The called party e.g. the second ED receives the INVITE message processes the INVITE message and sends a response message e.g. a 200 OK message to the signaling gateway . The signaling gateway forwards the response message to the first ED step . Each of the EDs is behind a respective symmetric NAT Firewall .

The first ED receives the response message and sends a ChannelBind request to the TURN server to reserve a channel step . The TURN server receives the ChannelBind request and sends a ChannelBind response to the first ED step . After the channel is set up the first and second EDs can exchange messages for a connectivity check e.g. using STUN binding requests . For example the TURN server receives data from the first ED via a connectivity check request message and relays the data to the second ED step . The second ED receives the data and responds via a connectivity check response message. The TURN server receives the connectivity check response message and relays the data therein to the first ED step . Thereafter the first and second EDs find a media path and start sending media packets to each other such as via Real time Transport Protocol RTP step .

The signaling gateway may be configured to dynamically renew a credential e.g. before anonymous calls or to avoid using one credential for too long to protect user privacy. To receive a new TURN user name and password before the next registration cycle e.g. before making an anonymous call the first ED sends an update request such as an OPTION or INFORM request to the signaling gateway that includes a parameter such as the tur cred parameter as described above with respect to step . The format of the tur cred parameter is the same as explained above with respect to . The signaling gateway validates the user request and generates anew TURN credential e.g. TURN USR and TURN PWD as explained above with respect to . The signaling server sends the new credential back to the first ED in the response to the OPTION or INFORM request e.g. 200 OK in SIP step . The first ED receives the new TURN credential from the signaling gateway and uses the new TURN credential to make anonymous calls.

Alternatively or in addition the signaling gateway may be configured to support re selection of a TURN server based on a network condition e.g. quality of service QoS or a security condition. For example if the first ED detects a TURN server issue e.g. QoS or security such as the previously received TURN server not responding to its requests the first ED may send an update request such as the OPTION or INFORM request to the signaling gateway that includes a parameter such as the tur serv parameter in step . The update request may contain a reason code that indicates why the first ED needs a new TURN server. The signaling gateway validates the user request selects a new TURN server or TURN servers based on its knowledge of the operational status of other TURN servers in the communication system and the feedback from the first ED and sends a new TURN server list back to the first ED in the response to the OPTION or INFORM request e.g. 200 OK in SIP step . The first ED receives the new TURN server list from the signaling gateway and selects a new TURN server.

The storage device may include for example an OS a communication protocol stack which controls data communication based on IP packets a database control programs for example call control protocols such as H.323 SIP or the like which defines voice communication procedures e.g. making and receiving calls and a server program which defines processing procedures for the NAT and firewall traversal method.

The control device may be a general purpose special purpose or digital signal processor and may be a plurality of processors or combination of such processors. The control device includes functionality to perform signal coding data processing input output processing and or any other functionality enabling the signaling gateway to operate in the system or the system . In addition the control device is coupled to the storage device operable for storing and retrieving data. Any suitable type of memory storage device may be included such as random access memory RAM read only memory ROM hard disk subscriber identity module SIM card a memory stick a secure digital SD memory card and the like.

The electronic device may include one or more other components devices or functionalities not shown . It will be understood that the electronic device may include fewer or more of the foregoing described elements.

The processor may be a general purpose special purpose or digital signal processor and may be a plurality of processors or combination of such processors. The processor includes functionality to perform signal coding data processing power control input output processing and or any other functionality enabling the electronic device to operate in the system or the system . The processor is coupled to the transceiver which is coupled to the antenna element . It will be understood that the processor and the transceiver may be separate components or integrated together. Similarly the antenna element may be a single element or a number of elements multiple antennas or elements .

The transceiver is configured to modulate the data or signals for transmission by the antenna and demodulate the data or signals received by the antenna .

The processor is coupled to the one or more input output devices including ports or busses operable for inputting outputting user data. In addition the processor is coupled to memory operable for storing and retrieving data. Any suitable type of memory storage device may be included such as random access memory RAM read only memory ROM hard disk subscriber identity module SIM card a memory stick a secure digital SD memory card and the like.

Other elements or devices that might be included within the electronic device will not be described herein unless necessary or relevant to an understanding of the present disclosure.

The signaling message parameters are validated at the signaling gateway at step . For example the registration message is validated by the signaling gateway step . To illustrate the signaling gateway validates the realm parameter realm if present against its security policies and discards requests with an invalid realm value. If the realm parameter is not present the signaling gateway chooses a default realm. The signaling gateway validates the expiration parameter exp if present and discards requests with an invalid value. If the expiration parameter is not present the signaling gateway chooses an expiration value such as an expiration value of the authentication message e.g. the REGISTER message .

The TURN credential is sent to the first electronic device by the signaling gateway at step . For example the signaling gateway sends the TURN credential in its response message 200 OK to the first electronic device step .

One of the advantages of the present disclosure is that the signaling gateway authenticates users during the registration process ensuring that only authenticated users can receive TURN credentials. Other approaches like OAuth Token or REST API use web servers to distribute TURN credentials. Web servers may or may not authenticate users. For example in a 3GPP defined WebRTC architecture the web server only hosts WebRTC JS code but will not authenticate users when an IMS identity is used to access the WebRTC service. In such case the signaling gateway based approach is more secure than the web server based approach.

Another advantage of the present disclosure is that the signaling gateway based approach reuses existing ICE TURN protocols with little to no change or addition of new interfaces. This approach does not need extra steps to verify TURN credentials e.g. steps to verify token in the OAuth solution thereby needing less overhead to implement and operate.

Another advantage of the present disclosure is that the signaling gateway based approach allows the ED to retrieve new credentials for anonymous calls to avoid call information leakage via analysis of the TURN user name thereby providing more protection on user privacy than other approaches.

In some embodiments some or all of the functions or processes of the one or more of the devices are implemented or supported by a computer program that is formed from computer readable program code and that is embodied in a computer readable medium. The phrase computer readable program code includes any type of computer code including source code object code and executable code. The phrase computer readable medium includes any type of medium capable of being accessed by a computer such as read only memory ROM random access memory RAM a hard disk drive a compact disc CD a digital video disc DVD or any other type of memory.

It may be advantageous to set forth definitions of certain words and phrases used throughout this patent document. The terms include and comprise as well as derivatives thereof mean inclusion without limitation. The term or is inclusive meaning and or. The phrases associated with and associated therewith as well as derivatives thereof mean to include be included within interconnect with contain be contained within connect to or with couple to or with be communicable with cooperate with interleave juxtapose be proximate to be bound to or with have have a property of or the like.

While this disclosure has described certain embodiments and generally associated methods alterations and permutations of these embodiments and methods will be apparent to those skilled in the art. Accordingly the above description of example embodiments does not define or constrain this disclosure. Other changes substitutions and alterations are also possible without departing from the spirit and scope of this disclosure as defined by the following claims.

