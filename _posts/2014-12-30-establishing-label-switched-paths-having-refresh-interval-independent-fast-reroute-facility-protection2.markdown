---

title: Establishing label switched paths having refresh interval independent fast reroute facility protection
abstract: In one example, techniques of this disclosure may enable a point of local repair (PLR) network device to signal availability of link protection or node protection to a merge point (MP) network device and enable a network device to actively determine whether or not it is a merge point router. Based on whether or not the network device determines it is a MP, the network device may selectively clean up LSP states when there is an upstream link or node failure. The RSVP-TE protocol may be extended to enable a network device to send a tear down message to a downstream router, which may enable the downstream router to conditionally delete locale LSP state information. In some instances, a PLR network device may directly send a tear down message to a MP network device even though the PLR network device may not have a working bypass LSP.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09590894&OS=09590894&RS=09590894
owner: Juniper Networks, Inc.
number: 09590894
owner_city: Sunnyvale
owner_country: US
publication_date: 20141230
---
This application claims the benefit of India Patent Application No. 5340 CHE 2014 filed Oct. 27 2014 the entire content of which is incorporated herein by reference.

The disclosure relates to packet based computer networks and more particularly to forwarding packets within computer networks.

Routing devices within a network often referred to as routers maintain routing information that describes available routes through the network. Upon receiving an incoming packet the routers examine information within the packet and forward the packet in accordance with the routing information. In order to maintain an accurate representation of the network routers exchange routing information in accordance with one or more defined routing protocols such as the Open Shortest Path First OSPF or the Intermediate System to Intermediate System ISIS .

Multi protocol Label Switching MPLS is a mechanism used to engineer traffic patterns within Internet Protocol IP networks. By using MPLS a source device can request a path through a network i.e. a Label Switched Path LSP . An LSP defines a distinct path through the network to carry MPLS packets from the source device to a destination device. A short label associated with a particular LSP is affixed to packets that travel through the network via the LSP. Routers along the path cooperatively perform MPLS operations to forward the MPLS packets along the established path. LSPs may be used for a variety of traffic engineering purposes including bandwidth management and quality of service QoS . A packet may be a formatted set of data.

A variety of protocols exist for establishing LSPs. For example one such protocol is the label distribution protocol LDP . Another type of protocol is a resource reservation protocol such as the Resource Reservation Protocol with Traffic Engineering extensions RSVP TE . RSVP TE uses constraint information such as bandwidth availability to compute paths and establish LSPs along the paths within a network. RSVP TE may use bandwidth availability information accumulated by a link state interior routing protocol such as the Intermediate System Intermediate System ISIS protocol or the Open Shortest Path First OSPF protocol.

Head end routers of an LSP are commonly known as ingress routers while routers at the tail end of the LSP are commonly known as egress routers. Ingress and egress routers as well as intermediate routers along the LSP that support MPLS are referred to generally as label switching routers LSRs . A set of packets to be forwarded along the LSP is referred to as a forwarding equivalence class FEC . A plurality of FECs may exist for each LSP although there may in some examples be only one active LSP for any given FEC. Typically a FEC definition includes the IP address of the destination for the packets traversing the LSP e.g. a destination IP address within headers of packets transported by the LSP. In general each router along the LSP maintains FEC to Nexthop Label Forwarding Entry mapping that associates a FEC with an incoming label and an outgoing label. The ingress LSR referred to as a label edge router LER uses label information propagated upstream by each LSR along a path from the egress LER to affix a label to each packet destined for the FEC thereby admitting the packet to the LSP. More specifically transport LSRs along the path use MPLS protocols to receive MPLS label mappings from downstream LSRs and to advertise MPLS label mappings to upstream LSRs. When an LSR receives an MPLS packet from an upstream router the LSR performs a lookup in the context and swaps the MPLS label according to the information in its forwarding table based on the lookup and forwards the packet to the appropriate downstream LSR or egress LER. The egress LER removes the label from the packet and forwards the packet to its destination in accordance with non label based packet forwarding techniques. If Penultimate Hop Popping PHP is enabled for the LSP then the penultimate LSR removes the label from the packet before forwarding to Egress LER.

In general this disclosure describes techniques for scaling an MPLS protocol such as RSVP TE in a manner that may be capable of establishing and maintaining a high volume of LSPs such as multiple hundreds of thousands of LSPs. For example in one example implementation a refresh interval of the MPLS protocol is extended such that the number of messages exchanged between nodes in the LSP is reduced. However extending the refresh interval may result in a build up of stale state information among the network devices in an LSP. In order to extend the refresh interval while reducing the build up of stale state information on the nodes this disclosure describes additional example implementations utilizing various modifications to the MPLS protocol.

For example this disclosure describes example implementations that enable a point of local repair PLR router to signal availability of link protection or node protection to a merge point MP router and that enable a router to actively determine whether or not it is a merge point router. Based on whether or not the router determines it is a merge point router the router may selectively clean up LSP states stored by the router when there is an upstream link or node failure.

As another example techniques of this disclosure may provide a set of extensions to the MPLS protocol such as RSVP TE that may enable a router to send a tear down message to a downstream router which may enable the downstream router to conditionally delete locale state information for the LSP. In some instances a PLR router may directly send a tear down message to a merge point router even though the PLR router may not have a working bypass LSP and or may not have already refreshed backup LSP state information. According to the techniques of this disclosure the RSVP TE extensions may be backwards compatible with routers along the LSP that do not support these modifications to the RSVP TE protocol.

In one example a method includes receiving with a first network device and from a second network device a first resource reservation path message for establishing a label switched path between the second network device and a third network device by way of the first network device such that the first network device is positioned between the second network device and the third network device along the label switched path wherein the first resource reservation request message specifies whether local protection is desired for the label switched path and sending by the first network device the first resource reservation path message to a next hop network device toward the third network device along the label switched path. The method may also include responsive to determining that the first resource reservation request message specifies that local protection is desired and responsive to receiving a resource reservation resv message from the next hop network device establishing by the first network device a bypass label switched path between the first network device and a merge point network device along the label switched path wherein the bypass label switched path bypasses a protected network resource positioned along the label switched path between the first network device and the merge point network device generating by the first network device a second resource reservation path message that specifies that local protection has been established for the label switched path at the first network device and sending by the first network device and to the next hop network device along the label switched path the second resource reservation path message.

In another example a first network device includes one or more network interface cards and a control unit. The control unit is configured to receive from a second network device using at least one of the one or more network interface cards a first resource reservation path message for establishing a label switched path between the second network device and a third network device by way of the first network device such that the first network device is positioned between the second network device and the third network device along the label switched path wherein the first resource reservation request message specifies whether local protection is desired for the label switched path and send the first resource reservation path message to a next hop network device toward the third network device along the label switched path. The control unit is further configured to responsive to determining that the first resource reservation request message specifies that local protection is desired and responsive to receiving a resource reservation resv message from the next hop network device establish a bypass label switched path between the first network device and a merge point network device along the label switched path wherein the bypass label switched path bypasses a protected network resource positioned along the label switched path between the first network device and the merge point network device generate a second resource reservation path message that specifies that local protection has been established for the label switched path at the first network device and send to the next hop network device along the label switched path using at least one of the one or more network interface cards the second resource reservation path message.

In another example a computer readable storage medium is encoded with instructions that when executed cause one or more programmable processors of a first network device to receive from a second network device a first resource reservation path message for establishing a label switched path between the second network device and a third network device by way of the first network device such that the first network device is positioned between the second network device and the third network device along the label switched path wherein the first resource reservation request message specifies whether local protection is desired for the label switched path and send the first resource reservation path message to a next hop network device toward the third network device along the label switched path. The instructions may further cause the one or more processors to responsive to determining that the first resource reservation request message specifies that local protection is desired and responsive to receiving a resource reservation resv message from the next hop network device establish a bypass label switched path between the first network device and a merge point network device along the label switched path wherein the bypass label switched path bypasses a protected network resource positioned along the label switched path between the first network device and the merge point network device generate a second resource reservation path message that specifies that local protection has been established for the label switched path at the first network device and send to the next hop network device along the label switched path the second resource reservation path message.

In another example a method includes receiving by a first network device and from a second network device a conditional pathtear message wherein the second network device is positioned upstream from the first network device along a label switched path in a network. The method may also include responsive to determining by the first network device that the first network device is a node protecting merge point network device for the second network device along the label switched path retaining with the first network device state information for the label switched path and sending from the first network device to a third network device a resource reservation path message that specifies local protection and node protection of the label switch path are no longer available at the second network device wherein the third network device is a nexthop for the first network device in a downstream direction along the label switched path.

In another example a network device includes one or more network interface cards and a control unit. The control unit is configured to receive from a second network device using at least one of the one or more network interface cards a conditional pathtear message wherein the second network device is positioned upstream from the first network device along a label switched path in a network. The control unit is further configured to responsive to determining that the first network device is a node protecting merge point network device for the second network device along the label switched path retain state information for the label switched path and send to a third network device and using at least one of the one or more network interface cards a resource reservation path message that specifies local protection and node protection of the label switch path are no longer available at the second network device wherein the third network device is a nexthop for the first network device in a downstream direction along the label switched path.

In another example a method includes determining by a network device that a hello session with a previous hop network device is down wherein the network device and the previous hop network device a part of a label switched path in a network and determining by the network device whether the network device is a merge point. The method may also include responsive to determining that the hello session is down and determining that the network device is not the merge point removing by the network device state information for the label switched path stored at the network device and sending by the network device to a downstream network device a conditional pathtear message.

In another example a network device includes one or more network interface cards and a control unit. The control unit is configured to determine that a hello session with a previous hop network device is down wherein the network device and the previous hop network device a part of a label switched path in a network and determine whether the network device is a merge point. The control unit is further configured to responsive to determining that the hello session is down and determining that the network device is not the merge point remove state information for the label switched path stored at the network device and send to a downstream network device and using at least one of the one or more network interface cards a conditional pathtear message wherein the downstream network device is positioned downstream from the network device along the label switched path

In another example a method includes receiving with a network device and from a previous hop network device a pathtear message for a label switched path in a network wherein the network device and the previous hop network device are label switched routers along the label switched path responsive to determining by the network device that at least one of a next hop network device of the network device or a link between the network device and the next hop network device has failed sending by the network device to a next next hop network device of the network device in a downstream direction along the label switched path a remote pathtear message instructing the next next hop network device to remove state information for the label switched path and responsive to determining that a link between the network device and the next hop has failed sending by the network device to the next hop network device the remote pathtear message instructing the next hop network device to remove the state information for the label switched path.

In another example a network device includes one or more network interface cards and a control unit. The control unit is configured to receive from a previous hop network device and using at least one of the one or more network interface cards a pathtear message for a label switched path in a network wherein the network device and the previous hop network device are label switched routers along the label switched path responsive to determining that a next hop network device of the network device has failed send to a next next hop network device of the network device in a downstream direction along the label switched path and using at least one of the one or more network interface cards a remote pathtear message instructing the next next hop network device to remove state information for the label switched path and responsive to determining that a link between the network device and the next hop has failed send to the next hop network device the remote pathtear message instructing the next hop network device to remove the state information for the label switched path.

In another example a method includes receiving by a first network device and from a second network device a remote pathtear message wherein the first network device and the second network device are part of a label switched path in a network determining by the first network device whether the first network device is a merge point for the second network device and responsive to determining that the first network device is the merge point for the second network device removing by the first network device path information for the label switched network stored by the first network device.

In another example a first network device includes one or more network interface cards and a control unit. The control unit is configured to receive from a second network device and using at least one of the one or more network interface cards a remote pathtear message wherein the first network device and the second network device are part of a label switched path in a network determine whether the first network device is a merge point for the second network device and responsive to determining that the first network device is the merge point for the second network device remove path information for the label switched network stored by the first network device.

In another example a method includes receiving by a network device and from an upstream network device a resource reservation path message to establish a label switched path wherein the upstream network device is positioned upstream from the network device along the label switched path and determining by the network device based on the resource reservation path message whether the network device is a candidate merge point for the label switched path. The method may also include determining by the network device whether there is a remote Hello session between the network device and the upstream device and responsive to determining that the network device is a candidate merge point and determining that there is the remote Hello session with the upstream device determining by the network device that the network device is a merge point for the upstream device.

In another example a network device includes one or more network interface cards and a control unit. The control unit is configured to receive from an upstream network device and using at least one of the one or more network interface cards a resource reservation path message to establish a label switched path wherein the upstream network device is positioned upstream from the network device along the label switched path and determine based on the resource reservation path message whether the network device is a candidate merge point for the label switched path. The control unit is further configured to determine whether there is a remote Hello session between the network device and the upstream device and responsive to determining that the network device is a candidate merge point and determining that there is the remote Hello session with the upstream device determine that the network device is a merge point for the upstream device.

In another example a computer readable storage medium is encoded with instructions that when executed cause one or more programmable processors of a first network device to receive from an upstream network device a resource reservation path message to establish a label switched path wherein the upstream network device is positioned upstream from the network device along the label switched path and determine based on the resource reservation path message whether the network device is a candidate merge point for the label switched path. The instructions may further cause the one or more processors to determine whether there is a remote Hello session between the network device and the upstream device and responsive to determining that the network device is a candidate merge point and determining that there is a remote Hello session with the upstream device determine that the network device is a merge point for the upstream device.

The details of one or more examples are set forth in the accompanying drawings and the description below. Other features objects and advantages will be apparent from the description and drawings and from the claims.

While not shown in the example of network system may include additional service provider networks subscriber networks and other types of networks such as access networks private networks or any other type of network commonly employed to deliver one or more services such as data service Internet Protocol Television IPTV service voice over Internet Protocol VoIP service video telephony service or any other type of service to subscriber networks.

As shown in routers operate a label switching routers LSR and utilize an MPLS protocol communicate label information so as to establish label switched path LSP . For purposes of example techniques of this disclosure are described with respective to RSVP TE which represents an exemplary MPLS protocol in which LSRs allocate labels and communicate label information to other LSRs. Example details of RSVP are described in Awduche D. Berger L. Gan D. Li T. Srinivasan V. and G. Swallow RSVP TE Extensions to RSVP for LSP Tunnels RFC 3209 December 2001 the entire contents of which is incorporated herein by reference. Other example MPLS protocols for distribution of MPLS labels include the Label Distribution Protocol LDP and BGP when used to distribute label mapping information. Example details of these protocols are described in Andersson L. Ed. Minei I. Ed. and B. Thomas Ed. LDP Specification RFC 5036 October 2007 and Rekhter Y. and E. Rosen Carrying Label Information in BGP 4 RFC 3107 May 2001 the contents of each of which are incorporated herein by reference.

In the example of router A is a point of local repair PLR router along label switched path LSP . In the example of PLR router A is a transit router i.e. an intermediate router along LSP and is neither an ingress router nor an egress router of LSP . In this example PE router A is the ingress router of LSP and PE router B is the egress router of LSP . LSP extends along respective paths that pass through PLR router A links A C links and router D.

PE routers and routers represent any network device that routes or otherwise forwards traffic through network and that applies label swapping operations to the network traffic. Typically routers represent a L3 packet switching device that operates at L3 to exchange routing information using a routing protocol such as an Interior Gateway Protocol IGP describing a current topology of network . Routers process this routing information selecting paths through its representation of the topology of network to reach all available destinations to generate forwarding information. In other words routers may reduce these paths to so called next hops which identify interfaces to which to forward traffic destined for a particular destination where the forwarding information includes this list of next hops. Routers install the forwarding information in a forwarding plane of the respective router whereupon the forwarding plane forwards received traffic in accordance with the forwarding information.

As shown in PLR router A may have previously computed and signaled bypass LSP as a backup path for protecting router B such as by using the Resource Reservation Protocol with Traffic Engineering extensions RSVP TE . In this example PLR router A is the point of local repair for bypass LSP and router C is the merge point MP for bypass LSP . Bypass LSP is a tunnel that provides node protection for router B between router A and router C such that if router B should fail PLR router A can establish a backup LSP over bypass LSP and send the network traffic received along an existing LSP through the backup LSP. Router A may establish bypass LSP in accordance with MPLS fast reroute techniques as described in P. Pan Fast Reroute Extensions to RSVP TE for LSP Tunnels Network Working Group RFC 4090 May 2005 the entire contents of which is incorporated by reference herein.

For example as the point of local repair and ingress of bypass LSP router A may establish bypass LSP to protect one or more other existing LSPs such as LSP that traverse at least router A and router B and do not traverse router E. In some examples router A may establish bypass LSP upon successful establishment of LSP . For example router A may receive an RSVP TE RESV from downstream router B and the RSVP TE PATH previously received from upstream router A for LSP contained local protection desired flag set in RSVP TE SESSION ATTRIBUTES object. After router A establishes bypass LSP router A maintains forwarding information in a data plane of router A that allows router A to send traffic through bypass LSP if router B fails.

Responsive to detecting a failed resource between PLR router A and merge point router C e.g. failure of router B in the example of PLR router A may perform a reroute action to reroute for the traffic LSP onto a previously established bypass LSP . For example PLR router A may update its stored forwarding state to change the primary next hops for LSP such as by setting a next hop for bypass LSP as the primary next hop for traffic received for LSP .

RFC 4090 describes a facility backup method which provides link or node protection by pre calculating a bypass path for the set of LSPs traversing a link. For example responsive to failure of router B PLR router A redirects traffic over bypass LSP via a backup LSP from PLR router A to MP router C. Because of the soft state nature of RSVP PLR router A is also expected to signal the backup LSPs along the bypass LSP towards MP router C. These backup LSPs help in maintaining state across PLR router A and MP router C.

When attempting to scale RSVP TE to establish and maintain a large number of LSPs e.g. 50 000 LSPs 100 000 LSPs 500 000 LSPs etc. it may be become difficult for routers to handle the rate of RSVP protocol messages that would be required to handle this large number of LSPs. The rate of RSVP protocol messages is influenced by both triggered and periodic messages. Triggered messages consist of initial PATH RESV messages during LSP setup and PATH RESV messages during backup LSP establishment after local repair e.g. redirection of traffic over bypass LSP following a failure of router B .

One mechanism to mitigate the RSVP message rate problem is to increase the refresh interval of LSP states so that the routers may prioritize backup LSP establishment and other triggered messages. If a large refresh time can be complemented with RSVP refresh reduction extensions defined in RFC 2961 then RSVP TE implementation can these apply extensions to avoid rapid retransmits to reliably convey any new state or state change to neighboring router and avoid re sending the entire message during refresh to neighboring router. Even though the combination of large refresh time and reliable message delivery is one potential solution described herein there are additional challenges if the technique is applied to facility protection specified in RFC 4090 and the additional challenges are also addressed herein.

In examples where there is a large number of LSPs from PLR router A to merge point MP router D that transit routers C and D the refresh interval may be configured to be large e.g. on the order of minutes as opposed to seconds and refresh reduction extensions are enabled on all routers . In the example shown in node protection has been configured for the LSPs and the LSPs are protected by each router in the following way 

Typically if link B fails the following is the sequence of events that is expected to occur for all protected LSPs under normal conditions 

However this sequence of events may result in a number of additional challenges. For example if the protected LSP on router C times out before router D receives signaling for the backup LSP then router D would receive a PathTear message from router C prior to receiving signaling for the backup LSP thus resulting in deleting the LSP state for LSP . As another example if upon the failure of link B router C is to keep state until its timeout then with long refresh interval e.g. of at least one minute this may result in a large amount of stale state on router C. Alternatively if upon the failure of link B router C is to delete the state and send a PathTear message to router D router D would delete the state information thus deleting LSP from router D. As yet another example if router A attempts to tear down LSP after router B performs local repair and re directs the traffic for LSP but before router B create backup state for LSP and triggers sending of backup LSP state to router D then router B may receive the PathTear message before creating the backup state for the LSP and may delete the LSP state from its state database. As another example if router B fails to perform local repair then router B will delete the LSP state from its state database without informing router D.

In accordance with techniques of this disclosure routers and or routers may be configured to operate according to modified MPLS protocol signaling mechanisms such as a modified RSVP TE so as to reduce or eliminate such problems. As one example the techniques of this disclosure may enhance facility protection method defined in RFC 4090 by for example introducing a merge point determination mechanism that enables the point of local repair to signal availability of link or node protection to the MP. The techniques may also provide techniques for handling upstream link or node failures by cleaning up LSP states if the node has not determined that it is a merge point by using the merge point determination mechanism. Moreover the techniques of this disclosure may also introduce extensions to enable a router to send tear down message to downstream router that enables the receiving router to conditionally delete its local state. In some examples the techniques of this disclosure may also enhance facility protection by allowing a point of local repair to directly send tear down message to merge point without requiring the point of local repair to either have a working bypass LSP or have already refreshed backup LSP state. According to the techniques of this disclosure the RSVP TE extensions may be backwards compatible with routers along the LSP that do not support these modifications to the RSVP TE protocol. In this way techniques of this disclosure may enable support for longer refresh intervals such as intervals that are longer than or equal to one minute in duration including two minutes five minutes 10 minutes etc. as specified in the RSVP PATH message.

Routing component primarily provides an operating environment for control plane protocols . For example one or more IGP routing protocols such as Intermediate System to Intermediate System ISIS routing protocol A or the Open Shortest Path First OSPF routing protocol B maintain routing information to reflect the current topology of a network and other network entities to which router is connected. In particular IGPs update routing information to accurately reflect the topology of the network and other entities. Router may include other example routing protocols such as Border Gateway Protocol BGP .

Routing component generates and programs forwarding component with FIB that associates network destinations with specific next hops and corresponding interfaces ports of IFCs in accordance with routing information . Routing component may generate FIB in the form of a radix tree having leaf nodes that represent destinations within the network for example.

Based on FIB forwarding component forwards packets received from inbound links A N to outbound links A N that correspond to next hops associated with destinations of the packets. In one example forwarding component is a rich and dynamic shared forwarding plane optionally distributed over a multi chassis router. Moreover forwarding component may be provided by dedicated forwarding integrated circuits normally associated with high end routing components of a network router. Further details of one example embodiment of router can be found in U.S. Pat. No. 8 339 959 issued Dec. 25 2012 entitled STREAMLINED PACKET FORWARDING USING DYNAMIC FILTERS FOR ROUTING AND SECURITY IN A SHARED FORWARDING PLANE the entire contents of which are incorporated herein by reference.

As shown in protocols executing within routing component includes one or more MPLS protocols for establishing a LSP which may be accumulated by IGPs . For example RSVP TE may generate and maintain a traffic engineering database TED including bandwidth reservations for paths associated with MPLS LSPs. Constrained Shortest Path First CSPF process computes a shortest path or paths for an MPLS LSP based on specified constraints and bandwidth availability information associated with the links within the network. IGPs may in turn advertise the calculated bandwidth availability information in TED to other peer routers. As another example constrained Label Distribution Protocol CR LDP may send and receive label mapping messages for establishing a LSP.

Router receives RSVP TE PATH messages from PE routers A for setting up LSP . In response RSVP TE of router forwards the RSVP TE PATH messages to router B and also sends RSVP TE RESV messages back to PE router A confirming the reservation of the requested bandwidth. RSVP TE may also inform IGPs which in turn can update TED with current available bandwidth information. IGPs may also forward the updated current available bandwidth information to other IGP peers. RSVP TE may also store MPLS labels to FIB for LSP .

Subsequent to LSP being established router may in some examples detect a failure condition of a link such as link A of . For example connectivity fault detection module may run a session on link A and can detect when link A fails. In some examples the link A is managed by the kernel of router and the routing protocol daemon RPD and or RSVP TE is informed by the kernel if there is any change. RSVP TE will react depending on its configuration. In the example of a one hop session IGP at a transit router adjacent to the failed link then a Periodic Packet Management Daemon PPMD not shown of routing component may delegate connectivity fault detection functionality to a forwarding component monitor module e.g. pfemon . Otherwise routing component may do fault detection. Example techniques for connectivity fault detection in a multi chassis routing system are described in U.S. Pat. No. 7 720 061 filed Aug. 18 2006 entitled Distributed Solution for Managing Periodic Communications in a Multi Chassis Routing System the entire contents of which are incorporated by reference herein. In some examples in response to detecting a failure condition of a protected resource between router and a merge point router e.g. a failure of PLR router B positioned between PLR router A and MP router C as shown in connectivity fault detection module informs RSVP TE in the control plane of router of the detected condition. In other examples connectivity fault detection module may detect a node failure condition such as where an intermediate router is present on the path between the router and a merge point router.

Although illustrated for purposes of example as being positioned in the forwarding component e.g. in the forwarding plane of router connectivity fault detection module could alternatively be located in the control plane of router such as within routing component . In the case of connectivity fault detection module being located in the control plane connectivity fault detection module may poll the forwarding component for statistics and information and compare the data received from forwarding component to configured thresholds for example. In one example connectivity fault detection module may comprise a software application programming interface API in the control plane of router that notifies notify the control plane of the status of aspects of forwarding component such as next hop utilization statistics and forwarding component responds by providing the requested statistics. In this case connectivity fault detection module might perform bookkeeping accounting of bandwidth in the control plane for example.

In accordance with the techniques of this disclosure RSVP TE operates in accordance with an RSVP TE protocol that has been extended to signal availability of link and or node protection to a merge point and to enable RSVP TE to determine if router is a merge point. Based on whether or not RSVP TE determines router is a merge point router RSVP TE may selectively clean up LSP states stored by router when there is an upstream link or node failure. For example RSVP TE may support extensions to the RSVP TE protocol that may enable router to send a tear down message to a downstream router which may enable the downstream router to conditionally delete locate state information for the LSP. In some instances router may directly send a tear down message to a merge point router e.g. MP router C of even though router may not have a working bypass LSP and or may not have already refreshed backup LSP state information. According to the techniques of this disclosure the RSVP TE extensions may be backwards compatible with routers along the LSP that do not support these modifications to the RSVP TE protocol.

RSVP TE includes protection module merge point MP determination module and teardown module . Protection module set up link and or node protection and determines whether router has made node and or link protection available. In an example where router corresponds to router A of router receives a PATH message of PE router A to set up LSP . Using the SESSION ATTRIBUTE object of the PATH message PE router A signals to router that local protection is desired e.g. by setting a local protection flag of the SESSION ATTRIBUTE object and signals whether node protection is desired e.g. by setting a node protection flag of the SESSION ATTRIBUTE object . Responsive to receiving the PATH message protection module determines whether local protection and or node protection for LSP is desired. If local protection is desired but not node protection protection module attempts to make link protection available for the LSP once the LSP establishment is determined to be successful upon receiving RESV message. If both local protection and link protection are desired for LSP protection module attempts to make node protection available upon receiving RESV message from downstream router. If protection module successfully sets up node link protection protection module signals that node protection is available using a new PATH message and triggers the sending of the new PATH message. If protection module successfully sets up link protection protection module signals that links protection is available using a new PATH message and triggers the sending of the new PATH message. If after signaling local protection availability protection module determines that local protection is no longer available protection module may reset the record route object RRO flags relating to protection availability and trigger a PATH message including the reset RRO flags to be sent downstream.

MP determination module determines whether or not router is a merge point e.g. MP router D for a PLR router e.g. router B . In examples where router receives a PATH message e.g. where router is MP router D and receives the PATH message from router C of MP determination module determines whether the PATH message includes one or more RRO flags set to indicate that local protection is available. If the RRO flags indicate that local protection is available then MP determination module determines if there is remote RSVP TE Hello session with the point of local repair e.g. router B . A remote RSVP TE Hello session exists when two routers e.g. router and router B successfully exchange RSVP TE Hello Request and Ack messages. That is if router sends an RVSP Hello Request message to router B and in response receives an RSVP Hello Ack message from router B router determines that a remote Hello session exists between router and router B. In some examples the remote Hello session may be between a router and a next next hop router or previous previous hop router e.g. in the example of between router A and router C router B and D etc. . If the RRO flags are set and the remote Hello session is present then MP determination module determines that router is a merge point. If the PATH message does not include one or more RRO flags set to indicate that local protection is available or if MP determination module determines that there is no remote Hello session with the point of local repair MP determination module determines that router is not a merge point.

Teardown module determines when and what type of teardown message to send and where to send the teardown message. Teardown module may send one or more of a PathTear message a remote PathTear message and a conditional PathTear message. A conditional PathTear message is a mechanism by which router signals to another router e.g. router C of that router does not require the receiving router to unconditionally delete the LSP state immediately. The receiving router may delete the LSP state only if it is not a link protecting or a node protecting merge point. In other words the receiving router may be configured to delete the LSP state if there is no remote point of local repair path state on the receiving router. A remote PathTear message is a mechanism by which router may enable LSP state clean up while LSP is being locally repaired. The remote PathTear message may be sent to the next next hop i.e. the next hop of the next hop for the LSP in instances of next hop node failure or to the next hop in instances of link failure between the node and the next hop node and instructs the receiving node to delete the LSP state information for LSP .

As shown in router A is the first router along the path to PE router B. Router A receives the PATH message from PE router A and determines whether PE router A is attempting to set up a protected LSP. A protection module of router A e.g. protection availability module of analyzes the PATH message to determine if the SESSION ATTRIBUTE object includes a flag indicating that local protection is desired. In the example shown in the protection availability module determines that PE router A is attempting to set up a protected LSP i.e. that the SESSION ATTRIBUTE object includes the local protection desired set to indicate that location protection is desired.

An RSVP TE protocol executing at router A e.g. RSVP TE of sends via link A a PATH message downstream i.e. to router B to continue the LSP setup process. The PATH message sent to router B includes the location protection flag of the SESSION ATTRIBUTE object set the same way as was set in the PATH message router A received from PE router A. That is if the PATH message router A received from PE router A indicated that local protection is desired then the PATH message sent by router A also indicates that local protection is desired. Routers each analyze the PATH message received from the upstream device and send PATH messages to downstream devices until PE router B i.e. the egress router for the LSP receives the PATH message. PE router B reserves resources and sends a RESV message back upstream to router D which propagates the RESV message upstream to router C and so on until PE router A receives the RESV message. Once the LSP is established any of routers may periodically send RSVP refresh messages to refresh LSP state information on other routers .

Responsive to determining that location protection is desired router A determines whether a node protection flag is set in the SESSION ATTRIBUTE object. If the node protection flag is set the RSVP TE protocol attempts to create a node protection bypass LSP to the next next hop i.e. router C avoiding the next hop i.e. router B on the protected LSP path once the protected LSP establishment is successful with the arrival of RESV message from next hop router i.e. router B . That is router A establishes bypass LSP that traverses router E and bypasses router B. Router A may establish bypass LSP in accordance with MPLS fast reroute techniques as described in RFC 4090. For example as the point of local repair and ingress of bypass LSP router A may establish bypass LSP to protect not only LSP but also one or more other existing LSPs that traverse at least routers A and router B and do not traverse router E. After router A establishes bypass LSP router A maintains forwarding information in a data plane of router A e.g. in FIB that allows router A to send traffic through bypass tunnel if router B fails.

While selecting destination address of bypass LSP router A may attempt to select the router ID of the next next hop or next hop router. If router A and the merge point router i.e. router C are in same IGP area and if the node ID is not included in the Record Route Object RRO of the RESV message received from router B then router A may utilize TED to determine the router ID from the interface address in RRO. If router A and the next next hop merge point are in different IGP areas then router A may use the NodeID address of the next next hop merge point if the node ID is included in the RRO of the RESV message received from router B. If the node ID is not included in the RRO of the RESV message then router A should use the node protecting merge point s interface address present in the RRO of the RESV message. Router A should use its router ID as the source address of bypass LSP and may include its router ID as the node ID in the PATH RRO message.

If router A is not able to set up node protection after some period of time i.e. node protection setup times out without bypass LSP being setup router A may attempt to create a link protection bypass LSP to the next hop router i.e. router B . In the example shown in router A is able to establish bypass LSP . In various instances even though router A is able to establish bypass LSP router A may be configured to also establish a link protection bypass LSP.

If the node protection flag is not set in the SESSION ATTRIBUTE object router A attempts to create a link protection bypass LSP without first attempting to create a node protection bypass LSP. In general a link protection bypass LSP avoids the link between a router and the next hop i.e. link A between router A and B . Additional details with respect to link protection bypass LSPs will be discussed with respect to router C and link protection bypass LSP .

In parallel to the attempt to create a node protection bypass LSP or link protection bypass LSP router A may initiate remote Hello session to the next next hop or next hop node to track the reachability of the node protecting merge point or the link protecting merge point after any failure. The address of the remote neighbor is derived in the same manner as the destination address of the node protection bypass LSP or link protection bypass LSP. If the node protection bypass LSP i.e. LSP comes up then router A sets local protection available and node protection available RRO flags and triggers a new PATH message to be sent from router A to router B. If the link protection bypass LSP comes up then router A would set local protection available RRO flag and trigger a new PATH message to be sent to PLR router B.

A node ID based Hello session is one in which the node ID is used in source and destination address fields in an RSVP Hello message. RFC 4558 Node ID Based Resource Reservation Protocol RSVP Hello A Clarification Statement by Ali et al. June 2006 the entire contents of which is incorporated by reference herein formalizes node ID based Hello messages between two neighboring routers. The new procedures defined in the previous section extends the applicability of node ID based Hello messages between two routers that may not have an interface connecting them for exchanging RSVP messages.

As mentioned above router A sends a PATH message downstream to router B where the PATH message includes the local protection desired flag set. Router B propagates the PATH message downstream until the PATH message reaches the egress router e.g. PE router B of for the protected LSP e.g. LSP of . The egress router sends a RESV upstream e.g. to router D indicating that the egress router has reserved resources for LSP . Router D also sends a RESV message upstream to router C.

Router C receives the RESV message from router D and determines that a link protection bypass LSP needs to be created. Router C initiates creation of a link protection bypass LSP e.g. link protection bypass LSP sends a Hello message to router D to establish a NodeID Hello session and sends a RESV message to router B. Once router C determines that link protection bypass LSP has been successfully created router C sends a RESV message and a PATH message each having an RRO flag set indicating link protection is available for link C. Router C sends the RESV message upstream to router B and sends the PATH message downstream to router D. Router D receives the PATH message having the RRO local protection available flag and based on the RRO flag a merge point determination module of router D e.g. merge point determination module of determines that router D is a link protecting merge point for router C.

When the next next hop in the case of node protection or next hop in the case of link protection router receives the triggered PATH with RRO flag s set the router checks for the presence of a NodeID Hello session with point of local repair so that the router can detect if the network being partitioned. For example if router D receives the triggered PATH message from router C router D checks if it has the NodeID Hello session with router C. If the flags are set and the NodeID Hello session is present router D determines that protection has been made available at router C. If router C has included a node ID in triggered PATH RRO then the included node ID is the remote neighbor address. Otherwise the interface address of router C as specified in the PATH RRO is used as the remote neighbor address. If the node protection available flag is set by the previous previous hop router e.g. router B then router D determines that it is a node protecting merge point. Otherwise router D determines that it is a link protecting merge point.

Once a router determines it is a merge point e.g. router D determines it is a link protecting merge point or router C determines it is a node protecting merge point the router creates remote LSP path state information. The remote LSP state information is substantially the same as the protected LSP state except for a difference in the HOP object that contains the address of the NodeID Hello session with the point of local repair. The merge point router should automatically delete the remote state if 

As mentioned above when router C establishes link protection bypass LSP router C sends a RESV message to router B. Router B receives the RESV message and initiates creation of a node protection bypass LSP e.g. node protection bypass LSP sends a Hello message to router D to establish a NodeID Hello session and sends a RESV message to router A. Once router B determines that node protection bypass LSP has been successfully created router B sends a RESV message to router A and a PATH message to router C each having an RRO flag set indicating node protection is available. Router C receives the PATH message having the RRO node protection available flag set and propagates the PATH message. Router D receives the PATH message propagated by router C and a merge point determination module of router D e.g. merge point determination module of determines that router D is a node protecting merge point for router B.

Router A receives the RESV message from router B and initiates the creation of a node protection bypass LSP e.g. node protection bypass LSP and sends a Hello message to router D to establish adjacency signaling. Once router A determines that node protection bypass LSP has been successfully created router A sends a PATH message to router B with an RRO flag set indicating node protection is available. Router B receives the PATH message having the RRO node protection available flag propagates the PATH message. Router C receives the PATH message propagated by router B and a merge point determination module of router C e.g. merge point determination module of determines that router C is a node protecting merge point for router A. However router C does not propagate the PATH message to router D.

Whenever a router receives a PATH message the router should check if the only change is in RRO flags. If the change is only in PATH RRO flags then the router should decide whether to propagate the PATH based on the following rules 

In general when the next next hop router or next hop router receives the triggered PATH with RRO flag s set the router determines that protection has been made available at the point of local repair. As an additional check to detect whether the network is partitioned the router may check for the presence of a NodeID Hello session with the point of local repair. If the point of local repair has included a node ID in the PATH RRO then that node ID is the remote neighbor address. Otherwise the point of local repair s interface address in specified in the PATH RRO is used as the remote neighbor address. If the NP available flag is set by previous previous hop router the router that receives the propagated PATH message determines it is a node protecting merge point. Otherwise the router determines that it is a link protecting merge point. However a router may be both a link protecting merge point and a node protecting merge point. As shown in router D is a link protecting merge point for router C and link protection bypass LSP as well as a node protecting merge point for router B and node protection bypass LSP .

Techniques of this disclosure also provide for backwards compatibility for routers that do not support the enhanced fast reroute FRR facility protection techniques described herein. In this disclosure enhanced FRR facility protection may also be referred to as enhanced facility protection or enhanced fast reroute. Routers configured in accordance with the backwards compatibility techniques may support backward compatibility for a subset of LSPs configured on the routers. That is a router may simultaneously support both LSPs that only traverse routers that support the FRR enhancements described herein LSPs that traverse routers that only support conventional FRR techniques and LSP that traverse some routers that only support conventional FRR techniques and routers that support the FRR enhancements described herein.

There are at least two possible approaches to determine whether nodes along the LSP path support enhanced facility protection specified in previous sections. The first approach is based on signaling enhancement where any router implementing the FRR enhancements would set a new flag e.g. an enhanced facility protection flag in the RRO carried in PATH and RESV messages to indicate support for the FRR enhancements. Using this approach a router may determine whether a previous previous hop or previous hop router supports the FRR enhancements based on the PATH RRO flags included in PATH messages received from the previous previous hop or previous hop. Similarly a router may determine whether a next next hop or next hop router supports the FRR enhances based on the RESV RRO flags included in RESV messages received from the next next hop or next hop. In some examples any router that sets the enhanced facility protection flag may also set a Refresh Reduction Capable flag in the common header of all RSVP messages. The Refresh Reduction Capable flag indicates that the router supports increased refresh intervals of LSP states e.g. refresh intervals of at least one minute .

The second approach for providing backward compatibility is based on advertising support for FRR enhancements by setting a new flag Enhanced facility protection in the CAPABILITY object of Hello messages. The format of the CAPABILITY object of a Hello message is shown in . As a router that supports the FRR enhancements typically initiates Hellos with an adjacent router the router can determine whether a previous hop or next hop neighbor supports the FRR enhancements based on the Hello messages sent by the neighbor. If a router attempts to make node protection available then the point of local repair may initiate a remote NodeID Hello session with the next next hop. If the next next hop a does not reply to a remote Hello message or b does not set the Enhanced facility protection flag in the CAPABILITY object in the reply then the point of local repair determines that the next next hop does not support FRR enhancements. If node protection is requested for an LSP and if a the previous previous hop router has not set local protection available and NP available flags in its RRO flags or b the previous previous hop router has not initiated remote Hello messages then the router determines that the point of local repair does not support FRR enhancements.

If one or more downstream routers do not support the FRR enhancements a router may generate PATH messages with different parameters than if the downstream routers supported the FRR enhancements. For example if the next hop router does not support enhanced facility protection then the router may reduce the refresh period in TIME VALUES object carried in PATH messages to a default small refresh time value. If node protection is requested and the next hop router or the next next hop router does not support the FRR enhancements then the router may reduce the refresh period in TIME VALUES object carried in PATH to default value. If the router reduces the refresh time the router may also refrain from sending Remote PathTear and or Conditional PathTear messages.

As one example consider the example topology in . If router C does not support enhanced facility protection then routers A and B should reduce the refresh time to a shorter time period such as 10 seconds 30 seconds 45 seconds etc. and trigger sending of a PATH message. If router B is not an merge point and if the previous hop link of router B fails e.g. link A router B cannot send a Conditional PathTear to router C but may allow the LSP state from router A to time out normally. This would be accomplished if router A would also reduce the refresh time to a default value. That is if router C does not support enhanced facility protection then previous hop router B and previous previous hop router A should each reduce the refresh time specified in the PATH messages to a default value that is shorted that would otherwise be specified.

If one or more upstream routers do not support the FRR enhancements a router may generate RESV messages with different parameters than if the upstream routers supported the FRR enhancements. For example of the previous hop router does not support enhanced facility protection then the router should reduce the refresh period in TIME VALUES object carried in RESV to a default small refresh time value. If node protection is requested and the previous hop router does not support the FRR enhancements then the router should reduce the refresh period in TIME VALUES object carried in PATH to a default value. If node protection is requested and the previous previous hop node does not support the FRR enhancements then the router should reduce the refresh period in TIME VALUES object carried in RESV to a default value. If the router reduces the refresh time from the above procedures the router may also refrain from performing the merge point determination procedures described herein.

After signaling protection availability if router A determines that the protection is unavailable e.g. due to a link and or node failure router A may attempt to make protection available. That is if bypass LSP becomes unavailable router A may attempt to establish a different bypass LSP. Router A may wait for a time out before resetting RRO flags relating to protection availability and triggering a new PATH message to be sent downstream. If router A is able to establish an alternate bypass LSP router A need not wait for the time out to set RRO flags relating to protection availability and may immediately trigger a new PATH message to be sent downstream.

As shown in CAPABILITY object includes a Length field a Class Num field a C Type field a Reserved portion and a series of flag bits E T R and S. The Length field specifies the length of the CAPABILITY object. The Class Num field specifies the class number for the object. As the CAPABILITY object is assigned the class number of 134 the Class Num field is set to 134. The C Type field indicates the class type for the object within the class number. The CAPABILITY object is assigned class type 1 so the C type field is set to 1. The reserved portion of the capability object is reserved for future use. The T bit is the RecoveryPath Transmit Enabled bit and when set i.e. is the value 1 the T bit indicates that the sending node is enabled to send RecoveryPath messages. The R bit is the RecoveryPath Desired bit that when set indicates that the sending node desires to receive RecoveryPath messages. The S bit is the RecoveryPath Srefresh Capable bit. In combination with the R bit the S bit indicates that the sending node is capable of receiving and processing Srefresh messages with the RecoveryPath Flag set in the MESSAGE ID LIST object.

In accordance with the techniques of this disclosure the CAPABILITY object is modified to include E bit . E bit is created by using one bit from the reserved space. E bit indicates that the sender supports enhanced FRR facility protection. If E bit is set i.e. the value of E bit is 1 the sender is indicating that it supports enhanced FRR facility protection. If E bit is not set i.e. the value of E bit is 0 the sender is indicating that it does not support enhanced FRR facility protection. In this way the CAPABILITY object of the Hello message may be used to signal whether or not a node supports the enhanced facility protection techniques described in this disclosure. If the sender has not included CAPABILITY object in Hello message then the sender is considered not to support enhanced FRR facility protection.

Routers may detect when a neighboring node becomes unavailable by exchanging Hello messages. For example router B may send a Hello Request message to router A and router A responds with a Hello Ack message. If router B does not receive a Hello Ack message in response to the Hello Request message within a configured timeout period router B may determine that router A is unavailable. In general a neighboring node may become unavailable due to a link and or node failure.

When the link to a point of local repair fails e.g. link A between routers A and B the link Hello session to the point of local repair e.g. between routers A and B will fail whereas the remote NodeID Hello session to the point of local repair will remain up e.g. between routers A and C . Because the remote NodeID Hello session remains up the merge point will retain state until a refresh timeout because of the presence of remote path state. However if router B were to send a typical PathTear message then router C would delete LSP state upon receipt of the PathTear message instead of retaining the state information. In order to avoid router C prematurely deleting the state information router B includes a new optional object in the PathTear message. A PathTear message that includes the optional object is referred to herein as a Conditional Path Tear message. If router C also understands the new object then router C should delete LSP state only if it is not a node protecting merge point. In other words router C should delete LSP state if there is no remote point of local repair path state on router C.

A node e.g. router B may send a Conditional PathTear if router B determines to delete the LSP state under the following conditions 

If router B were to receive a Conditional PathTear message router B is configured to delete its LSP state information and process the Conditional PathTear as a normal PathTear message because router B is not a node protecting merge point. Router B may not propagate the Conditional PathTear message downstream i.e. to router C but instead removes the optional object and sends a normal PathTear message downstream.

When router C receives the Conditional PathTear message from router B router C does not immediately delete its LSP state information. Instead router C checks whether router B previously set NP available flag in the PATH message RRO flags. If router B previously set the flag then router C should clear local protection available and NP available flags in the PATH message RRO flags and trigger sending the PATH message downstream e.g. to router D .

Techniques of this disclosure also provide for backwards compatibility for nodes that do not support the enhanced facility protection techniques described herein. For example if a Conditional PathTear message is received from a neighbor that has not advertised support for enhanced facility protection then the node processes the message as normal PathTear message propagates a normal PathTear message downstream and delete its LSP state information. In other words if router C did advertise enhanced facility protection in Hello messages but propagated a Conditional PathTear message to router D which does support enhanced facility protection router D may ignore the new object defining the PathTear message as a Conditional PathTear message and process the Conditional PathTear message as if it were a normal PathTear message. That is router D may delete its LSP state information and propagate a normal PathTear message downstream.

If an upstream link that is not attached to a node protecting merge point fails and the node protecting merge point receives a Conditional PathTear message from the previous hop node then the merge point may retain the LSP state information as long as the remote NodeID Hello session with the point of local repair is up because the Conditional PathTear from the previous hop node will not impact the remote path state from the point of local repair. For example if link A fails router C receives a Conditional PathTear message from router B. As router C is the node protecting merge point for router A and bypass LSP router C is configured to retain the LSP state information as long as routers A and C are able to continue to exchange Hello messages i.e. as long as the remote NodeID Hello session with the point of local repair is up . If router C does not receive a Hello Ack in response to a Hello Request e.g. the remote Hello session is down router C may delete the LSP state information.

In the example shown in assume routers C and D are node protecting merge points for routers A and B respectively. When link A fails as router B is not a merge point and its previous hop link Hello session has failed router B deletes its LSP state information. In the data plane that would require router B to delete the label forwarding entry corresponding to LSP . So if router B s downstream nodes i.e. router C and D continue to retain LSP state information it would not be correct for router D to continue to assume that it is the node protecting merge point for router B. There are several different ways to address this problem. In one example as router B had previously signaled node protection availability router B may signal lack of node protection availability before sending the Conditional PathTear message to router C. Router B may trigger a PATH message wait for a PATH Ack in response to the PATH message and in response to receiving the PATH Ack send the Conditional PathTear message to router C. Router B may include both PATH with updated RRO flags and Conditional PathTear in a message bundle.

As another example router B may send a Conditional PathTear message to router C via link B and let router C interpret the Conditional PathTear message as implicit signaling of the lack of node protection availability. In this example router C should then update the PATH RRO flags for router B to signal router D that node protection is no longer available on router B. In general to process to update the PATH RRO flags includes router B sending a Conditional PathTear to router C and deleting its LSP state information. When router C receives the Conditional PathTear router C determines that it should retain the LSP state information because router C had previously determined that it is a node protecting merge point for router A. Router C also determines whether router B had previously signaled availability of node protection to router C. As shown in router B had previously signaled node protection availability in its PATH RRO flags. Accordingly router C resets the local protection available and NP available flags in the PATH RRO flags corresponding to router B and triggers propagation of the PATH message to router D via link C. When router D receives the triggered PATH message router D determines that it is no longer a node protecting merge point and deletes the remote state information. However router D does not propagate the triggered PATH message further downstream because the only change in the triggered PATH message is in PATH RRO flags of router B.

If at a later time link A comes back up router A may attempt to revert LSP to traversing the original path rather than using bypass LSP . Router A may attempt to re establish LSP by at least signaling the same LSP instance to router B e.g. using a PATH message . Router B receives the PATH message creates LSP state information for LSP and propagates the PATH message to router C. In instances where router C determines that it retained state information for LSP router C sends a RESV message to router B and does not propagate the PATH message downstream.

Router B attempts to re establish node protection e.g. bypass LSP via router F as shown in . Once node protection becomes available again router B sets the node protection available flag in the RRO flags of a PATH message and sends the PATH message to router C. Router C receives the PATH message and determines that the RRO flags have changed as compared to the previously received PATH message. Responsive to determining that the RRO flags have changed router C propagates the PATH message to router D. Router D receives the propagated PATH message determines based on the node protection available flag in the PATH message that it is a node protecting merge point for router C and recreates the remote LSP path state information.

As the refresh timeout of the LSP state information may be high e.g. minutes LSP state needs to be cleaned up properly even after local repair. If the ingress router e.g. PE router A intends to tear down the LSP or if the point of local repair is unable to perform local repair it would not be desirable to wait for backup LSP signaling to perform state cleanup. To enable LSP state cleanup when LSP is being locally repaired nodes should send remote tear down message instructing the receiving node to delete LSP state.

For example if after link A fails router A is unable to perform a local repair router A sends a Remote PathTear message to router C as router C is the node protecting merge point for router A. As described above in response to determining that link A failed router B deletes the LSP state information and sends a Conditional PathTear message to router C. If router C only received the Conditional PathTear message from router B router C would maintain LSP state information so long as the remote NodeID Hello session with router A is up. However because router C also received a Remote PathTear message from router A router C deletes the LSP state information and sends a normal PathTear message to router D. Router D processes the Remote PathTear message just like any other normal PathTear message in as much as router D deletes the LSP state information.

M bit is a single bit and specifies the conditions under which default processing rules of the RSVP message should be invoked. That is conditions object with M bit being set to 1 indicates that the PathTear message should be processed based on whether the receiving node is a merge point. If the receiving node is a merge point i.e. a link protecting merge point or a node protecting merge point the receiving node will retain the LSP state information so long as the remote NodeID Hello session with point of local repair is up. If the receiving node is not a merge point then the receiving node will delete the LSP state information.

As shown in router B has failed. Router A which is the point of local repair performs local repair. That is router A updates LSP to include bypass LSP such that LSP traverses router A E and C rather than router A B and C. When router B fails the link Hello session from router C to router B will fail but the remote NodeID Hello session between router C and router A the point of local repair remains up as router A performed local repair. As router C is the node protecting merge point for router A so long as the remote NodeID Hello session between router C and A remains up router C will retain the LSP state information.

With the failure of router B router D determines that the remote NodeID Hello session with router B has failed. Based on the remote NodeID Hello session failure router D deletes the remote LSP path state information. However because router D continues to receive RSVP refresh message from router C and link Hello session with router C is up router D maintains LSP state information for LSP .

At a later point in time router B comes back up. Router A determines that router B is back up and re signals the same LSP instance in an attempt to re establish LSP traversing the path along routers A B and . That is router A sends a PATH message to router B instructing router B to re establish LSP . Router B receives the PATH message creates LSP state information for LSP and propagates the PATH message to router C. In instances where router C determines that it retained state information for LSP router C sends a RESV message to router B and does not propagate the PATH message downstream.

Router B attempts to re establish node protection e.g. bypass LSP via router F as shown in . Once node protection becomes available again router B sets the node protection available flag in the RRO flags of a PATH message and sends the PATH message to router C. Router C receives the PATH message and determines that the RRO flags have changed as compared to the previously received PATH message. Responsive to determining that the RRO flags have changed router C propagates the PATH message to router D. Router D receives the propagated PATH message determines based on the node protection available flag in the PATH message that it is a node protecting merge point for router C and recreates the remote LSP path state information.

If after router B fails router A is unable to perform a local repair router A sends a Remote PathTear message to router C as router C is the node protecting merge point for router A. As router C received an explicit PathTear requesting state deletion router C deletes the LSP state information and sends a normal PathTear message to router D. Router D process the normal PathTear message just like any other normal PathTear message in as much as router D deletes the LSP state information.

An LSP may be preempted by a new LSP. Details of how one LSP may be preempted by another LSP are described in J. do Oliveira Label Switched Path LSP Preemption Polices for MPLS Traffic Engineering Network Working Group RFC 4829 April 2007 and M. Meyer MPLS Traffic Engineering Soft Preemption Internet Engineering Task Force RFC 5712 January 2010 the entire contents of each of which is incorporated by reference herein. In instances where an LSP is preempted when there is no failure along the path of the LSP the node on which preemption occurs sends PathErr and ResvTear upstream and deletes the forwarding state. If the LSP is being locally repaired and if the failure has occurred upstream to the node on which the LSP is preempted then the node would not be able to send PathErr or ResvTear upstream.

As one example LSP is preempted on router C after router B has failed but before router A establishes bypass LSP . As router C has retained LSP state information because router A refreshes LSP using signaling traversing bypass LSP preemption of LSP brings down LSP and router C ceases being a node protecting merge point. As router C is no longer be a node protecting merge point router C needs to remove the LSP state information for LSP . Router C deletes its reservation on link C by for example sending a normal PathTear message to router D but router C cannot send PathErr or ResvTear to router A because backup LSP has not yet been signaled by router A.

As router C retained LSP state information after router B failed because router C was a node protecting merge point router C may send normal PathTear to router D and delete the LSP state information. Router D may also delete state on receiving PathTear from router C. Router A starts backup LSP signaling to router C. But as router C does not have the LSP state information for LSP router C rejects backup LSP PATH and sends a PathErr to router A. Router A deletes its reservation and sends ResvTear to router A.

In some instances router B is unable to perform local repair i.e. router B failed to bring up bypass LSP . With the failure of link B and the local repair failure router B sends a PathErr and ResvTear message to router A via link A a Remote PathTear to router D and deletes LSP state information for LSP . Router D receives the Remote PathTear deletes state information for LSP and sends a ResvTear message to router C via link C. As LSP goes down on router C i.e. because router B was unable to perform local repair and as link B is already down router C deletes LSP state information for LSP .

In the example topology in assume both router A has made node protection available and router C has concluded it is a node protecting merge point. When link B fails router C retains LSP state as it is a node protecting merge point. As router B has made node protection available router B will eventually complete backup LSP signaling with its corresponding node protecting merge point router D. At the completion of backup LSP signaling the RRO of the LSP carried in RESV message sent by router B to router A will not include information for router C but will include information for router B and router D. When router A processes the RESV message with the new RRO values which do not include information for the former node protecting merge point of router A i.e. router C router A may send Remote PathTear to router C. When router C receives the Remote PathTear message from its corresponding point of local repair router A router C sends a normal PathTear message to router D and deletes the LSP state stored at router C. As router D had already completed backup LSP signaling with its point of local repair i.e. router B router D will have backup path state and will ignore the normal PathTear from router C.

As shown in router C has failed. In general when the NodeID Hello session between router D and router C which is the point of local repair for the link protection goes down router D sends a normal PathTear message and deletes the LSP state. If router D which is both a link protecting merge point and a node protecting merge point detects the failure of router C then router D retains LSP state until an RSVP refresh timeout.

In one example router C has gone down and router B has not signaled backup LSP to router D. If router A intends to tear down LSP then router A sends normal PathTear to router B. To enable LSP state cleanup router B sends a Remote PathTear to router D. The Remote PathTear includes a destination IP address set to that of router D and a HOP object that includes the local address used in remote NodeID Hello sessions with router D. Because router D maintains a NodeID Hello session with router B router D accept the Remote PathTear from router B and deletes the LSP state information for LSP . In this way routers may clean up the LSP state information on all nodes along the path of the LSP .

In some instances router B is unable to perform local repair i.e. router B failed to bring up bypass LSP . With the failure of router C and the local protection failure of router B router B sends a PathErr and a ResvTear message to router A via link A a Remote PathTear message to router D and deletes LSP state information for LSP . Router D receives the Remote PathTear and deletes state information for LSP . That is all nodes downstream of and immediate to the failure clean up LSP state information for LSP . However router A may retain the LSP path state block without any forwarding entry in its forward tables.

As shown in link C has failed. When link C fails the link Hello session between routers C and D also fails whereas the NodeID Hello session between routers B and D remains up. As such router D retains the LSP state information for LSP . Moreover router D retains LSP state information for LSP because router C has made link protection available.

If LSP is preempted on router D after router C or link C has already failed but before the respective one of the backup LSPs has been signaled over bypass LSPs and then router D sends a normal PathTear downstream and deletes the LSP state information for LSP . As router D has retained LSP state information for LSP because the point of local repair for the particular type of failure i.e. the respective one of routers B and C would refresh the LSP through backup LSP signaling preemption would bring down LSP and router D would no longer be a link protection or node protecting merge point requiring router D to clean up LSP state.

In some instances router C is unable to perform local repair i.e. router C failed to bring up a backup LSP or bypass LSP . Such a failure may trigger LSP state clean up from router C to the egress router e.g. PE router B of . That is with the failure of link C and the local protection failure of router C router C sends a PathErr and a ResvTear message to router B via link C a Remote PathTear message to router D and deletes LSP state information for LSP . Router D receives the Remote PathTear and deletes state information for LSP . Responsive to receiving the ResvTear message from router C router B brings down LSP and sends a ResvTear to router A. Similarly responsive to receiving the ResvTear message from router B router A brings down LSP .

Router A receives a PATH message from the LSP ingress PE router A to set up LSP . PE router A signals whether local protection is by selectively setting a flag of the SESSION ATTRIBUTE object of the PATH message. Router A propagates the PATH message downstream to continue to set up the LSP. PE router B i.e. the egress router for the LSP receives the PATH message and sends back a RESV message indicating that the LSP is being established. Router A receives a RESV message from an downstream router e.g. router B indicating that the LSP is setup downstream of router A . Responsive to receiving the RESV message protection module of router A may determine whether local protection is desired for LSP . Protection module may analyze the received PATH message in response to receiving the RESV message or may analyze the PATH message in response to receiving the PATH message. In either instance if protection module of router A determines that local protection is not desired NO branch of router A does not attempt to set up link protection or node protection.

If protection module determines that local protection is desired YES branch of protection module determines whether node protection is desired . While illustrated as two separate decisions with the node protection determination following the local protection determination protection module may determine whether local protection and or node protection is desired in parallel or in any order. If protection module determines that node protection is not desired NO branch of RSVP TE attempts to establish a bypass LSP between router A and router B once the protected LSP establishment is determined to be successful based on the arrival of RESV message from the next hop router i.e. router B . In instances where RSVP TE establishes the bypass LSP RSVP TE generates a PATH message indicating that link protection is available and sends the PATH message to router B .

In the example shown in protection module determines that node protection is desired YES branch of . Responsive to determining that node protection is desired YES branch of protection module attempts to make node protection available by establishing bypass LSP between router A and router C . If protection module successfully sets up node link protection protection module signals that node protection is available by generating a new PATH message indicating that node protection is available and sends the PATH message downstream to router B .

In one example router C receives a Conditional PathTear message from router B . When router C receives the Conditional PathTear message from router B router C does not immediately delete its LSP state information. Instead MP determination module of router C checks whether router B previously set NP available flag in the PATH message RRO flags . That is router C determines whether it is a node protecting merge point . If router C determines that it is not a node protecting merge point NO branch of router C generates a normal PathTear message i.e. without the optional object sends the PathTear message downstream e.g. to router D and removes the LSP state information for LSP . If router C determines that it is not a node protecting merge point YES branch of router C retains the LSP state information for LSP clears the local protection available and NP available flags in the PATH message RRO flags and sends the PATH message downstream e.g. to router D 

The techniques described in this disclosure may be implemented at least in part in hardware software firmware or any combination thereof. For example various aspects of the described techniques may be implemented within one or more processors including one or more microprocessors digital signal processors DSPs application specific integrated circuits ASICs field programmable gate arrays FPGAs or any other equivalent integrated or discrete logic circuitry as well as any combinations of such components. The term processor or processing circuitry may generally refer to any of the foregoing logic circuitry alone or in combination with other logic circuitry or any other equivalent circuitry. A control unit comprising hardware may also perform one or more of the techniques of this disclosure.

Such hardware software and firmware may be implemented within the same device or within separate devices to support the various operations and functions described in this disclosure. In addition any of the described units modules or components may be implemented together or separately as discrete but interoperable logic devices. Depiction of different features as modules or units is intended to highlight different functional aspects and does not necessarily imply that such modules or units must be realized by separate hardware or software components. Rather functionality associated with one or more modules or units may be performed by separate hardware or software components or integrated within common or separate hardware or software components.

The techniques described in this disclosure may also be embodied or encoded in a computer readable medium such as a computer readable storage medium containing instructions. Instructions embedded or encoded in a computer readable medium may cause a programmable processor or other processor to perform the method e.g. when the instructions are executed. Computer readable media may include non transitory computer readable storage media and transient communication media. Computer readable storage media which is tangible and non transitory may include random access memory RAM read only memory ROM programmable read only memory PROM erasable programmable read only memory EPROM electronically erasable programmable read only memory EEPROM flash memory a hard disk a CD ROM a floppy disk a cassette magnetic media optical media or other computer readable storage media. It should be understood that the term computer readable storage media refers to physical storage media and not signals carrier waves or other transient media.

Various aspects of this disclosure have been described. These and other aspects are within the scope of the following claims.

